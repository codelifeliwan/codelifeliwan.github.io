<!doctype html>
<!--[if IE 6]>
<html id="ie6" lang="zh-CN">
<![endif]-->
<!--[if IE 7]>
<html id="ie7" lang="zh-CN">
<![endif]-->
<!--[if IE 8]>
<html id="ie8" lang="zh-CN">
<![endif]-->
<!--[if !(IE 6) | !(IE 7) | !(IE 8)  ]><!-->
<html lang="zh-CN">
 <!--<![endif]-->
 <head>      
  <link rel="stylesheet" type="text/css" media="all" href="stylesheets/style.css">     
  <link rel="stylesheet" id="codebox-css" href="stylesheets/codebox.css" type="text/css" media="screen">             
 </head> 
 <body class="single single-post postid-252 single-format-standard content-sidebar"> 
  <div id="page" class="hfeed"> 
   <header id="branding" role="banner"> 
    <hgroup> 
     <h1 id="site-title"><span><a href="http://codelifeliwan.github.io/" title="Code_Life_LiWan" rel="home">Code_Life_LiWan</a></span></h1> 
     <h2 id="site-description">My heart will go on and on…</h2> 
    </hgroup>  
    <!-- #access --> 
   </header>
   <!-- #branding --> 
   <div id="main" class="clearfix"> 
    <div id="primary"> 
     <div id="content" role="main"> 
      <!-- #nav-single --> 
      <article id="post-252" class="post-252 post type-post status-publish format-standard hentry category-my_operating_system tag-reserved"> 
       <header class="entry-header"> 
        <h1 class="entry-title">[转载]收集点关于FS寄存器的资料</h1> 
        <div class="entry-meta"> 
         <span class="sep">Posted on </span>
         <a href="http://codelifeliwan.github.io/?p=252" title="下午 9:17" rel="bookmark"><time class="entry-date" datetime="2012-08-22T21:17:25+00:00" pubdate>22 八月, 2012</time></a>
         <span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codelifeliwan.github.io/?author=1" title="View all posts by wanli" rel="author">wanli</a></span></span> 
         <span class="sep"> — </span> 
         <span class="comments-link"> <a href="http://codelifeliwan.github.io/?p=252#respond" title="Comment on [转载]收集点关于FS寄存器的资料">No Comments ↓</a> </span> 
        </div>
        <!-- .entry-meta --> 
       </header>
       <!-- .entry-header --> 
       <div class="entry-content">
        <div class="entry-content"> 
         <div class="blogzz_abstract borderc" style="padding-top:15px;margin:20px 0; border:none; border-top:1px dotted #ccc;"> 
          <div class="blogzz_ainfo" style="margin-bottom:12px;"> 
           <span style="margin-right:25px;"><strong>原文地址：</strong><a target="_blank" href="http://blog.sina.com.cn/s/blog_4de78d590100eq1z.html" title="收集点关于FS寄存器的资料">收集点关于FS寄存器的资料</a></span> 
           <span><strong>作者：</strong><a href="http://blog.sina.com.cn/u/1307020633" title="winsunxs" target="_blank">winsunxs</a></span> 
          </div> 
          <div class="blogzz_acon"> 
           <p><span style="FonT-siZe: large">收集点关于FS寄存器的资料：</span></p> 
           <p><span style="FonT-FAMiLY: 宋体">FS寄存器指向当前活动线程的TEB结构（线程结构）<br> 偏移&nbsp;<wbr> 说明<br> 000&nbsp;<wbr> 指向SEH链指针<br> 004&nbsp;<wbr> 线程堆栈顶部<br> 008&nbsp;<wbr> 线程堆栈底部<br> 00C&nbsp;<wbr> SubSystemTib<br> 010&nbsp;<wbr> FiberData<br> 014&nbsp;<wbr> ArbitraryUserPointer<br> 018&nbsp;<wbr> FS段寄存器在内存中的镜像地址<br> 020&nbsp;<wbr> 进程PID<br> 024&nbsp;<wbr> 线程ID<br> 02C&nbsp;<wbr> 指向线程局部存储指针<br> 030&nbsp;<wbr> PEB结构地址（进程结构）<br> 034&nbsp;<wbr> 上个错误号</span></p> 
           <p><span style="FonT-FAMiLY: 宋体"><br> 得到KERNEL32.DLL基址的方法<br> assume<br> fs:nothing&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr><br> ;打开FS寄存器<br> mov<br> eax,fs:[30h]&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr><br> ;得到PEB结构地址<br> mov eax,[eax +<br> 0ch]&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr><br> ;得到PEB_LDR_DATA结构地址<br> mov esi,[eax +<br> 1ch]&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr><br> ;InInitializationOrderMod<wbr>uleList<br> lodsd&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr><br> ;得到KERNEL32.DLL所在LDR_MODULE结构的InInitializationOrderMod<wbr>uleList地址</span></p> 
           <p>mov edx,[eax +<br> 8h]&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr><br> ;得到BaseAddress，既Kernel32.dll基址</p> 
           <p>&nbsp;<wbr></p> 
           <p><span style="FonT-siZe: large">S.E.H结构原理：</span></p> 
           <div> 
            <p>首先确定自己的链表知识回调函数知识已经补充.</p> 
            <p>S.E.H结构包含两个DWORD指针:SEH链表指针和异常处理函数句柄,8个字节,8个要点.</p> 
            <p>1)SEH结构体存放在系统栈;</p> 
            <p>2)线程初始化将自动向栈里安装一个SEH结构,作为默认线程异常处理.</p> 
            <p> 3)如果程序源代码中使用了_try{}和_excopt{}或者宏等异常处理机制,编译器将最终通过向当前函数栈安装一个SEH来实现异常处理.</p> 
            <p>4)栈中一般会同时存在多个SEH.</p> 
            <p>5)栈中的多个SEH通过链表指针在栈内由栈顶向栈底穿成单向链表,位于链表最顶端的SEH通过TEB 0字节处的指针来标识.</p> 
            <p>6)当异常发生时,操作系统会中断程序,并首先从TEB的<br> 0字节偏移处取得最近的SEH,使用异常处理函数句柄所指向的代码来处理异常.</p> 
            <p>7)当离异常最近的异常处理函数不能处理时,将沿顺SEH链表逐步尝试.</p> 
            <p>8)如果程序所安装的异常处理函数都不能解决,系统将采用默认的异常处理函数来处理,通常弹出错误对话框,强制关闭程序.</p> 
            <p>根据以上8个要点可以总结出以下处理顺序:</p> 
            <p>①—&gt;首先执行线程异常处理函数及最近的SEH.</p> 
            <p>②失败后将执行链表中的下一个异常处理函数,只止于NULL而不能解决.</p> 
            <p>③执行进程异常处理SEH</p> 
            <p>④执行系统异常处理SEH.</p> 
            <p>线程异常处理:2个状态值,参数无须解释.值得一提的是unwind操作.清理现场,释放资源技巧可以借鉴.</p> 
            <p>unwind操作通过kernerl.32中的函数rtlunwind()来实现.</p> 
            <p> 进程异常处理:3种状态值.进程的异常处理回调函数需要使用kernerl32.dll中的函数setunhandledexceptionfli<wbr>ter()函数来注册.</p> 
            <p> 系统默认异常处理:终极BOSS也称UEF.如果进程异常处理函数失败或者进程异常处理函数没有注册,系统异常处理函数unhandledexptionfilter()将被调用,所有的异常都将被捕获.</p> 
            <p> 首先这个函数检查注册表,HKLMSOFTWAREMICROSOFTwin<wbr>dowsntcvaedebug.其中值得一提的是其中的参数.指定了程序调试器.</p> 
            <p> ring3中第一个异常处理函数为kiuserexceptiondispatche<wbr>r(),其首先检查调试状态,遍历SEH表,unwind操作,</p> 
            <p> 然后失败调用终极BOSS.winxp增加了VEH.其中VEH与SEH不同的一个显著特点是,其为双向链表.其处理级别要高于SEH并保存在堆内.unwind操作对起不起作用.</p> 
           </div> 
          </div> 
         </div> 
        </div>
       </div>
       <!-- .entry-content --> 
       <!-- .entry-meta --> 
      </article>
      <!-- #post-252 --> 
      <!-- #comments --> 
     </div>
     <!-- #content --> 
    </div>
    <!-- #primary --> 
    <!-- #secondary .widget-area --> 
   </div>
   <!-- #main --> 
   <!-- #colophon --> 
  </div>
  <!-- #page -->   
  <!-- JiaThis Button BEGIN -->  
  <!-- JiaThis Button END -->   
 </body>
</html>