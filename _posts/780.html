<!doctype html>
<!--[if IE 6]>
<html id="ie6" lang="zh-CN">
<![endif]-->
<!--[if IE 7]>
<html id="ie7" lang="zh-CN">
<![endif]-->
<!--[if IE 8]>
<html id="ie8" lang="zh-CN">
<![endif]-->
<!--[if !(IE 6) | !(IE 7) | !(IE 8)  ]><!-->
<html lang="zh-CN">
 <!--<![endif]-->
 <head>      
  <link rel="stylesheet" type="text/css" media="all" href="stylesheets/style.css">     
  <link rel="stylesheet" id="codebox-css" href="stylesheets/codebox.css" type="text/css" media="screen">             
 </head> 
 <body class="single single-post postid-780 single-format-standard content-sidebar"> 
  <div id="page" class="hfeed"> 
   <header id="branding" role="banner"> 
    <hgroup> 
     <h1 id="site-title"><span><a href="http://codelifeliwan.github.io/" title="Code_Life_LiWan" rel="home">Code_Life_LiWan</a></span></h1> 
     <h2 id="site-description">My heart will go on and on…</h2> 
    </hgroup>  
    <!-- #access --> 
   </header>
   <!-- #branding --> 
   <div id="main" class="clearfix"> 
    <div id="primary"> 
     <div id="content" role="main"> 
      <!-- #nav-single --> 
      <article id="post-780" class="post-780 post type-post status-publish format-standard hentry category-linux_kernel_source_code_notes"> 
       <header class="entry-header"> 
        <h1 class="entry-title">Linux内核-设备驱动（五、块设备驱动概述及其数据结构说明）</h1> 
        <div class="entry-meta"> 
         <span class="sep">Posted on </span>
         <a href="http://codelifeliwan.github.io/?p=780" title="下午 3:51" rel="bookmark"><time class="entry-date" datetime="2013-01-20T15:51:15+00:00" pubdate>20 一月, 2013</time></a>
         <span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codelifeliwan.github.io/?author=1" title="View all posts by wanli" rel="author">wanli</a></span></span> 
         <span class="sep"> — </span> 
         <span class="comments-link"> <a href="http://codelifeliwan.github.io/?p=780#comments" title="Comment on Linux内核-设备驱动（五、块设备驱动概述及其数据结构说明）">2 Comments ↓</a> </span> 
        </div>
        <!-- .entry-meta --> 
       </header>
       <!-- .entry-header --> 
       <div class="entry-content">
        <div class="entry-content"> 
         <p>块设备分几个部分来看。</p> 
         <h2>1、块设备驱动概述</h2> 
         <p>块设备是文件系统的物质基础，而文件系统，则就是对块设备上存储的内容按照某种格式加以组织的结果。对块设备的访问有两种方式，一种就是按照文件系统的组织，将其看成通过各层目录将文件组织的结果，而另外一种就是忽略文件系统的组织，将其看成单纯的记录块阵列。在底层都是一定的字节流，后面一种在特殊的情况下会用到，比如我们安装Linux的时候使用U盘安装，则我们就直接使用open()打开我们的dev/sdb（U盘设备），然后使用write()将我们的iso镜像直接写入进去即可，就免去了刻录光盘的麻烦，但是如果我们按照文件系统的组织将iso镜像拷贝到U盘中则不行。</p> 
         <p>在我们访问一个文件的时候，指令首先是穿过最上层的文件系统，到达VFS，然后穿过VFS到达最后的块设备比如IDE硬盘等，在最后面通过一定方式来进行数据的读取与写入等操作。</p> 
         <p>在Linux中，我们如果是通过设备节点进行访问，那么我们就称对于这个设备的访问是“原始访问”，也就是对原始设备的访问，也就是上面说的第二种。其他的才是正常访问。</p> 
         <h2>2、数据结构说明</h2> 
         <p>关于文件系统的部分在文件系统章节中已经讲过（没讲的部分以后有机会的话补上），我们这里重点讲对于原始设备的访问。</p> 
         <p>在文件系统中有个inode结构，这是非常重要的一个结构，在结构里面有个file_operations指针i_fop，如果一个文件是块设备文件节点，那么这个指针指向的是def_blk_fops，这个数据定义于fs/block_dev.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=780&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7801"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td> 
             <td class="code" id="p780code1"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> file_operations def_blk_fops <span style="color: #339933;">=</span> <span style="color: #009900;">{</span>
	open<span style="color: #339933;">:</span>		blkdev_open<span style="color: #339933;">,</span>
	release<span style="color: #339933;">:</span>	blkdev_close<span style="color: #339933;">,</span>
	llseek<span style="color: #339933;">:</span>		block_llseek<span style="color: #339933;">,</span>
	read<span style="color: #339933;">:</span>		block_read<span style="color: #339933;">,</span>
	write<span style="color: #339933;">:</span>		block_write<span style="color: #339933;">,</span>
	fsync<span style="color: #339933;">:</span>		block_fsync<span style="color: #339933;">,</span>
	ioctl<span style="color: #339933;">:</span>		blkdev_ioctl<span style="color: #339933;">,</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>其中定义了一系列的块设备的函数指针。另外，inode中还定义了一个专用于块设备的指针i_bdev，指向代表着具体块设备的block_device数据结构，在本章第一节已经说过了，在这里再次列出来，它定义于include/linux/fs.h中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=780&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7802"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td> 
             <td class="code" id="p780code2"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> block_device <span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> list_head	bd_hash<span style="color: #339933;">;</span>
	atomic_t		bd_count<span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*	struct address_space	bd_data; */</span>
	dev_t			bd_dev<span style="color: #339933;">;</span>  <span style="color: #808080; font-style: italic;">/* not a kdev_t - it's a search key */</span>
	atomic_t		bd_openers<span style="color: #339933;">;</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">struct</span> block_device_operations <span style="color: #339933;">*</span>bd_op<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> semaphore	bd_sem<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* open/close mutex */</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>其中的指针bd_op指向其块设备的操作结构block_device_operations，这个结构定义于include/linux/fs.h中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=780&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7803"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
</pre></td> 
             <td class="code" id="p780code3"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> block_device_operations <span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>open<span style="color: #009900;">)</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> inode <span style="color: #339933;">*,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>release<span style="color: #009900;">)</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> inode <span style="color: #339933;">*,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>ioctl<span style="color: #009900;">)</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> inode <span style="color: #339933;">*,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*,</span> <span style="color: #993333;">unsigned</span><span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>check_media_change<span style="color: #009900;">)</span> <span style="color: #009900;">(</span>kdev_t<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>revalidate<span style="color: #009900;">)</span> <span style="color: #009900;">(</span>kdev_t<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>对于每一个具体的块设备都有一套这样的具体操作。</p> 
         <p>在内核中有一个数组blkdevs[]，以主设备号为下标就能通过数组中的表项找到各种设备的block_device_operations数据结构，这个数组定义于fs/block_dev.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=780&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7804"> 
             <td class="line_numbers"><pre>1
2
3
4
</pre></td> 
             <td class="code" id="p780code4"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">struct</span> <span style="color: #009900;">{</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>name<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> block_device_operations <span style="color: #339933;">*</span>bdops<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span> blkdevs<span style="color: #009900;">[</span>MAX_BLKDEV<span style="color: #009900;">]</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>下面的块设备就比较具体了，我们也就以IDE硬盘来说明。</p> 
         <p>对于IDE硬盘，我们的block_device_operations数据结构是这样的（drivers/ide/ide.c）：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=780&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7805"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
</pre></td> 
             <td class="code" id="p780code5"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> block_device_operations ide_fops<span style="color: #009900;">[</span><span style="color: #009900;">]</span> <span style="color: #339933;">=</span> <span style="color: #009900;">{</span><span style="color: #009900;">{</span>
	open<span style="color: #339933;">:</span>			ide_open<span style="color: #339933;">,</span>
	release<span style="color: #339933;">:</span>		ide_release<span style="color: #339933;">,</span>
	ioctl<span style="color: #339933;">:</span>			ide_ioctl<span style="color: #339933;">,</span>
	check_media_change<span style="color: #339933;">:</span>	ide_check_media_change<span style="color: #339933;">,</span>
	revalidate<span style="color: #339933;">:</span>		ide_revalidate_disk
<span style="color: #009900;">}</span><span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>这样，通过这些数据结构我们就把对抽象的“块设备文件”的操作逐层地具体化为了对设备的操作。</p> 
         <p>下面的就是对具体的ide硬盘的设备层的操作了。</p> 
         <p>比如在block_device_operations中的ide_open，就可以通过inode中的i_rdev来寻找设备的驱动程序等。</p> 
         <p>对于具体的设备还需要设备的“设备控制块”，对于IDE硬盘则是ide_drive_t数据结构，这个结构定义于include/linux/ide.h中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=780&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7806"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
</pre></td> 
             <td class="code" id="p780code6"><pre class="c" style="font-family:monospace;"><span style="color: #339933;">#define ide_scsi	0x21</span>
<span style="color: #339933;">#define ide_disk	0x20</span>
<span style="color: #339933;">#define ide_optical	0x7</span>
<span style="color: #339933;">#define ide_cdrom	0x5</span>
<span style="color: #339933;">#define ide_tape	0x1</span>
<span style="color: #339933;">#define ide_floppy	0x0</span>
&nbsp;
<span style="color: #993333;">typedef</span> <span style="color: #993333;">union</span> <span style="color: #009900;">{</span>
	<span style="color: #993333;">unsigned</span> all			<span style="color: #339933;">:</span> <span style="color: #0000dd;">8</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* all of the bits together */</span>
	<span style="color: #993333;">struct</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">unsigned</span> set_geometry	<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* respecify drive geometry */</span>
		<span style="color: #993333;">unsigned</span> recalibrate	<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* seek to cyl 0      */</span>
		<span style="color: #993333;">unsigned</span> set_multmode	<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* set multmode count */</span>
		<span style="color: #993333;">unsigned</span> set_tune	<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* tune interface for drive */</span>
		<span style="color: #993333;">unsigned</span> reserved	<span style="color: #339933;">:</span> <span style="color: #0000dd;">4</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* unused */</span>
	<span style="color: #009900;">}</span> b<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span> special_t<span style="color: #339933;">;</span>
&nbsp;
<span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span> ide_drive_s <span style="color: #009900;">{</span>
<span style="color: #808080; font-style: italic;">/*
 *用于存储请求操作队列的队列头
 */</span>
	request_queue_t		 queue<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* request queue */</span>
	<span style="color: #993333;">struct</span> ide_drive_s 	<span style="color: #339933;">*</span>next<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* circular list of hwgroup drives */</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> sleep<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* sleep until this time */</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> service_start<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* time we started last request */</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> service_time<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* service time of last request */</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> timeout<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* max time to wait for irq */</span>
	special_t	special<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* special action flags */</span>
	byte     keep_settings<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* restore settings after drive reset */</span>
	byte     using_dma<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* disk is using dma for read/write */</span>
	byte     waiting_for_dma<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* dma currently in progress */</span>
	byte     unmask<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* flag: okay to unmask other irqs */</span>
	byte     slow<span style="color: #339933;">;</span>			<span style="color: #808080; font-style: italic;">/* flag: slow data port */</span>
	byte     bswap<span style="color: #339933;">;</span>			<span style="color: #808080; font-style: italic;">/* flag: byte swap data */</span>
	byte     dsc_overlap<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* flag: DSC overlap */</span>
	byte     nice1<span style="color: #339933;">;</span>			<span style="color: #808080; font-style: italic;">/* flag: give potential excess bandwidth */</span>
	<span style="color: #993333;">unsigned</span> present	<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* drive is physically present */</span>
	<span style="color: #993333;">unsigned</span> noprobe 	<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* from:  hdx=noprobe */</span>
	<span style="color: #993333;">unsigned</span> busy		<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* currently doing revalidate_disk() */</span>
	<span style="color: #993333;">unsigned</span> removable	<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* 1 if need to do check_media_change */</span>
	<span style="color: #993333;">unsigned</span> forced_geom	<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* 1 if hdx=c,h,s was given at boot */</span>
	<span style="color: #993333;">unsigned</span> no_unmask	<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* disallow setting unmask bit */</span>
	<span style="color: #993333;">unsigned</span> no_io_32bit	<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* disallow enabling 32bit I/O */</span>
	<span style="color: #993333;">unsigned</span> nobios		<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* flag: do not probe bios for drive */</span>
	<span style="color: #993333;">unsigned</span> revalidate	<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* request revalidation */</span>
	<span style="color: #993333;">unsigned</span> atapi_overlap	<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* flag: ATAPI overlap (not supported) */</span>
	<span style="color: #993333;">unsigned</span> nice0		<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* flag: give obvious excess bandwidth */</span>
	<span style="color: #993333;">unsigned</span> nice2		<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* flag: give a share in our own bandwidth */</span>
	<span style="color: #993333;">unsigned</span> doorlocking	<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* flag: for removable only: door lock/unlock works */</span>
	<span style="color: #993333;">unsigned</span> autotune	<span style="color: #339933;">:</span> <span style="color: #0000dd;">2</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* 1=autotune, 2=noautotune, 0=default */</span>
	<span style="color: #993333;">unsigned</span> remap_0_to_1	<span style="color: #339933;">:</span> <span style="color: #0000dd;">2</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* 0=remap if ezdrive, 1=remap, 2=noremap */</span>
	<span style="color: #993333;">unsigned</span> ata_flash	<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* 1=present, 0=default */</span>
	byte		scsi<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* 0=default, 1=skip current ide-subdriver for ide-scsi emulation */</span>
	byte		media<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* disk, cdrom, tape, floppy, ... */</span>
	select_t	select<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* basic drive/head select reg value */</span>
	byte		ctl<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* "normal" value for IDE_CONTROL_REG */</span>
	byte		ready_stat<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* min status value for drive ready */</span>
	byte		mult_count<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* current multiple sector setting */</span>
	byte 		mult_req<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* requested multiple sector setting */</span>
	byte 		tune_req<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* requested drive tuning setting */</span>
	byte		io_32bit<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* 0=16-bit, 1=32-bit, 2/3=32bit+sync */</span>
	byte		bad_wstat<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* used for ignoring WRERR_STAT */</span>
	byte		nowerr<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* used for ignoring WRERR_STAT */</span>
	byte		sect0<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* offset of first sector for DM6:DDO */</span>
	byte 		usage<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* current "open()" count for drive */</span>
	byte 		head<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* "real" number of heads */</span>
	byte		sect<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* "real" sectors per track */</span>
	byte		bios_head<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* BIOS/fdisk/LILO number of heads */</span>
	byte		bios_sect<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* BIOS/fdisk/LILO sectors per track */</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span>	bios_cyl<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* BIOS/fdisk/LILO number of cyls */</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span>	cyl<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* "real" number of cyls */</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span>	capacity<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* total number of sectors */</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span>	drive_data<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* for use by tuneproc/selectproc as needed */</span>
	<span style="color: #993333;">void</span>		  <span style="color: #339933;">*</span>hwif<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* actually (ide_hwif_t *) */</span>
	wait_queue_head_t wqueue<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* used to wait for drive in open() */</span>
	<span style="color: #993333;">struct</span> hd_driveid <span style="color: #339933;">*</span>id<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* drive model identification info */</span>
	<span style="color: #993333;">struct</span> hd_struct  <span style="color: #339933;">*</span>part<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* drive partition table */</span>
	<span style="color: #993333;">char</span>		name<span style="color: #009900;">[</span><span style="color: #0000dd;">4</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* drive name, such as "hda" */</span>
<span style="color: #808080; font-style: italic;">/*
 *driver是具体块设备的驱动函数跳转表
 */</span>
	<span style="color: #993333;">void</span> 		<span style="color: #339933;">*</span>driver<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* (ide_driver_t *) */</span>
	<span style="color: #993333;">void</span>		<span style="color: #339933;">*</span>driver_data<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* extra driver data */</span>
	devfs_handle_t	de<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* directory for device */</span>
	<span style="color: #993333;">struct</span> proc_dir_entry <span style="color: #339933;">*</span>proc<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* /proc/ide/ directory entry */</span>
	<span style="color: #993333;">void</span>		<span style="color: #339933;">*</span>settings<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* /proc/ide/ drive settings */</span>
	<span style="color: #993333;">char</span>		driver_req<span style="color: #009900;">[</span><span style="color: #0000dd;">10</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* requests specific driver */</span>
	<span style="color: #993333;">int</span>		last_lun<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* last logical unit */</span>
	<span style="color: #993333;">int</span>		forced_lun<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* if hdxlun was given at boot */</span>
	<span style="color: #993333;">int</span>		lun<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* logical unit */</span>
	<span style="color: #993333;">int</span>		crc_count<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* crc counter to reduce drive speed */</span>
	byte		quirk_list<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* drive is considered quirky if set for a specific host */</span>
	byte		suspend_reset<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* drive suspend mode flag, soft-reset recovers */</span>
	byte		init_speed<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* transfer rate set at boot */</span>
	byte		current_speed<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* current transfer rate set */</span>
	byte		dn<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* now wide spread use */</span>
<span style="color: #009900;">}</span> ide_drive_t<span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>需要说明的是在PC机上可以有两个IDE插口，分别为主、次两个接口，每个IDE接口又可以支持主、从两个IDE硬盘，每个IDE硬盘由一个ide_drive_t数据结构代表，每个IDE接口由一个ide_hwif_t数据结构代表，这个结构定义在include/linux/ide.h中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=780&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7807"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre></td> 
             <td class="code" id="p780code7"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span> hwif_s <span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> hwif_s	<span style="color: #339933;">*</span>next<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* for linked-list in ide_hwgroup_t */</span>
	<span style="color: #993333;">void</span>		<span style="color: #339933;">*</span>hwgroup<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* actually (ide_hwgroup_t *) */</span>
	ide_ioreg_t	io_ports<span style="color: #009900;">[</span>IDE_NR_PORTS<span style="color: #009900;">]</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* task file registers */</span>
	hw_regs_t	hw<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* Hardware info */</span>
	ide_drive_t	drives<span style="color: #009900;">[</span>MAX_DRIVES<span style="color: #009900;">]</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* drive info */</span>
	<span style="color: #993333;">struct</span> gendisk	<span style="color: #339933;">*</span>gd<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* gendisk structure */</span>
	ide_tuneproc_t	<span style="color: #339933;">*</span>tuneproc<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* routine to tune PIO mode for drives */</span>
	ide_speedproc_t	<span style="color: #339933;">*</span>speedproc<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* routine to retune DMA modes for drives */</span>
	ide_selectproc_t <span style="color: #339933;">*</span>selectproc<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* tweaks hardware to select drive */</span>
	ide_resetproc_t	<span style="color: #339933;">*</span>resetproc<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* routine to reset controller after a disk reset */</span>
	ide_intrproc_t	<span style="color: #339933;">*</span>intrproc<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* special interrupt handling for shared pci interrupts */</span>
	ide_maskproc_t	<span style="color: #339933;">*</span>maskproc<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* special host masking for drive selection */</span>
	ide_quirkproc_t	<span style="color: #339933;">*</span>quirkproc<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* check host's drive quirk list */</span>
	ide_rw_proc_t	<span style="color: #339933;">*</span>rwproc<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* adjust timing based upon rq-&gt;cmd direction */</span>
	ide_dmaproc_t	<span style="color: #339933;">*</span>dmaproc<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* dma read/write/abort routine */</span>
<span style="color: #808080; font-style: italic;">/*
 *下面两个字段指向同一个用于DMA区间表的页面
 *dmatable_cpu是从CPU看来的地址，是虚拟地址
 *dmatable_dma是物理地址
 */</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span>	<span style="color: #339933;">*</span>dmatable_cpu<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* dma physical region descriptor table (cpu view) */</span>
	dma_addr_t	dmatable_dma<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* dma physical region descriptor table (dma view) */</span>
<span style="color: #808080; font-style: italic;">/*
 *sg_table指向scatterlist数组，数组中的每个成员指向一个用于DMA操作的
 *缓冲区间，包括其起始（虚拟）地址与长度
 */</span>
	<span style="color: #993333;">struct</span> scatterlist <span style="color: #339933;">*</span>sg_table<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Scatter-gather list used to build the above */</span>
	<span style="color: #993333;">int</span> sg_nents<span style="color: #339933;">;</span>			<span style="color: #808080; font-style: italic;">/* Current number of entries in it */</span>
	<span style="color: #993333;">int</span> sg_dma_direction<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* dma transfer direction */</span>
	<span style="color: #993333;">struct</span> hwif_s	<span style="color: #339933;">*</span>mate<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* other hwif from same PCI chip */</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span>	dma_base<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* base addr for dma ports */</span>
	<span style="color: #993333;">unsigned</span>	dma_extra<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* extra addr for dma ports */</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span>	config_data<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* for use by chipset-specific code */</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span>	select_data<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* for use by chipset-specific code */</span>
	<span style="color: #993333;">struct</span> proc_dir_entry <span style="color: #339933;">*</span>proc<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* /proc/ide/ directory entry */</span>
	<span style="color: #993333;">int</span>		irq<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* our irq number */</span>
	byte		major<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* our major number */</span>
	<span style="color: #993333;">char</span> 		name<span style="color: #009900;">[</span><span style="color: #0000dd;">6</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* name of interface, eg. "ide0" */</span>
	byte		index<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* 0 for ide0; 1 for ide1; ... */</span>
	hwif_chipset_t	chipset<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* sub-module for tuning.. */</span>
	<span style="color: #993333;">unsigned</span>	noprobe    <span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* don't probe for this interface */</span>
	<span style="color: #993333;">unsigned</span>	present    <span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* this interface exists */</span>
	<span style="color: #993333;">unsigned</span>	serialized <span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* serialized operation with mate hwif */</span>
	<span style="color: #993333;">unsigned</span>	sharing_irq<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* 1 = sharing irq with another hwif */</span>
	<span style="color: #993333;">unsigned</span>	reset      <span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* reset after probe */</span>
	<span style="color: #993333;">unsigned</span>	autodma    <span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* automatically try to enable DMA at boot */</span>
	<span style="color: #993333;">unsigned</span>	udma_four  <span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* 1=ATA-66 capable, 0=default */</span>
	byte		channel<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* for dual-port chips: 0=primary, 1=secondary */</span>
<span style="color: #339933;">#ifdef CONFIG_BLK_DEV_IDEPCI</span>
	<span style="color: #993333;">struct</span> pci_dev	<span style="color: #339933;">*</span>pci_dev<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* for pci chipsets */</span>
	ide_pci_devid_t	pci_devid<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* for pci chipsets: {VID,DID} */</span>
<span style="color: #339933;">#endif /* CONFIG_BLK_DEV_IDEPCI */</span>
<span style="color: #339933;">#if (DISK_RECOVERY_TIME &gt; 0)</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span>	last_time<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* time when previous rq was done */</span>
<span style="color: #339933;">#endif</span>
	byte		straight8<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Alan's straight 8 check */</span>
	<span style="color: #993333;">void</span>		<span style="color: #339933;">*</span>hwif_data<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* extra hwif data */</span>
<span style="color: #009900;">}</span> ide_hwif_t<span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>在内核中有个ide_hwifs[]数组，每个数组都是一个ide_hwif_t数据结构，代表着系统中的一个可能的IDE接口，如果系统初始化的时候检测到一个IDE接口，就把相应的表项中的present字段设置成1，同时在ide_hwif_t结构中有个ide_drive_t结构的数组drives[]，初始化的时候如果检测到某个接口上有IDE硬盘连接，那么就把这个结构的present也置1并设置其数据结构。也就是说，ide_hwif_t结构是对IDE接口的描述，而ide_drive_t结构是对具体接口上的IDE设备的描述。</p> 
         <p>在同一文件中还有个数据结构ide_driver_t：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=780&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7808"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td> 
             <td class="code" id="p780code8"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">typedef</span> <span style="color: #993333;">int</span>		<span style="color: #009900;">(</span>ide_cleanup_proc<span style="color: #009900;">)</span><span style="color: #009900;">(</span>ide_drive_t <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #993333;">typedef</span> ide_startstop_t	<span style="color: #009900;">(</span>ide_do_request_proc<span style="color: #009900;">)</span><span style="color: #009900;">(</span>ide_drive_t <span style="color: #339933;">*,</span> <span style="color: #993333;">struct</span> request <span style="color: #339933;">*,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #993333;">typedef</span> <span style="color: #993333;">void</span>		<span style="color: #009900;">(</span>ide_end_request_proc<span style="color: #009900;">)</span><span style="color: #009900;">(</span>byte<span style="color: #339933;">,</span> ide_hwgroup_t <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #993333;">typedef</span> <span style="color: #993333;">int</span>		<span style="color: #009900;">(</span>ide_ioctl_proc<span style="color: #009900;">)</span><span style="color: #009900;">(</span>ide_drive_t <span style="color: #339933;">*,</span> <span style="color: #993333;">struct</span> inode <span style="color: #339933;">*,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span><span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #993333;">typedef</span> <span style="color: #993333;">int</span>		<span style="color: #009900;">(</span>ide_open_proc<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> inode <span style="color: #339933;">*,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*,</span> ide_drive_t <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #993333;">typedef</span> <span style="color: #993333;">void</span>		<span style="color: #009900;">(</span>ide_release_proc<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> inode <span style="color: #339933;">*,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*,</span> ide_drive_t <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #993333;">typedef</span> <span style="color: #993333;">int</span>		<span style="color: #009900;">(</span>ide_check_media_change_proc<span style="color: #009900;">)</span><span style="color: #009900;">(</span>ide_drive_t <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #993333;">typedef</span> <span style="color: #993333;">void</span>		<span style="color: #009900;">(</span>ide_revalidate_proc<span style="color: #009900;">)</span><span style="color: #009900;">(</span>ide_drive_t <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #993333;">typedef</span> <span style="color: #993333;">void</span>		<span style="color: #009900;">(</span>ide_pre_reset_proc<span style="color: #009900;">)</span><span style="color: #009900;">(</span>ide_drive_t <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #993333;">typedef</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span>	<span style="color: #009900;">(</span>ide_capacity_proc<span style="color: #009900;">)</span><span style="color: #009900;">(</span>ide_drive_t <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #993333;">typedef</span> ide_startstop_t	<span style="color: #009900;">(</span>ide_special_proc<span style="color: #009900;">)</span><span style="color: #009900;">(</span>ide_drive_t <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #993333;">typedef</span> <span style="color: #993333;">void</span>		<span style="color: #009900;">(</span>ide_setting_proc<span style="color: #009900;">)</span><span style="color: #009900;">(</span>ide_drive_t <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span> ide_driver_s <span style="color: #009900;">{</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">char</span>			<span style="color: #339933;">*</span>name<span style="color: #339933;">;</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">char</span>			<span style="color: #339933;">*</span>version<span style="color: #339933;">;</span>
	byte				media<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> busy			<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> supports_dma		<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> supports_dsc_overlap	<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	ide_cleanup_proc		<span style="color: #339933;">*</span>cleanup<span style="color: #339933;">;</span>
	ide_do_request_proc		<span style="color: #339933;">*</span>do_request<span style="color: #339933;">;</span>
	ide_end_request_proc		<span style="color: #339933;">*</span>end_request<span style="color: #339933;">;</span>
	ide_ioctl_proc			<span style="color: #339933;">*</span>ioctl<span style="color: #339933;">;</span>
	ide_open_proc			<span style="color: #339933;">*</span>open<span style="color: #339933;">;</span>
	ide_release_proc		<span style="color: #339933;">*</span>release<span style="color: #339933;">;</span>
	ide_check_media_change_proc	<span style="color: #339933;">*</span>media_change<span style="color: #339933;">;</span>
	ide_revalidate_proc		<span style="color: #339933;">*</span>revalidate<span style="color: #339933;">;</span>
	ide_pre_reset_proc		<span style="color: #339933;">*</span>pre_reset<span style="color: #339933;">;</span>
	ide_capacity_proc		<span style="color: #339933;">*</span>capacity<span style="color: #339933;">;</span>
	ide_special_proc		<span style="color: #339933;">*</span>special<span style="color: #339933;">;</span>
	ide_proc_entry_t		<span style="color: #339933;">*</span>proc<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span> ide_driver_t<span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>在数据结构ide_drive_t中有个void类型的指针指向这个数据结构，这个数据结构表示的是具体的设备类型及其操作，例如对于IDE硬盘，它就是idedisk_driver，而对于cdrom它就是ide_cdrom_driver，硬盘的idedisk_driver定义在ide-disk.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=780&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7809"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td> 
             <td class="code" id="p780code9"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 *	IDE subdriver functions, registered with ide.c
 */</span>
<span style="color: #993333;">static</span> ide_driver_t idedisk_driver <span style="color: #339933;">=</span> <span style="color: #009900;">{</span>
	<span style="color: #ff0000;">"ide-disk"</span><span style="color: #339933;">,</span>		<span style="color: #808080; font-style: italic;">/* name */</span>
	IDEDISK_VERSION<span style="color: #339933;">,</span>	<span style="color: #808080; font-style: italic;">/* version */</span>
	ide_disk<span style="color: #339933;">,</span>		<span style="color: #808080; font-style: italic;">/* media */</span>
	<span style="color: #0000dd;">0</span><span style="color: #339933;">,</span>			<span style="color: #808080; font-style: italic;">/* busy */</span>
	<span style="color: #0000dd;">1</span><span style="color: #339933;">,</span>			<span style="color: #808080; font-style: italic;">/* supports_dma */</span>
	<span style="color: #0000dd;">0</span><span style="color: #339933;">,</span>			<span style="color: #808080; font-style: italic;">/* supports_dsc_overlap */</span>
	NULL<span style="color: #339933;">,</span>			<span style="color: #808080; font-style: italic;">/* cleanup */</span>
	do_rw_disk<span style="color: #339933;">,</span>		<span style="color: #808080; font-style: italic;">/* do_request */</span>
	NULL<span style="color: #339933;">,</span>			<span style="color: #808080; font-style: italic;">/* end_request */</span>
	NULL<span style="color: #339933;">,</span>			<span style="color: #808080; font-style: italic;">/* ioctl */</span>
	idedisk_open<span style="color: #339933;">,</span>		<span style="color: #808080; font-style: italic;">/* open */</span>
	idedisk_release<span style="color: #339933;">,</span>	<span style="color: #808080; font-style: italic;">/* release */</span>
	idedisk_media_change<span style="color: #339933;">,</span>	<span style="color: #808080; font-style: italic;">/* media_change */</span>
	idedisk_revalidate<span style="color: #339933;">,</span>	<span style="color: #808080; font-style: italic;">/* revalidate */</span>
	idedisk_pre_reset<span style="color: #339933;">,</span>	<span style="color: #808080; font-style: italic;">/* pre_reset */</span>
	idedisk_capacity<span style="color: #339933;">,</span>	<span style="color: #808080; font-style: italic;">/* capacity */</span>
	idedisk_special<span style="color: #339933;">,</span>	<span style="color: #808080; font-style: italic;">/* special */</span>
	idedisk_proc		<span style="color: #808080; font-style: italic;">/* proc */</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>对于以上的数据结构，在毛老先生的书上给出了如下解释：</p> 
         <p>（1）：file_operations结构使vfs具体化成了特定的文件系统或者文件类型（块设备文件）</p> 
         <p>（2）：block_device数据结构使代表着抽象意义的文件的inode结构具体化成了“块设备”</p> 
         <p>（3）：block_device_operations结构使“块设备文件”操作进一步具体化成了“IDE设备”操作</p> 
         <p>（4）：ide_drive_t结构将笼统的“IDE设备”具体化成了特定种类的IDE设备</p> 
         <p>（5）：ide_driver_t结构将某种IDE设备的操作具体化成对特定IDE硬盘的操作</p> 
         <p>毛老先生的解释非常透彻，我就不多说了。</p> 
         <p>对于块设备来说，每一个块设备都有一个操作请求队列（至于为什么，这里就不多说了，相信学过操作系统的人都知道）。队列的头部是一个request_queue_t数据结构，相信心细的人也看见了，在前面的ide_drive_t数据结构中也有一个request_queue_t类型的字段queue。这个数据结构定义在include/linux/blkdev.h中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=780&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78010"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre></td> 
             <td class="code" id="p780code10"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">typedef</span> <span style="color: #993333;">int</span> <span style="color: #009900;">(</span>merge_request_fn<span style="color: #009900;">)</span> <span style="color: #009900;">(</span>request_queue_t <span style="color: #339933;">*</span>q<span style="color: #339933;">,</span> 
				<span style="color: #993333;">struct</span> request  <span style="color: #339933;">*</span>req<span style="color: #339933;">,</span>
				<span style="color: #993333;">struct</span> buffer_head <span style="color: #339933;">*</span>bh<span style="color: #339933;">,</span>
				<span style="color: #993333;">int</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #993333;">typedef</span> <span style="color: #993333;">int</span> <span style="color: #009900;">(</span>merge_requests_fn<span style="color: #009900;">)</span> <span style="color: #009900;">(</span>request_queue_t <span style="color: #339933;">*</span>q<span style="color: #339933;">,</span> 
				 <span style="color: #993333;">struct</span> request  <span style="color: #339933;">*</span>req<span style="color: #339933;">,</span>
				 <span style="color: #993333;">struct</span> request  <span style="color: #339933;">*</span>req2<span style="color: #339933;">,</span>
				 <span style="color: #993333;">int</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #993333;">typedef</span> <span style="color: #993333;">void</span> <span style="color: #009900;">(</span>request_fn_proc<span style="color: #009900;">)</span> <span style="color: #009900;">(</span>request_queue_t <span style="color: #339933;">*</span>q<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #993333;">typedef</span> request_queue_t <span style="color: #339933;">*</span> <span style="color: #009900;">(</span>queue_proc<span style="color: #009900;">)</span> <span style="color: #009900;">(</span>kdev_t dev<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #993333;">typedef</span> <span style="color: #993333;">int</span> <span style="color: #009900;">(</span>make_request_fn<span style="color: #009900;">)</span> <span style="color: #009900;">(</span>request_queue_t <span style="color: #339933;">*</span>q<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> rw<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> buffer_head <span style="color: #339933;">*</span>bh<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #993333;">typedef</span> <span style="color: #993333;">void</span> <span style="color: #009900;">(</span>plug_device_fn<span style="color: #009900;">)</span> <span style="color: #009900;">(</span>request_queue_t <span style="color: #339933;">*</span>q<span style="color: #339933;">,</span> kdev_t device<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #993333;">typedef</span> <span style="color: #993333;">void</span> <span style="color: #009900;">(</span>unplug_device_fn<span style="color: #009900;">)</span> <span style="color: #009900;">(</span><span style="color: #993333;">void</span> <span style="color: #339933;">*</span>q<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 * Default nr free requests per queue
 */</span>
<span style="color: #339933;">#define QUEUE_NR_REQUESTS	256</span>
&nbsp;
<span style="color: #993333;">struct</span> request_queue
<span style="color: #009900;">{</span>
	<span style="color: #808080; font-style: italic;">/*
	 * the queue request freelist, one for reads and one for writes
	 */</span>
	<span style="color: #993333;">struct</span> list_head	request_freelist<span style="color: #009900;">[</span><span style="color: #0000dd;">2</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * Together with queue_head for cacheline sharing
	 */</span>
	<span style="color: #993333;">struct</span> list_head	queue_head<span style="color: #339933;">;</span>
	elevator_t		elevator<span style="color: #339933;">;</span>
&nbsp;
	request_fn_proc		<span style="color: #339933;">*</span> request_fn<span style="color: #339933;">;</span>
	merge_request_fn	<span style="color: #339933;">*</span> back_merge_fn<span style="color: #339933;">;</span>
	merge_request_fn	<span style="color: #339933;">*</span> front_merge_fn<span style="color: #339933;">;</span>
	merge_requests_fn	<span style="color: #339933;">*</span> merge_requests_fn<span style="color: #339933;">;</span>
	make_request_fn		<span style="color: #339933;">*</span> make_request_fn<span style="color: #339933;">;</span>
	plug_device_fn		<span style="color: #339933;">*</span> plug_device_fn<span style="color: #339933;">;</span>
	<span style="color: #808080; font-style: italic;">/*
	 * The queue owner gets to use this for whatever they like.
	 * ll_rw_blk doesn't touch it.
	 */</span>
	<span style="color: #993333;">void</span>			<span style="color: #339933;">*</span> queuedata<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * This is used to remove the plug when tq_disk runs.
 *这个字段是用来将请求链入程序后半部（bh）执行任务队列tq_disk
	 */</span>
	<span style="color: #993333;">struct</span> tq_struct	plug_tq<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * Boolean that indicates whether this queue is plugged or not.
	 */</span>
	<span style="color: #993333;">char</span>			plugged<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * Boolean that indicates whether current_request is active or
	 * not.
	 */</span>
	<span style="color: #993333;">char</span>			head_active<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * Is meant to protect the queue in the future instead of
	 * io_request_lock
	 */</span>
	spinlock_t		request_lock<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * Tasks wait here for free request
	 */</span>
	wait_queue_head_t	wait_for_request<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span>
<span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span> request_queue request_queue_t<span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>还有一个数据结构blk_dev_struct，主体就是request_queue，定义在include/linux/blkdev.h中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=780&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78011"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
</pre></td> 
             <td class="code" id="p780code11"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> blk_dev_struct <span style="color: #009900;">{</span>
	<span style="color: #808080; font-style: italic;">/*
	 * queue_proc has to be atomic
	 */</span>
	request_queue_t		request_queue<span style="color: #339933;">;</span>
	queue_proc		<span style="color: #339933;">*</span>queue<span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span>			<span style="color: #339933;">*</span>data<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>主体中还有一个queue函数指针，当这个指针为非空的时候就调用这个函数指针来寻找ide_drive_t中的queue字段，否则就使用这个结构中的request_queue字段，data用来提供一些辅助信息用来帮助找到请求队列。</p> 
         <p>为了把各个块设备的操作请求队列有效地组织起来，内核中有个以主设备号为下标的结构数组blk_dev[]，在driver/block/ll_rw_blk.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=780&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78012"> 
             <td class="line_numbers"><pre>1
2
3
4
5
</pre></td> 
             <td class="code" id="p780code12"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/* blk_dev_struct is:
 *	*request_fn
 *	*current_request
 */</span>
<span style="color: #993333;">struct</span> blk_dev_struct blk_dev<span style="color: #009900;">[</span>MAX_BLKDEV<span style="color: #009900;">]</span><span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* initialized by blk_dev_init() */</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>在request_queue_t结构中有个elevator字段，此字段是一个elevator_t结构的字段，用来存储电梯调度的各个函数指针等，这个数据结构定义于include/linux/elevator.h和include/linux/blkdev.h中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=780&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78013"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td> 
             <td class="code" id="p780code13"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> elevator_s
<span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span> sequence<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #993333;">int</span> read_latency<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> write_latency<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> max_bomb_segments<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> nr_segments<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> read_pendings<span style="color: #339933;">;</span>
&nbsp;
	elevator_fn <span style="color: #339933;">*</span> elevator_fn<span style="color: #339933;">;</span>
	elevator_merge_fn <span style="color: #339933;">*</span>elevator_merge_fn<span style="color: #339933;">;</span>
	elevator_dequeue_fn <span style="color: #339933;">*</span>dequeue_fn<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> queue_ID<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span>
<span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span> elevator_s elevator_t<span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>在request_queue_t结构中还有个字段queue_head，这个字段保存的是具体的请求队列。</p> 
         <p>每一个具体的请求都由一个request数据结构代表，这个数据结构定义在include/linux/blkdev.h中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=780&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78014"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td> 
             <td class="code" id="p780code14"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> request <span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> list_head queue<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> elevator_sequence<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> list_head table<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #993333;">struct</span> list_head <span style="color: #339933;">*</span>free_list<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #993333;">volatile</span> <span style="color: #993333;">int</span> rq_status<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* should split this into a few status bits */</span>
<span style="color: #339933;">#define RQ_INACTIVE		(-1)</span>
<span style="color: #339933;">#define RQ_ACTIVE		1</span>
<span style="color: #339933;">#define RQ_SCSI_BUSY		0xffff</span>
<span style="color: #339933;">#define RQ_SCSI_DONE		0xfffe</span>
<span style="color: #339933;">#define RQ_SCSI_DISCONNECTING	0xffe0</span>
&nbsp;
	kdev_t rq_dev<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> cmd<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* READ or WRITE */</span>
	<span style="color: #993333;">int</span> errors<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> sector<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> nr_sectors<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> hard_sector<span style="color: #339933;">,</span> hard_nr_sectors<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> nr_segments<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> nr_hw_segments<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> current_nr_sectors<span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span> <span style="color: #339933;">*</span> special<span style="color: #339933;">;</span>
	<span style="color: #993333;">char</span> <span style="color: #339933;">*</span> buffer<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> semaphore <span style="color: #339933;">*</span> sem<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> buffer_head <span style="color: #339933;">*</span> bh<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> buffer_head <span style="color: #339933;">*</span> bhtail<span style="color: #339933;">;</span>
	request_queue_t <span style="color: #339933;">*</span>q<span style="color: #339933;">;</span>
	elevator_t <span style="color: #339933;">*</span>e<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>在request_queue_t结构中，还有一个void指针queuedata，这个指针可以根据具体的设备的不同而指向不同的对象，对于IDE接口，这个指针指向一个ide_hwgroup_t数据结构，定义在include/linux/ide.h中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=780&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78015"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td> 
             <td class="code" id="p780code15"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span> hwgroup_s <span style="color: #009900;">{</span>
	ide_handler_t		<span style="color: #339933;">*</span>handler<span style="color: #339933;">;</span><span style="color: #808080; font-style: italic;">/* irq handler, if active */</span>
	<span style="color: #993333;">volatile</span> <span style="color: #993333;">int</span>		busy<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* BOOL: protects all fields below */</span>
	<span style="color: #993333;">int</span>			sleeping<span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* BOOL: wake us up on timer expiry */</span>
	ide_drive_t		<span style="color: #339933;">*</span>drive<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* current drive */</span>
	ide_hwif_t		<span style="color: #339933;">*</span>hwif<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* ptr to current hwif in linked-list */</span>
	<span style="color: #993333;">struct</span> request		<span style="color: #339933;">*</span>rq<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* current request */</span>
	<span style="color: #993333;">struct</span> timer_list	timer<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* failsafe timer */</span>
	<span style="color: #993333;">struct</span> request		wrq<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* local copy of current write rq */</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span>		poll_timeout<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* timeout value during long polls */</span>
	ide_expiry_t		<span style="color: #339933;">*</span>expiry<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* queried upon timeouts */</span>
<span style="color: #009900;">}</span> ide_hwgroup_t<span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>这个数据结构代表着一个“硬件组”，实际上代表着一组IDE接口，对属于同一组的IDE接口不能同时操作。</p> 
         <p>具体关系如下：</p> 
         <p>·每个ide_hwgroup_t数据结构代表一组不能同时操作的IDE接口</p> 
         <p>·每个ide_hwif_t数据结构代表着一个具体的IDE接口，其中有一个ide_drive_t数组</p> 
         <p>·每个ide_drive_t数据结构代表着一个具体的IDE设备</p> 
         <p>每个IDE设备即ide_drive_t数据结构都有自己的请求队列，但是整个IDE接口组只能有一个“当前操作请求”，所以在ide_hwgroup_t中的字段都是指向当前操作的设备和请求的。</p> 
         <p>这里给出前面的数据结构关系图如下：</p> 
         <p><a href="http://codelifeliwan.github.io/?attachment_id=782" rel="attachment wp-att-782"><img class="aligncenter size-full wp-image-782" alt="2" src="uploads/2013/01/21.jpg" width="950" height="330"></a></p> 
         <p>设置硬盘的“驱动器/磁头选择寄存器”的这个8位寄存器格式如下：</p> 
         <p><a href="http://codelifeliwan.github.io/?attachment_id=781" rel="attachment wp-att-781"><img class="aligncenter size-full wp-image-781" alt="1" src="uploads/2013/01/12.jpg" width="658" height="169"></a></p> 
         <p>在内核中有个数据结构来表示，定义于include/asm-i386/ide.h中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=780&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78016"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td> 
             <td class="code" id="p780code16"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">typedef</span> <span style="color: #993333;">union</span> <span style="color: #009900;">{</span>
	<span style="color: #993333;">unsigned</span> all			<span style="color: #339933;">:</span> <span style="color: #0000dd;">8</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* all of the bits together */</span>
	<span style="color: #993333;">struct</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">unsigned</span> head		<span style="color: #339933;">:</span> <span style="color: #0000dd;">4</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* always zeros here */</span>
		<span style="color: #993333;">unsigned</span> unit		<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* drive select number, 0 or 1 */</span>
		<span style="color: #993333;">unsigned</span> bit5		<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* always 1 */</span>
		<span style="color: #993333;">unsigned</span> lba		<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* using LBA instead of CHS */</span>
		<span style="color: #993333;">unsigned</span> bit7		<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* always 1 */</span>
	<span style="color: #009900;">}</span> b<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span> select_t<span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>对于IDE硬盘上的扇区有两种不同的寻址方式，第一种是CHS（柱面/磁头/扇区）模式，由于寄存器中只有4位用于磁头，所以理论上最多只能有16个磁头，同时另外两个用于柱面号的寄存器又将柱面数限制到1024，而扇区号寄存器又将扇区数限制在256，实际上只能划分64个扇区，这样的话IDE磁盘总容量就被限制在0.5GB以内。所以又有了LBA（逻辑块号）模式，将整个磁盘看作连续的逻辑扇区阵列，而由IDE磁盘自己进行从逻辑扇区号到柱面、磁头、扇区的转换，这样，由原来的两个用于柱面号的寄存器，加上原来用于扇区号的寄存器，再加上原来用于磁头号的4位，则共有28位用于逻辑扇区号，理论存储容量达到128GB（当然，现在的更大）。在上面寄存器中第6位表示使用哪种模式。</p> 
         <p>对于有些IDE设备有些特殊的操作，在ide_drive_t中有一个special_t类型字段special，定义在include/linux/ide.h中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=780&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78017"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td> 
             <td class="code" id="p780code17"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">typedef</span> <span style="color: #993333;">union</span> <span style="color: #009900;">{</span>
	<span style="color: #993333;">unsigned</span> all			<span style="color: #339933;">:</span> <span style="color: #0000dd;">8</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* all of the bits together */</span>
	<span style="color: #993333;">struct</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">unsigned</span> set_geometry	<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* respecify drive geometry */</span>
		<span style="color: #993333;">unsigned</span> recalibrate	<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* seek to cyl 0      */</span>
		<span style="color: #993333;">unsigned</span> set_multmode	<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* set multmode count */</span>
		<span style="color: #993333;">unsigned</span> set_tune	<span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* tune interface for drive */</span>
		<span style="color: #993333;">unsigned</span> reserved	<span style="color: #339933;">:</span> <span style="color: #0000dd;">4</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* unused */</span>
	<span style="color: #009900;">}</span> b<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span> special_t<span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>&nbsp;</p> 
        </div>
       </div>
       <!-- .entry-content --> 
       <!-- .entry-meta --> 
      </article>
      <!-- #post-780 --> 
      <!-- #comments --> 
     </div>
     <!-- #content --> 
    </div>
    <!-- #primary --> 
    <!-- #secondary .widget-area --> 
   </div>
   <!-- #main --> 
   <!-- #colophon --> 
  </div>
  <!-- #page -->   
  <!-- JiaThis Button BEGIN -->  
  <!-- JiaThis Button END -->   
 </body>
</html>