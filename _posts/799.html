<!doctype html>
<!--[if IE 6]>
<html id="ie6" lang="zh-CN">
<![endif]-->
<!--[if IE 7]>
<html id="ie7" lang="zh-CN">
<![endif]-->
<!--[if IE 8]>
<html id="ie8" lang="zh-CN">
<![endif]-->
<!--[if !(IE 6) | !(IE 7) | !(IE 8)  ]><!-->
<html lang="zh-CN">
 <!--<![endif]-->
 <head>      
  <link rel="stylesheet" type="text/css" media="all" href="stylesheets/style.css">     
  <link rel="stylesheet" id="codebox-css" href="stylesheets/codebox.css" type="text/css" media="screen">             
 </head> 
 <body class="single single-post postid-799 single-format-standard content-sidebar"> 
  <div id="page" class="hfeed"> 
   <header id="branding" role="banner"> 
    <hgroup> 
     <h1 id="site-title"><span><a href="http://codelifeliwan.github.io/" title="Code_Life_LiWan" rel="home">Code_Life_LiWan</a></span></h1> 
     <h2 id="site-description">My heart will go on and on…</h2> 
    </hgroup>  
    <!-- #access --> 
   </header>
   <!-- #branding --> 
   <div id="main" class="clearfix"> 
    <div id="primary"> 
     <div id="content" role="main"> 
      <!-- #nav-single --> 
      <article id="post-799" class="post-799 post type-post status-publish format-standard hentry category-linux_kernel_source_code_notes"> 
       <header class="entry-header"> 
        <h1 class="entry-title">Linux内核-设备驱动（九、字符设备驱动操作）</h1> 
        <div class="entry-meta"> 
         <span class="sep">Posted on </span>
         <a href="http://codelifeliwan.github.io/?p=799" title="下午 2:01" rel="bookmark"><time class="entry-date" datetime="2013-02-15T14:01:33+00:00" pubdate>15 二月, 2013</time></a>
         <span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codelifeliwan.github.io/?author=1" title="View all posts by wanli" rel="author">wanli</a></span></span> 
         <span class="sep"> — </span> 
         <span class="comments-link"> <a href="http://codelifeliwan.github.io/?p=799#comments" title="Comment on Linux内核-设备驱动（九、字符设备驱动操作）">1 Comment ↓</a> </span> 
        </div>
        <!-- .entry-meta --> 
       </header>
       <!-- .entry-header --> 
       <div class="entry-content">
        <div class="entry-content"> 
         <p>和前面一样，我们说的字符设备驱动主要指的是终端设备驱动。</p> 
         <p>先从字符设备的打开开始讲，同样，打开需要经过虚拟文件系统然后从file中的file_operations数据结构开始跳转。对于终端设备来说，它的file_operations数据结构如下（drivers/char/tty_io.c）：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7991"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td> 
             <td class="code" id="p799code1"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">struct</span> file_operations tty_fops <span style="color: #339933;">=</span> <span style="color: #009900;">{</span>
	llseek<span style="color: #339933;">:</span>		tty_lseek<span style="color: #339933;">,</span>
	read<span style="color: #339933;">:</span>		tty_read<span style="color: #339933;">,</span>
	write<span style="color: #339933;">:</span>		tty_write<span style="color: #339933;">,</span>
	poll<span style="color: #339933;">:</span>		tty_poll<span style="color: #339933;">,</span>
	ioctl<span style="color: #339933;">:</span>		tty_ioctl<span style="color: #339933;">,</span>
	open<span style="color: #339933;">:</span>		tty_open<span style="color: #339933;">,</span>
	release<span style="color: #339933;">:</span>	tty_release<span style="color: #339933;">,</span>
	fasync<span style="color: #339933;">:</span>		tty_fasync<span style="color: #339933;">,</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <h2>终端设备打开操作：</h2> 
         <p>打开函数是tty_open()，这个函数定义在drivers/char/tty_io.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7992"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
</pre></td> 
             <td class="code" id="p799code2"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * tty_open and tty_release keep up the tty count that contains the
 * number of opens done on a tty. We cannot use the inode-count, as
 * different inodes might point to the same tty.
 *
 * Open-counting is needed for pty masters, as well as for keeping
 * track of serial lines: DTR is dropped when the last close happens.
 * (This is not done solely through tty-&gt;count, now.  - Ted 1/27/92)
 *
 * The termios state of a pty is reset on first open so that
 * settings don't persist across reuse.
 */</span>
<span style="color: #993333;">static</span> <span style="color: #993333;">int</span> tty_open<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span> inode<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span> filp<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> noctty<span style="color: #339933;">,</span> retval<span style="color: #339933;">;</span>
	kdev_t device<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">short</span> saved_flags<span style="color: #339933;">;</span>
	<span style="color: #993333;">char</span>	buf<span style="color: #009900;">[</span><span style="color: #0000dd;">64</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
&nbsp;
	saved_flags <span style="color: #339933;">=</span> filp<span style="color: #339933;">-&gt;</span>f_flags<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//保存标志位</span>
retry_open<span style="color: #339933;">:</span>
	noctty <span style="color: #339933;">=</span> filp<span style="color: #339933;">-&gt;</span>f_flags <span style="color: #339933;">&amp;</span> O_NOCTTY<span style="color: #339933;">;</span>
	device <span style="color: #339933;">=</span> inode<span style="color: #339933;">-&gt;</span>i_rdev<span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *若主设备号为5，次设备号为0则是/dev/tty，就是当前进程的控制终端
 *#define TTY_DEV MKDEV(TTYAUX_MAJOR,0)
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>device <span style="color: #339933;">==</span> TTY_DEV<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>current<span style="color: #339933;">-&gt;</span>tty<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>ENXIO<span style="color: #339933;">;</span>
		device <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>tty<span style="color: #339933;">-&gt;</span>device<span style="color: #339933;">;</span>
		filp<span style="color: #339933;">-&gt;</span>f_flags <span style="color: #339933;">|=</span> O_NONBLOCK<span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* Don't let /dev/tty block */</span>
		<span style="color: #808080; font-style: italic;">/* noctty = 1; */</span>
	<span style="color: #009900;">}</span>
<span style="color: #808080; font-style: italic;">/*
 *此编译选项是对于配备了键盘、显示器等设备的虚拟终端看来说的
 *#define CONSOLE_DEV (TTY_MAJOR,0)
 *#define SYSCONS_DEV (TTYAUX_MAJOR,1)
 */</span>
<span style="color: #339933;">#ifdef CONFIG_VT</span>
<span style="color: #808080; font-style: italic;">/*
 *若主设备号为4而次设备号为0则表示/dev/tty0，也就是当前虚拟控制台
 *就将其替换成具体的设备号，在支持虚拟控制台的内核中有个全局变量fg_console
 *表示当前的“前台控制台”，这个变量的数值是从0开始的，而具体的虚拟控制台
 *编号是从1开始的，所以这里应该加1
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>device <span style="color: #339933;">==</span> CONSOLE_DEV<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #000000; font-weight: bold;">extern</span> <span style="color: #993333;">int</span> fg_console<span style="color: #339933;">;</span>
		device <span style="color: #339933;">=</span> MKDEV<span style="color: #009900;">(</span>TTY_MAJOR<span style="color: #339933;">,</span> fg_console <span style="color: #339933;">+</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		noctty <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
<span style="color: #339933;">#endif</span>
<span style="color: #808080; font-style: italic;">/*
 *若主设备号为5而次设备号为1表示/dev/console，用于外接控制台，
 *一般情况下它是连接到当前控制台的，但是在不同的版本里情况不同，
 *若它不是连接到/dev/tty0而是主设备号为5次设备号为1则内核会把
 *一个console数据结构挂入到内核的console_drivers队列中，此后内核
 *便会将需要显示的信息输出到所登记的设备上。在这里，如果要打开的
 *设备是/dev/console，那么就从队列中找到第一个设备号不为0的console
 *数据结构，它所提供的设备号就是当前系统控制台的设备号
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>device <span style="color: #339933;">==</span> SYSCONS_DEV<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">struct</span> console <span style="color: #339933;">*</span>c <span style="color: #339933;">=</span> console_drivers<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">while</span><span style="color: #009900;">(</span>c <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span>c<span style="color: #339933;">-&gt;</span>device<span style="color: #009900;">)</span>
			c <span style="color: #339933;">=</span> c<span style="color: #339933;">-&gt;</span>next<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>c<span style="color: #009900;">)</span>
                        <span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>ENODEV<span style="color: #339933;">;</span>
                device <span style="color: #339933;">=</span> c<span style="color: #339933;">-&gt;</span>device<span style="color: #009900;">(</span>c<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		filp<span style="color: #339933;">-&gt;</span>f_flags <span style="color: #339933;">|=</span> O_NONBLOCK<span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* Don't let /dev/console block */</span>
		noctty <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *#define PTMX_DEV MKDEV(TTYAUX_MAJOR,2)
 *主设备号为5而次设备号为2的设备是/dev/ptmx（新版本是/dev/pts/ptmx），
 *是用于伪终端设备的，那么伪终端设备两端的主设备号分别为2和3，我们
 *这里称主设备号为2的设备为主设备和3的为从设备，可以有256对伪终端
 *设备
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>device <span style="color: #339933;">==</span> PTMX_DEV<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
<span style="color: #808080; font-style: italic;">/*
 *此编译选项指的是使用UNIX98中的配套改进方案，打开/dev/ptmx后再对
 *伪终端的主设备和从设备号加以动态分配，就不受256个的限制了
 *需要初始化两个驱动数组ptm_driver[]和pts_driver[]，分别用于主设备和从设备
 */</span>
<span style="color: #339933;">#ifdef CONFIG_UNIX98_PTYS</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/* find a free pty. */</span>
		<span style="color: #993333;">int</span> major<span style="color: #339933;">,</span> minor<span style="color: #339933;">;</span>
		<span style="color: #993333;">struct</span> tty_driver <span style="color: #339933;">*</span>driver<span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/* find a device that is not in use. */</span>
		retval <span style="color: #339933;">=</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *依次扫描主设备号，对每个主设备号依次扫描次设备号
 */</span>
		<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span> major <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span> <span style="color: #339933;">;</span> major <span style="color: #339933;">&lt;</span> UNIX98_NR_MAJORS <span style="color: #339933;">;</span> major<span style="color: #339933;">++</span> <span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			driver <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>ptm_driver<span style="color: #009900;">[</span>major<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>minor <span style="color: #339933;">=</span> driver<span style="color: #339933;">-&gt;</span>minor_start <span style="color: #339933;">;</span>
			     minor <span style="color: #339933;">&lt;</span> driver<span style="color: #339933;">-&gt;</span>minor_start <span style="color: #339933;">+</span> driver<span style="color: #339933;">-&gt;</span>num <span style="color: #339933;">;</span>
			     minor<span style="color: #339933;">++</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				device <span style="color: #339933;">=</span> MKDEV<span style="color: #009900;">(</span>driver<span style="color: #339933;">-&gt;</span>major<span style="color: #339933;">,</span> minor<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>init_dev<span style="color: #009900;">(</span>device<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #b1b100;">goto</span> ptmx_found<span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* ok! */</span>
			<span style="color: #009900;">}</span>
		<span style="color: #009900;">}</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EIO<span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* no free ptys */</span>
	ptmx_found<span style="color: #339933;">:</span>
		set_bit<span style="color: #009900;">(</span>TTY_PTY_LOCK<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* LOCK THE SLAVE */</span>
		minor <span style="color: #339933;">-=</span> driver<span style="color: #339933;">-&gt;</span>minor_start<span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *为相应的次设备创建inode数据结构
 */</span>
		devpts_pty_new<span style="color: #009900;">(</span>driver<span style="color: #339933;">-&gt;</span>other<span style="color: #339933;">-&gt;</span>name_base <span style="color: #339933;">+</span> minor<span style="color: #339933;">,</span> MKDEV<span style="color: #009900;">(</span>driver<span style="color: #339933;">-&gt;</span>other<span style="color: #339933;">-&gt;</span>major<span style="color: #339933;">,</span> minor <span style="color: #339933;">+</span> driver<span style="color: #339933;">-&gt;</span>other<span style="color: #339933;">-&gt;</span>minor_start<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *创建设备节点，如/dev/pts/0等
 */</span>
		tty_register_devfs<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>pts_driver<span style="color: #009900;">[</span>major<span style="color: #009900;">]</span><span style="color: #339933;">,</span> DEVFS_FL_NO_PERSISTENCE<span style="color: #339933;">,</span>
				   pts_driver<span style="color: #009900;">[</span>major<span style="color: #009900;">]</span>.<span style="color: #202020;">minor_start</span> <span style="color: #339933;">+</span> minor<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		noctty <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> init_dev_done<span style="color: #339933;">;</span>
&nbsp;
<span style="color: #339933;">#else   /* CONFIG_UNIX_98_PTYS */</span>
&nbsp;
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>ENODEV<span style="color: #339933;">;</span>
&nbsp;
<span style="color: #339933;">#endif  /* CONFIG_UNIX_98_PTYS */</span>
	<span style="color: #009900;">}</span>
&nbsp;
	retval <span style="color: #339933;">=</span> init_dev<span style="color: #009900;">(</span>device<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//初始化</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>retval<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> retval<span style="color: #339933;">;</span>
&nbsp;
<span style="color: #339933;">#ifdef CONFIG_UNIX98_PTYS</span>
init_dev_done<span style="color: #339933;">:</span>
<span style="color: #339933;">#endif</span>
<span style="color: #808080; font-style: italic;">/*
 *对于普通文件private_data几乎不用，这里建立当前进程和终端设备的连接
 */</span>
	filp<span style="color: #339933;">-&gt;</span>private_data <span style="color: #339933;">=</span> tty<span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *将当前终端设备的file结构挂入tty_struct的tty_files队列
 */</span>
	file_move<span style="color: #009900;">(</span>filp<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>tty_files<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	check_tty_count<span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> <span style="color: #ff0000;">"tty_open"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>driver.<span style="color: #202020;">type</span> <span style="color: #339933;">==</span> TTY_DRIVER_TYPE_PTY <span style="color: #339933;">&amp;&amp;</span>
	    tty<span style="color: #339933;">-&gt;</span>driver.<span style="color: #202020;">subtype</span> <span style="color: #339933;">==</span> PTY_TYPE_MASTER<span style="color: #009900;">)</span>
		noctty <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#ifdef TTY_DEBUG_HANGUP</span>
	printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"opening %s..."</span><span style="color: #339933;">,</span> tty_name<span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> buf<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#endif</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>driver.<span style="color: #202020;">open</span><span style="color: #009900;">)</span>
		retval <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>driver.<span style="color: #202020;">open</span><span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> filp<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//调用内部的open()方法</span>
	<span style="color: #b1b100;">else</span>
		retval <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ENODEV<span style="color: #339933;">;</span>
	filp<span style="color: #339933;">-&gt;</span>f_flags <span style="color: #339933;">=</span> saved_flags<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>retval <span style="color: #339933;">&amp;&amp;</span> test_bit<span style="color: #009900;">(</span>TTY_EXCLUSIVE<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>flags<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span>suser<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		retval <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EBUSY<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>retval<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
<span style="color: #339933;">#ifdef TTY_DEBUG_HANGUP</span>
		printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"error %d in opening %s..."</span><span style="color: #339933;">,</span> retval<span style="color: #339933;">,</span>
		       tty_name<span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> buf<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#endif</span>
&nbsp;
		release_dev<span style="color: #009900;">(</span>filp<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>retval <span style="color: #339933;">!=</span> <span style="color: #339933;">-</span>ERESTARTSYS<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">return</span> retval<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>signal_pending<span style="color: #009900;">(</span>current<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">return</span> retval<span style="color: #339933;">;</span>
		schedule<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #808080; font-style: italic;">/*
		 * Need to reset f_op in case a hangup happened.
		 */</span>
		filp<span style="color: #339933;">-&gt;</span>f_op <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>tty_fops<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> retry_open<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>noctty <span style="color: #339933;">&amp;&amp;</span>
	    current<span style="color: #339933;">-&gt;</span>leader <span style="color: #339933;">&amp;&amp;</span>
	    <span style="color: #339933;">!</span>current<span style="color: #339933;">-&gt;</span>tty <span style="color: #339933;">&amp;&amp;</span>
	    tty<span style="color: #339933;">-&gt;</span>session <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
	    	task_lock<span style="color: #009900;">(</span>current<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		current<span style="color: #339933;">-&gt;</span>tty <span style="color: #339933;">=</span> tty<span style="color: #339933;">;</span>
		task_unlock<span style="color: #009900;">(</span>current<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		current<span style="color: #339933;">-&gt;</span>tty_old_pgrp <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		tty<span style="color: #339933;">-&gt;</span>session <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>session<span style="color: #339933;">;</span>
		tty<span style="color: #339933;">-&gt;</span>pgrp <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>pgrp<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>driver.<span style="color: #202020;">type</span> <span style="color: #339933;">==</span> TTY_DRIVER_TYPE_SERIAL<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span>
	    <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>driver.<span style="color: #202020;">subtype</span> <span style="color: #339933;">==</span> SERIAL_TYPE_CALLOUT<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span>
	    <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>count <span style="color: #339933;">==</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">static</span> <span style="color: #993333;">int</span> nr_warns<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>nr_warns <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">5</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			printk<span style="color: #009900;">(</span>KERN_WARNING <span style="color: #ff0000;">"tty_io.c: "</span>
				<span style="color: #ff0000;">"process %d (%s) used obsolete /dev/%s - "</span>
				<span style="color: #ff0000;">"update software to use /dev/ttyS%d<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span>
				current<span style="color: #339933;">-&gt;</span>pid<span style="color: #339933;">,</span> current<span style="color: #339933;">-&gt;</span>comm<span style="color: #339933;">,</span>
				tty_name<span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> buf<span style="color: #009900;">)</span><span style="color: #339933;">,</span> TTY_NUMBER<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			nr_warns<span style="color: #339933;">++;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>在这个函数中，非常重要的一个函数是初始化函数init_dev()，它将各种数据结构连接在了一起，这个函数定义于文件drivers/char/tty_io.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7993"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
</pre></td> 
             <td class="code" id="p799code3"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * WSH 06/09/97: Rewritten to remove races and properly clean up after a
 * failed open.  The new code protects the open with a semaphore, so it's
 * really quite straightforward.  The semaphore locking can probably be
 * relaxed for the (most common) case of reopening a tty.
 */</span>
<span style="color: #993333;">static</span> <span style="color: #993333;">int</span> init_dev<span style="color: #009900;">(</span>kdev_t device<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">**</span>ret_tty<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>o_tty<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> termios <span style="color: #339933;">*</span>tp<span style="color: #339933;">,</span> <span style="color: #339933;">**</span>tp_loc<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>o_tp<span style="color: #339933;">,</span> <span style="color: #339933;">**</span>o_tp_loc<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> termios <span style="color: #339933;">*</span>ltp<span style="color: #339933;">,</span> <span style="color: #339933;">**</span>ltp_loc<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>o_ltp<span style="color: #339933;">,</span> <span style="color: #339933;">**</span>o_ltp_loc<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> tty_driver <span style="color: #339933;">*</span>driver<span style="color: #339933;">;</span>	
	<span style="color: #993333;">int</span> retval<span style="color: #339933;">=</span><span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> idx<span style="color: #339933;">;</span>
&nbsp;
	driver <span style="color: #339933;">=</span> get_tty_driver<span style="color: #009900;">(</span>device<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//从tty_drivers链表中找到相应的tty_driver数据结构</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>driver<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>ENODEV<span style="color: #339933;">;</span>
&nbsp;
	idx <span style="color: #339933;">=</span> MINOR<span style="color: #009900;">(</span>device<span style="color: #009900;">)</span> <span style="color: #339933;">-</span> driver<span style="color: #339933;">-&gt;</span>minor_start<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* 
	 * Check whether we need to acquire the tty semaphore to avoid
	 * race conditions.  For now, play it safe.
	 */</span>
	down_tty_sem<span style="color: #009900;">(</span>idx<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* check whether we're reopening an existing tty */</span>
	tty <span style="color: #339933;">=</span> driver<span style="color: #339933;">-&gt;</span>table<span style="color: #009900;">[</span>idx<span style="color: #009900;">]</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//指向数组的当前tty_struct</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #b1b100;">goto</span> fast_track<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//若已经创建，则转向fast_track</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * First time open is complex, especially for PTY devices.
	 * This code guarantees that either everything succeeds and the
	 * TTY is ready for operation, or else the table slots are vacated
	 * and the allocated memory released.  (Except that the termios 
	 * and locked termios may be retained.)
	 */</span>
&nbsp;
	o_tty <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	tp <span style="color: #339933;">=</span> o_tp <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	ltp <span style="color: #339933;">=</span> o_ltp <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
&nbsp;
	tty <span style="color: #339933;">=</span> alloc_tty_struct<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//分配tty_struct空间</span>
	<span style="color: #b1b100;">if</span><span style="color: #009900;">(</span><span style="color: #339933;">!</span>tty<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> fail_no_mem<span style="color: #339933;">;</span>
	initialize_tty_struct<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//初始化tty_struct结构</span>
	tty<span style="color: #339933;">-&gt;</span>device <span style="color: #339933;">=</span> device<span style="color: #339933;">;</span>
	tty<span style="color: #339933;">-&gt;</span>driver <span style="color: #339933;">=</span> <span style="color: #339933;">*</span>driver<span style="color: #339933;">;</span>
&nbsp;
	tp_loc <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>driver<span style="color: #339933;">-&gt;</span>termios<span style="color: #009900;">[</span>idx<span style="color: #009900;">]</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//找出本次打开终端的termios结构</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!*</span>tp_loc<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		tp <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> termios <span style="color: #339933;">*</span><span style="color: #009900;">)</span> kmalloc<span style="color: #009900;">(</span><span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> termios<span style="color: #009900;">)</span><span style="color: #339933;">,</span>
						GFP_KERNEL<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>tp<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> free_mem_out<span style="color: #339933;">;</span>
		<span style="color: #339933;">*</span>tp <span style="color: #339933;">=</span> driver<span style="color: #339933;">-&gt;</span>init_termios<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//从里面的样板复制</span>
	<span style="color: #009900;">}</span>
&nbsp;
	ltp_loc <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>driver<span style="color: #339933;">-&gt;</span>termios_locked<span style="color: #009900;">[</span>idx<span style="color: #009900;">]</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//找出本次打开终端的termios结构</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!*</span>ltp_loc<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		ltp <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> termios <span style="color: #339933;">*</span><span style="color: #009900;">)</span> kmalloc<span style="color: #009900;">(</span><span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> termios<span style="color: #009900;">)</span><span style="color: #339933;">,</span>
						 GFP_KERNEL<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>ltp<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> free_mem_out<span style="color: #339933;">;</span>
		memset<span style="color: #009900;">(</span>ltp<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> termios<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//全部初始化为0</span>
	<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *伪终端处理，对于伪终端，则需要成对地创建，在创建了一头的tty以后
 *还要创建另一头的o_tty
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>driver<span style="color: #339933;">-&gt;</span>type <span style="color: #339933;">==</span> TTY_DRIVER_TYPE_PTY<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		o_tty <span style="color: #339933;">=</span> alloc_tty_struct<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>o_tty<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> free_mem_out<span style="color: #339933;">;</span>
		initialize_tty_struct<span style="color: #009900;">(</span>o_tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		o_tty<span style="color: #339933;">-&gt;</span>device <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>kdev_t<span style="color: #009900;">)</span> MKDEV<span style="color: #009900;">(</span>driver<span style="color: #339933;">-&gt;</span>other<span style="color: #339933;">-&gt;</span>major<span style="color: #339933;">,</span>
					driver<span style="color: #339933;">-&gt;</span>other<span style="color: #339933;">-&gt;</span>minor_start <span style="color: #339933;">+</span> idx<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		o_tty<span style="color: #339933;">-&gt;</span>driver <span style="color: #339933;">=</span> <span style="color: #339933;">*</span>driver<span style="color: #339933;">-&gt;</span>other<span style="color: #339933;">;</span>
&nbsp;
		o_tp_loc  <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>driver<span style="color: #339933;">-&gt;</span>other<span style="color: #339933;">-&gt;</span>termios<span style="color: #009900;">[</span>idx<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!*</span>o_tp_loc<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			o_tp <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> termios <span style="color: #339933;">*</span><span style="color: #009900;">)</span>
				kmalloc<span style="color: #009900;">(</span><span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> termios<span style="color: #009900;">)</span><span style="color: #339933;">,</span> GFP_KERNEL<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>o_tp<span style="color: #009900;">)</span>
				<span style="color: #b1b100;">goto</span> free_mem_out<span style="color: #339933;">;</span>
			<span style="color: #339933;">*</span>o_tp <span style="color: #339933;">=</span> driver<span style="color: #339933;">-&gt;</span>other<span style="color: #339933;">-&gt;</span>init_termios<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
&nbsp;
		o_ltp_loc <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>driver<span style="color: #339933;">-&gt;</span>other<span style="color: #339933;">-&gt;</span>termios_locked<span style="color: #009900;">[</span>idx<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!*</span>o_ltp_loc<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			o_ltp <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> termios <span style="color: #339933;">*</span><span style="color: #009900;">)</span>
				kmalloc<span style="color: #009900;">(</span><span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> termios<span style="color: #009900;">)</span><span style="color: #339933;">,</span> GFP_KERNEL<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>o_ltp<span style="color: #009900;">)</span>
				<span style="color: #b1b100;">goto</span> free_mem_out<span style="color: #339933;">;</span>
			memset<span style="color: #009900;">(</span>o_ltp<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> termios<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/*
		 * Everything allocated ... set up the o_tty structure.
		 */</span>
		driver<span style="color: #339933;">-&gt;</span>other<span style="color: #339933;">-&gt;</span>table<span style="color: #009900;">[</span>idx<span style="color: #009900;">]</span> <span style="color: #339933;">=</span> o_tty<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!*</span>o_tp_loc<span style="color: #009900;">)</span>
			<span style="color: #339933;">*</span>o_tp_loc <span style="color: #339933;">=</span> o_tp<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!*</span>o_ltp_loc<span style="color: #009900;">)</span>
			<span style="color: #339933;">*</span>o_ltp_loc <span style="color: #339933;">=</span> o_ltp<span style="color: #339933;">;</span>
		o_tty<span style="color: #339933;">-&gt;</span>termios <span style="color: #339933;">=</span> <span style="color: #339933;">*</span>o_tp_loc<span style="color: #339933;">;</span>
		o_tty<span style="color: #339933;">-&gt;</span>termios_locked <span style="color: #339933;">=</span> <span style="color: #339933;">*</span>o_ltp_loc<span style="color: #339933;">;</span>
		<span style="color: #009900;">(</span><span style="color: #339933;">*</span>driver<span style="color: #339933;">-&gt;</span>other<span style="color: #339933;">-&gt;</span>refcount<span style="color: #009900;">)</span><span style="color: #339933;">++;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>driver<span style="color: #339933;">-&gt;</span>subtype <span style="color: #339933;">==</span> PTY_TYPE_MASTER<span style="color: #009900;">)</span>
			o_tty<span style="color: #339933;">-&gt;</span>count<span style="color: #339933;">++;</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/* Establish the links in both directions */</span>
		tty<span style="color: #339933;">-&gt;</span>link   <span style="color: #339933;">=</span> o_tty<span style="color: #339933;">;</span>
		o_tty<span style="color: #339933;">-&gt;</span>link <span style="color: #339933;">=</span> tty<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* 
	 * All structures have been allocated, so now we install them.
	 * Failures after this point use release_mem to clean up, so 
	 * there's no need to null out the local pointers.
	 */</span>
	driver<span style="color: #339933;">-&gt;</span>table<span style="color: #009900;">[</span>idx<span style="color: #009900;">]</span> <span style="color: #339933;">=</span> tty<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!*</span>tp_loc<span style="color: #009900;">)</span>
		<span style="color: #339933;">*</span>tp_loc <span style="color: #339933;">=</span> tp<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!*</span>ltp_loc<span style="color: #009900;">)</span>
		<span style="color: #339933;">*</span>ltp_loc <span style="color: #339933;">=</span> ltp<span style="color: #339933;">;</span>
	tty<span style="color: #339933;">-&gt;</span>termios <span style="color: #339933;">=</span> <span style="color: #339933;">*</span>tp_loc<span style="color: #339933;">;</span>
	tty<span style="color: #339933;">-&gt;</span>termios_locked <span style="color: #339933;">=</span> <span style="color: #339933;">*</span>ltp_loc<span style="color: #339933;">;</span>
	<span style="color: #009900;">(</span><span style="color: #339933;">*</span>driver<span style="color: #339933;">-&gt;</span>refcount<span style="color: #009900;">)</span><span style="color: #339933;">++;</span>
	tty<span style="color: #339933;">-&gt;</span>count<span style="color: #339933;">++;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* 
	 * Structures all installed ... call the ldisc open routines.
	 * If we fail here just call release_mem to clean up.  No need
	 * to decrement the use counts, as release_mem doesn't care.
	 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>ldisc.<span style="color: #202020;">open</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		retval <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>ldisc.<span style="color: #202020;">open</span><span style="color: #009900;">)</span><span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//调用底层（链路规则）的open()初始化</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>retval<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> release_mem_out<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>o_tty <span style="color: #339933;">&amp;&amp;</span> o_tty<span style="color: #339933;">-&gt;</span>ldisc.<span style="color: #202020;">open</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		retval <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>o_tty<span style="color: #339933;">-&gt;</span>ldisc.<span style="color: #202020;">open</span><span style="color: #009900;">)</span><span style="color: #009900;">(</span>o_tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//调用底层（链路规则）的open()初始化</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>retval<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>ldisc.<span style="color: #202020;">close</span><span style="color: #009900;">)</span>
				<span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>ldisc.<span style="color: #202020;">close</span><span style="color: #009900;">)</span><span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//调用底层（链路规则）的close()</span>
			<span style="color: #b1b100;">goto</span> release_mem_out<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">goto</span> success<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * This fast open can be used if the tty is already open.
	 * No memory is allocated, and the only failures are from
	 * attempting to open a closing tty or attempting multiple
	 * opens on a pty master.
	 */</span>
<span style="color: #808080; font-style: italic;">/*
 *若tty已经打开，则转向此处，设置数据结构，共享计数自加等
 */</span>
fast_track<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>test_bit<span style="color: #009900;">(</span>TTY_CLOSING<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>flags<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		retval <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EIO<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> end_init<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>driver<span style="color: #339933;">-&gt;</span>type <span style="color: #339933;">==</span> TTY_DRIVER_TYPE_PTY <span style="color: #339933;">&amp;&amp;</span>
	    driver<span style="color: #339933;">-&gt;</span>subtype <span style="color: #339933;">==</span> PTY_TYPE_MASTER<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #808080; font-style: italic;">/*
		 * special case for PTY masters: only one open permitted, 
		 * and the slave side open count is incremented as well.
		 */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>count<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			retval <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EIO<span style="color: #339933;">;</span>
			<span style="color: #b1b100;">goto</span> end_init<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		tty<span style="color: #339933;">-&gt;</span>link<span style="color: #339933;">-&gt;</span>count<span style="color: #339933;">++;</span>
	<span style="color: #009900;">}</span>
	tty<span style="color: #339933;">-&gt;</span>count<span style="color: #339933;">++;</span>
	tty<span style="color: #339933;">-&gt;</span>driver <span style="color: #339933;">=</span> <span style="color: #339933;">*</span>driver<span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* N.B. why do this every time?? */</span>
&nbsp;
success<span style="color: #339933;">:</span>
	<span style="color: #339933;">*</span>ret_tty <span style="color: #339933;">=</span> tty<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* All paths come through here to release the semaphore */</span>
end_init<span style="color: #339933;">:</span>
	up_tty_sem<span style="color: #009900;">(</span>idx<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> retval<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Release locally allocated memory ... nothing placed in slots */</span>
free_mem_out<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>o_tp<span style="color: #009900;">)</span>
		kfree<span style="color: #009900;">(</span>o_tp<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>o_tty<span style="color: #009900;">)</span>
		free_tty_struct<span style="color: #009900;">(</span>o_tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>ltp<span style="color: #009900;">)</span>
		kfree<span style="color: #009900;">(</span>ltp<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tp<span style="color: #009900;">)</span>
		kfree<span style="color: #009900;">(</span>tp<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	free_tty_struct<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
fail_no_mem<span style="color: #339933;">:</span>
	retval <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ENOMEM<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">goto</span> end_init<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* call the tty release_mem routine to clean out this slot */</span>
release_mem_out<span style="color: #339933;">:</span>
	printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"init_dev: ldisc open failed, clearing slot %d<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> idx<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	release_mem<span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> idx<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">goto</span> end_init<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>初始化tty_struct结构的函数initialize_tty_struct()定义在drivers/char/tty_io.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7994"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td> 
             <td class="code" id="p799code4"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * This subroutine initializes a tty structure.
 */</span>
<span style="color: #993333;">static</span> <span style="color: #993333;">void</span> initialize_tty_struct<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	memset<span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	tty<span style="color: #339933;">-&gt;</span>magic <span style="color: #339933;">=</span> TTY_MAGIC<span style="color: #339933;">;</span>
	tty<span style="color: #339933;">-&gt;</span>ldisc <span style="color: #339933;">=</span> ldiscs<span style="color: #009900;">[</span>N_TTY<span style="color: #009900;">]</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//整体赋值</span>
	tty<span style="color: #339933;">-&gt;</span>pgrp <span style="color: #339933;">=</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">char_buf_ptr</span> <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">char_buf</span><span style="color: #339933;">;</span>
	tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">flag_buf_ptr</span> <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">flag_buf</span><span style="color: #339933;">;</span>
	tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">tqueue</span>.<span style="color: #202020;">routine</span> <span style="color: #339933;">=</span> flush_to_ldisc<span style="color: #339933;">;</span>
	tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">tqueue</span>.<span style="color: #202020;">data</span> <span style="color: #339933;">=</span> tty<span style="color: #339933;">;</span>
	init_MUTEX<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">pty_sem</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	init_waitqueue_head<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>write_wait<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	init_waitqueue_head<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_wait<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	tty<span style="color: #339933;">-&gt;</span>tq_hangup.<span style="color: #202020;">routine</span> <span style="color: #339933;">=</span> do_tty_hangup<span style="color: #339933;">;</span>
	tty<span style="color: #339933;">-&gt;</span>tq_hangup.<span style="color: #202020;">data</span> <span style="color: #339933;">=</span> tty<span style="color: #339933;">;</span>
	sema_init<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>atomic_read<span style="color: #339933;">,</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	sema_init<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>atomic_write<span style="color: #339933;">,</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	spin_lock_init<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	INIT_LIST_HEAD<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>tty_files<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>不管哪一种终端设备，开始时总是采用标号为N_TTY的tty_ldisc数据结构，实际上是tty_ldisc_N_TTY，定义于drivers/char/n_tty.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7995"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td> 
             <td class="code" id="p799code5"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> tty_ldisc tty_ldisc_N_TTY <span style="color: #339933;">=</span> <span style="color: #009900;">{</span>
	TTY_LDISC_MAGIC<span style="color: #339933;">,</span>	<span style="color: #808080; font-style: italic;">/* magic */</span>
	<span style="color: #ff0000;">"n_tty"</span><span style="color: #339933;">,</span>		<span style="color: #808080; font-style: italic;">/* name */</span>
	<span style="color: #0000dd;">0</span><span style="color: #339933;">,</span>			<span style="color: #808080; font-style: italic;">/* num */</span>
	<span style="color: #0000dd;">0</span><span style="color: #339933;">,</span>			<span style="color: #808080; font-style: italic;">/* flags */</span>
	n_tty_open<span style="color: #339933;">,</span>		<span style="color: #808080; font-style: italic;">/* open */</span>
	n_tty_close<span style="color: #339933;">,</span>		<span style="color: #808080; font-style: italic;">/* close */</span>
	n_tty_flush_buffer<span style="color: #339933;">,</span>	<span style="color: #808080; font-style: italic;">/* flush_buffer */</span>
	n_tty_chars_in_buffer<span style="color: #339933;">,</span>	<span style="color: #808080; font-style: italic;">/* chars_in_buffer */</span>
	read_chan<span style="color: #339933;">,</span>		<span style="color: #808080; font-style: italic;">/* read */</span>
	write_chan<span style="color: #339933;">,</span>		<span style="color: #808080; font-style: italic;">/* write */</span>
	n_tty_ioctl<span style="color: #339933;">,</span>		<span style="color: #808080; font-style: italic;">/* ioctl */</span>
	n_tty_set_termios<span style="color: #339933;">,</span>	<span style="color: #808080; font-style: italic;">/* set_termios */</span>
	normal_poll<span style="color: #339933;">,</span>		<span style="color: #808080; font-style: italic;">/* poll */</span>
	n_tty_receive_buf<span style="color: #339933;">,</span>	<span style="color: #808080; font-style: italic;">/* receive_buf */</span>
	n_tty_receive_room<span style="color: #339933;">,</span>	<span style="color: #808080; font-style: italic;">/* receive_room */</span>
	<span style="color: #0000dd;">0</span>			<span style="color: #808080; font-style: italic;">/* write_wakeup */</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>其open指针就是指向函数n_tty_open()，这个函数定义于drivers/char/n_tty.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7996"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td> 
             <td class="code" id="p799code6"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">int</span> n_tty_open<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>tty<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EINVAL<span style="color: #339933;">;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *在讲前面的tty_flip_buffer时候讲过，那个数据结构中的缓冲区是用来
 *盛放从底层中断服务程序接收来的字符的，但是一般终端都是工作在
 *“加工模式”，tty_struct里的buff缓冲区是用来盛放加工过的字符的
 *若打开时发现没有则需要分配，大小为一个页面
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>tty<span style="color: #339933;">-&gt;</span>read_buf<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		tty<span style="color: #339933;">-&gt;</span>read_buf <span style="color: #339933;">=</span> alloc_buf<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>tty<span style="color: #339933;">-&gt;</span>read_buf<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>ENOMEM<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	memset<span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>read_buf<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> N_TTY_BUF_SIZE<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *重置字符标志
 */</span>
	reset_buffer_flags<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	tty<span style="color: #339933;">-&gt;</span>column <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *根据终端设备的termios数据结构设置其tty_struct结构中的process_char_map
 *和其他的几个标志位
 */</span>
	n_tty_set_termios<span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	tty<span style="color: #339933;">-&gt;</span>minimum_to_wake <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	tty<span style="color: #339933;">-&gt;</span>closing <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>函数reset_buffer_flags()定义在drivers/char/n_tty.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7997"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td> 
             <td class="code" id="p799code7"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * Reset the read buffer counters, clear the flags, 
 * and make sure the driver is unthrottled. Called
 * from n_tty_open() and n_tty_flush_buffer().
 */</span>
<span style="color: #993333;">static</span> <span style="color: #993333;">void</span> reset_buffer_flags<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> flags<span style="color: #339933;">;</span>
&nbsp;
	spin_lock_irqsave<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	tty<span style="color: #339933;">-&gt;</span>read_head <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>read_tail <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>read_cnt <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//缓冲区中当前读出位置的下标</span>
	spin_unlock_irqrestore<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	tty<span style="color: #339933;">-&gt;</span>canon_head <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>canon_data <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>erasing <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><span style="color: #666666; font-style: italic;">//缓冲区中当前读出位置的下标</span>
	memset<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_flags<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span> tty<span style="color: #339933;">-&gt;</span>read_flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//清除位图</span>
	check_unthrottle<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>函数n_tty_set_termios()定义在drivers/char/n_tty.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7998"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre></td> 
             <td class="code" id="p799code8"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">void</span> n_tty_set_termios<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> termios <span style="color: #339933;">*</span> old<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
<span style="color: #808080; font-style: italic;">/*
 *tty_struct结构中的process_char_map中的每一位对应着一个字符
 *若某一位为1则表示这个字符需要进行加工处理，具体的处理方法
 *读者可以参考毛老先生的书上，这里不是我们的重点
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>tty<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
&nbsp;
	tty<span style="color: #339933;">-&gt;</span>icanon <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>L_ICANON<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>test_bit<span style="color: #009900;">(</span>TTY_HW_COOK_IN<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>flags<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		tty<span style="color: #339933;">-&gt;</span>raw <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
		tty<span style="color: #339933;">-&gt;</span>real_raw <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>I_ISTRIP<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">||</span> I_IUCLC<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">||</span> I_IGNCR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">||</span>
	    I_ICRNL<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">||</span> I_INLCR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">||</span> L_ICANON<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">||</span>
	    I_IXON<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">||</span> L_ISIG<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">||</span> L_ECHO<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">||</span>
	    I_PARMRK<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		cli<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		memset<span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>process_char_map<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> <span style="color: #0000dd;">256</span><span style="color: #339933;">/</span><span style="color: #0000dd;">8</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>I_IGNCR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">||</span> I_ICRNL<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			set_bit<span style="color: #009900;">(</span><span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\r</span>'</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>process_char_map<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>I_INLCR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			set_bit<span style="color: #009900;">(</span><span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\n</span>'</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>process_char_map<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>L_ICANON<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			set_bit<span style="color: #009900;">(</span>ERASE_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>process_char_map<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			set_bit<span style="color: #009900;">(</span>KILL_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>process_char_map<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			set_bit<span style="color: #009900;">(</span>EOF_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>process_char_map<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			set_bit<span style="color: #009900;">(</span><span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\n</span>'</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>process_char_map<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			set_bit<span style="color: #009900;">(</span>EOL_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>process_char_map<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>L_IEXTEN<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				set_bit<span style="color: #009900;">(</span>WERASE_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">,</span>
					<span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>process_char_map<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				set_bit<span style="color: #009900;">(</span>LNEXT_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">,</span>
					<span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>process_char_map<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				set_bit<span style="color: #009900;">(</span>EOL2_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">,</span>
					<span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>process_char_map<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>L_ECHO<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
					set_bit<span style="color: #009900;">(</span>REPRINT_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">,</span>
						<span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>process_char_map<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
		<span style="color: #009900;">}</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>I_IXON<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			set_bit<span style="color: #009900;">(</span>START_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>process_char_map<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			set_bit<span style="color: #009900;">(</span>STOP_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>process_char_map<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>L_ISIG<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			set_bit<span style="color: #009900;">(</span>INTR_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>process_char_map<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			set_bit<span style="color: #009900;">(</span>QUIT_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>process_char_map<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			set_bit<span style="color: #009900;">(</span>SUSP_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>process_char_map<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		clear_bit<span style="color: #009900;">(</span>__DISABLED_CHAR<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>process_char_map<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		sti<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		tty<span style="color: #339933;">-&gt;</span>raw <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		tty<span style="color: #339933;">-&gt;</span>real_raw <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
		tty<span style="color: #339933;">-&gt;</span>raw <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>I_IGNBRK<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">||</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>I_BRKINT<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span>I_PARMRK<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span>
		    <span style="color: #009900;">(</span>I_IGNPAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">||</span> <span style="color: #339933;">!</span>I_INPCK<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span>
		    <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>driver.<span style="color: #202020;">flags</span> <span style="color: #339933;">&amp;</span> TTY_DRIVER_REAL_RAW<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			tty<span style="color: #339933;">-&gt;</span>real_raw <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">else</span>
			tty<span style="color: #339933;">-&gt;</span>real_raw <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>前面我们说了，最后要调用tty_driver中的打开函数指针，对于控制台来说，这个指针指向函数con_open()，定义于drivers/char/console.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7999"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td> 
             <td class="code" id="p799code9"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * Allocate the console screen memory.
 */</span>
<span style="color: #993333;">static</span> <span style="color: #993333;">int</span> con_open<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span> filp<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span>	currcons<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> i<span style="color: #339933;">;</span>
&nbsp;
	currcons <span style="color: #339933;">=</span> MINOR<span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>device<span style="color: #009900;">)</span> <span style="color: #339933;">-</span> tty<span style="color: #339933;">-&gt;</span>driver.<span style="color: #202020;">minor_start</span><span style="color: #339933;">;</span>
&nbsp;
	i <span style="color: #339933;">=</span> vc_allocate<span style="color: #009900;">(</span>currcons<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>i<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> i<span style="color: #339933;">;</span>
&nbsp;
	vt_cons<span style="color: #009900;">[</span>currcons<span style="color: #009900;">]</span><span style="color: #339933;">-&gt;</span>vc_num <span style="color: #339933;">=</span> currcons<span style="color: #339933;">;</span>
	tty<span style="color: #339933;">-&gt;</span>driver_data <span style="color: #339933;">=</span> vt_cons<span style="color: #009900;">[</span>currcons<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>tty<span style="color: #339933;">-&gt;</span>winsize.<span style="color: #202020;">ws_row</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span>tty<span style="color: #339933;">-&gt;</span>winsize.<span style="color: #202020;">ws_col</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		tty<span style="color: #339933;">-&gt;</span>winsize.<span style="color: #202020;">ws_row</span> <span style="color: #339933;">=</span> video_num_lines<span style="color: #339933;">;</span>
		tty<span style="color: #339933;">-&gt;</span>winsize.<span style="color: #202020;">ws_col</span> <span style="color: #339933;">=</span> video_num_columns<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>count <span style="color: #339933;">==</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span>
		vcs_make_devfs <span style="color: #009900;">(</span>currcons<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>作用是为了当前的虚拟终端分配缓冲区和数据结构等，具体的就不多说了。</p> 
         <h2>终端设备读操作：</h2> 
         <p>从上面的file_operations跳转表可以看出，终端设备的读操作从函数tty_read()开始的，从这个函数开始包括了一系列的键盘、VGA显卡等的驱动，为了阅读方便，我们这里给出函数调用关系表：</p> 
         <p><a href="uploads/2013/02/1.jpg"><img class="aligncenter size-full wp-image-800" alt="1" src="uploads/2013/02/1.jpg" width="543" height="328"></a></p> 
         <p>函数tty_read()定义在drivers/char/tty_io.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79910"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td> 
             <td class="code" id="p799code10"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> ssize_t tty_read<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span> file<span style="color: #339933;">,</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span> buf<span style="color: #339933;">,</span> size_t count<span style="color: #339933;">,</span> 
			loff_t <span style="color: #339933;">*</span>ppos<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span> i<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span> tty<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span>inode<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Can't seek (pread) on ttys.  */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>ppos <span style="color: #339933;">!=</span> <span style="color: #339933;">&amp;</span>file<span style="color: #339933;">-&gt;</span>f_pos<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>ESPIPE<span style="color: #339933;">;</span>
&nbsp;
	tty <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span><span style="color: #009900;">)</span>file<span style="color: #339933;">-&gt;</span>private_data<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//取得其tty_struct结构</span>
	inode <span style="color: #339933;">=</span> file<span style="color: #339933;">-&gt;</span>f_dentry<span style="color: #339933;">-&gt;</span>d_inode<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty_paranoia_check<span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> inode<span style="color: #339933;">-&gt;</span>i_rdev<span style="color: #339933;">,</span> <span style="color: #ff0000;">"tty_read"</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EIO<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>tty <span style="color: #339933;">||</span> <span style="color: #009900;">(</span>test_bit<span style="color: #009900;">(</span>TTY_IO_ERROR<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>flags<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EIO<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* This check not only needs to be done before reading, but also
	   whenever read_chan() gets woken up after sleeping, so I've
	   moved it to there.  This should only be done for the N_TTY
	   line discipline, anyway.  Same goes for write_chan(). -- jlc. */</span>
<span style="color: #339933;">#if 0</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>inode<span style="color: #339933;">-&gt;</span>i_rdev <span style="color: #339933;">!=</span> CONSOLE_DEV<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #808080; font-style: italic;">/* don't stop on /dev/console */</span>
	    <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>pgrp <span style="color: #339933;">&gt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span>
	    <span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>tty <span style="color: #339933;">==</span> tty<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span>
	    <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>pgrp <span style="color: #339933;">!=</span> current<span style="color: #339933;">-&gt;</span>pgrp<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>is_ignored<span style="color: #009900;">(</span>SIGTTIN<span style="color: #009900;">)</span> <span style="color: #339933;">||</span> is_orphaned_pgrp<span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>pgrp<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EIO<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
			<span style="color: #009900;">(</span><span style="color: #993333;">void</span><span style="color: #009900;">)</span> kill_pg<span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>pgrp<span style="color: #339933;">,</span> SIGTTIN<span style="color: #339933;">,</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>ERESTARTSYS<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
<span style="color: #339933;">#endif</span>
	lock_kernel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>ldisc.<span style="color: #202020;">read</span><span style="color: #009900;">)</span>
		i <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>ldisc.<span style="color: #202020;">read</span><span style="color: #009900;">)</span><span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span>file<span style="color: #339933;">,</span>buf<span style="color: #339933;">,</span>count<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//进入下一层的read</span>
	<span style="color: #b1b100;">else</span>
		i <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EIO<span style="color: #339933;">;</span>
	unlock_kernel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>i <span style="color: #339933;">&gt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
		inode<span style="color: #339933;">-&gt;</span>i_atime <span style="color: #339933;">=</span> CURRENT_TIME<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> i<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>链路规则层的read指针指向函数read_chan()，这个函数定义于drivers/char/n_tty.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79911"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
</pre></td> 
             <td class="code" id="p799code11"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> ssize_t read_chan<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span>file<span style="color: #339933;">,</span>
			 <span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>buf<span style="color: #339933;">,</span> size_t nr<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>b <span style="color: #339933;">=</span> buf<span style="color: #339933;">;</span>
	DECLARE_WAITQUEUE<span style="color: #009900;">(</span>wait<span style="color: #339933;">,</span> current<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> c<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> minimum<span style="color: #339933;">,</span> time<span style="color: #339933;">;</span>
	ssize_t retval <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	ssize_t size<span style="color: #339933;">;</span>
	<span style="color: #993333;">long</span> timeout<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> flags<span style="color: #339933;">;</span>
&nbsp;
do_it_again<span style="color: #339933;">:</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>tty<span style="color: #339933;">-&gt;</span>read_buf<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//无缓冲区</span>
		printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"n_tty_read_chan: called with read_buf == NULL?!?<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EIO<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Job control check -- must be done at start and after
	   every sleep (POSIX.1 7.1.1.4). */</span>
	<span style="color: #808080; font-style: italic;">/* NOTE: not yet done after every sleep pending a thorough
	   check of the logic of this change. -- jlc */</span>
	<span style="color: #808080; font-style: italic;">/* don't stop on /dev/console */</span>
<span style="color: #666666; font-style: italic;">//what is the fucking this???</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>file<span style="color: #339933;">-&gt;</span>f_dentry<span style="color: #339933;">-&gt;</span>d_inode<span style="color: #339933;">-&gt;</span>i_rdev <span style="color: #339933;">!=</span> CONSOLE_DEV <span style="color: #339933;">&amp;&amp;</span>
	    file<span style="color: #339933;">-&gt;</span>f_dentry<span style="color: #339933;">-&gt;</span>d_inode<span style="color: #339933;">-&gt;</span>i_rdev <span style="color: #339933;">!=</span> SYSCONS_DEV <span style="color: #339933;">&amp;&amp;</span>
	    current<span style="color: #339933;">-&gt;</span>tty <span style="color: #339933;">==</span> tty<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>pgrp <span style="color: #339933;">&lt;=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
			printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"read_chan: tty-&gt;pgrp &lt;= 0!<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>pgrp <span style="color: #339933;">!=</span> tty<span style="color: #339933;">-&gt;</span>pgrp<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>is_ignored<span style="color: #009900;">(</span>SIGTTIN<span style="color: #009900;">)</span> <span style="color: #339933;">||</span>
			    is_orphaned_pgrp<span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>pgrp<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EIO<span style="color: #339933;">;</span>
			kill_pg<span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>pgrp<span style="color: #339933;">,</span> SIGTTIN<span style="color: #339933;">,</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>ERESTARTSYS<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
&nbsp;
	minimum <span style="color: #339933;">=</span> time <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	timeout <span style="color: #339933;">=</span> MAX_SCHEDULE_TIMEOUT<span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *当工作于“原始”模式或者非“规范”模式时，当缓冲区中有了最低限度的
 *数据量minimum_to_wake时，就要唤醒正在等待从该设备读出的进程，这里
 *为其确定一个数值
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>tty<span style="color: #339933;">-&gt;</span>icanon<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		time <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>HZ <span style="color: #339933;">/</span> <span style="color: #0000dd;">10</span><span style="color: #009900;">)</span> <span style="color: #339933;">*</span> TIME_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		minimum <span style="color: #339933;">=</span> MIN_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>minimum<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>time<span style="color: #009900;">)</span>
				tty<span style="color: #339933;">-&gt;</span>minimum_to_wake <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>waitqueue_active<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_wait<span style="color: #009900;">)</span> <span style="color: #339933;">||</span>
				 <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>minimum_to_wake <span style="color: #339933;">&gt;</span> minimum<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				tty<span style="color: #339933;">-&gt;</span>minimum_to_wake <span style="color: #339933;">=</span> minimum<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
			timeout <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>time<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				timeout <span style="color: #339933;">=</span> time<span style="color: #339933;">;</span>
				time <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			tty<span style="color: #339933;">-&gt;</span>minimum_to_wake <span style="color: #339933;">=</span> minimum <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>file<span style="color: #339933;">-&gt;</span>f_flags <span style="color: #339933;">&amp;</span> O_NONBLOCK<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>down_trylock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>atomic_read<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EAGAIN<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>down_interruptible<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>atomic_read<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>ERESTARTSYS<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *在当前进程的系统堆栈中准备下一个wait_queue_t数据结构wait，并将其
 *挂入目标终端的等待队列read_wait中，使终端设备的驱动程序在有数据可读
 *时可以唤醒这个进程
 */</span>
	add_wait_queue<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_wait<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>wait<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	set_bit<span style="color: #009900;">(</span>TTY_DONT_FLIP<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *循环字符
 */</span>
	<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>nr<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #808080; font-style: italic;">/* First test for status change. */</span>
<span style="color: #808080; font-style: italic;">/*
 *对于伪终端设备，可以将终端设置成packet模式，因为这两端
 *有时候在通过网络连接的不同计算机中，这种情况下tty-&gt;packet为1
 *而若tty-&gt;link-&gt;ctrl_status非0就表示有反应通信链路状态变化的控制
 *信息需要优先提交
 */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>packet <span style="color: #339933;">&amp;&amp;</span> tty<span style="color: #339933;">-&gt;</span>link<span style="color: #339933;">-&gt;</span>ctrl_status<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> cs<span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>b <span style="color: #339933;">!=</span> buf<span style="color: #009900;">)</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			cs <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>link<span style="color: #339933;">-&gt;</span>ctrl_status<span style="color: #339933;">;</span>
			tty<span style="color: #339933;">-&gt;</span>link<span style="color: #339933;">-&gt;</span>ctrl_status <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
			put_user<span style="color: #009900;">(</span>cs<span style="color: #339933;">,</span> b<span style="color: #339933;">++</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			nr<span style="color: #339933;">--;</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		<span style="color: #808080; font-style: italic;">/* This statement must be first before checking for input
		   so that any interrupt will set the state back to
		   TASK_RUNNING. */</span>
		set_current_state<span style="color: #009900;">(</span>TASK_INTERRUPTIBLE<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//睡眠等待唤醒</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *b开始时和buf相同，但是每读取一个字符b加1，所以b-buf就是
 *已经读出的字符数
 */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #009900;">(</span>minimum <span style="color: #339933;">-</span> <span style="color: #009900;">(</span>b <span style="color: #339933;">-</span> buf<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">&lt;</span> tty<span style="color: #339933;">-&gt;</span>minimum_to_wake<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span>
		    <span style="color: #009900;">(</span><span style="color: #009900;">(</span>minimum <span style="color: #339933;">-</span> <span style="color: #009900;">(</span>b <span style="color: #339933;">-</span> buf<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">&gt;=</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			tty<span style="color: #339933;">-&gt;</span>minimum_to_wake <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>minimum <span style="color: #339933;">-</span> <span style="color: #009900;">(</span>b <span style="color: #339933;">-</span> buf<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>input_available_p<span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//检查输入缓冲区中有无字符，此处条件没有执行</span>
<span style="color: #808080; font-style: italic;">/*
 *若输入缓冲区中没有字符，那么除非有特殊情况，否则睡眠等待
 *等缓冲区中有字符了才会唤醒
 */</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>test_bit<span style="color: #009900;">(</span>TTY_OTHER_CLOSED<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>flags<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				retval <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EIO<span style="color: #339933;">;</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty_hung_up_p<span style="color: #009900;">(</span>file<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>timeout<span style="color: #009900;">)</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>file<span style="color: #339933;">-&gt;</span>f_flags <span style="color: #339933;">&amp;</span> O_NONBLOCK<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				retval <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EAGAIN<span style="color: #339933;">;</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>signal_pending<span style="color: #009900;">(</span>current<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				retval <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ERESTARTSYS<span style="color: #339933;">;</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			clear_bit<span style="color: #009900;">(</span>TTY_DONT_FLIP<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			timeout <span style="color: #339933;">=</span> schedule_timeout<span style="color: #009900;">(</span>timeout<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			set_bit<span style="color: #009900;">(</span>TTY_DONT_FLIP<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
<span style="color: #808080; font-style: italic;">/*
 *进程已经唤醒，缓冲区中有数据
 */</span>
		current<span style="color: #339933;">-&gt;</span>state <span style="color: #339933;">=</span> TASK_RUNNING<span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/* Deal with packet mode. */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>packet <span style="color: #339933;">&amp;&amp;</span> b <span style="color: #339933;">==</span> buf<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			put_user<span style="color: #009900;">(</span>TIOCPKT_DATA<span style="color: #339933;">,</span> b<span style="color: #339933;">++</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			nr<span style="color: #339933;">--;</span>
		<span style="color: #009900;">}</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>icanon<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//规范模式，缓冲区中字符是经过加工了的</span>
			<span style="color: #808080; font-style: italic;">/* N.B. avoid overrun if nr == 0 */</span>
<span style="color: #808080; font-style: italic;">/*
 *规范模式下缓冲区中的字符要累积起一个“缓冲行”，即碰到'\n'字符
 *时才会唤醒等待读出的进程，此时tty-&gt;read_cnt表示缓冲行中的字符个数
 *tty-&gt;read_buff[]是个循环缓冲，tty-&gt;read_tail指向当前可供读出的第一个
 *字符，若tty-&gt;read_flags中的对应于tty-&gt;read_tail这一位为1表示这个
 *位置上已经是缓冲行的终点，此后的数据是属于另外一个缓冲行
 */</span>
			<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>nr <span style="color: #339933;">&amp;&amp;</span> tty<span style="color: #339933;">-&gt;</span>read_cnt<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
 				<span style="color: #993333;">int</span> eol<span style="color: #339933;">;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *eol表示到达了缓冲行终点
 */</span>
				eol <span style="color: #339933;">=</span> test_and_clear_bit<span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>read_tail<span style="color: #339933;">,</span>
						<span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				c <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>read_buf<span style="color: #009900;">[</span>tty<span style="color: #339933;">-&gt;</span>read_tail<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
				spin_lock_irqsave<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				tty<span style="color: #339933;">-&gt;</span>read_tail <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>read_tail<span style="color: #339933;">+</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span> <span style="color: #339933;">&amp;</span>
						  <span style="color: #009900;">(</span>N_TTY_BUF_SIZE<span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				tty<span style="color: #339933;">-&gt;</span>read_cnt<span style="color: #339933;">--;</span>
				spin_unlock_irqrestore<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *eol表示到达了缓冲行终点，而__DISABLED_CHAR表示字符'\0'
 *	#define __DISABLED_CHAR '\0'
 *这里表示若未到达缓冲行终点或者未到达字符终点就复制
 */</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>eol <span style="color: #339933;">||</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">!=</span> __DISABLED_CHAR<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
					put_user<span style="color: #009900;">(</span>c<span style="color: #339933;">,</span> b<span style="color: #339933;">++</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//将字符复制到用户空间中去</span>
					nr<span style="color: #339933;">--;</span>
				<span style="color: #009900;">}</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>eol<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
					<span style="color: #808080; font-style: italic;">/* this test should be redundant:
					 * we shouldn't be reading data if
					 * canon_data is 0
					 */</span>
					<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">--</span>tty<span style="color: #339933;">-&gt;</span>canon_data <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
						tty<span style="color: #339933;">-&gt;</span>canon_data <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
					<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
				<span style="color: #009900;">}</span>
			<span style="color: #009900;">}</span>
		<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
<span style="color: #808080; font-style: italic;">/*
 *对于非规范模式就直接复制，因为是循环缓冲，所以可能字符
 *被分成两段，需要分两次复制
 */</span>
			<span style="color: #993333;">int</span> uncopied<span style="color: #339933;">;</span>
			uncopied <span style="color: #339933;">=</span> copy_from_read_buf<span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>b<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>nr<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			uncopied <span style="color: #339933;">+=</span> copy_from_read_buf<span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>b<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>nr<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>uncopied<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				retval <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EFAULT<span style="color: #339933;">;</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
		<span style="color: #009900;">}</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/* If there is enough space in the read buffer now, let the
		 * low-level driver know. We use n_tty_chars_in_buffer() to
		 * check the buffer, as it now knows about canonical mode.
		 * Otherwise, if the driver is throttled and the line is
		 * longer than TTY_THRESHOLD_UNTHROTTLE in canonical mode,
		 * we won't get any more characters.
		 */</span>
<span style="color: #808080; font-style: italic;">/*
 *由于缓冲区的大小有限，如果输入字符过快而导致缓冲区不够，那么会
 *暂时关闭输入，不接收输入字符并将进程睡眠，但是在缓冲区的空闲数量
 *达到一定程度(TTY_THRESHOLD_UNTHROTTLE)后会将进程唤醒
 */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>n_tty_chars_in_buffer<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">&lt;=</span> TTY_THRESHOLD_UNTHROTTLE<span style="color: #009900;">)</span>
			check_unthrottle<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//检查并唤醒等待输入的进程</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>b <span style="color: #339933;">-</span> buf <span style="color: #339933;">&gt;=</span> minimum<span style="color: #009900;">)</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>time<span style="color: #009900;">)</span>
			timeout <span style="color: #339933;">=</span> time<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	clear_bit<span style="color: #009900;">(</span>TTY_DONT_FLIP<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	up<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>atomic_read<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	remove_wait_queue<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_wait<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>wait<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//将已经读完的进程从等待队列拆除</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>waitqueue_active<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_wait<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		tty<span style="color: #339933;">-&gt;</span>minimum_to_wake <span style="color: #339933;">=</span> minimum<span style="color: #339933;">;</span>
&nbsp;
	current<span style="color: #339933;">-&gt;</span>state <span style="color: #339933;">=</span> TASK_RUNNING<span style="color: #339933;">;</span>
	size <span style="color: #339933;">=</span> b <span style="color: #339933;">-</span> buf<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>size<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		retval <span style="color: #339933;">=</span> size<span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *TTY_PUSH是由底层驱动程序在读到一个EOF字符并将其放入
 *缓冲区中设置成1的，表示用户应该尽快将该字符取走，在取走
 *以后又清0
 */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>nr<span style="color: #009900;">)</span>
	       		clear_bit<span style="color: #009900;">(</span>TTY_PUSH<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>test_and_clear_bit<span style="color: #009900;">(</span>TTY_PUSH<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>flags<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		 <span style="color: #b1b100;">goto</span> do_it_again<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">return</span> retval<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>It’s a vary long function!</p> 
         <p>一般而言，一个典型的读终端过程可以分为以下三个部分：</p> 
         <p>1、当前进程企图从终端的缓冲区读出，但是因为当前缓冲区中尚无足够的字符而受阻进入睡眠状态；</p> 
         <p>2、当使用者在键盘上输入字符，底层驱动程序将足够的字符写入缓冲区以后就把睡眠中的进程唤醒；</p> 
         <p>3、睡眠中的进程被唤醒，继续读出字符。</p> 
         <p>在read_chan()中调用的一些函数这里列出如下：</p> 
         <p>一是检查输入缓冲区中有无字符可供读出的函数，在“规范模式”下，检查的是经过加工过后的字符，而在原始模式就是原始字符数量，函数input_available_p()定义于drivers/char/n_tty.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79912"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td> 
             <td class="code" id="p799code12"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #000000; font-weight: bold;">inline</span> <span style="color: #993333;">int</span> input_available_p<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> amt<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>icanon<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>canon_data<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>read_cnt <span style="color: #339933;">&gt;=</span> <span style="color: #009900;">(</span>amt <span style="color: #339933;">?</span> amt <span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>还有一个就是复制原始模式缓冲区字符的函数copy_from_read_buf()，这个函数定义于drivers/char/n_tty.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79913"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td> 
             <td class="code" id="p799code13"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * Helper function to speed up read_chan.  It is only called when
 * ICANON is off; it copies characters straight from the tty queue to
 * user space directly.  It can be profitably called twice; once to
 * drain the space from the tail pointer to the (physical) end of the
 * buffer, and once to drain the space from the (physical) beginning of
 * the buffer to head pointer.
 */</span>
<span style="color: #993333;">static</span> <span style="color: #000000; font-weight: bold;">inline</span> <span style="color: #993333;">int</span> copy_from_read_buf<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #339933;">,</span>
				      <span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> <span style="color: #339933;">**</span>b<span style="color: #339933;">,</span>
				      size_t <span style="color: #339933;">*</span>nr<span style="color: #009900;">)</span>
&nbsp;
<span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span> retval<span style="color: #339933;">;</span>
	ssize_t n<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> flags<span style="color: #339933;">;</span>
&nbsp;
	retval <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	spin_lock_irqsave<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	n <span style="color: #339933;">=</span> MIN<span style="color: #009900;">(</span><span style="color: #339933;">*</span>nr<span style="color: #339933;">,</span> MIN<span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>read_cnt<span style="color: #339933;">,</span> N_TTY_BUF_SIZE <span style="color: #339933;">-</span> tty<span style="color: #339933;">-&gt;</span>read_tail<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	spin_unlock_irqrestore<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>n<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		mb<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		retval <span style="color: #339933;">=</span> copy_to_user<span style="color: #009900;">(</span><span style="color: #339933;">*</span>b<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_buf<span style="color: #009900;">[</span>tty<span style="color: #339933;">-&gt;</span>read_tail<span style="color: #009900;">]</span><span style="color: #339933;">,</span> n<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		n <span style="color: #339933;">-=</span> retval<span style="color: #339933;">;</span>
		spin_lock_irqsave<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		tty<span style="color: #339933;">-&gt;</span>read_tail <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>read_tail <span style="color: #339933;">+</span> n<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;</span> <span style="color: #009900;">(</span>N_TTY_BUF_SIZE<span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		tty<span style="color: #339933;">-&gt;</span>read_cnt <span style="color: #339933;">-=</span> n<span style="color: #339933;">;</span>
		spin_unlock_irqrestore<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #339933;">*</span>b <span style="color: #339933;">+=</span> n<span style="color: #339933;">;</span>
		<span style="color: #339933;">*</span>nr <span style="color: #339933;">-=</span> n<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">return</span> retval<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>另外还有一个检查并唤醒进程的函数check_unthrottle()，定义于drivers/char/n_tty.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79914"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td> 
             <td class="code" id="p799code14"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/* 
 * Check whether to call the driver.unthrottle function.
 * We test the TTY_THROTTLED bit first so that it always
 * indicates the current state.
 */</span>
<span style="color: #993333;">static</span> <span style="color: #993333;">void</span> check_unthrottle<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span> tty<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>count <span style="color: #339933;">&amp;&amp;</span>
	    test_and_clear_bit<span style="color: #009900;">(</span>TTY_THROTTLED<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>flags<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> 
	    tty<span style="color: #339933;">-&gt;</span>driver.<span style="color: #202020;">unthrottle</span><span style="color: #009900;">)</span>
		tty<span style="color: #339933;">-&gt;</span>driver.<span style="color: #202020;">unthrottle</span><span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>对于终端控制台，最终调用的函数是con_unthrottle()，定义于drivers/char/console.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79915"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
</pre></td> 
             <td class="code" id="p799code15"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">void</span> con_unthrottle<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> vt_struct <span style="color: #339933;">*</span>vt <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> vt_struct <span style="color: #339933;">*</span><span style="color: #009900;">)</span> tty<span style="color: #339933;">-&gt;</span>driver_data<span style="color: #339933;">;</span>
&nbsp;
	wake_up_interruptible<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>vt<span style="color: #339933;">-&gt;</span>paste_wait<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>以上说的是在上层，都是以字符缓冲区为主的，但是把字符放入字符缓冲区的是下层的键盘等的驱动函数，键盘是由中断驱动的，它的中断服务程序是函数keyboard_interrupt()，每当我们按下键盘，就调用此中断服务程序，为了方便理解，我们还是给出函数调用关系图如下：<br> <a href="uploads/2013/02/2.jpg"><img class="aligncenter size-full wp-image-801" alt="2" src="uploads/2013/02/2.jpg" width="507" height="291"></a></p> 
         <p>关于键盘扫描码等识别请参考赵炯《Linux内核源代码导读》以及Diers OS中的键盘驱动部分。</p> 
         <p>我们每按下或者放开一个按键都发送一次中断请求，按下和放开产生不同的键盘扫描码，然后软件从相应I/O口读出扫描码等，其服务程序入口keyboard_interrupt()定义于drivers/char/pc_keyb.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79916"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td> 
             <td class="code" id="p799code16"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">void</span> keyboard_interrupt<span style="color: #009900;">(</span><span style="color: #993333;">int</span> irq<span style="color: #339933;">,</span> <span style="color: #993333;">void</span> <span style="color: #339933;">*</span>dev_id<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> pt_regs <span style="color: #339933;">*</span>regs<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
<span style="color: #339933;">#ifdef CONFIG_VT</span>
	kbd_pt_regs <span style="color: #339933;">=</span> regs<span style="color: #339933;">;</span>
<span style="color: #339933;">#endif</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *为了防止多处理器对一次按键的操作，这里需要加锁
 */</span>
	spin_lock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>kbd_controller_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	handle_kbd_event<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	spin_unlock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>kbd_controller_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>函数handle_kbd_event()定义于drivers/char/pc_keyb.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79917"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td> 
             <td class="code" id="p799code17"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * This reads the keyboard status port, and does the
 * appropriate action.
 *
 * It requires that we hold the keyboard controller
 * spinlock.
 */</span>
<span style="color: #993333;">static</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> handle_kbd_event<span style="color: #009900;">(</span><span style="color: #993333;">void</span><span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
<span style="color: #808080; font-style: italic;">/*
 *从控制/状态寄存器中取出键盘状态
 *	#define kbd_read_input() inb(KBD_DATA_REG)
 *	#define kbd_read_status() inb(KBD_STATUS_REG)
 */</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> status <span style="color: #339933;">=</span> kbd_read_status<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> work <span style="color: #339933;">=</span> <span style="color: #0000dd;">10000</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *在键盘状态寄存器中有个OBF(Output Buffer Full)标志，为1表示键盘
 *内部缓冲区中有数据，可以读出，全部读出后表为0，若读出1000次
 *OBF还是1那就是键盘出问题了，否则，缓冲区中可能只有一个或者
 *多个字符
 */</span>
	<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #339933;">--</span>work <span style="color: #339933;">&gt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">(</span>status <span style="color: #339933;">&amp;</span> KBD_STAT_OBF<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> scancode<span style="color: #339933;">;</span>
&nbsp;
		scancode <span style="color: #339933;">=</span> kbd_read_input<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//读出键盘扫描码</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/* Error bytes must be ignored to make the 
		   Synaptics touchpads compaq use work */</span>
<span style="color: #339933;">#if 1</span>
		<span style="color: #808080; font-style: italic;">/* Ignore error bytes */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span><span style="color: #009900;">(</span>status <span style="color: #339933;">&amp;</span> <span style="color: #009900;">(</span>KBD_STAT_GTO <span style="color: #339933;">|</span> KBD_STAT_PERR<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
<span style="color: #339933;">#endif</span>
		<span style="color: #009900;">{</span>
<span style="color: #808080; font-style: italic;">/*
 *鼠标和键盘是共用同一个I/O接口的，这里需要确定中断来源
 */</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>status <span style="color: #339933;">&amp;</span> KBD_STAT_MOUSE_OBF<span style="color: #009900;">)</span>
				handle_mouse_event<span style="color: #009900;">(</span>scancode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">else</span>
				handle_keyboard_event<span style="color: #009900;">(</span>scancode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
&nbsp;
		status <span style="color: #339933;">=</span> kbd_read_status<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>work<span style="color: #009900;">)</span>
		printk<span style="color: #009900;">(</span>KERN_ERR <span style="color: #ff0000;">"pc_keyb: controller jammed (0x%02X).<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> status<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">return</span> status<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>这里只说键盘驱动，函数handle_keyboard_event()定义于drivers/char/pc_keyb.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79918"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td> 
             <td class="code" id="p799code18"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> kbd_exists <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #993333;">static</span> <span style="color: #000000; font-weight: bold;">inline</span> <span style="color: #993333;">void</span> handle_keyboard_event<span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> scancode<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
<span style="color: #339933;">#ifdef CONFIG_VT</span>
	kbd_exists <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *键盘在在收到数据后都要送回一个KBD_REPLY_ACK予以确认
 *或者KBD_REPLY_RESEND要求重发，这两个字符应该不能作为
 *正常输入，所以用do_scknowledge()来检测并丢弃
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>do_acknowledge<span style="color: #009900;">(</span>scancode<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
<span style="color: #808080; font-style: italic;">/*
 *处理扫描码，第一个参数是扫描码，第二个参数为1表示是按下的
 *扫描码，为0表示是按键弹起的扫描码
 */</span>
		handle_scancode<span style="color: #009900;">(</span>scancode<span style="color: #339933;">,</span> <span style="color: #339933;">!</span><span style="color: #009900;">(</span>scancode <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0x80</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#endif				</span>
	tasklet_schedule<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>keyboard_tasklet<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//挂入键盘tasklet队列</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>我们知道，我们按下一个按键可能产生一个扫描码，也可能产生好几个扫描码，这个函数是对于一个扫描码的处理。</p> 
         <p>函数do_scknowledge()的代码在drivers/char/pc_keyb.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79919"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td> 
             <td class="code" id="p799code19"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">int</span> do_acknowledge<span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> scancode<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>reply_expected<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
	  <span style="color: #808080; font-style: italic;">/* Unfortunately, we must recognise these codes only if we know they
	   * are known to be valid (i.e., after sending a command), because there
	   * are some brain-damaged keyboards (yes, FOCUS 9000 again) which have
	   * keys with such codes :(
	   */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>scancode <span style="color: #339933;">==</span> KBD_REPLY_ACK<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			acknowledge <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
			reply_expected <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>scancode <span style="color: #339933;">==</span> KBD_REPLY_RESEND<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			resend <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
			reply_expected <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		<span style="color: #808080; font-style: italic;">/* Should not happen... */</span>
<span style="color: #339933;">#if 0</span>
		printk<span style="color: #009900;">(</span>KERN_DEBUG <span style="color: #ff0000;">"keyboard reply expected - got %02x<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span>
		       scancode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#endif</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>函数handle_scancode()的代码定义在drivers/char/keyboard.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79920"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
</pre></td> 
             <td class="code" id="p799code20"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">void</span> handle_scancode<span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> scancode<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> down<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> keycode<span style="color: #339933;">;</span>
	<span style="color: #993333;">char</span> up_flag <span style="color: #339933;">=</span> down <span style="color: #339933;">?</span> <span style="color: #0000dd;">0</span> <span style="color: #339933;">:</span> <span style="color: #208080;">0200</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">char</span> raw_mode<span style="color: #339933;">;</span>
&nbsp;
	pm_access<span style="color: #009900;">(</span>pm_kbd<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//电源管理接口，这里是个空函数</span>
&nbsp;
	do_poke_blanked_console <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *中断服务程序不宜太长，所以有些比较耗时的操作就应该放在bh或者tasklet中
 *完成，对于虚拟控制台的切换就是这样一种操作，为此，控制台操作有一个tasklet
 *这里将其挂入队列
 */</span>
	tasklet_schedule<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>console_tasklet<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	add_keyboard_randomness<span style="color: #009900;">(</span>scancode <span style="color: #339933;">|</span> up_flag<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//和随机数有关，增加伪随机数的随机性</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *PC机的控制台终端由显示器和键盘组成，所以除了tty_struct数据结构外
 *还有个kbd_struct数据结构，每个虚拟终端都有自己的tty_struct和kbd_struct
 *在内核中分别有两个数组ttytab[]和kbd_table[]，同时tty和kbd两个全局指针
 *分别指向当前虚拟终端的结构，fg_console是当前虚拟终端号
 */</span>
	tty <span style="color: #339933;">=</span> ttytab<span style="color: #339933;">?</span> ttytab<span style="color: #009900;">[</span>fg_console<span style="color: #009900;">]</span><span style="color: #339933;">:</span> NULL<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>tty<span style="color: #339933;">-&gt;</span>driver_data<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #808080; font-style: italic;">/*
		 * We touch the tty structure via the the ttytab array
		 * without knowing whether or not tty is open, which
		 * is inherently dangerous.  We currently rely on that
		 * fact that console_open sets tty-&gt;driver_data when
		 * it opens it, and clears it when it closes it.
		 */</span>
		tty <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	kbd <span style="color: #339933;">=</span> kbd_table <span style="color: #339933;">+</span> fg_console<span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *如果终端的键盘工作于“原始模式”VC_RAW，那就直接把扫描码放在
 *键盘的接收队列中，否则就转换成“键码”后再放入队列
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>raw_mode <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>kbd<span style="color: #339933;">-&gt;</span>kbdmode <span style="color: #339933;">==</span> VC_RAW<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		put_queue<span style="color: #009900;">(</span>scancode <span style="color: #339933;">|</span> up_flag<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #808080; font-style: italic;">/* we do not return yet, because we want to maintain
		   the key_down array, so that we have the correct
		   values when finishing RAW mode or when changing VT's */</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 *  Convert scancode to keycode
 	 *	转换键码
 	 *	#define kbd_translate pckbd_translate
	 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>kbd_translate<span style="color: #009900;">(</span>scancode<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>keycode<span style="color: #339933;">,</span> raw_mode<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
	    <span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * At this point the variable `keycode' contains the keycode.
	 * Note: the keycode must not be 0 (++Geert: on m68k 0 is valid).
	 * We keep track of the up/down status of the key, and
	 * return the keycode if in MEDIUMRAW mode.
	 */</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *全局位图key_down用来记录各个按键的状态，若按键处于弹起状态
 *那就把位图中相应位设置成0，若本来就为0则说明至少是漏了一个
 *扫描码，要调用kbd_unexpected_up()，若按键处于按下状态，就要把
 *相应位设置成1，若本来就是1，那么就说明用户在按着这个按键不放
 *就开始了自动重复功能，这时候返回的rep不为0
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>up_flag<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//按键弹起</span>
		rep <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span><span style="color: #009900;">(</span><span style="color: #339933;">!</span>test_and_clear_bit<span style="color: #009900;">(</span>keycode<span style="color: #339933;">,</span> key_down<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		    up_flag <span style="color: #339933;">=</span> kbd_unexpected_up<span style="color: #009900;">(</span>keycode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span>	<span style="color: #666666; font-style: italic;">//按键按下</span>
		rep <span style="color: #339933;">=</span> test_and_set_bit<span style="color: #009900;">(</span>keycode<span style="color: #339933;">,</span> key_down<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #339933;">#ifdef CONFIG_MAGIC_SYSRQ		/* Handle the SysRq Hack */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>keycode <span style="color: #339933;">==</span> SYSRQ_KEY<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		sysrq_pressed <span style="color: #339933;">=</span> <span style="color: #339933;">!</span>up_flag<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>sysrq_pressed<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>up_flag<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			handle_sysrq<span style="color: #009900;">(</span>kbd_sysrq_xlate<span style="color: #009900;">[</span>keycode<span style="color: #009900;">]</span><span style="color: #339933;">,</span> kbd_pt_regs<span style="color: #339933;">,</span> kbd<span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
<span style="color: #339933;">#endif</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>kbd<span style="color: #339933;">-&gt;</span>kbdmode <span style="color: #339933;">==</span> VC_MEDIUMRAW<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><span style="color: #666666; font-style: italic;">//“半原始”状态，此时已经可以放入队列</span>
		<span style="color: #808080; font-style: italic;">/* soon keycodes will require more than one byte */</span>
		put_queue<span style="color: #009900;">(</span>keycode <span style="color: #339933;">+</span> up_flag<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		raw_mode <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Most key classes will be ignored */</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * Small change in philosophy: earlier we defined repetition by
	 *	 rep = keycode == prev_keycode;
	 *	 prev_keycode = keycode;
	 * but now by the fact that the depressed key was down already.
	 * Does this ever make a difference? Yes.
	 */</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 *  Repeat a key only if the input buffers are empty or the
	 *  characters get echoed locally. This makes key repeat usable
	 *  with slow applications and under heavy loads.
	 */</span>
<span style="color: #808080; font-style: italic;">/*
 *对于正常状态的键盘输入，这个是无条件的，但是对于重复按键的输入，键盘
 *必须工作于VC_REPEAT模式，并且满足如下两个条件之一：
 *1、终端运行于echo模式
 *2、缓冲区已空
 *然后可以进行最后一步转换并将其放入队列
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>rep <span style="color: #339933;">||</span>
	    <span style="color: #009900;">(</span>vc_kbd_mode<span style="color: #009900;">(</span>kbd<span style="color: #339933;">,</span>VC_REPEAT<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> tty <span style="color: #339933;">&amp;&amp;</span>
	     <span style="color: #009900;">(</span>L_ECHO<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">||</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>driver.<span style="color: #202020;">chars_in_buffer</span><span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		u_short keysym<span style="color: #339933;">;</span>
		u_char type<span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/* the XOR below used to be an OR */</span>
		<span style="color: #993333;">int</span> shift_final <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>shift_state <span style="color: #339933;">|</span> kbd<span style="color: #339933;">-&gt;</span>slockstate<span style="color: #009900;">)</span> <span style="color: #339933;">^</span>
		    kbd<span style="color: #339933;">-&gt;</span>lockstate<span style="color: #339933;">;</span>
		ushort <span style="color: #339933;">*</span>key_map <span style="color: #339933;">=</span> key_maps<span style="color: #009900;">[</span>shift_final<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>key_map <span style="color: #339933;">!=</span> NULL<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			keysym <span style="color: #339933;">=</span> key_map<span style="color: #009900;">[</span>keycode<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
			type <span style="color: #339933;">=</span> KTYP<span style="color: #009900;">(</span>keysym<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>type <span style="color: #339933;">&gt;=</span> <span style="color: #208080;">0xf0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			    type <span style="color: #339933;">-=</span> <span style="color: #208080;">0xf0</span><span style="color: #339933;">;</span>
			    <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>raw_mode <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span> <span style="color: #009900;">(</span>TYPES_ALLOWED_IN_RAW_MODE <span style="color: #339933;">&amp;</span> <span style="color: #009900;">(</span><span style="color: #0000dd;">1</span> <span style="color: #339933;">&lt;&lt;</span> type<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
			    <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>type <span style="color: #339933;">==</span> KT_LETTER<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				type <span style="color: #339933;">=</span> KT_LATIN<span style="color: #339933;">;</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>vc_kbd_led<span style="color: #009900;">(</span>kbd<span style="color: #339933;">,</span> VC_CAPSLOCK<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				    key_map <span style="color: #339933;">=</span> key_maps<span style="color: #009900;">[</span>shift_final <span style="color: #339933;">^</span> <span style="color: #009900;">(</span><span style="color: #0000dd;">1</span><span style="color: #339933;">&lt;&lt;</span>KG_SHIFT<span style="color: #009900;">)</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
				    <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>key_map<span style="color: #009900;">)</span>
				      keysym <span style="color: #339933;">=</span> key_map<span style="color: #009900;">[</span>keycode<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
				<span style="color: #009900;">}</span>
			    <span style="color: #009900;">}</span>
			    <span style="color: #009900;">(</span><span style="color: #339933;">*</span>key_handler<span style="color: #009900;">[</span>type<span style="color: #009900;">]</span><span style="color: #009900;">)</span><span style="color: #009900;">(</span>keysym <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0xff</span><span style="color: #339933;">,</span> up_flag<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			    <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>type <span style="color: #339933;">!=</span> KT_SLOCK<span style="color: #009900;">)</span>
			      kbd<span style="color: #339933;">-&gt;</span>slockstate <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
			    <span style="color: #808080; font-style: italic;">/* maybe only if (kbd-&gt;kbdmode == VC_UNICODE) ? */</span>
			    <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>up_flag <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span>raw_mode<span style="color: #009900;">)</span>
			      to_utf8<span style="color: #009900;">(</span>keysym<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
		<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
			<span style="color: #808080; font-style: italic;">/* maybe beep? */</span>
			<span style="color: #808080; font-style: italic;">/* we have at least to update shift_state */</span>
<span style="color: #339933;">#if 1			/* how? two almost equivalent choices follow */</span>
			compute_shiftstate<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			kbd<span style="color: #339933;">-&gt;</span>slockstate <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* play it safe */</span>
<span style="color: #339933;">#else</span>
			keysym <span style="color: #339933;">=</span> U<span style="color: #009900;">(</span>plain_map<span style="color: #009900;">[</span>keycode<span style="color: #009900;">]</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			type <span style="color: #339933;">=</span> KTYP<span style="color: #009900;">(</span>keysym<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>type <span style="color: #339933;">==</span> KT_SHIFT<span style="color: #009900;">)</span>
			  <span style="color: #009900;">(</span><span style="color: #339933;">*</span>key_handler<span style="color: #009900;">[</span>type<span style="color: #009900;">]</span><span style="color: #009900;">)</span><span style="color: #009900;">(</span>keysym <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0xff</span><span style="color: #339933;">,</span> up_flag<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#endif</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>由于具体转换方式不是我们所关心的内容，所以这里就不讨论了。</p> 
         <p>这里需要讲的就是一个put_queue()函数，也就是将字符放入缓冲区的函数，这个函数定义于drivers/char/keyboard.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79921"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
</pre></td> 
             <td class="code" id="p799code21"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">void</span> put_queue<span style="color: #009900;">(</span><span style="color: #993333;">int</span> ch<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	wake_up<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>keypress_wait<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		tty_insert_flip_char<span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> ch<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		con_schedule_flip<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>首先唤醒等待键盘输入操作的进程，然后将未经加工的原始字符放入filp缓冲区（前面说过的），然后进行tasklet的挂入操作，将后续操作留给tasklet。</p> 
         <p>函数tty_insert_flip_char()定义于include/linux/tty_flip.h中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79922"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td> 
             <td class="code" id="p799code22"><pre class="c" style="font-family:monospace;">_INLINE_ <span style="color: #993333;">void</span> tty_insert_flip_char<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #339933;">,</span>
				   <span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> ch<span style="color: #339933;">,</span> <span style="color: #993333;">char</span> flag<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">count</span> <span style="color: #339933;">&lt;</span> TTY_FLIPBUF_SIZE<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">count</span><span style="color: #339933;">++;</span>
		<span style="color: #339933;">*</span>tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">flag_buf_ptr</span><span style="color: #339933;">++</span> <span style="color: #339933;">=</span> flag<span style="color: #339933;">;</span>
		<span style="color: #339933;">*</span>tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">char_buf_ptr</span><span style="color: #339933;">++</span> <span style="color: #339933;">=</span> ch<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>函数con_schedule_flip()定义在include/linux/kbd_kern.h中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79923"> 
             <td class="line_numbers"><pre>1
2
3
4
5
</pre></td> 
             <td class="code" id="p799code23"><pre class="c" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">extern</span> <span style="color: #000000; font-weight: bold;">inline</span> <span style="color: #993333;">void</span> con_schedule_flip<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>t<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	queue_task<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>t<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">tqueue</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>con_task_queue<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	tasklet_schedule<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>console_tasklet<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>其目的就是将一个指向console_tasklet()的指针通过一个结构挂入tasklet的执行队列。</p> 
         <p>这个tasklet定义在drivers/char/console.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79924"> 
             <td class="line_numbers"><pre>1
</pre></td> 
             <td class="code" id="p799code24"><pre class="c" style="font-family:monospace;">DECLARE_TASKLET_DISABLED<span style="color: #009900;">(</span>console_tasklet<span style="color: #339933;">,</span> console_softint<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>实际执行程序是console_softint()，此后中断服务程序已经完成，剩下的就交给tasklet了。</p> 
         <p>为了理解方便，我们也给出函数调用关系图：</p> 
         <p><a href="uploads/2013/02/3.jpg"><img class="aligncenter size-full wp-image-802" alt="3" src="uploads/2013/02/3.jpg" width="394" height="614"></a></p> 
         <p>函数console_softint()定义在drivers/char/console.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79925"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td> 
             <td class="code" id="p799code25"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * This is the console switching tasklet.
 *
 * Doing console switching in a tasklet allows
 * us to do the switches asynchronously (needed when we want
 * to switch due to a keyboard interrupt).  Synchronization
 * with other console code and prevention of re-entrancy is
 * ensured with console_lock.
 */</span>
<span style="color: #993333;">static</span> <span style="color: #993333;">void</span> console_softint<span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> ignored<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #808080; font-style: italic;">/* Runs the task queue outside of the console lock.  These
	 * callbacks can come back into the console code and thus
	 * will perform their own locking.
	 */</span>
	run_task_queue<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>con_task_queue<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	spin_lock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>console_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>want_console <span style="color: #339933;">&gt;=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>want_console <span style="color: #339933;">!=</span> fg_console <span style="color: #339933;">&amp;&amp;</span> vc_cons_allocated<span style="color: #009900;">(</span>want_console<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			hide_cursor<span style="color: #009900;">(</span>fg_console<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			change_console<span style="color: #009900;">(</span>want_console<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #808080; font-style: italic;">/* we only changed when the console had already
			   been allocated - a new console is not created
			   in an interrupt routine */</span>
		<span style="color: #009900;">}</span>
		want_console <span style="color: #339933;">=</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>do_poke_blanked_console<span style="color: #009900;">)</span> <span style="color: #009900;">{</span> <span style="color: #808080; font-style: italic;">/* do not unblank for a LED change */</span>
		do_poke_blanked_console <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		poke_blanked_console<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>scrollback_delta<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">int</span> currcons <span style="color: #339933;">=</span> fg_console<span style="color: #339933;">;</span>
		clear_selection<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>vcmode <span style="color: #339933;">==</span> KD_TEXT<span style="color: #009900;">)</span>
			sw<span style="color: #339933;">-&gt;</span>con_scrolldelta<span style="color: #009900;">(</span>vc_cons<span style="color: #009900;">[</span>currcons<span style="color: #009900;">]</span>.<span style="color: #202020;">d</span><span style="color: #339933;">,</span> scrollback_delta<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		scrollback_delta <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	spin_unlock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>console_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>这里重点关心run_task_queue()的调用，在前面我们看到con_schedule_flip()中把相应tty_struct结构中的flip.tqueue挂入了这个队列，而在前面的initialize_tty_struct()中将其函数指针设置成了指向flush_to_ldisc()函数，所以在tasklet中执行的是flush_to_ldisc()函数，这个函数的代码定义在drivers/char/tty_io.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79926"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td> 
             <td class="code" id="p799code26"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * This routine is called out of the software interrupt to flush data
 * from the flip buffer to the line discipline.
 */</span>
<span style="color: #993333;">static</span> <span style="color: #993333;">void</span> flush_to_ldisc<span style="color: #009900;">(</span><span style="color: #993333;">void</span> <span style="color: #339933;">*</span>private_<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span><span style="color: #009900;">)</span> private_<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span>	<span style="color: #339933;">*</span>cp<span style="color: #339933;">;</span>
	<span style="color: #993333;">char</span>		<span style="color: #339933;">*</span>fp<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span>		count<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> flags<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>test_bit<span style="color: #009900;">(</span>TTY_DONT_FLIP<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>flags<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
<span style="color: #808080; font-style: italic;">/*
 *若TTY_DONT_FLIP为1就将其转入tq_timer队列，使其在关中断
 *条件下执行
 */</span>
		queue_task<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">tqueue</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tq_timer<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
<span style="color: #808080; font-style: italic;">/*
 *由于tasklet的特殊性，无法关闭中断等，这里为了防止一个CPU对缓冲区
 *的多次操作，使得操作被打乱，所以在tty_flip_buffer数据结构中定义的缓冲区
 *大小为2*TTY_FLIPBUF_SIZE，就像一张纸的正反面，每个TTY_FLIPBUF_SIZE
 *是一面，循环反复使用不同面
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">buf_num</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		cp <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">char_buf</span> <span style="color: #339933;">+</span> TTY_FLIPBUF_SIZE<span style="color: #339933;">;</span>
		fp <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">flag_buf</span> <span style="color: #339933;">+</span> TTY_FLIPBUF_SIZE<span style="color: #339933;">;</span>
		tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">buf_num</span> <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
		save_flags<span style="color: #009900;">(</span>flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span> cli<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">char_buf_ptr</span> <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">char_buf</span><span style="color: #339933;">;</span>
		tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">flag_buf_ptr</span> <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">flag_buf</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
		cp <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">char_buf</span><span style="color: #339933;">;</span>
		fp <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">flag_buf</span><span style="color: #339933;">;</span>
		tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">buf_num</span> <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
&nbsp;
		save_flags<span style="color: #009900;">(</span>flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span> cli<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">char_buf_ptr</span> <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">char_buf</span> <span style="color: #339933;">+</span> TTY_FLIPBUF_SIZE<span style="color: #339933;">;</span>
		tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">flag_buf_ptr</span> <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">flag_buf</span> <span style="color: #339933;">+</span> TTY_FLIPBUF_SIZE<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	count <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">count</span><span style="color: #339933;">;</span>
	tty<span style="color: #339933;">-&gt;</span>flip.<span style="color: #202020;">count</span> <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	restore_flags<span style="color: #009900;">(</span>flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *本函数的主要作用是调用函数将数据从flip缓冲区中搬运到另一个缓冲区中
 *并且加以处理
 */</span>
	tty<span style="color: #339933;">-&gt;</span>ldisc.<span style="color: #202020;">receive_buf</span><span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> cp<span style="color: #339933;">,</span> fp<span style="color: #339933;">,</span> count<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>具体的receive_buf指针指向函数n_tty_receive_buf()函数，这个函数定义在drivers/char/n_tty.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79927"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
</pre></td> 
             <td class="code" id="p799code27"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">void</span> n_tty_receive_buf<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #339933;">,</span> <span style="color: #993333;">const</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>cp<span style="color: #339933;">,</span>
			      <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>fp<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> count<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>p<span style="color: #339933;">;</span>
	<span style="color: #993333;">char</span> <span style="color: #339933;">*</span>f<span style="color: #339933;">,</span> flags <span style="color: #339933;">=</span> TTY_NORMAL<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span>	i<span style="color: #339933;">;</span>
	<span style="color: #993333;">char</span>	buf<span style="color: #009900;">[</span><span style="color: #0000dd;">64</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> cpuflags<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>tty<span style="color: #339933;">-&gt;</span>read_buf<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *如果工作在real_raw模式就是最原始的模式，那么数据不需要经过半毛钱的
 *修改，直接从flip的缓冲区复制进tty的缓冲区中，raw也是原始模式，但是
 *没有real_raw原始
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>real_raw<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		spin_lock_irqsave<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_lock<span style="color: #339933;">,</span> cpuflags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		i <span style="color: #339933;">=</span> MIN<span style="color: #009900;">(</span>count<span style="color: #339933;">,</span> MIN<span style="color: #009900;">(</span>N_TTY_BUF_SIZE <span style="color: #339933;">-</span> tty<span style="color: #339933;">-&gt;</span>read_cnt<span style="color: #339933;">,</span>
				   N_TTY_BUF_SIZE <span style="color: #339933;">-</span> tty<span style="color: #339933;">-&gt;</span>read_head<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		memcpy<span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>read_buf <span style="color: #339933;">+</span> tty<span style="color: #339933;">-&gt;</span>read_head<span style="color: #339933;">,</span> cp<span style="color: #339933;">,</span> i<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		tty<span style="color: #339933;">-&gt;</span>read_head <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>read_head <span style="color: #339933;">+</span> i<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;</span> <span style="color: #009900;">(</span>N_TTY_BUF_SIZE<span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		tty<span style="color: #339933;">-&gt;</span>read_cnt <span style="color: #339933;">+=</span> i<span style="color: #339933;">;</span>
		cp <span style="color: #339933;">+=</span> i<span style="color: #339933;">;</span>
		count <span style="color: #339933;">-=</span> i<span style="color: #339933;">;</span>
&nbsp;
		i <span style="color: #339933;">=</span> MIN<span style="color: #009900;">(</span>count<span style="color: #339933;">,</span> MIN<span style="color: #009900;">(</span>N_TTY_BUF_SIZE <span style="color: #339933;">-</span> tty<span style="color: #339933;">-&gt;</span>read_cnt<span style="color: #339933;">,</span>
			       N_TTY_BUF_SIZE <span style="color: #339933;">-</span> tty<span style="color: #339933;">-&gt;</span>read_head<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		memcpy<span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>read_buf <span style="color: #339933;">+</span> tty<span style="color: #339933;">-&gt;</span>read_head<span style="color: #339933;">,</span> cp<span style="color: #339933;">,</span> i<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		tty<span style="color: #339933;">-&gt;</span>read_head <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>read_head <span style="color: #339933;">+</span> i<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;</span> <span style="color: #009900;">(</span>N_TTY_BUF_SIZE<span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		tty<span style="color: #339933;">-&gt;</span>read_cnt <span style="color: #339933;">+=</span> i<span style="color: #339933;">;</span>
		spin_unlock_irqrestore<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_lock<span style="color: #339933;">,</span> cpuflags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
<span style="color: #808080; font-style: italic;">/*
 *否则就要逐个字节地搬运处理加工
 */</span>
		<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>i<span style="color: #339933;">=</span>count<span style="color: #339933;">,</span> p <span style="color: #339933;">=</span> cp<span style="color: #339933;">,</span> f <span style="color: #339933;">=</span> fp<span style="color: #339933;">;</span> i<span style="color: #339933;">;</span> i<span style="color: #339933;">--,</span> p<span style="color: #339933;">++</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>f<span style="color: #009900;">)</span>
				flags <span style="color: #339933;">=</span> <span style="color: #339933;">*</span>f<span style="color: #339933;">++;</span>
<span style="color: #808080; font-style: italic;">/*
 *在由函数tty_insert_flip_char()写入flip缓冲区的时候总是将其对应
 *的flag字段设置成0，所以这里总是调用n_tty_receive_char()
 */</span>
			<span style="color: #b1b100;">switch</span> <span style="color: #009900;">(</span>flags<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #b1b100;">case</span> TTY_NORMAL<span style="color: #339933;">:</span>
				n_tty_receive_char<span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>p<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//加工复制一个字符</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">case</span> TTY_BREAK<span style="color: #339933;">:</span>
				n_tty_receive_break<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">case</span> TTY_PARITY<span style="color: #339933;">:</span>
			<span style="color: #b1b100;">case</span> TTY_FRAME<span style="color: #339933;">:</span>
				n_tty_receive_parity_error<span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>p<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">case</span> TTY_OVERRUN<span style="color: #339933;">:</span>
				n_tty_receive_overrun<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">default</span><span style="color: #339933;">:</span>
				printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"%s: unknown flag %d<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span>
				       tty_name<span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> buf<span style="color: #009900;">)</span><span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
		<span style="color: #009900;">}</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>driver.<span style="color: #202020;">flush_chars</span><span style="color: #009900;">)</span>
			tty<span style="color: #339933;">-&gt;</span>driver.<span style="color: #202020;">flush_chars</span><span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *在规范模式下，当缓冲区中接收了平常字符并不唤醒可能正在睡眠的进程
 *直到接收到了'\n'或者EOF等这些特殊字符才唤醒，而对于非规范模式当
 *接收到一定的数量的字符，也就是说字符数达到了前面设置的minimun_to_wake
 *的时候就唤醒
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>tty<span style="color: #339933;">-&gt;</span>icanon <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>read_cnt <span style="color: #339933;">&gt;=</span> tty<span style="color: #339933;">-&gt;</span>minimum_to_wake<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		kill_fasync<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>fasync<span style="color: #339933;">,</span> SIGIO<span style="color: #339933;">,</span> POLL_IN<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>waitqueue_active<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_wait<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			wake_up_interruptible<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_wait<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * Check the remaining room for the input canonicalization
	 * mode.  We don't want to throttle the driver if we're in
	 * canonical mode and don't have a newline yet!
	 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>n_tty_receive_room<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">&lt;</span> TTY_THRESHOLD_THROTTLE<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #808080; font-style: italic;">/* check TTY_THROTTLED first so it indicates our state */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>test_and_set_bit<span style="color: #009900;">(</span>TTY_THROTTLED<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>flags<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span>
		    tty<span style="color: #339933;">-&gt;</span>driver.<span style="color: #202020;">throttle</span><span style="color: #009900;">)</span>
			tty<span style="color: #339933;">-&gt;</span>driver.<span style="color: #202020;">throttle</span><span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>加工并且复制字符的函数n_tty_receive_char()定义在drivers/char/n_tty.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79928"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
</pre></td> 
             <td class="code" id="p799code28"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #000000; font-weight: bold;">inline</span> <span style="color: #993333;">void</span> n_tty_receive_char<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> c<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>raw<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//运行于原始模式，直接搬运，已经通过上一个函数的错误检查</span>
		put_tty_queue<span style="color: #009900;">(</span>c<span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
 	 *控制字符等处理
 	 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>stopped <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span>tty<span style="color: #339933;">-&gt;</span>flow_stopped <span style="color: #339933;">&amp;&amp;</span>
	    I_IXON<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> I_IXANY<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		start_tty<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>I_ISTRIP<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		c <span style="color: #339933;">&amp;=</span> <span style="color: #208080;">0x7f</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>I_IUCLC<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> L_IEXTEN<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		c<span style="color: #339933;">=</span>tolower<span style="color: #009900;">(</span>c<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>closing<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>I_IXON<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">==</span> START_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				start_tty<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">==</span> STOP_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				stop_tty<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * If the previous character was LNEXT, or we know that this
	 * character is not one of the characters that we'll have to
	 * handle specially, do shortcut processing to speed things
	 * up.
	 */</span>
<span style="color: #808080; font-style: italic;">/*
 *process_char_map中指明了需要特殊处理的字符，这里是不需要特殊处理的
 *字符，另外还有一种情况就是上个字符是lnext，表明了这次不是一个字符
 *还有其他的字符应该一起处理（？），然后复制进缓冲区
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>test_bit<span style="color: #009900;">(</span>c<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>process_char_map<span style="color: #009900;">)</span> <span style="color: #339933;">||</span> tty<span style="color: #339933;">-&gt;</span>lnext<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		finish_erasing<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//不许特殊处理，所以不许eras，结束终端退字符状态</span>
		tty<span style="color: #339933;">-&gt;</span>lnext <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>L_ECHO<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//字符需要回显</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>read_cnt <span style="color: #339933;">&gt;=</span> N_TTY_BUF_SIZE<span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
<span style="color: #808080; font-style: italic;">/*
 *若read_buf[]中已满，无空位接收当前字符，需要鸣一声
 *实际调用的是tty-&gt;driver.put_char()，指向函数
 *tty_default_put_char()
 */</span>
				put_char<span style="color: #009900;">(</span><span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\a</span>'</span><span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* beep if no space */</span>
				<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			<span style="color: #808080; font-style: italic;">/* Record the column of first canon char. */</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>canon_head <span style="color: #339933;">==</span> tty<span style="color: #339933;">-&gt;</span>read_head<span style="color: #009900;">)</span>
				tty<span style="color: #339933;">-&gt;</span>canon_column <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>column<span style="color: #339933;">;</span>
			echo_char<span style="color: #009900;">(</span>c<span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//回显字符</span>
		<span style="color: #009900;">}</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>I_PARMRK<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> c <span style="color: #339933;">==</span> <span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span><span style="color: #009900;">)</span> <span style="color: #ff0000;">'<span style="color: #006699; font-weight: bold;">\377</span>'</span><span style="color: #009900;">)</span>
			put_tty_queue<span style="color: #009900;">(</span>c<span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		put_tty_queue<span style="color: #009900;">(</span>c<span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">==</span> <span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\r</span>'</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//'\r'字符的处理</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>I_IGNCR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>I_ICRNL<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			c <span style="color: #339933;">=</span> <span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\n</span>'</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">==</span> <span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\n</span>'</span> <span style="color: #339933;">&amp;&amp;</span> I_INLCR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span>	<span style="color: #666666; font-style: italic;">//'\n'字符的处理</span>
		c <span style="color: #339933;">=</span> <span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\r</span>'</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>I_IXON<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">==</span> START_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			start_tty<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">==</span> STOP_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			stop_tty<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>L_ISIG<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//发出信号的字符，例如Ctrl-C、Ctrl-Z等</span>
		<span style="color: #993333;">int</span> signal<span style="color: #339933;">;</span>
		signal <span style="color: #339933;">=</span> SIGINT<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">==</span> INTR_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> send_signal<span style="color: #339933;">;</span>
		signal <span style="color: #339933;">=</span> SIGQUIT<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">==</span> QUIT_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> send_signal<span style="color: #339933;">;</span>
		signal <span style="color: #339933;">=</span> SIGTSTP<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">==</span> SUSP_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
send_signal<span style="color: #339933;">:</span>
			isig<span style="color: #009900;">(</span>signal<span style="color: #339933;">,</span> tty<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>icanon<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//规范模式的加工处理</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">==</span> ERASE_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">||</span> c <span style="color: #339933;">==</span> KILL_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">||</span>
		    <span style="color: #009900;">(</span>c <span style="color: #339933;">==</span> WERASE_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> L_IEXTEN<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			eraser<span style="color: #009900;">(</span>c<span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">==</span> LNEXT_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> L_IEXTEN<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			tty<span style="color: #339933;">-&gt;</span>lnext <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>L_ECHO<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				finish_erasing<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>L_ECHOCTL<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
					put_char<span style="color: #009900;">(</span><span style="color: #ff0000;">'^'</span><span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
					put_char<span style="color: #009900;">(</span><span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\b</span>'</span><span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #009900;">}</span>
			<span style="color: #009900;">}</span>
			<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">==</span> REPRINT_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> L_ECHO<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span>
		    L_IEXTEN<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> tail <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>canon_head<span style="color: #339933;">;</span>
&nbsp;
			finish_erasing<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			echo_char<span style="color: #009900;">(</span>c<span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			opost<span style="color: #009900;">(</span><span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\n</span>'</span><span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>tail <span style="color: #339933;">!=</span> tty<span style="color: #339933;">-&gt;</span>read_head<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				echo_char<span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>read_buf<span style="color: #009900;">[</span>tail<span style="color: #009900;">]</span><span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				tail <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>tail<span style="color: #339933;">+</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span> <span style="color: #339933;">&amp;</span> <span style="color: #009900;">(</span>N_TTY_BUF_SIZE<span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">==</span> <span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\n</span>'</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>L_ECHO<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">||</span> L_ECHONL<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>read_cnt <span style="color: #339933;">&gt;=</span> N_TTY_BUF_SIZE<span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
					put_char<span style="color: #009900;">(</span><span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\a</span>'</span><span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
					<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
				<span style="color: #009900;">}</span>
				opost<span style="color: #009900;">(</span><span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\n</span>'</span><span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			<span style="color: #b1b100;">goto</span> handle_newline<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">==</span> EOF_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		        <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>canon_head <span style="color: #339933;">!=</span> tty<span style="color: #339933;">-&gt;</span>read_head<span style="color: #009900;">)</span>
			        set_bit<span style="color: #009900;">(</span>TTY_PUSH<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			c <span style="color: #339933;">=</span> __DISABLED_CHAR<span style="color: #339933;">;</span>
			<span style="color: #b1b100;">goto</span> handle_newline<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>c <span style="color: #339933;">==</span> EOL_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">||</span>
		    <span style="color: #009900;">(</span>c <span style="color: #339933;">==</span> EOL2_CHAR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> L_IEXTEN<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #808080; font-style: italic;">/*
			 * XXX are EOL_CHAR and EOL2_CHAR echoed?!?
			 */</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>L_ECHO<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>read_cnt <span style="color: #339933;">&gt;=</span> N_TTY_BUF_SIZE<span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
					put_char<span style="color: #009900;">(</span><span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\a</span>'</span><span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
					<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
				<span style="color: #009900;">}</span>
				<span style="color: #808080; font-style: italic;">/* Record the column of first canon char. */</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>canon_head <span style="color: #339933;">==</span> tty<span style="color: #339933;">-&gt;</span>read_head<span style="color: #009900;">)</span>
					tty<span style="color: #339933;">-&gt;</span>canon_column <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>column<span style="color: #339933;">;</span>
				echo_char<span style="color: #009900;">(</span>c<span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			<span style="color: #808080; font-style: italic;">/*
			 * XXX does PARMRK doubling happen for
			 * EOL_CHAR and EOL2_CHAR?
			 */</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>I_PARMRK<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> c <span style="color: #339933;">==</span> <span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span><span style="color: #009900;">)</span> <span style="color: #ff0000;">'<span style="color: #006699; font-weight: bold;">\377</span>'</span><span style="color: #009900;">)</span>
				put_tty_queue<span style="color: #009900;">(</span>c<span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
		handle_newline<span style="color: #339933;">:</span>
			set_bit<span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>read_head<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			put_tty_queue<span style="color: #009900;">(</span>c<span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			tty<span style="color: #339933;">-&gt;</span>canon_head <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>read_head<span style="color: #339933;">;</span>
			tty<span style="color: #339933;">-&gt;</span>canon_data<span style="color: #339933;">++;</span>
			kill_fasync<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>fasync<span style="color: #339933;">,</span> SIGIO<span style="color: #339933;">,</span> POLL_IN<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>waitqueue_active<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_wait<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				wake_up_interruptible<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_wait<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
&nbsp;
	finish_erasing<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>L_ECHO<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>read_cnt <span style="color: #339933;">&gt;=</span> N_TTY_BUF_SIZE<span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			put_char<span style="color: #009900;">(</span><span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\a</span>'</span><span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* beep if no space */</span>
			<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">==</span> <span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\n</span>'</span><span style="color: #009900;">)</span>
			opost<span style="color: #009900;">(</span><span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\n</span>'</span><span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
			<span style="color: #808080; font-style: italic;">/* Record the column of first canon char. */</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>canon_head <span style="color: #339933;">==</span> tty<span style="color: #339933;">-&gt;</span>read_head<span style="color: #009900;">)</span>
				tty<span style="color: #339933;">-&gt;</span>canon_column <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>column<span style="color: #339933;">;</span>
			echo_char<span style="color: #009900;">(</span>c<span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>I_PARMRK<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> c <span style="color: #339933;">==</span> <span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span><span style="color: #009900;">)</span> <span style="color: #ff0000;">'<span style="color: #006699; font-weight: bold;">\377</span>'</span><span style="color: #009900;">)</span>
		put_tty_queue<span style="color: #009900;">(</span>c<span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	put_tty_queue<span style="color: #009900;">(</span>c<span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>函数put_tty_queue()定义在n_tty.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79929"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td> 
             <td class="code" id="p799code29"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #000000; font-weight: bold;">inline</span> <span style="color: #993333;">void</span> put_tty_queue<span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> c<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> flags<span style="color: #339933;">;</span>
	<span style="color: #808080; font-style: italic;">/*
	 *	The problem of stomping on the buffers ends here.
	 *	Why didn't anyone see this one comming? --AJK
	*/</span>
	spin_lock_irqsave<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *若缓冲区已写满，则丢弃新来的输入
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>read_cnt <span style="color: #339933;">&lt;</span> N_TTY_BUF_SIZE<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		tty<span style="color: #339933;">-&gt;</span>read_buf<span style="color: #009900;">[</span>tty<span style="color: #339933;">-&gt;</span>read_head<span style="color: #009900;">]</span> <span style="color: #339933;">=</span> c<span style="color: #339933;">;</span>
		tty<span style="color: #339933;">-&gt;</span>read_head <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>read_head <span style="color: #339933;">+</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span> <span style="color: #339933;">&amp;</span> <span style="color: #009900;">(</span>N_TTY_BUF_SIZE<span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		tty<span style="color: #339933;">-&gt;</span>read_cnt<span style="color: #339933;">++;</span>
	<span style="color: #009900;">}</span>
	spin_unlock_irqrestore<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tty<span style="color: #339933;">-&gt;</span>read_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>回显函数echo_char()定义在n_tty.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79930"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td> 
             <td class="code" id="p799code30"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">void</span> echo_char<span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> c<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>L_ECHOCTL<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> iscntrl<span style="color: #009900;">(</span>c<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> c <span style="color: #339933;">!=</span> <span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\t</span>'</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		put_char<span style="color: #009900;">(</span><span style="color: #ff0000;">'^'</span><span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		put_char<span style="color: #009900;">(</span>c <span style="color: #339933;">^</span> <span style="color: #208080;">0100</span><span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		tty<span style="color: #339933;">-&gt;</span>column <span style="color: #339933;">+=</span> <span style="color: #0000dd;">2</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span>
		opost<span style="color: #009900;">(</span>c<span style="color: #339933;">,</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>函数处理在同时按下了Ctrl键的字符，要显示个“^”字符，对于正常输入的字符要使用opost()来进一步处理，这个函数定义在n_tty.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79931"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre></td> 
             <td class="code" id="p799code31"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * Perform OPOST processing.  Returns -1 when the output device is
 * full and the character must be retried.
 */</span>
<span style="color: #993333;">static</span> <span style="color: #993333;">int</span> opost<span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> c<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span>	space<span style="color: #339933;">,</span> spaces<span style="color: #339933;">;</span>
&nbsp;
	space <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>driver.<span style="color: #202020;">write_room</span><span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//检查写缓冲区是否有空间</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>space<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>O_OPOST<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//对特殊字符的处理</span>
		<span style="color: #b1b100;">switch</span> <span style="color: #009900;">(</span>c<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">case</span> <span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\n</span>'</span><span style="color: #339933;">:</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>O_ONLRET<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				tty<span style="color: #339933;">-&gt;</span>column <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>O_ONLCR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>space <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">2</span><span style="color: #009900;">)</span>
					<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
				tty<span style="color: #339933;">-&gt;</span>driver.<span style="color: #202020;">put_char</span><span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> <span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\r</span>'</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				tty<span style="color: #339933;">-&gt;</span>column <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			tty<span style="color: #339933;">-&gt;</span>canon_column <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>column<span style="color: #339933;">;</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">case</span> <span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\r</span>'</span><span style="color: #339933;">:</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>O_ONOCR<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> tty<span style="color: #339933;">-&gt;</span>column <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
				<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>O_OCRNL<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				c <span style="color: #339933;">=</span> <span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\n</span>'</span><span style="color: #339933;">;</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>O_ONLRET<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
					tty<span style="color: #339933;">-&gt;</span>canon_column <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>column <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			tty<span style="color: #339933;">-&gt;</span>canon_column <span style="color: #339933;">=</span> tty<span style="color: #339933;">-&gt;</span>column <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">case</span> <span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\t</span>'</span><span style="color: #339933;">:</span>
			spaces <span style="color: #339933;">=</span> <span style="color: #0000dd;">8</span> <span style="color: #339933;">-</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>column <span style="color: #339933;">&amp;</span> <span style="color: #0000dd;">7</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>O_TABDLY<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span> <span style="color: #339933;">==</span> XTABS<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>space <span style="color: #339933;">&lt;</span> spaces<span style="color: #009900;">)</span>
					<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
				tty<span style="color: #339933;">-&gt;</span>column <span style="color: #339933;">+=</span> spaces<span style="color: #339933;">;</span>
				tty<span style="color: #339933;">-&gt;</span>driver.<span style="color: #202020;">write</span><span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">"        "</span><span style="color: #339933;">,</span> spaces<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			tty<span style="color: #339933;">-&gt;</span>column <span style="color: #339933;">+=</span> spaces<span style="color: #339933;">;</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">case</span> <span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\b</span>'</span><span style="color: #339933;">:</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tty<span style="color: #339933;">-&gt;</span>column <span style="color: #339933;">&gt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
				tty<span style="color: #339933;">-&gt;</span>column<span style="color: #339933;">--;</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">default</span><span style="color: #339933;">:</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>O_OLCUC<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				c <span style="color: #339933;">=</span> toupper<span style="color: #009900;">(</span>c<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>iscntrl<span style="color: #009900;">(</span>c<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				tty<span style="color: #339933;">-&gt;</span>column<span style="color: #339933;">++;</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
	tty<span style="color: #339933;">-&gt;</span>driver.<span style="color: #202020;">put_char</span><span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> c<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//写入写缓冲区</span>
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>tty-&gt;driver.putchar指针指向函数tty_default_put_char()，这个函数定义在drivers/char/tty_io.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79932"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
</pre></td> 
             <td class="code" id="p799code32"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * The default put_char routine if the driver did not define one.
 */</span>
<span style="color: #993333;">void</span> tty_default_put_char<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> ch<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	tty<span style="color: #339933;">-&gt;</span>driver.<span style="color: #202020;">write</span><span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>ch<span style="color: #339933;">,</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>对于控制台终端，这个指针指向的是函数con_write()，这个函数定义在drivers/char/console.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79933"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td> 
             <td class="code" id="p799code33"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 *	/dev/ttyN handling
 */</span>
&nbsp;
<span style="color: #993333;">static</span> <span style="color: #993333;">int</span> con_write<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span> tty<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> from_user<span style="color: #339933;">,</span>
		     <span style="color: #993333;">const</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>buf<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> count<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
<span style="color: #808080; font-style: italic;">/*
 *当参数from_user为1时表示要写的内容来自用户空间，0表示来自系统空间
 *buf是要写的字符缓冲区，count是长度
 *这个函数也是系统调用write()的入口
 */</span>
	<span style="color: #993333;">int</span>	retval<span style="color: #339933;">;</span>
&nbsp;
	pm_access<span style="color: #009900;">(</span>pm_con<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	retval <span style="color: #339933;">=</span> do_con_write<span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> from_user<span style="color: #339933;">,</span> buf<span style="color: #339933;">,</span> count<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	con_flush_chars<span style="color: #009900;">(</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">return</span> retval<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>函数do_con_write()定义在drivers/char/console.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=799&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p79934"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
</pre></td> 
             <td class="code" id="p799code34"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">int</span> do_con_write<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span> tty<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> from_user<span style="color: #339933;">,</span>
			<span style="color: #993333;">const</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>buf<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> count<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
<span style="color: #339933;">#ifdef VT_BUF_VRAM_ONLY</span>
<span style="color: #339933;">#define FLUSH do { } while(0);</span>
<span style="color: #339933;">#else</span>
<span style="color: #339933;">#define FLUSH if (draw_x &gt;= 0) { \
	sw-&gt;con_putcs(vc_cons[currcons].d, (u16 *)draw_from, (u16 *)draw_to-(u16 *)draw_from, y, draw_x); \
	draw_x = -1; \
	}</span>
<span style="color: #339933;">#endif</span>
&nbsp;
	<span style="color: #993333;">int</span> c<span style="color: #339933;">,</span> tc<span style="color: #339933;">,</span> ok<span style="color: #339933;">,</span> n <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> draw_x <span style="color: #339933;">=</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> currcons<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> draw_from <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> draw_to <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> vt_struct <span style="color: #339933;">*</span>vt <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> vt_struct <span style="color: #339933;">*</span><span style="color: #009900;">)</span>tty<span style="color: #339933;">-&gt;</span>driver_data<span style="color: #339933;">;</span>
	u16 himask<span style="color: #339933;">,</span> charmask<span style="color: #339933;">;</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>orig_buf <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> orig_count<span style="color: #339933;">;</span>
&nbsp;
	currcons <span style="color: #339933;">=</span> vt<span style="color: #339933;">-&gt;</span>vc_num<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>vc_cons_allocated<span style="color: #009900;">(</span>currcons<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
	    <span style="color: #808080; font-style: italic;">/* could this happen? */</span>
	    <span style="color: #993333;">static</span> <span style="color: #993333;">int</span> error <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	    <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>error<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		error <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
		printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"con_write: tty %d not allocated<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> currcons<span style="color: #339933;">+</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	    <span style="color: #009900;">}</span>
	    <span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	orig_buf <span style="color: #339933;">=</span> buf<span style="color: #339933;">;</span>
	orig_count <span style="color: #339933;">=</span> count<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>from_user<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		down<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>con_buf_sem<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
again<span style="color: #339933;">:</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>count <span style="color: #339933;">&gt;</span> CON_BUF_SIZE<span style="color: #009900;">)</span>
			count <span style="color: #339933;">=</span> CON_BUF_SIZE<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>copy_from_user<span style="color: #009900;">(</span>con_buf<span style="color: #339933;">,</span> buf<span style="color: #339933;">,</span> count<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			n <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* ?? are error codes legal here ?? */</span>
			<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
&nbsp;
		buf <span style="color: #339933;">=</span> con_buf<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *以上部分是在字符来自用户空间的时候将其复制到系统空间用的
 *以下部分是对字符的编码转换和底层写入等，有兴趣的读者自己看吧
 */</span>
	<span style="color: #808080; font-style: italic;">/* At this point 'buf' is guarenteed to be a kernel buffer
	 * and therefore no access to userspace (and therefore sleeping)
	 * will be needed.  The con_buf_sem serializes all tty based
	 * console rendering and vcs write/read operations.  We hold
	 * the console spinlock during the entire write.
	 */</span>
&nbsp;
	spin_lock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>console_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	himask <span style="color: #339933;">=</span> hi_font_mask<span style="color: #339933;">;</span>
	charmask <span style="color: #339933;">=</span> himask <span style="color: #339933;">?</span> <span style="color: #208080;">0x1ff</span> <span style="color: #339933;">:</span> <span style="color: #208080;">0xff</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* undraw cursor first */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>IS_FG<span style="color: #009900;">)</span>
		hide_cursor<span style="color: #009900;">(</span>currcons<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>tty<span style="color: #339933;">-&gt;</span>stopped <span style="color: #339933;">&amp;&amp;</span> count<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		c <span style="color: #339933;">=</span> <span style="color: #339933;">*</span>buf<span style="color: #339933;">;</span>
		buf<span style="color: #339933;">++;</span>
		n<span style="color: #339933;">++;</span>
		count<span style="color: #339933;">--;</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>utf<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		    <span style="color: #808080; font-style: italic;">/* Combine UTF-8 into Unicode */</span>
		    <span style="color: #808080; font-style: italic;">/* Incomplete characters silently ignored */</span>
		    <span style="color: #b1b100;">if</span><span style="color: #009900;">(</span>c <span style="color: #339933;">&gt;</span> <span style="color: #208080;">0x7f</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>utf_count <span style="color: #339933;">&gt;</span> <span style="color: #0000dd;">0</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0xc0</span><span style="color: #009900;">)</span> <span style="color: #339933;">==</span> <span style="color: #208080;">0x80</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				utf_char <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>utf_char <span style="color: #339933;">&lt;&lt;</span> <span style="color: #0000dd;">6</span><span style="color: #009900;">)</span> <span style="color: #339933;">|</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0x3f</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				utf_count<span style="color: #339933;">--;</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>utf_count <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
				    tc <span style="color: #339933;">=</span> c <span style="color: #339933;">=</span> utf_char<span style="color: #339933;">;</span>
				<span style="color: #b1b100;">else</span> <span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>c <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0xe0</span><span style="color: #009900;">)</span> <span style="color: #339933;">==</span> <span style="color: #208080;">0xc0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				    utf_count <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
				    utf_char <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0x1f</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>c <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0xf0</span><span style="color: #009900;">)</span> <span style="color: #339933;">==</span> <span style="color: #208080;">0xe0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				    utf_count <span style="color: #339933;">=</span> <span style="color: #0000dd;">2</span><span style="color: #339933;">;</span>
				    utf_char <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0x0f</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>c <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0xf8</span><span style="color: #009900;">)</span> <span style="color: #339933;">==</span> <span style="color: #208080;">0xf0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				    utf_count <span style="color: #339933;">=</span> <span style="color: #0000dd;">3</span><span style="color: #339933;">;</span>
				    utf_char <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0x07</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>c <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0xfc</span><span style="color: #009900;">)</span> <span style="color: #339933;">==</span> <span style="color: #208080;">0xf8</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				    utf_count <span style="color: #339933;">=</span> <span style="color: #0000dd;">4</span><span style="color: #339933;">;</span>
				    utf_char <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0x03</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>c <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0xfe</span><span style="color: #009900;">)</span> <span style="color: #339933;">==</span> <span style="color: #208080;">0xfc</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				    utf_count <span style="color: #339933;">=</span> <span style="color: #0000dd;">5</span><span style="color: #339933;">;</span>
				    utf_char <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0x01</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span>
				    utf_count <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
				<span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span>
			      <span style="color: #009900;">}</span>
		    <span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
		      tc <span style="color: #339933;">=</span> c<span style="color: #339933;">;</span>
		      utf_count <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		    <span style="color: #009900;">}</span>
		<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>	<span style="color: #808080; font-style: italic;">/* no utf */</span>
		  tc <span style="color: #339933;">=</span> translate<span style="color: #009900;">[</span>toggle_meta <span style="color: #339933;">?</span> <span style="color: #009900;">(</span>c<span style="color: #339933;">|</span><span style="color: #208080;">0x80</span><span style="color: #009900;">)</span> <span style="color: #339933;">:</span> c<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
&nbsp;
                <span style="color: #808080; font-style: italic;">/* If the original code was a control character we
                 * only allow a glyph to be displayed if the code is
                 * not normally used (such as for cursor movement) or
                 * if the disp_ctrl mode has been explicitly enabled.
                 * Certain characters (as given by the CTRL_ALWAYS
                 * bitmap) are always displayed as control characters,
                 * as the console would be pretty useless without
                 * them; to display an arbitrary font position use the
                 * direct-to-font zone in UTF-8 mode.
                 */</span>
                ok <span style="color: #339933;">=</span> tc <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">&gt;=</span> <span style="color: #0000dd;">32</span> <span style="color: #339933;">||</span>
                            <span style="color: #009900;">(</span><span style="color: #339933;">!</span>utf <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span><span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #009900;">(</span>disp_ctrl <span style="color: #339933;">?</span> CTRL_ALWAYS
                                         <span style="color: #339933;">:</span> CTRL_ACTION<span style="color: #009900;">)</span> <span style="color: #339933;">&gt;&gt;</span> c<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
                        <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">!=</span> <span style="color: #0000dd;">127</span> <span style="color: #339933;">||</span> disp_ctrl<span style="color: #009900;">)</span>
			<span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">(</span>c <span style="color: #339933;">!=</span> <span style="color: #0000dd;">128</span><span style="color: #339933;">+</span><span style="color: #0000dd;">27</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>vc_state <span style="color: #339933;">==</span> ESnormal <span style="color: #339933;">&amp;&amp;</span> ok<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #808080; font-style: italic;">/* Now try to find out how to display it */</span>
			tc <span style="color: #339933;">=</span> conv_uni_to_pc<span style="color: #009900;">(</span>vc_cons<span style="color: #009900;">[</span>currcons<span style="color: #009900;">]</span>.<span style="color: #202020;">d</span><span style="color: #339933;">,</span> tc<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span> tc <span style="color: #339933;">==</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">4</span> <span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
                                <span style="color: #808080; font-style: italic;">/* If we got -4 (not found) then see if we have
                                   defined a replacement character (U+FFFD) */</span>
                                tc <span style="color: #339933;">=</span> conv_uni_to_pc<span style="color: #009900;">(</span>vc_cons<span style="color: #009900;">[</span>currcons<span style="color: #009900;">]</span>.<span style="color: #202020;">d</span><span style="color: #339933;">,</span> <span style="color: #208080;">0xfffd</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
				<span style="color: #808080; font-style: italic;">/* One reason for the -4 can be that we just
				   did a clear_unimap();
				   try at least to show something. */</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tc <span style="color: #339933;">==</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">4</span><span style="color: #009900;">)</span>
				     tc <span style="color: #339933;">=</span> c<span style="color: #339933;">;</span>
                        <span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span> tc <span style="color: #339933;">==</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">3</span> <span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
                                <span style="color: #808080; font-style: italic;">/* Bad hash table -- hope for the best */</span>
                                tc <span style="color: #339933;">=</span> c<span style="color: #339933;">;</span>
                        <span style="color: #009900;">}</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tc <span style="color: #339933;">&amp;</span> ~charmask<span style="color: #009900;">)</span>
                                <span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* Conversion failed */</span>
&nbsp;
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>need_wrap <span style="color: #339933;">||</span> decim<span style="color: #009900;">)</span>
				FLUSH
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>need_wrap<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				cr<span style="color: #009900;">(</span>currcons<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				lf<span style="color: #009900;">(</span>currcons<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>decim<span style="color: #009900;">)</span>
				insert_char<span style="color: #009900;">(</span>currcons<span style="color: #339933;">,</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			scr_writew<span style="color: #009900;">(</span>himask <span style="color: #339933;">?</span>
				     <span style="color: #009900;">(</span><span style="color: #009900;">(</span>attr <span style="color: #339933;">&lt;&lt;</span> <span style="color: #0000dd;">8</span><span style="color: #009900;">)</span> <span style="color: #339933;">&amp;</span> ~himask<span style="color: #009900;">)</span> <span style="color: #339933;">+</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>tc <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0x100</span><span style="color: #009900;">)</span> <span style="color: #339933;">?</span> himask <span style="color: #339933;">:</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #339933;">+</span> <span style="color: #009900;">(</span>tc <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0xff</span><span style="color: #009900;">)</span> <span style="color: #339933;">:</span>
				     <span style="color: #009900;">(</span>attr <span style="color: #339933;">&lt;&lt;</span> <span style="color: #0000dd;">8</span><span style="color: #009900;">)</span> <span style="color: #339933;">+</span> tc<span style="color: #339933;">,</span>
				   <span style="color: #009900;">(</span>u16 <span style="color: #339933;">*</span><span style="color: #009900;">)</span> pos<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>DO_UPDATE <span style="color: #339933;">&amp;&amp;</span> draw_x <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				draw_x <span style="color: #339933;">=</span> x<span style="color: #339933;">;</span>
				draw_from <span style="color: #339933;">=</span> pos<span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>x <span style="color: #339933;">==</span> video_num_columns <span style="color: #339933;">-</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				need_wrap <span style="color: #339933;">=</span> decawm<span style="color: #339933;">;</span>
				draw_to <span style="color: #339933;">=</span> pos<span style="color: #339933;">+</span><span style="color: #0000dd;">2</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
				x<span style="color: #339933;">++;</span>
				draw_to <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>pos<span style="color: #339933;">+=</span><span style="color: #0000dd;">2</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			<span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		FLUSH
		do_con_trol<span style="color: #009900;">(</span>tty<span style="color: #339933;">,</span> currcons<span style="color: #339933;">,</span> c<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	FLUSH
	spin_unlock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>console_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
out<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>from_user<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #808080; font-style: italic;">/* If the user requested something larger than
		 * the CON_BUF_SIZE, and the tty is not stopped,
		 * keep going.
		 */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>orig_count <span style="color: #339933;">&gt;</span> CON_BUF_SIZE<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span>tty<span style="color: #339933;">-&gt;</span>stopped<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			orig_count <span style="color: #339933;">-=</span> CON_BUF_SIZE<span style="color: #339933;">;</span>
			orig_buf <span style="color: #339933;">+=</span> CON_BUF_SIZE<span style="color: #339933;">;</span>
			count <span style="color: #339933;">=</span> orig_count<span style="color: #339933;">;</span>
			buf <span style="color: #339933;">=</span> orig_buf<span style="color: #339933;">;</span>
			<span style="color: #b1b100;">goto</span> again<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
&nbsp;
		up<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>con_buf_sem<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #b1b100;">return</span> n<span style="color: #339933;">;</span>
<span style="color: #339933;">#undef FLUSH</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>&nbsp;</p> 
         <p>The End.</p> 
        </div>
       </div>
       <!-- .entry-content --> 
       <!-- .entry-meta --> 
      </article>
      <!-- #post-799 --> 
      <!-- #comments --> 
     </div>
     <!-- #content --> 
    </div>
    <!-- #primary --> 
    <!-- #secondary .widget-area --> 
   </div>
   <!-- #main --> 
   <!-- #colophon --> 
  </div>
  <!-- #page -->   
  <!-- JiaThis Button BEGIN -->  
  <!-- JiaThis Button END -->   
 </body>
</html>