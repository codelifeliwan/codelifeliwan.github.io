<!doctype html>
<!--[if IE 6]>
<html id="ie6" lang="zh-CN">
<![endif]-->
<!--[if IE 7]>
<html id="ie7" lang="zh-CN">
<![endif]-->
<!--[if IE 8]>
<html id="ie8" lang="zh-CN">
<![endif]-->
<!--[if !(IE 6) | !(IE 7) | !(IE 8)  ]><!-->
<html lang="zh-CN">
 <!--<![endif]-->
 <head>      
  <link rel="stylesheet" type="text/css" media="all" href="stylesheets/style.css">     
  <link rel="stylesheet" id="codebox-css" href="stylesheets/codebox.css" type="text/css" media="screen">             
 </head> 
 <body class="single single-post postid-686 single-format-standard content-sidebar"> 
  <div id="page" class="hfeed"> 
   <header id="branding" role="banner"> 
    <hgroup> 
     <h1 id="site-title"><span><a href="http://codelifeliwan.github.io/" title="Code_Life_LiWan" rel="home">Code_Life_LiWan</a></span></h1> 
     <h2 id="site-description">My heart will go on and on…</h2> 
    </hgroup>  
    <!-- #access --> 
   </header>
   <!-- #branding --> 
   <div id="main" class="clearfix"> 
    <div id="primary"> 
     <div id="content" role="main"> 
      <!-- #nav-single --> 
      <article id="post-686" class="post-686 post type-post status-publish format-standard hentry category-linux_kernel_source_code_notes"> 
       <header class="entry-header"> 
        <h1 class="entry-title">Linux内核-文件系统（三、访问权限与文件安全性）</h1> 
        <div class="entry-meta"> 
         <span class="sep">Posted on </span>
         <a href="http://codelifeliwan.github.io/?p=686" title="下午 7:11" rel="bookmark"><time class="entry-date" datetime="2012-10-27T19:11:54+00:00" pubdate>27 十月, 2012</time></a>
         <span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codelifeliwan.github.io/?author=1" title="View all posts by wanli" rel="author">wanli</a></span></span> 
         <span class="sep"> — </span> 
         <span class="comments-link"> <a href="http://codelifeliwan.github.io/?p=686#comments" title="Comment on Linux内核-文件系统（三、访问权限与文件安全性）">1 Comment ↓</a> </span> 
        </div>
        <!-- .entry-meta --> 
       </header>
       <!-- .entry-header --> 
       <div class="entry-content">
        <div class="entry-content"> 
         <p>在Linux<span style="font-family: 宋体;">中，访问权限设置比较复杂，我头都晕了。</span></p> 
         <p>Linux<span style="font-family: 宋体;">中用一个</span><span style="font-family: 'Times New Roman';">16</span><span style="font-family: 宋体;">位的短整数来表示文件的访问模式，这个数字的结构如下所示：</span><br> <a href="uploads/2012/10/1.jpg"><img class="aligncenter size-full wp-image-687" title="1" src="uploads/2012/10/1.jpg" alt="" width="573" height="233"></a><br> 其中，后<span style="font-family: 'Times New Roman';">9</span><span style="font-family: 宋体;">位用于文件的权限控制，分别为文件组的权限，同组人的权限，其他权限，而这</span><span style="font-family: 'Times New Roman';">9</span><span style="font-family: 宋体;">位又分为了三个三位的八进制，每一位分别对应读、写、执行等，如</span><span style="font-family: 'Times New Roman';">chmod&nbsp;755</span><span style="font-family: 宋体;">，这里面的</span><span style="font-family: 'Times New Roman';">7</span><span style="font-family: 宋体;">、</span><span style="font-family: 'Times New Roman';">5</span><span style="font-family: 宋体;">、</span><span style="font-family: 'Times New Roman';">5</span><span style="font-family: 宋体;">分别对应了三个三位的八进制权限，对这些位的定义如下：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=686&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6861"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td> 
             <td class="code" id="p686code1"><pre class="c" style="font-family:monospace;"><span style="color: #339933;">#define S_IRWXU 00700</span>
<span style="color: #339933;">#define S_IRUSR 00400</span>
<span style="color: #339933;">#define S_IWUSR 00200</span>
<span style="color: #339933;">#define S_IXUSR 00100</span>
&nbsp;
<span style="color: #339933;">#define S_IRWXG 00070</span>
<span style="color: #339933;">#define S_IRGRP 00040</span>
<span style="color: #339933;">#define S_IWGRP 00020</span>
<span style="color: #339933;">#define S_IXGRP 00010</span>
&nbsp;
<span style="color: #339933;">#define S_IRWXO 00007</span>
<span style="color: #339933;">#define S_IROTH 00004</span>
<span style="color: #339933;">#define S_IWOTH 00002</span>
<span style="color: #339933;">#define S_IXOTH 00001</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>注意：这里面有三组，分别表示<span style="font-family: 'Times New Roman';">U,G,O.</span></p> 
         <p>Linux<span style="font-family: 宋体;">中有一类文件称为</span><span style="font-family: 'Times New Roman';">set_uid</span><span style="font-family: 宋体;">文件，这种文件允许使得任何用户在执行该文件的时候暂时有该文件的“文件主”的权限，执行完毕则又回到原来的权限。但是这种方式上对于系统的安全性不好。</span></p> 
         <p>粘滞位是对于一些频繁运行的程序，标志位设置成<span style="font-family: 'Times New Roman';">1</span><span style="font-family: 宋体;">，让内核尽量不释放该程序的内存映像，这样下次启动的时候就不必要从磁盘装入了。</span></p> 
         <p>最高四位表示的是文件类型，使用的是编码方式，类型的说明如下：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=686&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6862"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td> 
             <td class="code" id="p686code2"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/* The admissible values for i_mode are listed in &lt;linux/stat.h&gt; :
 * #define S_IFMT  00170000  mask for type
 * #define S_IFREG  0100000  type = regular file
 * #define S_IFBLK  0060000  type = block device
 * #define S_IFDIR  0040000  type = directory
 * #define S_IFCHR  0020000  type = character device
 * #define S_IFIFO  0010000  type = named pipe
 * #define S_ISUID  0004000  set user id
 * #define S_ISGID  0002000  set group id
 * #define S_ISVTX  0001000  save swapped text even after use
 * Additionally for SystemV:
 * #define S_IFLNK  0120000  type = symbolic link
 * #define S_IFNAM  0050000  type = XENIX special named file ??
 * Additionally for Coherent:
 * #define S_IFMPB  0070000  type = multiplexed block device ??
 * #define S_IFMPC  0030000  type = multiplexed character device ??
 *
 * Since Coherent doesn't know about symbolic links, we use a kludgey
 * implementation of symbolic links: i_mode = COH_KLUDGE_SYMLINK_MODE
 * denotes a symbolic link. When a regular file should get this mode by
 * accident, it is automatically converted to COH_KLUDGE_NOT_SYMLINK.
 * We use S_IFREG because only regular files (and Coherent pipes...) can have
 * data blocks with arbitrary contents associated with them, and S_ISVTX
 * ("save swapped text after use") because it is unused on both Linux and
 * Coherent: Linux does much more intelligent paging, and Coherent hasn't
 * virtual memory at all.
 * Same trick for Xenix.
 */</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>在文件系统<span style="font-family: 'Times New Roman';">inode</span><span style="font-family: 宋体;">数据结构中有一个字段为</span><span style="font-family: 'Times New Roman';">i_flags</span><span style="font-family: 宋体;">，也是用来控制权限的，具体说明在后面。</span></p> 
         <p>在<span style="font-family: 'Times New Roman';">Linux</span><span style="font-family: 宋体;">的</span><span style="font-family: 'Times New Roman';">task_struct</span><span style="font-family: 宋体;">结构中有如下几个关于用户和组的字段：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=686&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6863"> 
             <td class="line_numbers"><pre>1
2
3
4
</pre></td> 
             <td class="code" id="p686code3"><pre class="c" style="font-family:monospace;">uid_t uid<span style="color: #339933;">,</span>euid<span style="color: #339933;">,</span>suid<span style="color: #339933;">,</span>fsuid<span style="color: #339933;">;</span>
gid_t gid<span style="color: #339933;">,</span>egid<span style="color: #339933;">,</span>sgid<span style="color: #339933;">,</span>fsgid<span style="color: #339933;">;</span>
&nbsp;
gid_t	groups<span style="color: #009900;">[</span>NGROUPS<span style="color: #009900;">]</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>1、每个用户被授予一个唯一的<span style="font-family: 'Times New Roman';">uid</span><span style="font-family: 宋体;">（用户号），注意一个用户只对应一个</span><span style="font-family: 'Times New Roman';">uid</span><span style="font-family: 宋体;">但是一个</span><span style="font-family: 'Times New Roman';">uid</span><span style="font-family: 宋体;">可以对应多个用户。</span></p> 
         <p>2、每个用户都属于一个组，组号为<span style="font-family: 'Times New Roman';">gid</span><span style="font-family: 宋体;">，</span><span style="font-family: 'Times New Roman';">uid</span><span style="font-family: 宋体;">和</span><span style="font-family: 'Times New Roman';">gid</span><span style="font-family: 宋体;">是登录的时候从</span><span style="font-family: 'Times New Roman';">/etc/passwd</span><span style="font-family: 宋体;">中取出的。</span></p> 
         <p>3、euid<span style="font-family: 宋体;">表示当前有效的</span><span style="font-family: 'Times New Roman';">uid</span><span style="font-family: 宋体;">。</span></p> 
         <p>4、egid<span style="font-family: 宋体;">表示当前有效的组号。</span></p> 
         <p>5、当<span style="font-family: 'Times New Roman';">euid</span><span style="font-family: 宋体;">改变的时候将原来的</span><span style="font-family: 'Times New Roman';">euid</span><span style="font-family: 宋体;">保存至</span><span style="font-family: 'Times New Roman';">suid</span><span style="font-family: 宋体;">中。</span></p> 
         <p>6、当<span style="font-family: 'Times New Roman';">egid</span><span style="font-family: 宋体;">改变的时候将原来的</span><span style="font-family: 'Times New Roman';">egid</span><span style="font-family: 宋体;">保存至</span><span style="font-family: 'Times New Roman';">sgid</span><span style="font-family: 宋体;">中。</span></p> 
         <p>7、fsuid<span style="font-family: 宋体;">和</span><span style="font-family: 'Times New Roman';">fsgid</span><span style="font-family: 宋体;">用于网络文件系统</span><span style="font-family: 'Times New Roman';">NFS</span><span style="font-family: 宋体;">，一般与</span><span style="font-family: 'Times New Roman';">euid</span><span style="font-family: 宋体;">和</span><span style="font-family: 'Times New Roman';">egid</span><span style="font-family: 宋体;">相同，但是在特殊情况下可以不同，是专用于文件访问目的的有效</span><span style="font-family: 'Times New Roman';">uid</span><span style="font-family: 宋体;">。</span></p> 
         <p>8、groups<span style="font-family: 宋体;">表示的文件的“候补组号”，一个文件（程序）可以属于多个组。</span></p> 
         <p>了解了这些，可以看看文件系统的权限判定了，权限判定函数主要是由函数<span style="font-family: 'Times New Roman';">permission()</span><span style="font-family: 宋体;">来完成的，其代码在</span><span style="font-family: 'Times New Roman';">fs/namei.c</span><span style="font-family: 宋体;">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=686&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6864"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td> 
             <td class="code" id="p686code4"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">int</span> permission<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span> inode<span style="color: #339933;">,</span><span style="color: #993333;">int</span> mask<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>inode<span style="color: #339933;">-&gt;</span>i_op <span style="color: #339933;">&amp;&amp;</span> inode<span style="color: #339933;">-&gt;</span>i_op<span style="color: #339933;">-&gt;</span>permission<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">int</span> retval<span style="color: #339933;">;</span>
		lock_kernel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		retval <span style="color: #339933;">=</span> inode<span style="color: #339933;">-&gt;</span>i_op<span style="color: #339933;">-&gt;</span>permission<span style="color: #009900;">(</span>inode<span style="color: #339933;">,</span> mask<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		unlock_kernel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span> retval<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">return</span> vfs_permission<span style="color: #009900;">(</span>inode<span style="color: #339933;">,</span> mask<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>其中，参数<span style="font-family: 'Times New Roman';">inode</span><span style="font-family: 宋体;">是需要判定的文件的</span><span style="font-family: 'Times New Roman';">inode</span><span style="font-family: 宋体;">，</span><span style="font-family: 'Times New Roman';">mask</span><span style="font-family: 宋体;">代表这访问方式标志位，只有后三位有用，分别代表可读、可写、可执行，定义如下（</span><span style="font-family: 'Times New Roman';">include/linux/fs.h</span><span style="font-family: 宋体;">）：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=686&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6865"> 
             <td class="line_numbers"><pre>1
2
3
</pre></td> 
             <td class="code" id="p686code5"><pre class="c" style="font-family:monospace;"><span style="color: #339933;">#define MAY_EXEC 1</span>
<span style="color: #339933;">#define MAY_WRITE 2</span>
<span style="color: #339933;">#define MAY_READ 4</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>在<span style="font-family: 'Times New Roman';">permission()</span><span style="font-family: 宋体;">中，若文件系统自己定义了访问权限操作则使用自己的，在</span><span style="font-family: 'Times New Roman';">Ext2</span><span style="font-family: 宋体;">中没有则使用函数</span><span style="font-family: 'Times New Roman';">vfs_permission()</span><span style="font-family: 宋体;">来进行权限判定。这个函数定义在</span><span style="font-family: 'Times New Roman';">fs/namei.c</span><span style="font-family: 宋体;">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=686&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6866"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
</pre></td> 
             <td class="code" id="p686code6"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">int</span> vfs_permission<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span> inode<span style="color: #339933;">,</span><span style="color: #993333;">int</span> mask<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span> mode <span style="color: #339933;">=</span> inode<span style="color: #339933;">-&gt;</span>i_mode<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//mode就是上述代表访问模式的16位短整数</span>
&nbsp;
　　<span style="color: #808080; font-style: italic;">/*
　　 *若文件只读，但是要求写权限，那么对于常规文件、目录及符号链接都不可写
　　 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>mask <span style="color: #339933;">&amp;</span> S_IWOTH<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> IS_RDONLY<span style="color: #009900;">(</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span>
		 <span style="color: #009900;">(</span>S_ISREG<span style="color: #009900;">(</span>mode<span style="color: #009900;">)</span> <span style="color: #339933;">||</span> S_ISDIR<span style="color: #009900;">(</span>mode<span style="color: #009900;">)</span> <span style="color: #339933;">||</span> S_ISLNK<span style="color: #009900;">(</span>mode<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EROFS<span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* Nobody gets write access to a read-only fs */</span>
&nbsp;
　　<span style="color: #808080; font-style: italic;">/*
　　 *对于设置了IMMUTABLE标志的文件不可写
　　 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>mask <span style="color: #339933;">&amp;</span> S_IWOTH<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> IS_IMMUTABLE<span style="color: #009900;">(</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EACCES<span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* Nobody gets write access to an immutable file */</span>
　　
　　<span style="color: #808080; font-style: italic;">/*
　　 *若当前进程的fsuid与文件的uid相同，那么当前进程的用户就是文件组
　　 *将mode右移6位比较文件主访问权限
　　 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>fsuid <span style="color: #339933;">==</span> inode<span style="color: #339933;">-&gt;</span>i_uid<span style="color: #009900;">)</span>
		mode <span style="color: #339933;">&gt;&gt;=</span> <span style="color: #0000dd;">6</span><span style="color: #339933;">;</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *若不是文件主则比较是否是同组者，右移三位，从当前进程的task_struct中搜索
　　 *代码如下（kernel/sys.c）：
　　 *	int in_group_p(gid_t grp)
　　 *	{
　　 *		int retval = 1;
　　 *		if (grp != current-&gt;fsgid)
　　 *			retval = supplemental_group_member(grp);
　　 *		return retval;
　　 *	}
　　 *	static int supplemental_group_member(gid_t grp)
　　 *	{
　　 *		int i = current-&gt;ngroups;
　　 *
　　 *		if (i) {
　　 *			gid_t *groups = current-&gt;groups;
　　 *			do {
　　 *				if (*groups == grp)
　　 *					return 1;
　　 *				groups++;
　　 *				i--;
　　 *			} while (i);
　　 *		}
　　 *		return 0;
　　 *	}
　　 */</span>
	<span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>in_group_p<span style="color: #009900;">(</span>inode<span style="color: #339933;">-&gt;</span>i_gid<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		mode <span style="color: #339933;">&gt;&gt;=</span> <span style="color: #0000dd;">3</span><span style="color: #339933;">;</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *((mode &amp; mask &amp; S_IRWXO) == mask)条件指的是符合permission
　　 *capable(CAP_DAC_OVERRIDE)指的是进程得到了CAP_DAC_OVERRIDE授权，
　　 *不受文件系统的访问权限控制
　　 *这时成功，返回0
　　 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #009900;">(</span>mode <span style="color: #339933;">&amp;</span> mask <span style="color: #339933;">&amp;</span> S_IRWXO<span style="color: #009900;">)</span> <span style="color: #339933;">==</span> mask<span style="color: #009900;">)</span> <span style="color: #339933;">||</span> capable<span style="color: #009900;">(</span>CAP_DAC_OVERRIDE<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* read and search access */</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *想要读文件的话若访问权限不符，则还有一种就是有CAP_DAC_READ_SEARCH
　　 *授权的进程，这样的进程可以读和搜索文件，注意这里面对目录的搜索用的是执行
　　 *权限
　　 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>mask <span style="color: #339933;">==</span> S_IROTH<span style="color: #009900;">)</span> <span style="color: #339933;">||</span>
	    <span style="color: #009900;">(</span>S_ISDIR<span style="color: #009900;">(</span>inode<span style="color: #339933;">-&gt;</span>i_mode<span style="color: #009900;">)</span>  <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span><span style="color: #009900;">(</span>mask <span style="color: #339933;">&amp;</span> ~<span style="color: #009900;">(</span>S_IROTH <span style="color: #339933;">|</span> S_IXOTH<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>capable<span style="color: #009900;">(</span>CAP_DAC_READ_SEARCH<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
　　
　　<span style="color: #808080; font-style: italic;">/*
　　 *权限获取失败，返回
　　 */</span>
	<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EACCES<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>其中IMMUTABLE标志在<span style="font-family: 'Times New Roman';">i_flags</span><span style="font-family: 宋体;">中，标志设置如下（</span><span style="font-family: 'Times New Roman';">include/linux/ext2_fs.h</span><span style="font-family: 宋体;">）：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=686&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6867"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td> 
             <td class="code" id="p686code7"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * Inode flags
 */</span>
<span style="color: #339933;">#define	EXT2_SECRM_FL			0x00000001 /* Secure deletion */</span>
<span style="color: #339933;">#define	EXT2_UNRM_FL			0x00000002 /* Undelete */</span>
<span style="color: #339933;">#define	EXT2_COMPR_FL			0x00000004 /* Compress file */</span>
<span style="color: #339933;">#define EXT2_SYNC_FL			0x00000008 /* Synchronous updates */</span>
<span style="color: #339933;">#define EXT2_IMMUTABLE_FL		0x00000010 /* Immutable file */</span>
<span style="color: #339933;">#define EXT2_APPEND_FL			0x00000020 /* writes to file may only append */</span>
<span style="color: #339933;">#define EXT2_NODUMP_FL			0x00000040 /* do not dump file */</span>
<span style="color: #339933;">#define EXT2_NOATIME_FL			0x00000080 /* do not update atime */</span>
<span style="color: #808080; font-style: italic;">/* Reserved for compression usage... */</span>
<span style="color: #339933;">#define EXT2_DIRTY_FL			0x00000100</span>
<span style="color: #339933;">#define EXT2_COMPRBLK_FL		0x00000200 /* One or more compressed clusters */</span>
<span style="color: #339933;">#define EXT2_NOCOMP_FL			0x00000400 /* Don't compress */</span>
<span style="color: #339933;">#define EXT2_ECOMPR_FL			0x00000800 /* Compression error */</span>
<span style="color: #808080; font-style: italic;">/* End compression flags --- maybe not all used */</span>	
<span style="color: #339933;">#define EXT2_BTREE_FL			0x00001000 /* btree format dir */</span>
<span style="color: #339933;">#define EXT2_RESERVED_FL		0x80000000 /* reserved for ext2 lib */</span>
&nbsp;
<span style="color: #339933;">#define EXT2_FL_USER_VISIBLE		0x00001FFF /* User visible flags */</span>
<span style="color: #339933;">#define EXT2_FL_USER_MODIFIABLE		0x000000FF /* User modifiable flags */</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>用户在一定条件下可以通过系统调用来设置其用户号，有关的系统调用有<span style="font-family: 'Times New Roman';">setuid()</span><span style="font-family: 宋体;">、</span><span style="font-family: 'Times New Roman';">setfsuid()</span><span style="font-family: 宋体;">、</span><span style="font-family: 'Times New Roman';">seteuid()</span><span style="font-family: 宋体;">以及</span><span style="font-family: 'Times New Roman';">setreuid()</span><span style="font-family: 宋体;">。在这里只说一个</span><span style="font-family: 'Times New Roman';">setuid()</span><span style="font-family: 宋体;">，内核中与之相对应的函数为</span><span style="font-family: 'Times New Roman';">sys_setuid()</span><span style="font-family: 宋体;">，代码在</span><span style="font-family: 'Times New Roman';">kernel/sys.c</span><span style="font-family: 宋体;">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=686&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6868"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td> 
             <td class="code" id="p686code8"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * setuid() is implemented like SysV with SAVED_IDS 
 * 
 * Note that SAVED_ID's is deficient in that a setuid root program
 * like sendmail, for example, cannot set its uid to be a normal 
 * user and then switch back, because if you're root, setuid() sets
 * the saved uid too.  If you don't like this, blame the bright people
 * in the POSIX committee and/or USG.  Note that the BSD-style setreuid()
 * will allow a root program to temporarily drop privileges and be able to
 * regain them by swapping the real and effective uid.  
 */</span>
asmlinkage <span style="color: #993333;">long</span> sys_setuid<span style="color: #009900;">(</span>uid_t uid<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span> old_euid <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>euid<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> old_ruid<span style="color: #339933;">,</span> old_suid<span style="color: #339933;">,</span> new_ruid<span style="color: #339933;">;</span>
&nbsp;
	old_ruid <span style="color: #339933;">=</span> new_ruid <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>uid<span style="color: #339933;">;</span>
	old_suid <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>suid<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>capable<span style="color: #009900;">(</span>CAP_SETUID<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>uid <span style="color: #339933;">!=</span> old_ruid <span style="color: #339933;">&amp;&amp;</span> set_user<span style="color: #009900;">(</span>uid<span style="color: #009900;">)</span> <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EAGAIN<span style="color: #339933;">;</span>
		current<span style="color: #339933;">-&gt;</span>suid <span style="color: #339933;">=</span> uid<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>uid <span style="color: #339933;">!=</span> current<span style="color: #339933;">-&gt;</span>uid<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">(</span>uid <span style="color: #339933;">!=</span> current<span style="color: #339933;">-&gt;</span>suid<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EPERM<span style="color: #339933;">;</span>
&nbsp;
	current<span style="color: #339933;">-&gt;</span>fsuid <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>euid <span style="color: #339933;">=</span> uid<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>old_euid <span style="color: #339933;">!=</span> uid<span style="color: #009900;">)</span>
		current<span style="color: #339933;">-&gt;</span>dumpable <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>issecure<span style="color: #009900;">(</span>SECURE_NO_SETUID_FIXUP<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		cap_emulate_setxuid<span style="color: #009900;">(</span>old_ruid<span style="color: #339933;">,</span> old_euid<span style="color: #339933;">,</span> old_suid<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>这里需要说明的是一般超级用户都有<span style="font-family: 'Times New Roman';">CAP_SETUID</span><span style="font-family: 宋体;">授权，只有有</span><span style="font-family: 'Times New Roman';">CAP_SETUID</span><span style="font-family: 宋体;">授权或者满足</span><span style="font-family: 'Times New Roman';">(uid&nbsp;!=&nbsp;current-&gt;uid)&nbsp;&amp;&amp;&nbsp;(uid&nbsp;!=&nbsp;current-&gt;suid)</span><span style="font-family: 宋体;">条件的时候才能更改其</span><span style="font-family: 'Times New Roman';">uid</span><span style="font-family: 宋体;">，注意在这里设置的时候也将</span><span style="font-family: 'Times New Roman';">suid</span><span style="font-family: 宋体;">设置成了新的</span><span style="font-family: 'Times New Roman';">uid</span><span style="font-family: 宋体;">，这与</span><span style="font-family: 'Times New Roman';">suid</span><span style="font-family: 宋体;">的存在初衷不符，但是这个是</span><span style="font-family: 'Times New Roman';">POSIX</span><span style="font-family: 宋体;">的硬性规定，</span><span style="font-family: 'Times New Roman';">Linux</span><span style="font-family: 宋体;">不得不遵从，</span><span style="font-family: 'Times New Roman';">Linux</span><span style="font-family: 宋体;">中设置了</span><span style="font-family: 'Times New Roman';">seteuid()</span><span style="font-family: 宋体;">和</span><span style="font-family: 'Times New Roman';">setreuid()</span><span style="font-family: 宋体;">来避免这些问题。</span><br> 当进程改变<span style="font-family: 'Times New Roman';">uid</span><span style="font-family: 宋体;">的时候将</span><span style="font-family: 'Times New Roman';">dumpable</span><span style="font-family: 宋体;">设置为</span><span style="font-family: 'Times New Roman';">0</span><span style="font-family: 宋体;">，这样不会在</span><span style="font-family: 'Times New Roman';">/tmp</span><span style="font-family: 宋体;">中产生</span><span style="font-family: 'Times New Roman';">dump</span><span style="font-family: 宋体;">临时调试文件。</span></p> 
         <p>进程的真实用户号是用<span style="font-family: 'Times New Roman';">set_user()</span><span style="font-family: 宋体;">来实施的，这个函数也是定义在</span><span style="font-family: 'Times New Roman';">sys.c</span><span style="font-family: 宋体;">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=686&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6869"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td> 
             <td class="code" id="p686code9"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">int</span> set_user<span style="color: #009900;">(</span>uid_t new_ruid<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> user_struct <span style="color: #339933;">*</span>new_user<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>old_user<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* What if a process setreuid()'s and this brings the
	 * new uid over his NPROC rlimit?  We can check this now
	 * cheaply with the new uid cache, so if it matters
	 * we should be checking for it.  -DaveM
	 */</span>
	new_user <span style="color: #339933;">=</span> alloc_uid<span style="color: #009900;">(</span>new_ruid<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>new_user<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EAGAIN<span style="color: #339933;">;</span>
	old_user <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>user<span style="color: #339933;">;</span>
	atomic_dec<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>old_user<span style="color: #339933;">-&gt;</span>processes<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	atomic_inc<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>new_user<span style="color: #339933;">-&gt;</span>processes<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	current<span style="color: #339933;">-&gt;</span>uid <span style="color: #339933;">=</span> new_ruid<span style="color: #339933;">;</span>
	current<span style="color: #339933;">-&gt;</span>user <span style="color: #339933;">=</span> new_user<span style="color: #339933;">;</span>
	free_uid<span style="color: #009900;">(</span>old_user<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>关于授权的检查函数<span style="font-family: 'Times New Roman';">capable()</span><span style="font-family: 宋体;">是在</span><span style="font-family: 'Times New Roman';">sched.h</span><span style="font-family: 宋体;">中定义的:</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=686&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p68610"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td> 
             <td class="code" id="p686code10"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * capable() checks for a particular capability.  
 * New privilege checks should use this interface, rather than suser() or
 * fsuser(). See include/linux/capability.h for defined capabilities.
 */</span>
&nbsp;
<span style="color: #993333;">static</span> <span style="color: #000000; font-weight: bold;">inline</span> <span style="color: #993333;">int</span> capable<span style="color: #009900;">(</span><span style="color: #993333;">int</span> cap<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
<span style="color: #339933;">#if 1 /* ok now */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>cap_raised<span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>cap_effective<span style="color: #339933;">,</span> cap<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
<span style="color: #339933;">#else</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>cap_is_fs_cap<span style="color: #009900;">(</span>cap<span style="color: #009900;">)</span> <span style="color: #339933;">?</span> current<span style="color: #339933;">-&gt;</span>fsuid <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span> <span style="color: #339933;">:</span> current<span style="color: #339933;">-&gt;</span>euid <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
<span style="color: #339933;">#endif</span>
	<span style="color: #009900;">{</span>
		current<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">|=</span> PF_SUPERPRIV<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>当<span style="font-family: 'Times New Roman';">uid</span><span style="font-family: 宋体;">改变的时候要通过</span><span style="font-family: 'Times New Roman';">cap_emulate_setxuid()</span><span style="font-family: 宋体;">来改变检查授权等，定义如下（</span><span style="font-family: 'Times New Roman';">sys.c</span><span style="font-family: 宋体;">）：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=686&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p68611"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td> 
             <td class="code" id="p686code11"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/* 
 * cap_emulate_setxuid() fixes the effective / permitted capabilities of
 * a process after a call to setuid, setreuid, or setresuid.
 *
 *  1) When set*uiding _from_ one of {r,e,s}uid == 0 _to_ all of
 *  {r,e,s}uid != 0, the permitted and effective capabilities are
 *  cleared.
 *
 *  2) When set*uiding _from_ euid == 0 _to_ euid != 0, the effective
 *  capabilities of the process are cleared.
 *
 *  3) When set*uiding _from_ euid != 0 _to_ euid == 0, the effective
 *  capabilities are set to the permitted capabilities.
 *
 *  fsuid is handled elsewhere. fsuid == 0 and {r,e,s}uid!= 0 should 
 *  never happen.
 *
 *  -astor 
 *
 * cevans - New behaviour, Oct '99
 * A process may, via prctl(), elect to keep its capabilities when it
 * calls setuid() and switches away from uid==0. Both permitted and
 * effective sets will be retained.
 * Without this change, it was impossible for a daemon to drop only some
 * of its privilege. The call to setuid(!=0) would drop all privileges!
 * Keeping uid 0 is not an option because uid 0 owns too many vital
 * files..
 * Thanks to Olaf Kirch and Peter Benie for spotting this.
 */</span>
<span style="color: #000000; font-weight: bold;">extern</span> <span style="color: #000000; font-weight: bold;">inline</span> <span style="color: #993333;">void</span> cap_emulate_setxuid<span style="color: #009900;">(</span><span style="color: #993333;">int</span> old_ruid<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> old_euid<span style="color: #339933;">,</span> 
				       <span style="color: #993333;">int</span> old_suid<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>old_ruid <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span> <span style="color: #339933;">||</span> old_euid <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span> <span style="color: #339933;">||</span> old_suid <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span>
	    <span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>uid <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span> <span style="color: #339933;">&amp;&amp;</span> current<span style="color: #339933;">-&gt;</span>euid <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span> <span style="color: #339933;">&amp;&amp;</span> current<span style="color: #339933;">-&gt;</span>suid <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span>
	    <span style="color: #339933;">!</span>current<span style="color: #339933;">-&gt;</span>keep_capabilities<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		cap_clear<span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>cap_permitted<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		cap_clear<span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>cap_effective<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>old_euid <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span> <span style="color: #339933;">&amp;&amp;</span> current<span style="color: #339933;">-&gt;</span>euid <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		cap_clear<span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>cap_effective<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>old_euid <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span> <span style="color: #339933;">&amp;&amp;</span> current<span style="color: #339933;">-&gt;</span>euid <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		current<span style="color: #339933;">-&gt;</span>cap_effective <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>cap_permitted<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>其他则没什么要说的了。</p> 
         <p>&nbsp;</p> 
         <p>The&nbsp;End.</p> 
        </div>
       </div>
       <!-- .entry-content --> 
       <!-- .entry-meta --> 
      </article>
      <!-- #post-686 --> 
      <!-- #comments --> 
     </div>
     <!-- #content --> 
    </div>
    <!-- #primary --> 
    <!-- #secondary .widget-area --> 
   </div>
   <!-- #main --> 
   <!-- #colophon --> 
  </div>
  <!-- #page -->   
  <!-- JiaThis Button BEGIN -->  
  <!-- JiaThis Button END -->   
 </body>
</html>