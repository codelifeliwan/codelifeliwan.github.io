<!doctype html>
<!--[if IE 6]>
<html id="ie6" lang="zh-CN">
<![endif]-->
<!--[if IE 7]>
<html id="ie7" lang="zh-CN">
<![endif]-->
<!--[if IE 8]>
<html id="ie8" lang="zh-CN">
<![endif]-->
<!--[if !(IE 6) | !(IE 7) | !(IE 8)  ]><!-->
<html lang="zh-CN">
 <!--<![endif]-->
 <head>      
  <link rel="stylesheet" type="text/css" media="all" href="stylesheets/style.css">     
  <link rel="stylesheet" id="codebox-css" href="stylesheets/codebox.css" type="text/css" media="screen">             
 </head> 
 <body class="single single-post postid-784 single-format-standard content-sidebar"> 
  <div id="page" class="hfeed"> 
   <header id="branding" role="banner"> 
    <hgroup> 
     <h1 id="site-title"><span><a href="http://codelifeliwan.github.io/" title="Code_Life_LiWan" rel="home">Code_Life_LiWan</a></span></h1> 
     <h2 id="site-description">My heart will go on and on…</h2> 
    </hgroup>  
    <!-- #access --> 
   </header>
   <!-- #branding --> 
   <div id="main" class="clearfix"> 
    <div id="primary"> 
     <div id="content" role="main"> 
      <!-- #nav-single --> 
      <article id="post-784" class="post-784 post type-post status-publish format-standard hentry category-linux_kernel_source_code_notes"> 
       <header class="entry-header"> 
        <h1 class="entry-title">Linux内核-设备驱动（六、块设备驱动操作）</h1> 
        <div class="entry-meta"> 
         <span class="sep">Posted on </span>
         <a href="http://codelifeliwan.github.io/?p=784" title="下午 4:11" rel="bookmark"><time class="entry-date" datetime="2013-01-20T16:11:24+00:00" pubdate>20 一月, 2013</time></a>
         <span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codelifeliwan.github.io/?author=1" title="View all posts by wanli" rel="author">wanli</a></span></span> 
         <span class="sep"> — </span> 
         <span class="comments-link"> <a href="http://codelifeliwan.github.io/?p=784#comments" title="Comment on Linux内核-设备驱动（六、块设备驱动操作）">3 Comments ↓</a> </span> 
        </div>
        <!-- .entry-meta --> 
       </header>
       <!-- .entry-header --> 
       <div class="entry-content">
        <div class="entry-content"> 
         <p>有了前面一节的数据结构说明，就可以开始看函数了，读者对于这两篇应该结合着看。</p> 
         <p>先从打开文件开始，块设备在文件系统中是一个设备文件代表的，设备文件是通过mknod()创建的，创建的时候已经将设备的主、次设备号都写入了代表该设备文件的索引节点中。打开时，在path_walk()中找到该设备文件节点所在目录，再根据目录项的指引从文件系统所在设备上读入这个索引节点，并检验它的模式，看是代表的什么文件。对于Ext2文件系统而言，这个操作是函数ext2_read_inode()，在这个函数里面调用函数init_special_inode()来初始化为这个文件创建的inode数据结构，函数init_special_inode()定义在fs/devices.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7841"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td> 
             <td class="code" id="p784code1"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">void</span> init_special_inode<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span>inode<span style="color: #339933;">,</span> umode_t mode<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> rdev<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	inode<span style="color: #339933;">-&gt;</span>i_mode <span style="color: #339933;">=</span> mode<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>S_ISCHR<span style="color: #009900;">(</span>mode<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		inode<span style="color: #339933;">-&gt;</span>i_fop <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>def_chr_fops<span style="color: #339933;">;</span>
		inode<span style="color: #339933;">-&gt;</span>i_rdev <span style="color: #339933;">=</span> to_kdev_t<span style="color: #009900;">(</span>rdev<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>S_ISBLK<span style="color: #009900;">(</span>mode<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//块设备部分</span>
<span style="color: #808080; font-style: italic;">/*
 *将块设备的操作跳转表指向def_blk_fops也就是块设备的
 *file_operations数据结构，同时inode中还有一个专用于块设备的
 *指针i_bdev，指向代表着具体块设备的block_device数据结构
 */</span>
		inode<span style="color: #339933;">-&gt;</span>i_fop <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>def_blk_fops<span style="color: #339933;">;</span>
		inode<span style="color: #339933;">-&gt;</span>i_rdev <span style="color: #339933;">=</span> to_kdev_t<span style="color: #009900;">(</span>rdev<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		inode<span style="color: #339933;">-&gt;</span>i_bdev <span style="color: #339933;">=</span> bdget<span style="color: #009900;">(</span>rdev<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>S_ISFIFO<span style="color: #009900;">(</span>mode<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		inode<span style="color: #339933;">-&gt;</span>i_fop <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>def_fifo_fops<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>S_ISSOCK<span style="color: #009900;">(</span>mode<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		inode<span style="color: #339933;">-&gt;</span>i_fop <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>bad_sock_fops<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">else</span>
		printk<span style="color: #009900;">(</span>KERN_DEBUG <span style="color: #ff0000;">"init_special_inode: bogus imode (%o)<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> mode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>当第一次打开文件的时候在函数dentr_open()中把目标文件inode结构中的指针f_ops复制到file结构中，并通过相应file_operations结构中的函数指针open调用函数blkdev_open()，这个函数的代码在fs/block_dev.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7842"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td> 
             <td class="code" id="p784code2"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">int</span> blkdev_open<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span> inode<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span> filp<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span> ret <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ENXIO<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> block_device <span style="color: #339933;">*</span>bdev <span style="color: #339933;">=</span> inode<span style="color: #339933;">-&gt;</span>i_bdev<span style="color: #339933;">;</span>
	down<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>bdev<span style="color: #339933;">-&gt;</span>bd_sem<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	lock_kernel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>bdev<span style="color: #339933;">-&gt;</span>bd_op<span style="color: #009900;">)</span>
<span style="color: #808080; font-style: italic;">/*
 *如果是第一次打开，函数跳转指针必然还没设置，这里设置函数
 *跳转指针，也就是block_device_operations数据结构
 */</span>
		bdev<span style="color: #339933;">-&gt;</span>bd_op <span style="color: #339933;">=</span> get_blkfops<span style="color: #009900;">(</span>MAJOR<span style="color: #009900;">(</span>inode<span style="color: #339933;">-&gt;</span>i_rdev<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>bdev<span style="color: #339933;">-&gt;</span>bd_op<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		ret <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>bdev<span style="color: #339933;">-&gt;</span>bd_op<span style="color: #339933;">-&gt;</span>open<span style="color: #009900;">)</span>
<span style="color: #808080; font-style: italic;">/*
 *打开函数，对于IDE硬盘来说这个指针指向ide_open()函数
 */</span>
			ret <span style="color: #339933;">=</span> bdev<span style="color: #339933;">-&gt;</span>bd_op<span style="color: #339933;">-&gt;</span>open<span style="color: #009900;">(</span>inode<span style="color: #339933;">,</span>filp<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>ret<span style="color: #009900;">)</span>
			atomic_inc<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>bdev<span style="color: #339933;">-&gt;</span>bd_openers<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>atomic_read<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>bdev<span style="color: #339933;">-&gt;</span>bd_openers<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			bdev<span style="color: #339933;">-&gt;</span>bd_op <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>	
	unlock_kernel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	up<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>bdev<span style="color: #339933;">-&gt;</span>bd_sem<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> ret<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>寻找具体块设备类型的block_device_operations数据结构的函数get_blkfops()定义在fs/block_dev.c中，前面一篇说过，内核中定义了一个以设备号为下标的数组blkdevs，这里就是按照下标进行寻找：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7843"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td> 
             <td class="code" id="p784code3"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
	Return the function table of a device.
	Load the driver if needed.
*/</span>
<span style="color: #993333;">const</span> <span style="color: #993333;">struct</span> block_device_operations <span style="color: #339933;">*</span> get_blkfops<span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> major<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">struct</span> block_device_operations <span style="color: #339933;">*</span>ret <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* major 0 is used for non-device mounts */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>major <span style="color: #339933;">&amp;&amp;</span> major <span style="color: #339933;">&lt;</span> MAX_BLKDEV<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
<span style="color: #339933;">#ifdef CONFIG_KMOD</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>blkdevs<span style="color: #009900;">[</span>major<span style="color: #009900;">]</span>.<span style="color: #202020;">bdops</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #993333;">char</span> name<span style="color: #009900;">[</span><span style="color: #0000dd;">20</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
			sprintf<span style="color: #009900;">(</span>name<span style="color: #339933;">,</span> <span style="color: #ff0000;">"block-major-%d"</span><span style="color: #339933;">,</span> major<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			request_module<span style="color: #009900;">(</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
<span style="color: #339933;">#endif</span>
		ret <span style="color: #339933;">=</span> blkdevs<span style="color: #009900;">[</span>major<span style="color: #009900;">]</span>.<span style="color: #202020;">bdops</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">return</span> ret<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>具体的打开函数是ide_open()，这个函数定义在drivers/ide/ide.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7844"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td> 
             <td class="code" id="p784code4"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">int</span> ide_open <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span> inode<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span> filp<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	ide_drive_t <span style="color: #339933;">*</span>drive<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> rc<span style="color: #339933;">;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *获得ide_drive_t数据结构
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>drive <span style="color: #339933;">=</span> get_info_ptr<span style="color: #009900;">(</span>inode<span style="color: #339933;">-&gt;</span>i_rdev<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">==</span> NULL<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>ENXIO<span style="color: #339933;">;</span>
	MOD_INC_USE_COUNT<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>driver <span style="color: #339933;">==</span> NULL<span style="color: #009900;">)</span>
<span style="color: #808080; font-style: italic;">/*
 *如果driver指针是NULL，那就说明在初始化的时候虽然检测到了硬盘的存在
 *但是却由于某种原因而未能完成对设备以及数据结构的初始化，这里需要调用
 *ide_driver_module()再试一次
 */</span>
		ide_driver_module<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#ifdef CONFIG_KMOD</span>
<span style="color: #808080; font-style: italic;">/*
 *如果内核支持可安装模块，那么也可能是因为支持具体的IDE设备的模块
 *尚未安装或者已被拆除，所以可能需要根据具体的设备类型装入有关模块
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>driver <span style="color: #339933;">==</span> NULL<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>media <span style="color: #339933;">==</span> ide_disk<span style="color: #009900;">)</span>
			<span style="color: #009900;">(</span><span style="color: #993333;">void</span><span style="color: #009900;">)</span> request_module<span style="color: #009900;">(</span><span style="color: #ff0000;">"ide-disk"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>media <span style="color: #339933;">==</span> ide_cdrom<span style="color: #009900;">)</span>
			<span style="color: #009900;">(</span><span style="color: #993333;">void</span><span style="color: #009900;">)</span> request_module<span style="color: #009900;">(</span><span style="color: #ff0000;">"ide-cd"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>media <span style="color: #339933;">==</span> ide_tape<span style="color: #009900;">)</span>
			<span style="color: #009900;">(</span><span style="color: #993333;">void</span><span style="color: #009900;">)</span> request_module<span style="color: #009900;">(</span><span style="color: #ff0000;">"ide-tape"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>media <span style="color: #339933;">==</span> ide_floppy<span style="color: #009900;">)</span>
			<span style="color: #009900;">(</span><span style="color: #993333;">void</span><span style="color: #009900;">)</span> request_module<span style="color: #009900;">(</span><span style="color: #ff0000;">"ide-floppy"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
<span style="color: #339933;">#endif /* CONFIG_KMOD */</span>
	<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>busy<span style="color: #009900;">)</span>
		sleep_on<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>drive<span style="color: #339933;">-&gt;</span>wqueue<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	drive<span style="color: #339933;">-&gt;</span>usage<span style="color: #339933;">++;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>driver <span style="color: #339933;">!=</span> NULL<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
<span style="color: #808080; font-style: italic;">/*
 *调用具体驱动函数的open()
 */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>rc <span style="color: #339933;">=</span> DRIVER<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>open<span style="color: #009900;">(</span>inode<span style="color: #339933;">,</span> filp<span style="color: #339933;">,</span> drive<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			MOD_DEC_USE_COUNT<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span> rc<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	printk <span style="color: #009900;">(</span><span style="color: #ff0000;">"%s: driver not present<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> drive<span style="color: #339933;">-&gt;</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	drive<span style="color: #339933;">-&gt;</span>usage<span style="color: #339933;">--;</span>
	MOD_DEC_USE_COUNT<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>ENXIO<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>函数get_info_ptr()用来根据设备号找到ide_drive_t数据结构并返回其指针，前面一篇已经说了，其实就是根据下标找ide_hwifs[]数组中的字段，这个函数定义在drivers/ide/ide.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7845"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td> 
             <td class="code" id="p784code5"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * get_info_ptr() returns the (ide_drive_t *) for a given device number.
 * It returns NULL if the given device number does not match any present drives.
 */</span>
ide_drive_t <span style="color: #339933;">*</span>get_info_ptr <span style="color: #009900;">(</span>kdev_t i_rdev<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span>		major <span style="color: #339933;">=</span> MAJOR<span style="color: #009900;">(</span>i_rdev<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#if 0</span>
	<span style="color: #993333;">int</span>		minor <span style="color: #339933;">=</span> MINOR<span style="color: #009900;">(</span>i_rdev<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;</span> PARTN_MASK<span style="color: #339933;">;</span>
<span style="color: #339933;">#endif</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span>	h<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>h <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> h <span style="color: #339933;">&lt;</span> MAX_HWIFS<span style="color: #339933;">;</span> <span style="color: #339933;">++</span>h<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		ide_hwif_t  <span style="color: #339933;">*</span>hwif <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>ide_hwifs<span style="color: #009900;">[</span>h<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>hwif<span style="color: #339933;">-&gt;</span>present <span style="color: #339933;">&amp;&amp;</span> major <span style="color: #339933;">==</span> hwif<span style="color: #339933;">-&gt;</span>major<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #993333;">unsigned</span> unit <span style="color: #339933;">=</span> DEVICE_NR<span style="color: #009900;">(</span>i_rdev<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>unit <span style="color: #339933;">&lt;</span> MAX_DRIVES<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				ide_drive_t <span style="color: #339933;">*</span>drive <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>hwif<span style="color: #339933;">-&gt;</span>drives<span style="color: #009900;">[</span>unit<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#if 0</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>present<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>part<span style="color: #009900;">[</span>minor<span style="color: #009900;">]</span>.<span style="color: #202020;">nr_sects</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
<span style="color: #339933;">#else</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>present<span style="color: #009900;">)</span>
<span style="color: #339933;">#endif</span>
					<span style="color: #b1b100;">return</span> drive<span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">return</span> NULL<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>而ide_driver_t中的open指针指向函数idedisk_open()，这个函数定义在drivers/ide/ide-disk.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7846"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td> 
             <td class="code" id="p784code6"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">int</span> idedisk_open <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span>inode<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span>filp<span style="color: #339933;">,</span> ide_drive_t <span style="color: #339933;">*</span>drive<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	MOD_INC_USE_COUNT<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>removable <span style="color: #339933;">&amp;&amp;</span> drive<span style="color: #339933;">-&gt;</span>usage <span style="color: #339933;">==</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		check_disk_change<span style="color: #009900;">(</span>inode<span style="color: #339933;">-&gt;</span>i_rdev<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #808080; font-style: italic;">/*
		 * Ignore the return code from door_lock,
		 * since the open() has already succeeded,
		 * and the door_lock is irrelevant at this point.
		 */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>doorlocking <span style="color: #339933;">&amp;&amp;</span> ide_wait_cmd<span style="color: #009900;">(</span>drive<span style="color: #339933;">,</span> WIN_DOORLOCK<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> NULL<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			drive<span style="color: #339933;">-&gt;</span>doorlocking <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>现在具体设备已经打开，已经为下一步具体的操作做好了准备。</p> 
         <p>下面我们就以系统调用read()为例来看看对块设备的文件操作。在file结构中read指针指向了函数block_read()，这个函数定义在fs/block-dev.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7847"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
</pre></td> 
             <td class="code" id="p784code7"><pre class="c" style="font-family:monospace;">ssize_t block_read<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span> filp<span style="color: #339933;">,</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span> buf<span style="color: #339933;">,</span> size_t count<span style="color: #339933;">,</span> loff_t <span style="color: #339933;">*</span>ppos<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span> inode <span style="color: #339933;">=</span> filp<span style="color: #339933;">-&gt;</span>f_dentry<span style="color: #339933;">-&gt;</span>d_inode<span style="color: #339933;">;</span>
	size_t block<span style="color: #339933;">;</span>
	loff_t offset<span style="color: #339933;">;</span>
	ssize_t blocksize<span style="color: #339933;">;</span>
	ssize_t blocksize_bits<span style="color: #339933;">,</span> i<span style="color: #339933;">;</span>
	size_t blocks<span style="color: #339933;">,</span> rblocks<span style="color: #339933;">,</span> left<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> bhrequest<span style="color: #339933;">,</span> uptodate<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> buffer_head <span style="color: #339933;">**</span> bhb<span style="color: #339933;">,</span> <span style="color: #339933;">**</span> bhe<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> buffer_head <span style="color: #339933;">*</span> buflist<span style="color: #009900;">[</span>NBUF<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> buffer_head <span style="color: #339933;">*</span> bhreq<span style="color: #009900;">[</span>NBUF<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> chars<span style="color: #339933;">;</span>
	loff_t size<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//size是具体设备的总容量（单位：字节）</span>
	kdev_t dev<span style="color: #339933;">;</span>
	ssize_t read<span style="color: #339933;">;</span>
&nbsp;
	dev <span style="color: #339933;">=</span> inode<span style="color: #339933;">-&gt;</span>i_rdev<span style="color: #339933;">;</span>
	blocksize <span style="color: #339933;">=</span> BLOCK_SIZE<span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *blksize_size[][]数组中为具体的各个设备的记录块大小
 *而blk_size[][]中的内容则为各项设备中含有1024字节记录块的个数
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>blksize_size<span style="color: #009900;">[</span>MAJOR<span style="color: #009900;">(</span>dev<span style="color: #009900;">)</span><span style="color: #009900;">]</span> <span style="color: #339933;">&amp;&amp;</span> blksize_size<span style="color: #009900;">[</span>MAJOR<span style="color: #009900;">(</span>dev<span style="color: #009900;">)</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span>MINOR<span style="color: #009900;">(</span>dev<span style="color: #009900;">)</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span>
		blocksize <span style="color: #339933;">=</span> blksize_size<span style="color: #009900;">[</span>MAJOR<span style="color: #009900;">(</span>dev<span style="color: #009900;">)</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span>MINOR<span style="color: #009900;">(</span>dev<span style="color: #009900;">)</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
	i <span style="color: #339933;">=</span> blocksize<span style="color: #339933;">;</span>
	blocksize_bits <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//总容量的数字的位数</span>
	<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>i <span style="color: #339933;">!=</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		blocksize_bits<span style="color: #339933;">++;</span>
		i <span style="color: #339933;">&gt;&gt;=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	offset <span style="color: #339933;">=</span> <span style="color: #339933;">*</span>ppos<span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *size是具体设备的总容量（单位：字节）
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>blk_size<span style="color: #009900;">[</span>MAJOR<span style="color: #009900;">(</span>dev<span style="color: #009900;">)</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span>
		size <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>loff_t<span style="color: #009900;">)</span> blk_size<span style="color: #009900;">[</span>MAJOR<span style="color: #009900;">(</span>dev<span style="color: #009900;">)</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span>MINOR<span style="color: #009900;">(</span>dev<span style="color: #009900;">)</span><span style="color: #009900;">]</span> <span style="color: #339933;">&lt;&lt;</span> BLOCK_SIZE_BITS<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">else</span>
		size <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>loff_t<span style="color: #009900;">)</span> INT_MAX <span style="color: #339933;">&lt;&lt;</span> BLOCK_SIZE_BITS<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>offset <span style="color: #339933;">&gt;</span> size<span style="color: #009900;">)</span>
		left <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #808080; font-style: italic;">/* size - offset might not fit into left, so check explicitly. */</span>
	<span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>size <span style="color: #339933;">-</span> offset <span style="color: #339933;">&gt;</span> INT_MAX<span style="color: #009900;">)</span>
		left <span style="color: #339933;">=</span> INT_MAX<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">else</span>
		left <span style="color: #339933;">=</span> size <span style="color: #339933;">-</span> offset<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//left是该设备中剩下未读的字节数</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>left <span style="color: #339933;">&gt;</span> count<span style="color: #009900;">)</span>
		left <span style="color: #339933;">=</span> count<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//调整为本次读操作剩下未读的字节数</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>left <span style="color: #339933;">&lt;=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	read <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	block <span style="color: #339933;">=</span> offset <span style="color: #339933;">&gt;&gt;</span> blocksize_bits<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//计算起始块号</span>
	offset <span style="color: #339933;">&amp;=</span> blocksize<span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	size <span style="color: #339933;">&gt;&gt;=</span> blocksize_bits<span style="color: #339933;">;</span>
	rblocks <span style="color: #339933;">=</span> blocks <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>left <span style="color: #339933;">+</span> offset <span style="color: #339933;">+</span> blocksize <span style="color: #339933;">-</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span> <span style="color: #339933;">&gt;&gt;</span> blocksize_bits<span style="color: #339933;">;</span><span style="color: #666666; font-style: italic;">//本次操作要读的块数</span>
	bhb <span style="color: #339933;">=</span> bhe <span style="color: #339933;">=</span> buflist<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>filp<span style="color: #339933;">-&gt;</span>f_reada<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
	        <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>blocks <span style="color: #339933;">&lt;</span> read_ahead<span style="color: #009900;">[</span>MAJOR<span style="color: #009900;">(</span>dev<span style="color: #009900;">)</span><span style="color: #009900;">]</span> <span style="color: #339933;">/</span> <span style="color: #009900;">(</span>blocksize <span style="color: #339933;">&gt;&gt;</span> <span style="color: #0000dd;">9</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			blocks <span style="color: #339933;">=</span> read_ahead<span style="color: #009900;">[</span>MAJOR<span style="color: #009900;">(</span>dev<span style="color: #009900;">)</span><span style="color: #009900;">]</span> <span style="color: #339933;">/</span> <span style="color: #009900;">(</span>blocksize <span style="color: #339933;">&gt;&gt;</span> <span style="color: #0000dd;">9</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>rblocks <span style="color: #339933;">&gt;</span> blocks<span style="color: #009900;">)</span>
			blocks <span style="color: #339933;">=</span> rblocks<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>block <span style="color: #339933;">+</span> blocks <span style="color: #339933;">&gt;</span> size<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		blocks <span style="color: #339933;">=</span> size <span style="color: #339933;">-</span> block<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>blocks <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* We do this in a two stage process.  We first try to request
	   as many blocks as we can, then we wait for the first one to
	   complete, and then we try to wrap up as many as are actually
	   done.  This routine is rather generic, in that it can be used
	   in a filesystem by substituting the appropriate function in
	   for getblk.
&nbsp;
	   This routine is optimized to make maximum use of the various
	   buffers and caches. */</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *前面计算完了需要读取的字节数多少等，从这个循环开始读取
 */</span>
	<span style="color: #b1b100;">do</span> <span style="color: #009900;">{</span>
		bhrequest <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		uptodate <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *此循环就是在数组buflist[]中积累起需要从块设备读入的记录块缓冲区
 *同时在bhreq[]中积累起成片的读入请求
 */</span>
		<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>blocks<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #339933;">--</span>blocks<span style="color: #339933;">;</span>
			<span style="color: #339933;">*</span>bhb <span style="color: #339933;">=</span> getblk<span style="color: #009900;">(</span>dev<span style="color: #339933;">,</span> block<span style="color: #339933;">++,</span> blocksize<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>bhb <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span>buffer_uptodate<span style="color: #009900;">(</span><span style="color: #339933;">*</span>bhb<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				uptodate <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
				bhreq<span style="color: #009900;">[</span>bhrequest<span style="color: #339933;">++</span><span style="color: #009900;">]</span> <span style="color: #339933;">=</span> <span style="color: #339933;">*</span>bhb<span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *buflist[]用来收集和积累所需的记录块缓冲区
 */</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">++</span>bhb <span style="color: #339933;">==</span> <span style="color: #339933;">&amp;</span>buflist<span style="color: #009900;">[</span>NBUF<span style="color: #009900;">]</span><span style="color: #009900;">)</span>
				bhb <span style="color: #339933;">=</span> buflist<span style="color: #339933;">;</span>
&nbsp;
			<span style="color: #808080; font-style: italic;">/* If the block we have on hand is uptodate, go ahead
			   and complete processing. */</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>uptodate<span style="color: #009900;">)</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>bhb <span style="color: #339933;">==</span> bhe<span style="color: #009900;">)</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/* Now request them all */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>bhrequest<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//表示需要从设备读入</span>
			ll_rw_block<span style="color: #009900;">(</span>READ<span style="color: #339933;">,</span> bhrequest<span style="color: #339933;">,</span> bhreq<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
&nbsp;
		<span style="color: #b1b100;">do</span> <span style="color: #009900;">{</span> <span style="color: #808080; font-style: italic;">/* Finish off all I/O that has actually completed */</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>bhe<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				wait_on_buffer<span style="color: #009900;">(</span><span style="color: #339933;">*</span>bhe<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>buffer_uptodate<span style="color: #009900;">(</span><span style="color: #339933;">*</span>bhe<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #808080; font-style: italic;">/* read error? */</span>
				        brelse<span style="color: #009900;">(</span><span style="color: #339933;">*</span>bhe<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
					<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">++</span>bhe <span style="color: #339933;">==</span> <span style="color: #339933;">&amp;</span>buflist<span style="color: #009900;">[</span>NBUF<span style="color: #009900;">]</span><span style="color: #009900;">)</span>
					  bhe <span style="color: #339933;">=</span> buflist<span style="color: #339933;">;</span>
					left <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
					<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
				<span style="color: #009900;">}</span>
			<span style="color: #009900;">}</span>			
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>left <span style="color: #339933;">&lt;</span> blocksize <span style="color: #339933;">-</span> offset<span style="color: #009900;">)</span>
				chars <span style="color: #339933;">=</span> left<span style="color: #339933;">;</span>
			<span style="color: #b1b100;">else</span>
				chars <span style="color: #339933;">=</span> blocksize <span style="color: #339933;">-</span> offset<span style="color: #339933;">;</span>
			<span style="color: #339933;">*</span>ppos <span style="color: #339933;">+=</span> chars<span style="color: #339933;">;</span>
			left <span style="color: #339933;">-=</span> chars<span style="color: #339933;">;</span>
			read <span style="color: #339933;">+=</span> chars<span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>bhe<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				copy_to_user<span style="color: #009900;">(</span>buf<span style="color: #339933;">,</span>offset<span style="color: #339933;">+</span><span style="color: #009900;">(</span><span style="color: #339933;">*</span>bhe<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>b_data<span style="color: #339933;">,</span>chars<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				brelse<span style="color: #009900;">(</span><span style="color: #339933;">*</span>bhe<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				buf <span style="color: #339933;">+=</span> chars<span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
				<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>chars<span style="color: #339933;">--</span> <span style="color: #339933;">&gt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
					put_user<span style="color: #009900;">(</span><span style="color: #0000dd;">0</span><span style="color: #339933;">,</span>buf<span style="color: #339933;">++</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			offset <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">++</span>bhe <span style="color: #339933;">==</span> <span style="color: #339933;">&amp;</span>buflist<span style="color: #009900;">[</span>NBUF<span style="color: #009900;">]</span><span style="color: #009900;">)</span>
				bhe <span style="color: #339933;">=</span> buflist<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span> <span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>left <span style="color: #339933;">&gt;</span> <span style="color: #0000dd;">0</span> <span style="color: #339933;">&amp;&amp;</span> bhe <span style="color: #339933;">!=</span> bhb <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">(</span><span style="color: #339933;">!*</span>bhe <span style="color: #339933;">||</span> <span style="color: #339933;">!</span>buffer_locked<span style="color: #009900;">(</span><span style="color: #339933;">*</span>bhe<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>bhe <span style="color: #339933;">==</span> bhb <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span>blocks<span style="color: #009900;">)</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>left <span style="color: #339933;">&gt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/* Release the read-ahead blocks */</span>
	<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>bhe <span style="color: #339933;">!=</span> bhb<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		brelse<span style="color: #009900;">(</span><span style="color: #339933;">*</span>bhe<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">++</span>bhe <span style="color: #339933;">==</span> <span style="color: #339933;">&amp;</span>buflist<span style="color: #009900;">[</span>NBUF<span style="color: #009900;">]</span><span style="color: #009900;">)</span>
			bhe <span style="color: #339933;">=</span> buflist<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>read<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EIO<span style="color: #339933;">;</span>
	filp<span style="color: #339933;">-&gt;</span>f_reada <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> read<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>不管如何，我们先抛开缓冲区的部分不说，最后需要从设备上读取的操作都是通过函数ll_rw_block()函数，写函数也是一样。</p> 
         <p>函数ll_rw_block()定义在drivers/block/ll_rw_blk.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7848"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
</pre></td> 
             <td class="code" id="p784code8"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">void</span> ll_rw_block<span style="color: #009900;">(</span><span style="color: #993333;">int</span> rw<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> nr<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> buffer_head <span style="color: #339933;">*</span> bhs<span style="color: #009900;">[</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
<span style="color: #808080; font-style: italic;">/*
 *函数参数中的bhs[]是一个buffer_head指针数组，数组中的每一个元素都
 *指向一个需要从设备读/写的记录块的buffer_head数据结构，参数nr为
 *该数组的大小，rw表明是读还是写等操作
 */</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> major<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> correct_size<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> i<span style="color: #339933;">;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *读写的记录块不一定是连续的，但是必须要在同一设备上，所以这里只取一个设备号
 */</span>
	major <span style="color: #339933;">=</span> MAJOR<span style="color: #009900;">(</span>bhs<span style="color: #009900;">[</span><span style="color: #0000dd;">0</span><span style="color: #009900;">]</span><span style="color: #339933;">-&gt;</span>b_dev<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Determine correct block size for this device. */</span>
	correct_size <span style="color: #339933;">=</span> BLOCK_SIZE<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>blksize_size<span style="color: #009900;">[</span>major<span style="color: #009900;">]</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		i <span style="color: #339933;">=</span> blksize_size<span style="color: #009900;">[</span>major<span style="color: #009900;">]</span><span style="color: #009900;">[</span>MINOR<span style="color: #009900;">(</span>bhs<span style="color: #009900;">[</span><span style="color: #0000dd;">0</span><span style="color: #009900;">]</span><span style="color: #339933;">-&gt;</span>b_dev<span style="color: #009900;">)</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>i<span style="color: #009900;">)</span>
			correct_size <span style="color: #339933;">=</span> i<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Verify requested block sizes. */</span>
	<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>i <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> i <span style="color: #339933;">&lt;</span> nr<span style="color: #339933;">;</span> i<span style="color: #339933;">++</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//检查记录块大小</span>
		<span style="color: #993333;">struct</span> buffer_head <span style="color: #339933;">*</span>bh<span style="color: #339933;">;</span>
		bh <span style="color: #339933;">=</span> bhs<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>bh<span style="color: #339933;">-&gt;</span>b_size <span style="color: #339933;">!=</span> correct_size<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			printk<span style="color: #009900;">(</span>KERN_NOTICE <span style="color: #ff0000;">"ll_rw_block: device %s: "</span>
			       <span style="color: #ff0000;">"only %d-char blocks implemented (%u)<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span>
			       kdevname<span style="color: #009900;">(</span>bhs<span style="color: #009900;">[</span><span style="color: #0000dd;">0</span><span style="color: #009900;">]</span><span style="color: #339933;">-&gt;</span>b_dev<span style="color: #009900;">)</span><span style="color: #339933;">,</span>
			       correct_size<span style="color: #339933;">,</span> bh<span style="color: #339933;">-&gt;</span>b_size<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">goto</span> sorry<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *若为写操作，则要检查设备是否可写，在内核中有个
 *二维数组ro_bits（drivers/block/ll_rw_blk.c）：
 *	static long ro_bits[MAX_BLKDEV][8];
 *每个设备在这个数组中都有个标志位，通过ioctl()系统调用
 *可以将一个标志位设置成1或0表示相应设备只可读或可写
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>rw <span style="color: #339933;">&amp;</span> WRITE<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> is_read_only<span style="color: #009900;">(</span>bhs<span style="color: #009900;">[</span><span style="color: #0000dd;">0</span><span style="color: #009900;">]</span><span style="color: #339933;">-&gt;</span>b_dev<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		printk<span style="color: #009900;">(</span>KERN_NOTICE <span style="color: #ff0000;">"Can't write to read-only device %s<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span>
		       kdevname<span style="color: #009900;">(</span>bhs<span style="color: #009900;">[</span><span style="color: #0000dd;">0</span><span style="color: #009900;">]</span><span style="color: #339933;">-&gt;</span>b_dev<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> sorry<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *依次处理对各个缓冲区的读写请求
 */</span>
	<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>i <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> i <span style="color: #339933;">&lt;</span> nr<span style="color: #339933;">;</span> i<span style="color: #339933;">++</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">struct</span> buffer_head <span style="color: #339933;">*</span>bh<span style="color: #339933;">;</span>
		bh <span style="color: #339933;">=</span> bhs<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/* Only one thread can actually submit the I/O. */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>test_and_set_bit<span style="color: #009900;">(</span>BH_Lock<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>bh<span style="color: #339933;">-&gt;</span>b_state<span style="color: #009900;">)</span><span style="color: #009900;">)</span>	<span style="color: #666666; font-style: italic;">//加锁</span>
			<span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/* We have the buffer lock */</span>
		bh<span style="color: #339933;">-&gt;</span>b_end_io <span style="color: #339933;">=</span> end_buffer_io_sync<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//设置函数指针，完成读写调用</span>
&nbsp;
		<span style="color: #b1b100;">switch</span><span style="color: #009900;">(</span>rw<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">case</span> WRITE<span style="color: #339933;">:</span>
<span style="color: #808080; font-style: italic;">/*
 *对于待写的缓冲区，其脏位（BH_Dirty）应该是1，否则就不需要写
 *既然写了那它就是干净的了，应通过__mark_buffer_clean()将其转移到
 *干净队列
 */</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>atomic_set_buffer_clean<span style="color: #009900;">(</span>bh<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				<span style="color: #808080; font-style: italic;">/* Hmmph! Nothing to write */</span>
				<span style="color: #b1b100;">goto</span> end_io<span style="color: #339933;">;</span>
			__mark_buffer_clean<span style="color: #009900;">(</span>bh<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *同样，对于待读设备，其Uptodate位应该是0
 */</span>
		<span style="color: #b1b100;">case</span> READA<span style="color: #339933;">:</span>
		<span style="color: #b1b100;">case</span> READ<span style="color: #339933;">:</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>buffer_uptodate<span style="color: #009900;">(</span>bh<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				<span style="color: #808080; font-style: italic;">/* Hmmph! Already have it */</span>
				<span style="color: #b1b100;">goto</span> end_io<span style="color: #339933;">;</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">default</span><span style="color: #339933;">:</span>
			BUG<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	end_io<span style="color: #339933;">:</span>
			bh<span style="color: #339933;">-&gt;</span>b_end_io<span style="color: #009900;">(</span>bh<span style="color: #339933;">,</span> test_bit<span style="color: #009900;">(</span>BH_Uptodate<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>bh<span style="color: #339933;">-&gt;</span>b_state<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *提交读写请求，进行读写操作
 */</span>
		submit_bh<span style="color: #009900;">(</span>rw<span style="color: #339933;">,</span> bh<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
&nbsp;
sorry<span style="color: #339933;">:</span>
	<span style="color: #808080; font-style: italic;">/* Make sure we don't get infinite dirty retries.. */</span>
	<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>i <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> i <span style="color: #339933;">&lt;</span> nr<span style="color: #339933;">;</span> i<span style="color: #339933;">++</span><span style="color: #009900;">)</span>
		mark_buffer_clean<span style="color: #009900;">(</span>bhs<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>函数最后是通过函数submit_bh()来进行提交读写请求的，这个函数定义在drivers/block/ll_rw_blk.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7849"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td> 
             <td class="code" id="p784code9"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/**
 * submit_bh: submit a buffer_head to the block device later for I/O
 * @rw: whether to %READ or %WRITE, or mayve to %READA (read ahead)
 * @bh: The &amp;struct buffer_head which describes the I/O
 *
 * submit_bh() is very similar in purpose to generic_make_request(), and
 * uses that function to do most of the work.
 *
 * The extra functionality provided by submit_bh is to determine
 * b_rsector from b_blocknr and b_size, and to set b_rdev from b_dev.
 * This is is appropriate for IO requests that come from the buffer
 * cache and page cache which (currently) always use aligned blocks.
 */</span>
<span style="color: #993333;">void</span> submit_bh<span style="color: #009900;">(</span><span style="color: #993333;">int</span> rw<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> buffer_head <span style="color: #339933;">*</span> bh<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>test_bit<span style="color: #009900;">(</span>BH_Lock<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>bh<span style="color: #339933;">-&gt;</span>b_state<span style="color: #009900;">)</span><span style="color: #009900;">)</span>	<span style="color: #666666; font-style: italic;">//检验锁</span>
		BUG<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *对一个缓冲区的操作是独占的，所以需要加锁
 */</span>
	set_bit<span style="color: #009900;">(</span>BH_Req<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>bh<span style="color: #339933;">-&gt;</span>b_state<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * First step, 'identity mapping' - RAID or LVM might
	 * further remap this.
	 */</span>
	bh<span style="color: #339933;">-&gt;</span>b_rdev <span style="color: #339933;">=</span> bh<span style="color: #339933;">-&gt;</span>b_dev<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//实际目标设备就是逻辑目标设备</span>
	bh<span style="color: #339933;">-&gt;</span>b_rsector <span style="color: #339933;">=</span> bh<span style="color: #339933;">-&gt;</span>b_blocknr <span style="color: #339933;">*</span> <span style="color: #009900;">(</span>bh<span style="color: #339933;">-&gt;</span>b_size<span style="color: #339933;">&gt;&gt;</span><span style="color: #0000dd;">9</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//将块号换算成扇区号</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *实际操作主体
 */</span>
	generic_make_request<span style="color: #009900;">(</span>rw<span style="color: #339933;">,</span> bh<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">switch</span> <span style="color: #009900;">(</span>rw<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">case</span> WRITE<span style="color: #339933;">:</span>
			kstat.<span style="color: #202020;">pgpgout</span><span style="color: #339933;">++;</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">default</span><span style="color: #339933;">:</span>
			kstat.<span style="color: #202020;">pgpgin</span><span style="color: #339933;">++;</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>函数的实际操作主体是generic_make_request()，这个函数定义在drivers/block/ll_rw_blk.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78410"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
</pre></td> 
             <td class="code" id="p784code10"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/**
 * generic_make_request: hand a buffer head to it's device driver for I/O
 * @rw:  READ, WRITE, or READA - what sort of I/O is desired.
 * @bh:  The buffer head describing the location in memory and on the device.
 *
 * generic_make_request() is used to make I/O requests of block
 * devices. It is passed a &amp;struct buffer_head and a &amp;rw value.  The
 * %READ and %WRITE options are (hopefully) obvious in meaning.  The
 * %READA value means that a read is required, but that the driver is
 * free to fail the request if, for example, it cannot get needed
 * resources immediately.
 *
 * generic_make_request() does not return any status.  The
 * success/failure status of the request, along with notification of
 * completion, is delivered asynchronously through the bh-&gt;b_end_io
 * function described (one day) else where.
 *
 * The caller of generic_make_request must make sure that b_page,
 * b_addr, b_size are set to describe the memory buffer, that b_rdev
 * and b_rsector are set to describe the device address, and the
 * b_end_io and optionally b_private are set to describe how
 * completion notification should be signaled.  BH_Mapped should also
 * be set (to confirm that b_dev and b_blocknr are valid).
 *
 * generic_make_request and the drivers it calls may use b_reqnext,
 * and may change b_rdev and b_rsector.  So the values of these fields
 * should NOT be depended on after the call to generic_make_request.
 * Because of this, the caller should record the device address
 * information in b_dev and b_blocknr.
 *
 * Apart from those fields mentioned above, no other fields, and in
 * particular, no other flags, are changed by generic_make_request or
 * any lower level drivers.
 * */</span>
<span style="color: #993333;">void</span> generic_make_request <span style="color: #009900;">(</span><span style="color: #993333;">int</span> rw<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> buffer_head <span style="color: #339933;">*</span> bh<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span> major <span style="color: #339933;">=</span> MAJOR<span style="color: #009900;">(</span>bh<span style="color: #339933;">-&gt;</span>b_rdev<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	request_queue_t <span style="color: #339933;">*</span>q<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>bh<span style="color: #339933;">-&gt;</span>b_end_io<span style="color: #009900;">)</span> BUG<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>blk_size<span style="color: #009900;">[</span>major<span style="color: #009900;">]</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
<span style="color: #808080; font-style: italic;">/*
 *计算最大扇区号
 */</span>
		<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> maxsector <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>blk_size<span style="color: #009900;">[</span>major<span style="color: #009900;">]</span><span style="color: #009900;">[</span>MINOR<span style="color: #009900;">(</span>bh<span style="color: #339933;">-&gt;</span>b_rdev<span style="color: #009900;">)</span><span style="color: #009900;">]</span> <span style="color: #339933;">&lt;&lt;</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span> <span style="color: #339933;">+</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
		<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> sector<span style="color: #339933;">,</span> count<span style="color: #339933;">;</span>
&nbsp;
		count <span style="color: #339933;">=</span> bh<span style="color: #339933;">-&gt;</span>b_size <span style="color: #339933;">&gt;&gt;</span> <span style="color: #0000dd;">9</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//count是要读的扇区数</span>
		sector <span style="color: #339933;">=</span> bh<span style="color: #339933;">-&gt;</span>b_rsector<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//sector是起始扇区号</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *扇区超出，出错
 */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>maxsector <span style="color: #339933;">&lt;</span> count <span style="color: #339933;">||</span> maxsector <span style="color: #339933;">-</span> count <span style="color: #339933;">&lt;</span> sector<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			bh<span style="color: #339933;">-&gt;</span>b_state <span style="color: #339933;">&amp;=</span> <span style="color: #009900;">(</span><span style="color: #0000dd;">1</span> <span style="color: #339933;">&lt;&lt;</span> BH_Lock<span style="color: #009900;">)</span> <span style="color: #339933;">|</span> <span style="color: #009900;">(</span><span style="color: #0000dd;">1</span> <span style="color: #339933;">&lt;&lt;</span> BH_Mapped<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>blk_size<span style="color: #009900;">[</span>major<span style="color: #009900;">]</span><span style="color: #009900;">[</span>MINOR<span style="color: #009900;">(</span>bh<span style="color: #339933;">-&gt;</span>b_rdev<span style="color: #009900;">)</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
&nbsp;
				<span style="color: #808080; font-style: italic;">/* This may well happen - the kernel calls bread()
				   without checking the size of the device, e.g.,
				   when mounting a device. */</span>
				printk<span style="color: #009900;">(</span>KERN_INFO
				       <span style="color: #ff0000;">"attempt to access beyond end of device<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				printk<span style="color: #009900;">(</span>KERN_INFO <span style="color: #ff0000;">"%s: rw=%d, want=%d, limit=%d<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span>
				       kdevname<span style="color: #009900;">(</span>bh<span style="color: #339933;">-&gt;</span>b_rdev<span style="color: #009900;">)</span><span style="color: #339933;">,</span> rw<span style="color: #339933;">,</span>
				       <span style="color: #009900;">(</span>sector <span style="color: #339933;">+</span> count<span style="color: #009900;">)</span><span style="color: #339933;">&gt;&gt;</span><span style="color: #0000dd;">1</span><span style="color: #339933;">,</span>
				       blk_size<span style="color: #009900;">[</span>major<span style="color: #009900;">]</span><span style="color: #009900;">[</span>MINOR<span style="color: #009900;">(</span>bh<span style="color: #339933;">-&gt;</span>b_rdev<span style="color: #009900;">)</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			bh<span style="color: #339933;">-&gt;</span>b_end_io<span style="color: #009900;">(</span>bh<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * Resolve the mapping until finished. (drivers are
	 * still free to implement/resolve their own stacking
	 * by explicitly returning 0)
	 */</span>
	<span style="color: #808080; font-style: italic;">/* NOTE: we don't repeat the blk_size check for each new device.
	 * Stacking drivers are expected to know what they are doing.
	 */</span>
	<span style="color: #b1b100;">do</span> <span style="color: #009900;">{</span>
		q <span style="color: #339933;">=</span> blk_get_queue<span style="color: #009900;">(</span>bh<span style="color: #339933;">-&gt;</span>b_rdev<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//取得请求队列头部request_queue数据结构</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>q<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			printk<span style="color: #009900;">(</span>KERN_ERR
			       <span style="color: #ff0000;">"generic_make_request: Trying to access nonexistent block-device %s (%ld)<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span>
			       kdevname<span style="color: #009900;">(</span>bh<span style="color: #339933;">-&gt;</span>b_rdev<span style="color: #009900;">)</span><span style="color: #339933;">,</span> bh<span style="color: #339933;">-&gt;</span>b_rsector<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			buffer_IO_error<span style="color: #009900;">(</span>bh<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>q<span style="color: #339933;">-&gt;</span>make_request_fn<span style="color: #009900;">(</span>q<span style="color: #339933;">,</span> rw<span style="color: #339933;">,</span> bh<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>取得请求队列头部request_queue数据结构已经在前一篇中讲过，这里列出函数，不难理解，函数定义在drivers/block/ll_rw_blk.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78411"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td> 
             <td class="code" id="p784code11"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #000000; font-weight: bold;">inline</span> request_queue_t <span style="color: #339933;">*</span>__blk_get_queue<span style="color: #009900;">(</span>kdev_t dev<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> blk_dev_struct <span style="color: #339933;">*</span>bdev <span style="color: #339933;">=</span> blk_dev <span style="color: #339933;">+</span> MAJOR<span style="color: #009900;">(</span>dev<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>bdev<span style="color: #339933;">-&gt;</span>queue<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> bdev<span style="color: #339933;">-&gt;</span>queue<span style="color: #009900;">(</span>dev<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">else</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">&amp;</span>blk_dev<span style="color: #009900;">[</span>MAJOR<span style="color: #009900;">(</span>dev<span style="color: #009900;">)</span><span style="color: #009900;">]</span>.<span style="color: #202020;">request_queue</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 * NOTE: the device-specific queue() functions
 * have to be atomic!
 */</span>
request_queue_t <span style="color: #339933;">*</span>blk_get_queue<span style="color: #009900;">(</span>kdev_t dev<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	request_queue_t <span style="color: #339933;">*</span>ret<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> flags<span style="color: #339933;">;</span>
&nbsp;
	spin_lock_irqsave<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>io_request_lock<span style="color: #339933;">,</span>flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	ret <span style="color: #339933;">=</span> __blk_get_queue<span style="color: #009900;">(</span>dev<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	spin_unlock_irqrestore<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>io_request_lock<span style="color: #339933;">,</span>flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">return</span> ret<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>以主设备号为下标，就可以在blk_dev[]中找到目标设备的blk_dev_struct数据结构，对一种设备第一次调用的时候要通过其函数指针queue()找到这种设备的读写请求队列，找到后就将其记录在结构的request_queue字段，以后就不需要调用了，对于IDE硬盘，实际调用的函数是ide_get_queue()，而且其指针data设置成指向代表着相应硬件接口的ide_hwif_t数据结构，函数定义在drivers/ide/ide.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78412"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td> 
             <td class="code" id="p784code12"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * ide_get_queue() returns the queue which corresponds to a given device.
 */</span>
request_queue_t <span style="color: #339933;">*</span>ide_get_queue <span style="color: #009900;">(</span>kdev_t dev<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	ide_hwif_t <span style="color: #339933;">*</span>hwif <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>ide_hwif_t <span style="color: #339933;">*</span><span style="color: #009900;">)</span>blk_dev<span style="color: #009900;">[</span>MAJOR<span style="color: #009900;">(</span>dev<span style="color: #009900;">)</span><span style="color: #009900;">]</span>.<span style="color: #202020;">data</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">return</span> <span style="color: #339933;">&amp;</span>hwif<span style="color: #339933;">-&gt;</span>drives<span style="color: #009900;">[</span>DEVICE_NR<span style="color: #009900;">(</span>dev<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">]</span>.<span style="color: #202020;">queue</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>回到函数generic_make_request()中，找到请求队列以后就通过队列提供的make_request_fn操作创建一个读写请求数据结构并将其挂入队列。</p> 
         <p>在有些情况下，有些逻辑设备只是映射到其他设备上，而并没有直接的对应物，所以需要一个函数来实现最终的映射等，函数指针make_request_fn就是指向这个函数，如果这个函数所完成的只是从一个设备到另一个设备的映射，则返回一个正数，然后在while循环中再执行一次，否则返回0。</p> 
         <p>对于普通的IDE硬盘，这个指针指向函数__make_request()，它的主要作用就是为数据缓冲区准备一个request数据结构，并将这个数据结构挂入设备的操作请求队列中。如果之前队列是空的就启动该设备的输入/输出操作等，一旦启动则自动由中断驱动进行操作，直到队列空为止。</p> 
         <p>当然，这样还不行，由于硬盘的特殊性，它的使用得经过寻道、寻找扇区等等一系列操作，而这些往往是最耗费时间的，另外，硬盘转动的时候由于惯性等等一系列原因会出现“粘臂”现象，所以，最理想的方法就是把相邻扇区的读或者写操作放在一起进行，所以这里还得有一个优化，主要就是在队列中由后向前搜索，试图将新的请求与已经在队列中的其他请求合并，合并的操作主要就是操作相同并且扇区连续。</p> 
         <p>另外在Linux中的磁盘调度算法是电梯调度算法，也称Linus电梯。</p> 
         <p>函数__make_request()的定义在drivers/block/ll_rw_blk.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78413"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
</pre></td> 
             <td class="code" id="p784code13"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">int</span> __make_request<span style="color: #009900;">(</span>request_queue_t <span style="color: #339933;">*</span> q<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> rw<span style="color: #339933;">,</span>
				  <span style="color: #993333;">struct</span> buffer_head <span style="color: #339933;">*</span> bh<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> sector<span style="color: #339933;">,</span> count<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> max_segments <span style="color: #339933;">=</span> MAX_SEGMENTS<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> request <span style="color: #339933;">*</span> req <span style="color: #339933;">=</span> NULL<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>freereq <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> rw_ahead<span style="color: #339933;">,</span> max_sectors<span style="color: #339933;">,</span> el_ret<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> list_head <span style="color: #339933;">*</span>head<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> latency<span style="color: #339933;">;</span>
	elevator_t <span style="color: #339933;">*</span>elevator <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>q<span style="color: #339933;">-&gt;</span>elevator<span style="color: #339933;">;</span>
&nbsp;
	count <span style="color: #339933;">=</span> bh<span style="color: #339933;">-&gt;</span>b_size <span style="color: #339933;">&gt;&gt;</span> <span style="color: #0000dd;">9</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//需要操作的扇区数</span>
	sector <span style="color: #339933;">=</span> bh<span style="color: #339933;">-&gt;</span>b_rsector<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//起始扇区号</span>
&nbsp;
	rw_ahead <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* normal case; gets changed below for READA */</span>
	<span style="color: #b1b100;">switch</span> <span style="color: #009900;">(</span>rw<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">case</span> READA<span style="color: #339933;">:</span>
			rw_ahead <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//预读</span>
			rw <span style="color: #339933;">=</span> READ<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* drop into READ */</span>
		<span style="color: #b1b100;">case</span> READ<span style="color: #339933;">:</span>
		<span style="color: #b1b100;">case</span> WRITE<span style="color: #339933;">:</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">default</span><span style="color: #339933;">:</span>
			BUG<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">goto</span> end_io<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* We'd better have a real physical mapping!
	   Check this bit only if the buffer was dirty and just locked
	   down by us so at this point flushpage will block and
	   won't clear the mapped bit under us. */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>buffer_mapped<span style="color: #009900;">(</span>bh<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		BUG<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * Temporary solution - in 2.5 this will be done by the lowlevel
	 * driver. Create a bounce buffer if the buffer data points into
	 * high memory - keep the original buffer otherwise.
	 */</span>
<span style="color: #339933;">#if CONFIG_HIGHMEM</span>
	bh <span style="color: #339933;">=</span> create_bounce<span style="color: #009900;">(</span>rw<span style="color: #339933;">,</span> bh<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#endif</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/* look for a free request. */</span>
	<span style="color: #808080; font-style: italic;">/*
	 * Try to coalesce the new request with old requests
	 */</span>
	max_sectors <span style="color: #339933;">=</span> get_max_sectors<span style="color: #009900;">(</span>bh<span style="color: #339933;">-&gt;</span>b_rdev<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *latency反应了对操作等待时间预估值
 */</span>
	latency <span style="color: #339933;">=</span> elevator_request_latency<span style="color: #009900;">(</span>elevator<span style="color: #339933;">,</span> rw<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * Now we acquire the request spinlock, we have to be mega careful
	 * not to schedule or do something nonatomic
	 */</span>
again<span style="color: #339933;">:</span>
	spin_lock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>io_request_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * skip first entry, for devices with active queue head
	 */</span>
	head <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>q<span style="color: #339933;">-&gt;</span>queue_head<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>q<span style="color: #339933;">-&gt;</span>head_active <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span>q<span style="color: #339933;">-&gt;</span>plugged<span style="color: #009900;">)</span>	<span style="color: #666666; font-style: italic;">//若plugged为1表示已经在tq_disk队列中</span>
		head <span style="color: #339933;">=</span> head<span style="color: #339933;">-&gt;</span>next<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>list_empty<span style="color: #009900;">(</span>head<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
<span style="color: #808080; font-style: italic;">/*
 *如果队列为空，则需要启动I/O队列执行，有两种方法，一种是由当前进程
 *自己直接调用一个函数来执行；另一种是将I/O的启动作为一个bh函数“插入”
 *内核中的一个任务队列tq_disk，选择方法根据plug_device_fn指针所指的函数
 *不同而不同，这里是将其指向函数generic_plug_device()，使用第二种方法将
 *设备的操作请求队列插入tq_disk中，前一篇中的request_queue_t数据结构中
 *的plug_tq字段就是为此设计的
 */</span>
		q<span style="color: #339933;">-&gt;</span>plug_device_fn<span style="color: #009900;">(</span>q<span style="color: #339933;">,</span> bh<span style="color: #339933;">-&gt;</span>b_rdev<span style="color: #009900;">)</span><span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* is atomic */</span>
		<span style="color: #b1b100;">goto</span> get_rq<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *当一个IDE设备的队列中已经有操作请求在等待，而又有新的操作请求到来时，
 *可以做两种不同的优化：一种是因为扇区连续而引起的操作合并；还有一种是
 *对操作路线所做的优化或者调度，也就是电梯调度，由一个数据结构elevator_s
 *代表，对于Linus电梯定义如下（include/linux/elevator.h）：
 *	#define ELEVATOR_LINUS						\
 *	((elevator_t) {							\
 *		0,				/ * not used * /		\
 *									\
 *		1000000,				/ * read passovers * /	\
 *		2000000,				/ * write passovers * /	\
 *		0,				/ * max_bomb_segments * /	\
 *									\
 *		0,				/ * not used * /		\
 *		0,				/ * not used * /		\
 *									\
 *		elevator_linus,			/ * elevator_fn * /	\
 *		elevator_linus_merge,		/ * elevator_merge_fn * / \
 *		elevator_noop_dequeue,		/ * dequeue_fn * /	\
 *		})
 *所以下面实际调用的函数是elevator_linus_merge()
 *优化部分很简单，就不多说了
 */</span>
	el_ret <span style="color: #339933;">=</span> elevator<span style="color: #339933;">-&gt;</span>elevator_merge_fn<span style="color: #009900;">(</span>q<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>req<span style="color: #339933;">,</span> bh<span style="color: #339933;">,</span> rw<span style="color: #339933;">,</span>
					     <span style="color: #339933;">&amp;</span>max_sectors<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>max_segments<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">switch</span> <span style="color: #009900;">(</span>el_ret<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
&nbsp;
		<span style="color: #b1b100;">case</span> ELEVATOR_BACK_MERGE<span style="color: #339933;">:</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>q<span style="color: #339933;">-&gt;</span>back_merge_fn<span style="color: #009900;">(</span>q<span style="color: #339933;">,</span> req<span style="color: #339933;">,</span> bh<span style="color: #339933;">,</span> max_segments<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			req<span style="color: #339933;">-&gt;</span>bhtail<span style="color: #339933;">-&gt;</span>b_reqnext <span style="color: #339933;">=</span> bh<span style="color: #339933;">;</span>
			req<span style="color: #339933;">-&gt;</span>bhtail <span style="color: #339933;">=</span> bh<span style="color: #339933;">;</span>
			req<span style="color: #339933;">-&gt;</span>nr_sectors <span style="color: #339933;">=</span> req<span style="color: #339933;">-&gt;</span>hard_nr_sectors <span style="color: #339933;">+=</span> count<span style="color: #339933;">;</span>
			req<span style="color: #339933;">-&gt;</span>e <span style="color: #339933;">=</span> elevator<span style="color: #339933;">;</span>
			drive_stat_acct<span style="color: #009900;">(</span>req<span style="color: #339933;">-&gt;</span>rq_dev<span style="color: #339933;">,</span> req<span style="color: #339933;">-&gt;</span>cmd<span style="color: #339933;">,</span> count<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			attempt_back_merge<span style="color: #009900;">(</span>q<span style="color: #339933;">,</span> req<span style="color: #339933;">,</span> max_sectors<span style="color: #339933;">,</span> max_segments<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">case</span> ELEVATOR_FRONT_MERGE<span style="color: #339933;">:</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>q<span style="color: #339933;">-&gt;</span>front_merge_fn<span style="color: #009900;">(</span>q<span style="color: #339933;">,</span> req<span style="color: #339933;">,</span> bh<span style="color: #339933;">,</span> max_segments<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			bh<span style="color: #339933;">-&gt;</span>b_reqnext <span style="color: #339933;">=</span> req<span style="color: #339933;">-&gt;</span>bh<span style="color: #339933;">;</span>
			req<span style="color: #339933;">-&gt;</span>bh <span style="color: #339933;">=</span> bh<span style="color: #339933;">;</span>
			req<span style="color: #339933;">-&gt;</span>buffer <span style="color: #339933;">=</span> bh<span style="color: #339933;">-&gt;</span>b_data<span style="color: #339933;">;</span>
			req<span style="color: #339933;">-&gt;</span>current_nr_sectors <span style="color: #339933;">=</span> count<span style="color: #339933;">;</span>
			req<span style="color: #339933;">-&gt;</span>sector <span style="color: #339933;">=</span> req<span style="color: #339933;">-&gt;</span>hard_sector <span style="color: #339933;">=</span> sector<span style="color: #339933;">;</span>
			req<span style="color: #339933;">-&gt;</span>nr_sectors <span style="color: #339933;">=</span> req<span style="color: #339933;">-&gt;</span>hard_nr_sectors <span style="color: #339933;">+=</span> count<span style="color: #339933;">;</span>
			req<span style="color: #339933;">-&gt;</span>e <span style="color: #339933;">=</span> elevator<span style="color: #339933;">;</span>
			drive_stat_acct<span style="color: #009900;">(</span>req<span style="color: #339933;">-&gt;</span>rq_dev<span style="color: #339933;">,</span> req<span style="color: #339933;">-&gt;</span>cmd<span style="color: #339933;">,</span> count<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			attempt_front_merge<span style="color: #009900;">(</span>q<span style="color: #339933;">,</span> head<span style="color: #339933;">,</span> req<span style="color: #339933;">,</span> max_sectors<span style="color: #339933;">,</span> max_segments<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
		<span style="color: #808080; font-style: italic;">/*
		 * elevator says don't/can't merge. get new request
		 */</span>
		<span style="color: #b1b100;">case</span> ELEVATOR_NO_MERGE<span style="color: #339933;">:</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">default</span><span style="color: #339933;">:</span>
			printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"elevator returned crap (%d)<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> el_ret<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			BUG<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * Grab a free request from the freelist. Read first try their
	 * own queue - if that is empty, we steal from the write list.
	 * Writes must block if the write list is empty, and read aheads
	 * are not crucial.
	 */</span>
<span style="color: #808080; font-style: italic;">/*
 *如果经过优化合并，则不需要新建立数据结构，若未能优化则需要建立
 */</span>
get_rq<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>freereq<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		req <span style="color: #339933;">=</span> freereq<span style="color: #339933;">;</span>
		freereq <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>req <span style="color: #339933;">=</span> get_request<span style="color: #009900;">(</span>q<span style="color: #339933;">,</span> rw<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">==</span> NULL<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//分配request数据结构</span>
<span style="color: #808080; font-style: italic;">/*
 *在内核中request数据结构的数量是固定的，在调用get_request()的时候
 *还要说明具体的操作（写操作比读操作慢，所以要求更严）。如果分配
 *失败，则说明系统中的request数量已经够多了，那么如果操作是预读
 *就直接返回，如果是其他的就通过__get_request_wait()来进行睡眠等待
 *并且针对任务队列tq_disk调用run_task_queue()，使可能启动的操作队列
 *得到启动，为回收request创造条件
 */</span>
		spin_unlock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>io_request_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>rw_ahead<span style="color: #009900;">)</span>	<span style="color: #666666; font-style: italic;">//预读</span>
			<span style="color: #b1b100;">goto</span> end_io<span style="color: #339933;">;</span>
&nbsp;
		freereq <span style="color: #339933;">=</span> __get_request_wait<span style="color: #009900;">(</span>q<span style="color: #339933;">,</span> rw<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *经过睡眠，操作队列可能已经改变，所以要回到again处重新取得
 *队首请求
 */</span>
		<span style="color: #b1b100;">goto</span> again<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/* fill up the request-info, and add it to the queue */</span>
<span style="color: #808080; font-style: italic;">/*
 *设置request数据结构
 */</span>
	req<span style="color: #339933;">-&gt;</span>cmd <span style="color: #339933;">=</span> rw<span style="color: #339933;">;</span>
	req<span style="color: #339933;">-&gt;</span>errors <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	req<span style="color: #339933;">-&gt;</span>hard_sector <span style="color: #339933;">=</span> req<span style="color: #339933;">-&gt;</span>sector <span style="color: #339933;">=</span> sector<span style="color: #339933;">;</span>
	req<span style="color: #339933;">-&gt;</span>hard_nr_sectors <span style="color: #339933;">=</span> req<span style="color: #339933;">-&gt;</span>nr_sectors <span style="color: #339933;">=</span> count<span style="color: #339933;">;</span>
	req<span style="color: #339933;">-&gt;</span>current_nr_sectors <span style="color: #339933;">=</span> count<span style="color: #339933;">;</span>
	req<span style="color: #339933;">-&gt;</span>nr_segments <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* Always 1 for a new request. */</span>
	req<span style="color: #339933;">-&gt;</span>nr_hw_segments <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* Always 1 for a new request. */</span>
	req<span style="color: #339933;">-&gt;</span>buffer <span style="color: #339933;">=</span> bh<span style="color: #339933;">-&gt;</span>b_data<span style="color: #339933;">;</span>
	req<span style="color: #339933;">-&gt;</span>sem <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	req<span style="color: #339933;">-&gt;</span>bh <span style="color: #339933;">=</span> bh<span style="color: #339933;">;</span>
	req<span style="color: #339933;">-&gt;</span>bhtail <span style="color: #339933;">=</span> bh<span style="color: #339933;">;</span>
	req<span style="color: #339933;">-&gt;</span>rq_dev <span style="color: #339933;">=</span> bh<span style="color: #339933;">-&gt;</span>b_rdev<span style="color: #339933;">;</span>
	req<span style="color: #339933;">-&gt;</span>e <span style="color: #339933;">=</span> elevator<span style="color: #339933;">;</span>
	add_request<span style="color: #009900;">(</span>q<span style="color: #339933;">,</span> req<span style="color: #339933;">,</span> head<span style="color: #339933;">,</span> latency<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//挂入设备的操作请求队列</span>
out<span style="color: #339933;">:</span>
<span style="color: #808080; font-style: italic;">/*
 *若plugged标志为0，表示没有插入到tq_disk队列中，那么就使用request_fn
 *函数指针直接启动第一个I/O操作
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>q<span style="color: #339933;">-&gt;</span>plugged<span style="color: #009900;">)</span>
		<span style="color: #009900;">(</span>q<span style="color: #339933;">-&gt;</span>request_fn<span style="color: #009900;">)</span><span style="color: #009900;">(</span>q<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>freereq<span style="color: #009900;">)</span>
		blkdev_release_request<span style="color: #009900;">(</span>freereq<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	spin_unlock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>io_request_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
end_io<span style="color: #339933;">:</span>
	bh<span style="color: #339933;">-&gt;</span>b_end_io<span style="color: #009900;">(</span>bh<span style="color: #339933;">,</span> test_bit<span style="color: #009900;">(</span>BH_Uptodate<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>bh<span style="color: #339933;">-&gt;</span>b_state<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>加入请求队列函数add_request()定义在ll_rw_blk.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78414"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td> 
             <td class="code" id="p784code14"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * add-request adds a request to the linked list.
 * It disables interrupts (acquires the request spinlock) so that it can muck
 * with the request-lists in peace. Thus it should be called with no spinlocks
 * held.
 *
 * By this point, req-&gt;cmd is always either READ/WRITE, never READA,
 * which is important for drive_stat_acct() above.
 */</span>
&nbsp;
<span style="color: #993333;">static</span> <span style="color: #000000; font-weight: bold;">inline</span> <span style="color: #993333;">void</span> add_request<span style="color: #009900;">(</span>request_queue_t <span style="color: #339933;">*</span> q<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> request <span style="color: #339933;">*</span> req<span style="color: #339933;">,</span>
			       <span style="color: #993333;">struct</span> list_head <span style="color: #339933;">*</span>head<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> lat<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span> major<span style="color: #339933;">;</span>
&nbsp;
	drive_stat_acct<span style="color: #009900;">(</span>req<span style="color: #339933;">-&gt;</span>rq_dev<span style="color: #339933;">,</span> req<span style="color: #339933;">-&gt;</span>cmd<span style="color: #339933;">,</span> req<span style="color: #339933;">-&gt;</span>nr_sectors<span style="color: #339933;">,</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * let selected elevator insert the request
	 */</span>
	q<span style="color: #339933;">-&gt;</span>elevator.<span style="color: #202020;">elevator_fn</span><span style="color: #009900;">(</span>req<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>q<span style="color: #339933;">-&gt;</span>elevator<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>q<span style="color: #339933;">-&gt;</span>queue_head<span style="color: #339933;">,</span> head<span style="color: #339933;">,</span> lat<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;">/*
	 * FIXME(eric) I don't understand why there is a need for this
	 * special case code.  It clearly doesn't fit any more with
	 * the new queueing architecture, and it got added in 2.3.10.
	 * I am leaving this in here until I hear back from the COMPAQ
	 * people.
         */</span>
<span style="color: #808080; font-style: italic;">/*
 *检查操作的对象是否是若干种设备之一，如果是就要直接通过队列的函数指针
 *request_fn启动队列中的第一个I/O操作
 */</span>
	major <span style="color: #339933;">=</span> MAJOR<span style="color: #009900;">(</span>req<span style="color: #339933;">-&gt;</span>rq_dev<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>major <span style="color: #339933;">&gt;=</span> COMPAQ_SMART2_MAJOR<span style="color: #339933;">+</span><span style="color: #0000dd;">0</span> <span style="color: #339933;">&amp;&amp;</span> major <span style="color: #339933;">&lt;=</span> COMPAQ_SMART2_MAJOR<span style="color: #339933;">+</span><span style="color: #0000dd;">7</span><span style="color: #009900;">)</span>
		<span style="color: #009900;">(</span>q<span style="color: #339933;">-&gt;</span>request_fn<span style="color: #009900;">)</span><span style="color: #009900;">(</span>q<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>major <span style="color: #339933;">&gt;=</span> COMPAQ_CISS_MAJOR<span style="color: #339933;">+</span><span style="color: #0000dd;">0</span> <span style="color: #339933;">&amp;&amp;</span> major <span style="color: #339933;">&lt;=</span> COMPAQ_CISS_MAJOR<span style="color: #339933;">+</span><span style="color: #0000dd;">7</span><span style="color: #009900;">)</span>
                <span style="color: #009900;">(</span>q<span style="color: #339933;">-&gt;</span>request_fn<span style="color: #009900;">)</span><span style="color: #009900;">(</span>q<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>major <span style="color: #339933;">&gt;=</span> DAC960_MAJOR<span style="color: #339933;">+</span><span style="color: #0000dd;">0</span> <span style="color: #339933;">&amp;&amp;</span> major <span style="color: #339933;">&lt;=</span> DAC960_MAJOR<span style="color: #339933;">+</span><span style="color: #0000dd;">7</span><span style="color: #009900;">)</span>
		<span style="color: #009900;">(</span>q<span style="color: #339933;">-&gt;</span>request_fn<span style="color: #009900;">)</span><span style="color: #009900;">(</span>q<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>加入的时候使用Linus电梯调度进行了优化，电梯调度就不多说了，具体的elevator_fn指针指向了函数elevator_linus()函数，定义在drivers/block/elevator.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78415"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td> 
             <td class="code" id="p784code15"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * Order ascending, but only allow a request to be skipped a certain
 * number of times
 */</span>
<span style="color: #993333;">void</span> elevator_linus<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> request <span style="color: #339933;">*</span>req<span style="color: #339933;">,</span> elevator_t <span style="color: #339933;">*</span>elevator<span style="color: #339933;">,</span>
		    <span style="color: #993333;">struct</span> list_head <span style="color: #339933;">*</span>real_head<span style="color: #339933;">,</span>
		    <span style="color: #993333;">struct</span> list_head <span style="color: #339933;">*</span>head<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> orig_latency<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> list_head <span style="color: #339933;">*</span>entry <span style="color: #339933;">=</span> real_head<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> request <span style="color: #339933;">*</span>tmp<span style="color: #339933;">;</span>
&nbsp;
	req<span style="color: #339933;">-&gt;</span>elevator_sequence <span style="color: #339933;">=</span> orig_latency<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>entry <span style="color: #339933;">=</span> entry<span style="color: #339933;">-&gt;</span>prev<span style="color: #009900;">)</span> <span style="color: #339933;">!=</span> head<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		tmp <span style="color: #339933;">=</span> blkdev_entry_to_request<span style="color: #009900;">(</span>entry<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>IN_ORDER<span style="color: #009900;">(</span>tmp<span style="color: #339933;">,</span> req<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>tmp<span style="color: #339933;">-&gt;</span>elevator_sequence<span style="color: #009900;">)</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		tmp<span style="color: #339933;">-&gt;</span>elevator_sequence<span style="color: #339933;">--;</span>
	<span style="color: #009900;">}</span>
	list_add<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>req<span style="color: #339933;">-&gt;</span>queue<span style="color: #339933;">,</span> entry<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>宏操作IN_ORDER定义在include/linux/elevator.h中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78416"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td> 
             <td class="code" id="p784code16"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * This is used in the elevator algorithm.  We don't prioritise reads
 * over writes any more --- although reads are more time-critical than
 * writes, by treating them equally we increase filesystem throughput.
 * This turns out to give better overall performance.  -- sct
 */</span>
<span style="color: #339933;">#define IN_ORDER(s1,s2)				\
	((((s1)-&gt;rq_dev == (s2)-&gt;rq_dev &amp;&amp;	\
	   (s1)-&gt;sector &lt; (s2)-&gt;sector)) ||	\
	 (s1)-&gt;rq_dev &lt; (s2)-&gt;rq_dev)</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>至此，将新的请求挂入操作请求队列的任务已经完成了，真正的读/写操作是一个异步的过程，是留到bh处执行的。当然我们也可以使用一些函数来特意等待读写完成，毛老先生的书上介绍了个wait_on_buffer()函数，其定义列出此处就不解释了：<br> 函数wait_on_buffer()定义在include/linux/locks.h中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78417"> 
             <td class="line_numbers"><pre>1
2
3
4
5
</pre></td> 
             <td class="code" id="p784code17"><pre class="c" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">extern</span> <span style="color: #000000; font-weight: bold;">inline</span> <span style="color: #993333;">void</span> wait_on_buffer<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> buffer_head <span style="color: #339933;">*</span> bh<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>test_bit<span style="color: #009900;">(</span>BH_Lock<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>bh<span style="color: #339933;">-&gt;</span>b_state<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		__wait_on_buffer<span style="color: #009900;">(</span>bh<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>函数__wait_on_buffer()定义在fs/buffer.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78418"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td> 
             <td class="code" id="p784code18"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">void</span> __wait_on_buffer<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> buffer_head <span style="color: #339933;">*</span> bh<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> task_struct <span style="color: #339933;">*</span>tsk <span style="color: #339933;">=</span> current<span style="color: #339933;">;</span>
	DECLARE_WAITQUEUE<span style="color: #009900;">(</span>wait<span style="color: #339933;">,</span> tsk<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	atomic_inc<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>bh<span style="color: #339933;">-&gt;</span>b_count<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	add_wait_queue<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>bh<span style="color: #339933;">-&gt;</span>b_wait<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>wait<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">do</span> <span style="color: #009900;">{</span>
		run_task_queue<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tq_disk<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		set_task_state<span style="color: #009900;">(</span>tsk<span style="color: #339933;">,</span> TASK_UNINTERRUPTIBLE<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>buffer_locked<span style="color: #009900;">(</span>bh<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		schedule<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>buffer_locked<span style="color: #009900;">(</span>bh<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	tsk<span style="color: #339933;">-&gt;</span>state <span style="color: #339933;">=</span> TASK_RUNNING<span style="color: #339933;">;</span>
	remove_wait_queue<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>bh<span style="color: #339933;">-&gt;</span>b_wait<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>wait<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	atomic_dec<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>bh<span style="color: #339933;">-&gt;</span>b_count<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>当调用run_task_queue()的时候会把队列中tq_struct结构从队列中解除并通过其函数指针routine调用相应的bh函数，对于块设备，启动操作是generic_unplug_device()函数，定义在ll_rw_blk.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78419"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td> 
             <td class="code" id="p784code19"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * remove the plug and let it rip..
 */</span>
<span style="color: #993333;">static</span> <span style="color: #000000; font-weight: bold;">inline</span> <span style="color: #993333;">void</span> __generic_unplug_device<span style="color: #009900;">(</span>request_queue_t <span style="color: #339933;">*</span>q<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>q<span style="color: #339933;">-&gt;</span>plugged<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		q<span style="color: #339933;">-&gt;</span>plugged <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>list_empty<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>q<span style="color: #339933;">-&gt;</span>queue_head<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
<span style="color: #808080; font-style: italic;">/*
 *对于作为主设备连接在IDE接口上的硬盘，request_fn()指向的是
 *函数do_ide_request()
 */</span>
			q<span style="color: #339933;">-&gt;</span>request_fn<span style="color: #009900;">(</span>q<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #993333;">static</span> <span style="color: #993333;">void</span> generic_unplug_device<span style="color: #009900;">(</span><span style="color: #993333;">void</span> <span style="color: #339933;">*</span>data<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
<span style="color: #808080; font-style: italic;">/*
 *data为tq_struct结构中的指针，用来传递对bh函数的参数
 *在此传递request_queue_t数据结构指针
 */</span>
	request_queue_t <span style="color: #339933;">*</span>q <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>request_queue_t <span style="color: #339933;">*</span><span style="color: #009900;">)</span> data<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> flags<span style="color: #339933;">;</span>
&nbsp;
	spin_lock_irqsave<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>io_request_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	__generic_unplug_device<span style="color: #009900;">(</span>q<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	spin_unlock_irqrestore<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>io_request_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>函数do_ide_request()定义在drivers/ide/ide.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78420"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
</pre></td> 
             <td class="code" id="p784code20"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">void</span> do_ide_request<span style="color: #009900;">(</span>request_queue_t <span style="color: #339933;">*</span>q<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
<span style="color: #808080; font-style: italic;">/*
 *queuedata指针是个void类型的指针，对于IDE接口，它指向一个ide_hwgroup_t
 *数据结构
 */</span>
	ide_do_request<span style="color: #009900;">(</span>q<span style="color: #339933;">-&gt;</span>queuedata<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>函数ide_do_request()定义在drivers/ide/ide.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78421"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
</pre></td> 
             <td class="code" id="p784code21"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * Issue a new request to a drive from hwgroup
 * Caller must have already done spin_lock_irqsave(&amp;io_request_lock, ..);
 *
 * A hwgroup is a serialized group of IDE interfaces.  Usually there is
 * exactly one hwif (interface) per hwgroup, but buggy controllers (eg. CMD640)
 * may have both interfaces in a single hwgroup to "serialize" access.
 * Or possibly multiple ISA interfaces can share a common IRQ by being grouped
 * together into one hwgroup for serialized access.
 *
 * Note also that several hwgroups can end up sharing a single IRQ,
 * possibly along with many other devices.  This is especially common in
 * PCI-based systems with off-board IDE controller cards.
 *
 * The IDE driver uses the single global io_request_lock spinlock to protect
 * access to the request queues, and to protect the hwgroup-&gt;busy flag.
 *
 * The first thread into the driver for a particular hwgroup sets the
 * hwgroup-&gt;busy flag to indicate that this hwgroup is now active,
 * and then initiates processing of the top request from the request queue.
 *
 * Other threads attempting entry notice the busy setting, and will simply
 * queue their new requests and exit immediately.  Note that hwgroup-&gt;busy
 * remains set even when the driver is merely awaiting the next interrupt.
 * Thus, the meaning is "this hwgroup is busy processing a request".
 *
 * When processing of a request completes, the completing thread or IRQ-handler
 * will start the next request from the queue.  If no more work remains,
 * the driver will clear the hwgroup-&gt;busy flag and exit.
 *
 * The io_request_lock (spinlock) is used to protect all access to the
 * hwgroup-&gt;busy flag, but is otherwise not needed for most processing in
 * the driver.  This makes the driver much more friendlier to shared IRQs
 * than previous designs, while remaining 100% (?) SMP safe and capable.
 */</span>
<span style="color: #993333;">static</span> <span style="color: #993333;">void</span> ide_do_request<span style="color: #009900;">(</span>ide_hwgroup_t <span style="color: #339933;">*</span>hwgroup<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> masked_irq<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	ide_drive_t	<span style="color: #339933;">*</span>drive<span style="color: #339933;">;</span>
	ide_hwif_t	<span style="color: #339933;">*</span>hwif<span style="color: #339933;">;</span>
	ide_startstop_t	startstop<span style="color: #339933;">;</span>
&nbsp;
	ide_get_lock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>ide_lock<span style="color: #339933;">,</span> ide_intr<span style="color: #339933;">,</span> hwgroup<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* for atari only: POSSIBLY BROKEN HERE(?) */</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *对设备的操作必须是独占的，不允许其他干扰，所以这里关中断
 */</span>
	__cli<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* necessary paranoia: ensure IRQs are masked on local CPU */</span>
&nbsp;
	<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>hwgroup<span style="color: #339933;">-&gt;</span>busy<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		hwgroup<span style="color: #339933;">-&gt;</span>busy <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//防止其他干扰，使其他操作不会进入此while循环</span>
		drive <span style="color: #339933;">=</span> choose_drive<span style="color: #009900;">(</span>hwgroup<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//确定要操作IDE接口上的哪一个磁盘</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive <span style="color: #339933;">==</span> NULL<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> sleep <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
			hwgroup<span style="color: #339933;">-&gt;</span>rq <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
			drive <span style="color: #339933;">=</span> hwgroup<span style="color: #339933;">-&gt;</span>drive<span style="color: #339933;">;</span>	
<span style="color: #808080; font-style: italic;">/*
 *同一硬盘组不能同时操作指的是不能同时发送命令，在某些场合下
 *硬盘需要睡眠，也就是在某个预定的时间之前不对其进行发送命令
 *如果寻找操作的磁盘为空的话那就有两种可能，一个是所有磁盘
 *都在睡眠状态，二是所有磁盘操作请求队列都是空。
 *对于第二种情况直接将busy标志设成0结束循环即可
 *对于第一中情况，需要循环扫描最早结束时间，如果非0表示是由睡眠
 *引起的，因此将sleeping标志设置成1，表示整个磁盘组都在睡眠，同时
 *设置一个定时器，让它在到点的时候将该ide_hwgroup_t唤醒
 */</span>
			<span style="color: #b1b100;">do</span> <span style="color: #009900;">{</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>sleep <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>sleep <span style="color: #339933;">||</span> <span style="color: #0000dd;">0</span> <span style="color: #339933;">&lt;</span> <span style="color: #009900;">(</span><span style="color: #993333;">signed</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span><span style="color: #009900;">(</span>sleep <span style="color: #339933;">-</span> drive<span style="color: #339933;">-&gt;</span>sleep<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
					sleep <span style="color: #339933;">=</span> drive<span style="color: #339933;">-&gt;</span>sleep<span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span> <span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>drive <span style="color: #339933;">=</span> drive<span style="color: #339933;">-&gt;</span>next<span style="color: #009900;">)</span> <span style="color: #339933;">!=</span> hwgroup<span style="color: #339933;">-&gt;</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>sleep<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				<span style="color: #808080; font-style: italic;">/*
				 * Take a short snooze, and then wake up this hwgroup again.
				 * This gives other hwgroups on the same a chance to
				 * play fairly with us, just in case there are big differences
				 * in relative throughputs.. don't want to hog the cpu too much.
				 */</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #0000dd;">0</span> <span style="color: #339933;">&lt;</span> <span style="color: #009900;">(</span><span style="color: #993333;">signed</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span><span style="color: #009900;">(</span>jiffies <span style="color: #339933;">+</span> WAIT_MIN_SLEEP <span style="color: #339933;">-</span> sleep<span style="color: #009900;">)</span><span style="color: #009900;">)</span> 
					sleep <span style="color: #339933;">=</span> jiffies <span style="color: #339933;">+</span> WAIT_MIN_SLEEP<span style="color: #339933;">;</span>
<span style="color: #339933;">#if 1</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>timer_pending<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>hwgroup<span style="color: #339933;">-&gt;</span>timer<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
					printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"ide_set_handler: timer already active<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#endif</span>
				hwgroup<span style="color: #339933;">-&gt;</span>sleeping <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* so that ide_timer_expiry knows what to do */</span>
				mod_timer<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>hwgroup<span style="color: #339933;">-&gt;</span>timer<span style="color: #339933;">,</span> sleep<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #808080; font-style: italic;">/* we purposely leave hwgroup-&gt;busy==1 while sleeping */</span>
			<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
				<span style="color: #808080; font-style: italic;">/* Ugly, but how can we sleep for the lock otherwise? perhaps from tq_disk? */</span>
				ide_release_lock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>ide_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* for atari only */</span>
				hwgroup<span style="color: #339933;">-&gt;</span>busy <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* no more work for this hwgroup (for now) */</span>
		<span style="color: #009900;">}</span>
<span style="color: #808080; font-style: italic;">/*
 *	#define HWIF(drive)		((ide_hwif_t *)((drive)-&gt;hwif))
 *	#define SELECT_INTERRUPT(hwif,drive)				\
 *	{								\
 *		if (hwif-&gt;intrproc)					\
 *			hwif-&gt;intrproc(drive);				\
 *		else							\
 *		OUT_BYTE((drive)-&gt;ctl|2, hwif-&gt;io_ports[IDE_CONTROL_OFFSET]);	\
 *	}
 *SELECT_INTERRUPT宏第一个参数为需要写出的字节，当这个字节bit1为1
 *的时候该IDE接口中断请求就被屏蔽了，第二个参数是寄存器的I/O地址
 *这里涉及了IDE接口切换的问题，如果新的接口不与原ide_hwgroup_t中的
 *相同，那么就是将接口切换，发送完请求以后就可以切换了
 */</span>
		hwif <span style="color: #339933;">=</span> HWIF<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>hwgroup<span style="color: #339933;">-&gt;</span>hwif<span style="color: #339933;">-&gt;</span>sharing_irq <span style="color: #339933;">&amp;&amp;</span> hwif <span style="color: #339933;">!=</span> hwgroup<span style="color: #339933;">-&gt;</span>hwif <span style="color: #339933;">&amp;&amp;</span> hwif<span style="color: #339933;">-&gt;</span>io_ports<span style="color: #009900;">[</span>IDE_CONTROL_OFFSET<span style="color: #009900;">]</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #808080; font-style: italic;">/* set nIEN for previous hwif */</span>
			SELECT_INTERRUPT<span style="color: #009900;">(</span>hwif<span style="color: #339933;">,</span> drive<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		hwgroup<span style="color: #339933;">-&gt;</span>hwif <span style="color: #339933;">=</span> hwif<span style="color: #339933;">;</span>
		hwgroup<span style="color: #339933;">-&gt;</span>drive <span style="color: #339933;">=</span> drive<span style="color: #339933;">;</span>
		drive<span style="color: #339933;">-&gt;</span>sleep <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		drive<span style="color: #339933;">-&gt;</span>service_start <span style="color: #339933;">=</span> jiffies<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//本次操作启动时间</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span> drive<span style="color: #339933;">-&gt;</span>queue.<span style="color: #202020;">plugged</span> <span style="color: #009900;">)</span>	<span style="color: #808080; font-style: italic;">/* paranoia */</span>
			printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"%s: Huh? nuking plugged queue<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> drive<span style="color: #339933;">-&gt;</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *rq指向操作队列中的第一个请求
 */</span>
		hwgroup<span style="color: #339933;">-&gt;</span>rq <span style="color: #339933;">=</span> blkdev_entry_next_request<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>drive<span style="color: #339933;">-&gt;</span>queue.<span style="color: #202020;">queue_head</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #808080; font-style: italic;">/*
		 * Some systems have trouble with IDE IRQs arriving while
		 * the driver is still setting things up.  So, here we disable
		 * the IRQ used by this interface while the request is being started.
		 * This may look bad at first, but pretty much the same thing
		 * happens anyway when any interrupt comes in, IDE or otherwise
		 *  -- the kernel masks the IRQ while it is being handled.
		 */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>masked_irq <span style="color: #339933;">&amp;&amp;</span> hwif<span style="color: #339933;">-&gt;</span>irq <span style="color: #339933;">!=</span> masked_irq<span style="color: #009900;">)</span>
			disable_irq_nosync<span style="color: #009900;">(</span>hwif<span style="color: #339933;">-&gt;</span>irq<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//将具体的中断服务关闭</span>
		spin_unlock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>io_request_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		ide__sti<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* allow other IRQs while we start this request 开启全局中断*/</span>
		startstop <span style="color: #339933;">=</span> start_request<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//向目标磁盘发出请求命令</span>
		spin_lock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>io_request_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>masked_irq <span style="color: #339933;">&amp;&amp;</span> hwif<span style="color: #339933;">-&gt;</span>irq <span style="color: #339933;">!=</span> masked_irq<span style="color: #009900;">)</span>
			enable_irq<span style="color: #009900;">(</span>hwif<span style="color: #339933;">-&gt;</span>irq<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>startstop <span style="color: #339933;">==</span> ide_stopped<span style="color: #009900;">)</span>
			hwgroup<span style="color: #339933;">-&gt;</span>busy <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>函数start_request()定义在ide.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78422"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
</pre></td> 
             <td class="code" id="p784code22"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * start_request() initiates handling of a new I/O request
 */</span>
<span style="color: #993333;">static</span> ide_startstop_t start_request <span style="color: #009900;">(</span>ide_drive_t <span style="color: #339933;">*</span>drive<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	ide_startstop_t startstop<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> block<span style="color: #339933;">,</span> blockend<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> request <span style="color: #339933;">*</span>rq <span style="color: #339933;">=</span> blkdev_entry_next_request<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>drive<span style="color: #339933;">-&gt;</span>queue.<span style="color: #202020;">queue_head</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> minor <span style="color: #339933;">=</span> MINOR<span style="color: #009900;">(</span>rq<span style="color: #339933;">-&gt;</span>rq_dev<span style="color: #009900;">)</span><span style="color: #339933;">,</span> unit <span style="color: #339933;">=</span> minor <span style="color: #339933;">&gt;&gt;</span> PARTN_BITS<span style="color: #339933;">;</span>
	ide_hwif_t <span style="color: #339933;">*</span>hwif <span style="color: #339933;">=</span> HWIF<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #339933;">#ifdef DEBUG</span>
	printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"%s: start_request: current=0x%08lx<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> hwif<span style="color: #339933;">-&gt;</span>name<span style="color: #339933;">,</span> <span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span> rq<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#endif</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>unit <span style="color: #339933;">&gt;=</span> MAX_DRIVES<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"%s: bad device number: %s<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> hwif<span style="color: #339933;">-&gt;</span>name<span style="color: #339933;">,</span> kdevname<span style="color: #009900;">(</span>rq<span style="color: #339933;">-&gt;</span>rq_dev<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> kill_rq<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
<span style="color: #339933;">#ifdef DEBUG</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>rq<span style="color: #339933;">-&gt;</span>bh <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span>buffer_locked<span style="color: #009900;">(</span>rq<span style="color: #339933;">-&gt;</span>bh<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"%s: block not locked<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> drive<span style="color: #339933;">-&gt;</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> kill_rq<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
<span style="color: #339933;">#endif</span>
	block    <span style="color: #339933;">=</span> rq<span style="color: #339933;">-&gt;</span>sector<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//block是起始扇区号</span>
	blockend <span style="color: #339933;">=</span> block <span style="color: #339933;">+</span> rq<span style="color: #339933;">-&gt;</span>nr_sectors<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//blockend是结束扇区号</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>rq<span style="color: #339933;">-&gt;</span>cmd <span style="color: #339933;">==</span> READ <span style="color: #339933;">||</span> rq<span style="color: #339933;">-&gt;</span>cmd <span style="color: #339933;">==</span> WRITE<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span>
	    <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>media <span style="color: #339933;">==</span> ide_disk <span style="color: #339933;">||</span> drive<span style="color: #339933;">-&gt;</span>media <span style="color: #339933;">==</span> ide_floppy<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>blockend <span style="color: #339933;">&lt;</span> block<span style="color: #009900;">)</span> <span style="color: #339933;">||</span> <span style="color: #009900;">(</span>blockend <span style="color: #339933;">&gt;</span> drive<span style="color: #339933;">-&gt;</span>part<span style="color: #009900;">[</span>minor<span style="color: #339933;">&amp;</span>PARTN_MASK<span style="color: #009900;">]</span>.<span style="color: #202020;">nr_sects</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"%s%c: bad access: block=%ld, count=%ld<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> drive<span style="color: #339933;">-&gt;</span>name<span style="color: #339933;">,</span>
			 <span style="color: #009900;">(</span>minor<span style="color: #339933;">&amp;</span>PARTN_MASK<span style="color: #009900;">)</span><span style="color: #339933;">?</span><span style="color: #ff0000;">'0'</span><span style="color: #339933;">+</span><span style="color: #009900;">(</span>minor<span style="color: #339933;">&amp;</span>PARTN_MASK<span style="color: #009900;">)</span><span style="color: #339933;">:</span><span style="color: #ff0000;">' '</span><span style="color: #339933;">,</span> block<span style="color: #339933;">,</span> rq<span style="color: #339933;">-&gt;</span>nr_sectors<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">goto</span> kill_rq<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
<span style="color: #808080; font-style: italic;">/*
 *若所操作的“磁盘”实际上只是磁盘上的一个分区，那就要将其逻辑扇区号
 *映射成物理扇区号
 */</span>
		block <span style="color: #339933;">+=</span> drive<span style="color: #339933;">-&gt;</span>part<span style="color: #009900;">[</span>minor<span style="color: #339933;">&amp;</span>PARTN_MASK<span style="color: #009900;">]</span>.<span style="color: #202020;">start_sect</span> <span style="color: #339933;">+</span> drive<span style="color: #339933;">-&gt;</span>sect0<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #808080; font-style: italic;">/* Yecch - this will shift the entire interval,
	   possibly killing some innocent following sector */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>block <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span> <span style="color: #339933;">&amp;&amp;</span> drive<span style="color: #339933;">-&gt;</span>remap_0_to_1 <span style="color: #339933;">==</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span>
		block <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>  <span style="color: #808080; font-style: italic;">/* redirect MBR access to EZ-Drive partn table */</span>
&nbsp;
<span style="color: #339933;">#if (DISK_RECOVERY_TIME &gt; 0)</span>
	<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>read_timer<span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #339933;">-</span> hwif<span style="color: #339933;">-&gt;</span>last_time<span style="color: #009900;">)</span> <span style="color: #339933;">&lt;</span> DISK_RECOVERY_TIME<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//恢复时间等待</span>
<span style="color: #339933;">#endif</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *SELECT_DRIVE定义如下（ide.h）：
 *	#define SELECT_DRIVE(hwif,drive)				\
 *	{								\
 *		if (hwif-&gt;selectproc)					\
 *			hwif-&gt;selectproc(drive);			\
 *		OUT_BYTE((drive)-&gt;select.all, hwif-&gt;io_ports[IDE_SELECT_OFFSET]); \
 *	}
 */</span>
	SELECT_DRIVE<span style="color: #009900;">(</span>hwif<span style="color: #339933;">,</span> drive<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>ide_wait_stat<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>startstop<span style="color: #339933;">,</span> drive<span style="color: #339933;">,</span> drive<span style="color: #339933;">-&gt;</span>ready_stat<span style="color: #339933;">,</span> BUSY_STAT<span style="color: #339933;">|</span>DRQ_STAT<span style="color: #339933;">,</span> WAIT_READY<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"%s: drive not ready for command<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> drive<span style="color: #339933;">-&gt;</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span> startstop<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>drive<span style="color: #339933;">-&gt;</span>special.<span style="color: #202020;">all</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>rq<span style="color: #339933;">-&gt;</span>cmd <span style="color: #339933;">==</span> IDE_DRIVE_CMD <span style="color: #339933;">||</span> rq<span style="color: #339933;">-&gt;</span>cmd <span style="color: #339933;">==</span> IDE_DRIVE_TASK<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #b1b100;">return</span> execute_drive_cmd<span style="color: #009900;">(</span>drive<span style="color: #339933;">,</span> rq<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>driver <span style="color: #339933;">!=</span> NULL<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
<span style="color: #808080; font-style: italic;">/*
 *对于IDE硬盘来说实际调用的是do_rw_disk()函数
 */</span>
			<span style="color: #b1b100;">return</span> <span style="color: #009900;">(</span>DRIVER<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>do_request<span style="color: #009900;">(</span>drive<span style="color: #339933;">,</span> rq<span style="color: #339933;">,</span> block<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"%s: media type %d not supported<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> drive<span style="color: #339933;">-&gt;</span>name<span style="color: #339933;">,</span> drive<span style="color: #339933;">-&gt;</span>media<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> kill_rq<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">return</span> do_special<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
kill_rq<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>driver <span style="color: #339933;">!=</span> NULL<span style="color: #009900;">)</span>
		DRIVER<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>end_request<span style="color: #009900;">(</span><span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> HWGROUP<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">else</span>
		ide_end_request<span style="color: #009900;">(</span><span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> HWGROUP<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> ide_stopped<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>函数do_rw_disk()定义在ide-disk.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78423"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
</pre></td> 
             <td class="code" id="p784code23"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * do_rw_disk() issues READ and WRITE commands to a disk,
 * using LBA if supported, or CHS otherwise, to address sectors.
 * It also takes care of issuing special DRIVE_CMDs.
 */</span>
<span style="color: #993333;">static</span> ide_startstop_t do_rw_disk <span style="color: #009900;">(</span>ide_drive_t <span style="color: #339933;">*</span>drive<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> request <span style="color: #339933;">*</span>rq<span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> block<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>IDE_CONTROL_REG<span style="color: #009900;">)</span>
<span style="color: #808080; font-style: italic;">/*
 *#define IDE_CONTROL_REG (HWIF(drive)-&gt;io_ports[IDE_CONTROL_OFFSET])
 *bit1为0表示解除对IDE接口中断请求的屏蔽
 */</span>
		OUT_BYTE<span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>ctl<span style="color: #339933;">,</span>IDE_CONTROL_REG<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	OUT_BYTE<span style="color: #009900;">(</span>rq<span style="color: #339933;">-&gt;</span>nr_sectors<span style="color: #339933;">,</span>IDE_NSECTOR_REG<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//写入需要读写的扇区数量寄存器</span>
<span style="color: #339933;">#ifdef CONFIG_BLK_DEV_PDC4030</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>select.<span style="color: #202020;">b</span>.<span style="color: #202020;">lba</span> <span style="color: #339933;">||</span> IS_PDC4030_DRIVE<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
<span style="color: #339933;">#else /* !CONFIG_BLK_DEV_PDC4030 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>select.<span style="color: #202020;">b</span>.<span style="color: #202020;">lba</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//使用LBA模式</span>
<span style="color: #339933;">#endif /* CONFIG_BLK_DEV_PDC4030 */</span>
<span style="color: #339933;">#ifdef DEBUG</span>
		printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"%s: %sing: LBAsect=%ld, sectors=%ld, buffer=0x%08lx<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span>
			drive<span style="color: #339933;">-&gt;</span>name<span style="color: #339933;">,</span> <span style="color: #009900;">(</span>rq<span style="color: #339933;">-&gt;</span>cmd<span style="color: #339933;">==</span>READ<span style="color: #009900;">)</span><span style="color: #339933;">?</span><span style="color: #ff0000;">"read"</span><span style="color: #339933;">:</span><span style="color: #ff0000;">"writ"</span><span style="color: #339933;">,</span>
			block<span style="color: #339933;">,</span> rq<span style="color: #339933;">-&gt;</span>nr_sectors<span style="color: #339933;">,</span> <span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span> rq<span style="color: #339933;">-&gt;</span>buffer<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#endif</span>
		OUT_BYTE<span style="color: #009900;">(</span>block<span style="color: #339933;">,</span>IDE_SECTOR_REG<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		OUT_BYTE<span style="color: #009900;">(</span>block<span style="color: #339933;">&gt;&gt;=</span><span style="color: #0000dd;">8</span><span style="color: #339933;">,</span>IDE_LCYL_REG<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		OUT_BYTE<span style="color: #009900;">(</span>block<span style="color: #339933;">&gt;&gt;=</span><span style="color: #0000dd;">8</span><span style="color: #339933;">,</span>IDE_HCYL_REG<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		OUT_BYTE<span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #009900;">(</span>block<span style="color: #339933;">&gt;&gt;</span><span style="color: #0000dd;">8</span><span style="color: #009900;">)</span><span style="color: #339933;">&amp;</span><span style="color: #208080;">0x0f</span><span style="color: #009900;">)</span><span style="color: #339933;">|</span>drive<span style="color: #339933;">-&gt;</span>select.<span style="color: #202020;">all</span><span style="color: #339933;">,</span>IDE_SELECT_REG<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//使用CHS模式，需要换算成磁道、磁头等</span>
		<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> sect<span style="color: #339933;">,</span>head<span style="color: #339933;">,</span>cyl<span style="color: #339933;">,</span>track<span style="color: #339933;">;</span>
		track <span style="color: #339933;">=</span> block <span style="color: #339933;">/</span> drive<span style="color: #339933;">-&gt;</span>sect<span style="color: #339933;">;</span>
		sect  <span style="color: #339933;">=</span> block <span style="color: #339933;">%</span> drive<span style="color: #339933;">-&gt;</span>sect <span style="color: #339933;">+</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
		OUT_BYTE<span style="color: #009900;">(</span>sect<span style="color: #339933;">,</span>IDE_SECTOR_REG<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		head  <span style="color: #339933;">=</span> track <span style="color: #339933;">%</span> drive<span style="color: #339933;">-&gt;</span>head<span style="color: #339933;">;</span>
		cyl   <span style="color: #339933;">=</span> track <span style="color: #339933;">/</span> drive<span style="color: #339933;">-&gt;</span>head<span style="color: #339933;">;</span>
		OUT_BYTE<span style="color: #009900;">(</span>cyl<span style="color: #339933;">,</span>IDE_LCYL_REG<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		OUT_BYTE<span style="color: #009900;">(</span>cyl<span style="color: #339933;">&gt;&gt;</span><span style="color: #0000dd;">8</span><span style="color: #339933;">,</span>IDE_HCYL_REG<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		OUT_BYTE<span style="color: #009900;">(</span>head<span style="color: #339933;">|</span>drive<span style="color: #339933;">-&gt;</span>select.<span style="color: #202020;">all</span><span style="color: #339933;">,</span>IDE_SELECT_REG<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#ifdef DEBUG</span>
		printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"%s: %sing: CHS=%d/%d/%d, sectors=%ld, buffer=0x%08lx<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span>
			drive<span style="color: #339933;">-&gt;</span>name<span style="color: #339933;">,</span> <span style="color: #009900;">(</span>rq<span style="color: #339933;">-&gt;</span>cmd<span style="color: #339933;">==</span>READ<span style="color: #009900;">)</span><span style="color: #339933;">?</span><span style="color: #ff0000;">"read"</span><span style="color: #339933;">:</span><span style="color: #ff0000;">"writ"</span><span style="color: #339933;">,</span> cyl<span style="color: #339933;">,</span>
			head<span style="color: #339933;">,</span> sect<span style="color: #339933;">,</span> rq<span style="color: #339933;">-&gt;</span>nr_sectors<span style="color: #339933;">,</span> <span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span> rq<span style="color: #339933;">-&gt;</span>buffer<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#endif</span>
	<span style="color: #009900;">}</span>
<span style="color: #339933;">#ifdef CONFIG_BLK_DEV_PDC4030</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>IS_PDC4030_DRIVE<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #000000; font-weight: bold;">extern</span> ide_startstop_t do_pdc4030_io<span style="color: #009900;">(</span>ide_drive_t <span style="color: #339933;">*,</span> <span style="color: #993333;">struct</span> request <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span> do_pdc4030_io <span style="color: #009900;">(</span>drive<span style="color: #339933;">,</span> rq<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
<span style="color: #339933;">#endif /* CONFIG_BLK_DEV_PDC4030 */</span>
<span style="color: #808080; font-style: italic;">/*
 *读操作
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>rq<span style="color: #339933;">-&gt;</span>cmd <span style="color: #339933;">==</span> READ<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
<span style="color: #339933;">#ifdef CONFIG_BLK_DEV_IDEDMA</span>
<span style="color: #808080; font-style: italic;">/*
 *DMA选项，对于磁盘的I/O控制方式有两种，一种是程序控制I/O方式
 *就是通过CPU执行程序来在外设与内存之间搬运数据，而外设与内存并
 *不直接接触，另一种是由外设直接访问内存，即DMA方式。不管哪种
 *方式，当数据一次读/写完成后外设会向CPU发送中断请求来告知CPU
 *读写完成
 */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>using_dma <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span><span style="color: #009900;">(</span>HWIF<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>dmaproc<span style="color: #009900;">(</span>ide_dma_read<span style="color: #339933;">,</span> drive<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">return</span> ide_started<span style="color: #339933;">;</span>
<span style="color: #339933;">#endif /* CONFIG_BLK_DEV_IDEDMA */</span>
		ide_set_handler<span style="color: #009900;">(</span>drive<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>read_intr<span style="color: #339933;">,</span> WAIT_CMD<span style="color: #339933;">,</span> NULL<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//设置中断服务程序</span>
<span style="color: #808080; font-style: italic;">/*
 *处理好了一切之后，CPU就开始通过命令寄存器下达读操作命令，
 *由于不同的磁盘内部缓冲区大小不同，有的硬盘每读出一个扇区就
 *发送中断请求，而有的则读出多个扇区才发送
 *因为前面已经将要读/写的具体要求写入到特定寄存器了，所以这里只
 *需要发送读命令即可
 *读命令一经发送以后就启动了读操作，硬盘将数据读入硬盘的缓冲区，
 *读完一次以后硬盘发送中断请求，此后就是中断服务程序read_intr()
 *的事了
 */</span>
		OUT_BYTE<span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>mult_count <span style="color: #339933;">?</span> WIN_MULTREAD <span style="color: #339933;">:</span> WIN_READ<span style="color: #339933;">,</span> IDE_COMMAND_REG<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span> ide_started<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
<span style="color: #808080; font-style: italic;">/*
 *写操作
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>rq<span style="color: #339933;">-&gt;</span>cmd <span style="color: #339933;">==</span> WRITE<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		ide_startstop_t startstop<span style="color: #339933;">;</span>
<span style="color: #339933;">#ifdef CONFIG_BLK_DEV_IDEDMA</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>using_dma <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span><span style="color: #009900;">(</span>HWIF<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>dmaproc<span style="color: #009900;">(</span>ide_dma_write<span style="color: #339933;">,</span> drive<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">return</span> ide_started<span style="color: #339933;">;</span>
<span style="color: #339933;">#endif /* CONFIG_BLK_DEV_IDEDMA */</span>
<span style="color: #808080; font-style: italic;">/*
 *发送写操作命令
 */</span>
		OUT_BYTE<span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>mult_count <span style="color: #339933;">?</span> WIN_MULTWRITE <span style="color: #339933;">:</span> WIN_WRITE<span style="color: #339933;">,</span> IDE_COMMAND_REG<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>ide_wait_stat<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>startstop<span style="color: #339933;">,</span> drive<span style="color: #339933;">,</span> DATA_READY<span style="color: #339933;">,</span> drive<span style="color: #339933;">-&gt;</span>bad_wstat<span style="color: #339933;">,</span> WAIT_DRQ<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
<span style="color: #808080; font-style: italic;">/*
 *ide_wait_stat()函数用来等待和读取磁盘的状态寄存器
 */</span>
			printk<span style="color: #009900;">(</span>KERN_ERR <span style="color: #ff0000;">"%s: no DRQ after issuing %s<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> drive<span style="color: #339933;">-&gt;</span>name<span style="color: #339933;">,</span>
				drive<span style="color: #339933;">-&gt;</span>mult_count <span style="color: #339933;">?</span> <span style="color: #ff0000;">"MULTWRITE"</span> <span style="color: #339933;">:</span> <span style="color: #ff0000;">"WRITE"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">return</span> startstop<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>drive<span style="color: #339933;">-&gt;</span>unmask<span style="color: #009900;">)</span>
			__cli<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* local CPU only */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>mult_count<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			ide_hwgroup_t <span style="color: #339933;">*</span>hwgroup <span style="color: #339933;">=</span> HWGROUP<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #808080; font-style: italic;">/*
			 * Ugh.. this part looks ugly because we MUST set up
			 * the interrupt handler before outputting the first block
			 * of data to be written.  If we hit an error (corrupted buffer list)
			 * in ide_multwrite(), then we need to remove the handler/timer
			 * before returning.  Fortunately, this NEVER happens (right?).
			 *
			 * Except when you get an error it seems...
			 */</span>
			hwgroup<span style="color: #339933;">-&gt;</span>wrq <span style="color: #339933;">=</span> <span style="color: #339933;">*</span>rq<span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* scratchpad */</span>
			ide_set_handler <span style="color: #009900;">(</span>drive<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>multwrite_intr<span style="color: #339933;">,</span> WAIT_CMD<span style="color: #339933;">,</span> NULL<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>ide_multwrite<span style="color: #009900;">(</span>drive<span style="color: #339933;">,</span> drive<span style="color: #339933;">-&gt;</span>mult_count<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> flags<span style="color: #339933;">;</span>
				spin_lock_irqsave<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>io_request_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				hwgroup<span style="color: #339933;">-&gt;</span>handler <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
				del_timer<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>hwgroup<span style="color: #339933;">-&gt;</span>timer<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				spin_unlock_irqrestore<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>io_request_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #b1b100;">return</span> ide_stopped<span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
		<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//单扇区的写出</span>
			ide_set_handler <span style="color: #009900;">(</span>drive<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>write_intr<span style="color: #339933;">,</span> WAIT_CMD<span style="color: #339933;">,</span> NULL<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//设置中断服务</span>
			idedisk_output_data<span style="color: #009900;">(</span>drive<span style="color: #339933;">,</span> rq<span style="color: #339933;">-&gt;</span>buffer<span style="color: #339933;">,</span> SECTOR_WORDS<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//数据输出</span>
		<span style="color: #009900;">}</span>
		<span style="color: #b1b100;">return</span> ide_started<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	printk<span style="color: #009900;">(</span>KERN_ERR <span style="color: #ff0000;">"%s: bad command: %d<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> drive<span style="color: #339933;">-&gt;</span>name<span style="color: #339933;">,</span> rq<span style="color: #339933;">-&gt;</span>cmd<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	ide_end_request<span style="color: #009900;">(</span><span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> HWGROUP<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> ide_stopped<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>首先我们来讨论I/O程序控制方式。</p> 
         <p>对于读操作，CPU需要在已经准备好读出时得到通知，然后再执行从磁盘读出，也就是要先设置好一个中断服务程序read_intr()，这个函数是ide_set_handler()，定义在ide.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78424"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td> 
             <td class="code" id="p784code24"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * This should get invoked any time we exit the driver to
 * wait for an interrupt response from a drive.  handler() points
 * at the appropriate code to handle the next interrupt, and a
 * timer is started to prevent us from waiting forever in case
 * something goes wrong (see the ide_timer_expiry() handler later on).
 */</span>
<span style="color: #993333;">void</span> ide_set_handler <span style="color: #009900;">(</span>ide_drive_t <span style="color: #339933;">*</span>drive<span style="color: #339933;">,</span> ide_handler_t <span style="color: #339933;">*</span>handler<span style="color: #339933;">,</span>
		      <span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> timeout<span style="color: #339933;">,</span> ide_expiry_t <span style="color: #339933;">*</span>expiry<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
<span style="color: #808080; font-style: italic;">/*
 *第三个参数是为本次操作所设置的时间限制，第四个函数是个函数指针
 *表明超过时间时所调用的函数，NULL表示采用标准超时处理
 *这个函数的主要用途就是将中断服务函数指针放入ide_hwgroup_t数据结构
 */</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> flags<span style="color: #339933;">;</span>
	ide_hwgroup_t <span style="color: #339933;">*</span>hwgroup <span style="color: #339933;">=</span> HWGROUP<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	spin_lock_irqsave<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>io_request_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>hwgroup<span style="color: #339933;">-&gt;</span>handler <span style="color: #339933;">!=</span> NULL<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"%s: ide_set_handler: handler not null; old=%p, new=%p<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span>
			drive<span style="color: #339933;">-&gt;</span>name<span style="color: #339933;">,</span> hwgroup<span style="color: #339933;">-&gt;</span>handler<span style="color: #339933;">,</span> handler<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	hwgroup<span style="color: #339933;">-&gt;</span>handler	<span style="color: #339933;">=</span> handler<span style="color: #339933;">;</span>
	hwgroup<span style="color: #339933;">-&gt;</span>expiry		<span style="color: #339933;">=</span> expiry<span style="color: #339933;">;</span>
	hwgroup<span style="color: #339933;">-&gt;</span>timer.<span style="color: #202020;">expires</span>	<span style="color: #339933;">=</span> jiffies <span style="color: #339933;">+</span> timeout<span style="color: #339933;">;</span>
	add_timer<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>hwgroup<span style="color: #339933;">-&gt;</span>timer<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	spin_unlock_irqrestore<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>io_request_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>等待和读取磁盘状态寄存器的函数ide_wait_stat()定义在ide.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78425"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td> 
             <td class="code" id="p784code25"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * This routine busy-waits for the drive status to be not "busy".
 * It then checks the status for all of the "good" bits and none
 * of the "bad" bits, and if all is okay it returns 0.  All other
 * cases return 1 after invoking ide_error() -- caller should just return.
 *
 * This routine should get fixed to not hog the cpu during extra long waits..
 * That could be done by busy-waiting for the first jiffy or two, and then
 * setting a timer to wake up at half second intervals thereafter,
 * until timeout is achieved, before timing out.
 */</span>
<span style="color: #993333;">int</span> ide_wait_stat <span style="color: #009900;">(</span>ide_startstop_t <span style="color: #339933;">*</span>startstop<span style="color: #339933;">,</span> ide_drive_t <span style="color: #339933;">*</span>drive<span style="color: #339933;">,</span> byte good<span style="color: #339933;">,</span> byte bad<span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> timeout<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
	byte stat<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> i<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> flags<span style="color: #339933;">;</span>
&nbsp;
	udelay<span style="color: #009900;">(</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* spec allows drive 400ns to assert "BUSY" */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>stat <span style="color: #339933;">=</span> GET_STAT<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">&amp;</span> BUSY_STAT<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		__save_flags<span style="color: #009900;">(</span>flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* local CPU only */</span>
		ide__sti<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* local CPU only */</span>
		timeout <span style="color: #339933;">+=</span> jiffies<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>stat <span style="color: #339933;">=</span> GET_STAT<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">&amp;</span> BUSY_STAT<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #0000dd;">0</span> <span style="color: #339933;">&lt;</span> <span style="color: #009900;">(</span><span style="color: #993333;">signed</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span><span style="color: #009900;">(</span>jiffies <span style="color: #339933;">-</span> timeout<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				__restore_flags<span style="color: #009900;">(</span>flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* local CPU only */</span>
				<span style="color: #339933;">*</span>startstop <span style="color: #339933;">=</span> ide_error<span style="color: #009900;">(</span>drive<span style="color: #339933;">,</span> <span style="color: #ff0000;">"status timeout"</span><span style="color: #339933;">,</span> stat<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
		<span style="color: #009900;">}</span>
		__restore_flags<span style="color: #009900;">(</span>flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* local CPU only */</span>
	<span style="color: #009900;">}</span>
	<span style="color: #808080; font-style: italic;">/*
	 * Allow status to settle, then read it again.
	 * A few rare drives vastly violate the 400ns spec here,
	 * so we'll wait up to 10usec for a "good" status
	 * rather than expensively fail things immediately.
	 * This fix courtesy of Matthew Faupel &amp; Niccolo Rigacci.
	 */</span>
	<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>i <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> i <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">10</span><span style="color: #339933;">;</span> i<span style="color: #339933;">++</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		udelay<span style="color: #009900;">(</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>OK_STAT<span style="color: #009900;">(</span><span style="color: #009900;">(</span>stat <span style="color: #339933;">=</span> GET_STAT<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span> good<span style="color: #339933;">,</span> bad<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #339933;">*</span>startstop <span style="color: #339933;">=</span> ide_error<span style="color: #009900;">(</span>drive<span style="color: #339933;">,</span> <span style="color: #ff0000;">"status error"</span><span style="color: #339933;">,</span> stat<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>写操作的时候使用函数idedisk_output_data()来进行数据写出这个函数定义在ide-disk.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78426"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td> 
             <td class="code" id="p784code26"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #000000; font-weight: bold;">inline</span> <span style="color: #993333;">void</span> idedisk_output_data <span style="color: #009900;">(</span>ide_drive_t <span style="color: #339933;">*</span>drive<span style="color: #339933;">,</span> <span style="color: #993333;">void</span> <span style="color: #339933;">*</span>buffer<span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> wcount<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
<span style="color: #808080; font-style: italic;">/*
 *drive为具体硬盘的ide_drive_t数据结构
 *buffer指向缓冲区
 *wcount是待写数据长度
 *不同的CPU在内存中存储数据是不一样的，有“大端”模式和“小端”模式
 *之分，但是写到硬盘上的数据都是一样的，所以这里需要转换
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>bswap<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		idedisk_bswap_data<span style="color: #009900;">(</span>buffer<span style="color: #339933;">,</span> wcount<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		ide_output_data<span style="color: #009900;">(</span>drive<span style="color: #339933;">,</span> buffer<span style="color: #339933;">,</span> wcount<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		idedisk_bswap_data<span style="color: #009900;">(</span>buffer<span style="color: #339933;">,</span> wcount<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span>
		ide_output_data<span style="color: #009900;">(</span>drive<span style="color: #339933;">,</span> buffer<span style="color: #339933;">,</span> wcount<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>真正的写入数据操作是ide_output_data()函数，这个函数定义在ide.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78427"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td> 
             <td class="code" id="p784code27"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * This is used for most PIO data transfers *to* the IDE interface
 */</span>
<span style="color: #993333;">void</span> ide_output_data <span style="color: #009900;">(</span>ide_drive_t <span style="color: #339933;">*</span>drive<span style="color: #339933;">,</span> <span style="color: #993333;">void</span> <span style="color: #339933;">*</span>buffer<span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> wcount<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	byte io_32bit <span style="color: #339933;">=</span> drive<span style="color: #339933;">-&gt;</span>io_32bit<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>io_32bit<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
<span style="color: #339933;">#if SUPPORT_VLB_SYNC</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>io_32bit <span style="color: #339933;">&amp;</span> <span style="color: #0000dd;">2</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> flags<span style="color: #339933;">;</span>
			__save_flags<span style="color: #009900;">(</span>flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* local CPU only */</span>
			__cli<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* local CPU only */</span>
			do_vlb_sync<span style="color: #009900;">(</span>IDE_NSECTOR_REG<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			outsl<span style="color: #009900;">(</span>IDE_DATA_REG<span style="color: #339933;">,</span> buffer<span style="color: #339933;">,</span> wcount<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			__restore_flags<span style="color: #009900;">(</span>flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* local CPU only */</span>
		<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span>
<span style="color: #339933;">#endif /* SUPPORT_VLB_SYNC */</span>
			outsl<span style="color: #009900;">(</span>IDE_DATA_REG<span style="color: #339933;">,</span> buffer<span style="color: #339933;">,</span> wcount<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//32位输出</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
<span style="color: #339933;">#if SUPPORT_SLOW_DATA_PORTS</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>slow<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #993333;">unsigned</span> <span style="color: #993333;">short</span> <span style="color: #339933;">*</span>ptr <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">short</span> <span style="color: #339933;">*</span><span style="color: #009900;">)</span> buffer<span style="color: #339933;">;</span>
			<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>wcount<span style="color: #339933;">--</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				outw_p<span style="color: #009900;">(</span><span style="color: #339933;">*</span>ptr<span style="color: #339933;">++,</span> IDE_DATA_REG<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				outw_p<span style="color: #009900;">(</span><span style="color: #339933;">*</span>ptr<span style="color: #339933;">++,</span> IDE_DATA_REG<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
		<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span>
<span style="color: #339933;">#endif /* SUPPORT_SLOW_DATA_PORTS */</span>
			outsw<span style="color: #009900;">(</span>IDE_DATA_REG<span style="color: #339933;">,</span> buffer<span style="color: #339933;">,</span> wcount<span style="color: #339933;">&lt;&lt;</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//16位输出</span>
	<span style="color: #009900;">}</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>这样，写操作启动就完成了，写操作完成后磁盘会想CPU发送中断请求，转入到函数write_intr()处理，这里的就直接返回到函数do_rw_disk()中返回ide_started。</p> 
         <p>硬盘的中断服务总程序是ide_intr()程序，它定义在ide.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78428"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
</pre></td> 
             <td class="code" id="p784code28"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * entry point for all interrupts, caller does __cli() for us
 */</span>
<span style="color: #993333;">void</span> ide_intr <span style="color: #009900;">(</span><span style="color: #993333;">int</span> irq<span style="color: #339933;">,</span> <span style="color: #993333;">void</span> <span style="color: #339933;">*</span>dev_id<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> pt_regs <span style="color: #339933;">*</span>regs<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> flags<span style="color: #339933;">;</span>
	ide_hwgroup_t <span style="color: #339933;">*</span>hwgroup <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>ide_hwgroup_t <span style="color: #339933;">*</span><span style="color: #009900;">)</span>dev_id<span style="color: #339933;">;</span>
	ide_hwif_t <span style="color: #339933;">*</span>hwif<span style="color: #339933;">;</span>
	ide_drive_t <span style="color: #339933;">*</span>drive<span style="color: #339933;">;</span>
	ide_handler_t <span style="color: #339933;">*</span>handler<span style="color: #339933;">;</span>
	ide_startstop_t startstop<span style="color: #339933;">;</span>
&nbsp;
	spin_lock_irqsave<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>io_request_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	hwif <span style="color: #339933;">=</span> hwgroup<span style="color: #339933;">-&gt;</span>hwif<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>ide_ack_intr<span style="color: #009900;">(</span>hwif<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		spin_unlock_irqrestore<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>io_request_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>handler <span style="color: #339933;">=</span> hwgroup<span style="color: #339933;">-&gt;</span>handler<span style="color: #009900;">)</span> <span style="color: #339933;">==</span> NULL <span style="color: #339933;">||</span> hwgroup<span style="color: #339933;">-&gt;</span>poll_timeout <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #808080; font-style: italic;">/*
		 * Not expecting an interrupt from this drive.
		 * That means this could be:
		 *	(1) an interrupt from another PCI device
		 *	sharing the same PCI INT# as us.
		 * or	(2) a drive just entered sleep or standby mode,
		 *	and is interrupting to let us know.
		 * or	(3) a spurious interrupt of unknown origin.
		 *
		 * For PCI, we cannot tell the difference,
		 * so in that case we just ignore it and hope it goes away.
		 */</span>
<span style="color: #339933;">#ifdef CONFIG_BLK_DEV_IDEPCI</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>IDE_PCI_DEVID_EQ<span style="color: #009900;">(</span>hwif<span style="color: #339933;">-&gt;</span>pci_devid<span style="color: #339933;">,</span> IDE_PCI_DEVID_NULL<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
<span style="color: #339933;">#endif	/* CONFIG_BLK_DEV_IDEPCI */</span>
		<span style="color: #009900;">{</span>
			<span style="color: #808080; font-style: italic;">/*
			 * Probably not a shared PCI interrupt,
			 * so we can safely try to do something about it:
			 */</span>
			unexpected_intr<span style="color: #009900;">(</span>irq<span style="color: #339933;">,</span> hwgroup<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#ifdef CONFIG_BLK_DEV_IDEPCI</span>
		<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
			<span style="color: #808080; font-style: italic;">/*
			 * Whack the status register, just in case we have a leftover pending IRQ.
			 */</span>
			<span style="color: #009900;">(</span><span style="color: #993333;">void</span><span style="color: #009900;">)</span> IN_BYTE<span style="color: #009900;">(</span>hwif<span style="color: #339933;">-&gt;</span>io_ports<span style="color: #009900;">[</span>IDE_STATUS_OFFSET<span style="color: #009900;">]</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#endif /* CONFIG_BLK_DEV_IDEPCI */</span>
		<span style="color: #009900;">}</span>
		spin_unlock_irqrestore<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>io_request_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	drive <span style="color: #339933;">=</span> hwgroup<span style="color: #339933;">-&gt;</span>drive<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>drive<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #808080; font-style: italic;">/*
		 * This should NEVER happen, and there isn't much we could do about it here.
		 */</span>
		spin_unlock_irqrestore<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>io_request_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>drive_is_ready<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #808080; font-style: italic;">/*
		 * This happens regularly when we share a PCI IRQ with another device.
		 * Unfortunately, it can also happen with some buggy drives that trigger
		 * the IRQ before their status register is up to date.  Hopefully we have
		 * enough advance overhead that the latter isn't a problem.
		 */</span>
		spin_unlock_irqrestore<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>io_request_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>hwgroup<span style="color: #339933;">-&gt;</span>busy<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		hwgroup<span style="color: #339933;">-&gt;</span>busy <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* paranoia */</span>
		printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"%s: ide_intr: hwgroup-&gt;busy was 0 ??<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> drive<span style="color: #339933;">-&gt;</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	hwgroup<span style="color: #339933;">-&gt;</span>handler <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	del_timer<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>hwgroup<span style="color: #339933;">-&gt;</span>timer<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	spin_unlock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>io_request_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>unmask<span style="color: #009900;">)</span>
		ide__sti<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* local CPU only */</span>
	startstop <span style="color: #339933;">=</span> handler<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* service this interrupt, may set handler for next interrupt */</span>
	spin_lock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>io_request_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * Note that handler() may have set things up for another
	 * interrupt to occur soon, but it cannot happen until
	 * we exit from this routine, because it will be the
	 * same irq as is currently being serviced here, and Linux
	 * won't allow another of the same (on any CPU) until we return.
	 */</span>
	set_recovery_timer<span style="color: #009900;">(</span>HWIF<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	drive<span style="color: #339933;">-&gt;</span>service_time <span style="color: #339933;">=</span> jiffies <span style="color: #339933;">-</span> drive<span style="color: #339933;">-&gt;</span>service_start<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>startstop <span style="color: #339933;">==</span> ide_stopped<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>hwgroup<span style="color: #339933;">-&gt;</span>handler <span style="color: #339933;">==</span> NULL<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #808080; font-style: italic;">/* paranoia */</span>
			hwgroup<span style="color: #339933;">-&gt;</span>busy <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
			ide_do_request<span style="color: #009900;">(</span>hwgroup<span style="color: #339933;">,</span> hwif<span style="color: #339933;">-&gt;</span>irq<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
			printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"%s: ide_intr: huh? expected NULL handler on exit<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> drive<span style="color: #339933;">-&gt;</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
	spin_unlock_irqrestore<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>io_request_lock<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>主要就是调用其handler指针，在读操作的时候这个指针就是指向函数read_intr()，定义在ide-disk.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78429"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre></td> 
             <td class="code" id="p784code29"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * read_intr() is the handler for disk read/multread interrupts
 */</span>
<span style="color: #993333;">static</span> ide_startstop_t read_intr <span style="color: #009900;">(</span>ide_drive_t <span style="color: #339933;">*</span>drive<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	byte stat<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> i<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> msect<span style="color: #339933;">,</span> nsect<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> request <span style="color: #339933;">*</span>rq<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* new way for dealing with premature shared PCI interrupts */</span>
<span style="color: #808080; font-style: italic;">/*
 *如果标志位表明中断未准备好，但是也没有出错的话就将中断服务程序继续设置成
 *read_intr()到下次中断再处理
 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>OK_STAT<span style="color: #009900;">(</span>stat<span style="color: #339933;">=</span>GET_STAT<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>DATA_READY<span style="color: #339933;">,</span>BAD_R_STAT<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>stat <span style="color: #339933;">&amp;</span> <span style="color: #009900;">(</span>ERR_STAT<span style="color: #339933;">|</span>DRQ_STAT<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #b1b100;">return</span> ide_error<span style="color: #009900;">(</span>drive<span style="color: #339933;">,</span> <span style="color: #ff0000;">"read_intr"</span><span style="color: #339933;">,</span> stat<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		<span style="color: #808080; font-style: italic;">/* no data yet, so wait for another interrupt */</span>
		ide_set_handler<span style="color: #009900;">(</span>drive<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>read_intr<span style="color: #339933;">,</span> WAIT_CMD<span style="color: #339933;">,</span> NULL<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span> ide_started<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	msect <span style="color: #339933;">=</span> drive<span style="color: #339933;">-&gt;</span>mult_count<span style="color: #339933;">;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *否则就进行具体的读取处理
 *nsect为一次从磁盘上读取的扇区数量
 */</span>
read_next<span style="color: #339933;">:</span>
	rq <span style="color: #339933;">=</span> HWGROUP<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>rq<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>msect<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>nsect <span style="color: #339933;">=</span> rq<span style="color: #339933;">-&gt;</span>current_nr_sectors<span style="color: #009900;">)</span> <span style="color: #339933;">&gt;</span> msect<span style="color: #009900;">)</span>
			nsect <span style="color: #339933;">=</span> msect<span style="color: #339933;">;</span>
		msect <span style="color: #339933;">-=</span> nsect<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span>
		nsect <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	idedisk_input_data<span style="color: #009900;">(</span>drive<span style="color: #339933;">,</span> rq<span style="color: #339933;">-&gt;</span>buffer<span style="color: #339933;">,</span> nsect <span style="color: #339933;">*</span> SECTOR_WORDS<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//读取</span>
<span style="color: #339933;">#ifdef DEBUG</span>
	printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"%s:  read: sectors(%ld-%ld), buffer=0x%08lx, remaining=%ld<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span>
		drive<span style="color: #339933;">-&gt;</span>name<span style="color: #339933;">,</span> rq<span style="color: #339933;">-&gt;</span>sector<span style="color: #339933;">,</span> rq<span style="color: #339933;">-&gt;</span>sector<span style="color: #339933;">+</span>nsect<span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #339933;">,</span>
		<span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span> rq<span style="color: #339933;">-&gt;</span>buffer<span style="color: #339933;">+</span><span style="color: #009900;">(</span>nsect<span style="color: #339933;">&lt;&lt;</span><span style="color: #0000dd;">9</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span> rq<span style="color: #339933;">-&gt;</span>nr_sectors<span style="color: #339933;">-</span>nsect<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#endif</span>
	rq<span style="color: #339933;">-&gt;</span>sector <span style="color: #339933;">+=</span> nsect<span style="color: #339933;">;</span>
	rq<span style="color: #339933;">-&gt;</span>buffer <span style="color: #339933;">+=</span> nsect<span style="color: #339933;">&lt;&lt;</span><span style="color: #0000dd;">9</span><span style="color: #339933;">;</span>
	rq<span style="color: #339933;">-&gt;</span>errors <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	i <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>rq<span style="color: #339933;">-&gt;</span>nr_sectors <span style="color: #339933;">-=</span> nsect<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #993333;">long</span><span style="color: #009900;">)</span><span style="color: #009900;">(</span>rq<span style="color: #339933;">-&gt;</span>current_nr_sectors <span style="color: #339933;">-=</span> nsect<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">&lt;=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
<span style="color: #808080; font-style: italic;">/*
 *只要到达了缓冲区末尾，就会调用ide_end_request()来进行启用下一个
 *缓冲区或者对整个操作进行善后处理
 */</span>
		ide_end_request<span style="color: #009900;">(</span><span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> HWGROUP<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>i <span style="color: #339933;">&gt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>msect<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> read_next<span style="color: #339933;">;</span>
		ide_set_handler <span style="color: #009900;">(</span>drive<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>read_intr<span style="color: #339933;">,</span> WAIT_CMD<span style="color: #339933;">,</span> NULL<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
                <span style="color: #b1b100;">return</span> ide_started<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
        <span style="color: #b1b100;">return</span> ide_stopped<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>缓冲区部分暂时跳过，这篇实在是太长了，捡重点讲。</p> 
         <p>下面那讨论DMA方式：</p> 
         <p>在传统的PC结构中，要通过一个DMA控制器才能进行DMA操作，在对外设进行DMA操作的时候，DMA控制器暂时接管CPU称为主设备与内存通信。现在PCI总线的设计推广了PC系统结构中的DMA操作的概念。PCI总线允许连接的总线上的设备竞争成为总线主设备，并且可以把内存看成是总线上的从设备，这样一来，PCI有可能当家作主，作为主设备来真正访问内存了。</p> 
         <p>对于可以成为总线主设备的设备，在配置寄存器组的命令寄存器中有个控制位，可以允许或者不允许参加这种竞争，IDE硬盘接口就有竞争的能力，因而可以进行这种真正意义上的DMA操作。为了与传统PC系统结构的DMA操作相区别，这种DMA操作称为“总线主DMA”或者BMDMA，至于不具备BMDMA功能的PCI设备，仍可以通过DMA控制器对其进行DMA操作。</p> 
         <p>DMA操作主要是先准备DMA区间，DMA区间准备完成之后，实现DMA操作就简单了。</p> 
         <p>为了BMDMA的需要，IDE接口中增设了两组DMA寄存器。分别用于IDE接口上的两个通道。这些寄存器采用I/O编址并且固定为IDE接口的第五个区间（配置寄存器中的resource[4]），IDE接口能进行单缓冲和多缓冲的DMA实现。只要为之准备下一个“DMA区间表”，表中逐个地列出用于DMA操作的若干缓冲区间，并把这个表的起始地址写入IDE接口上相应的“总线主IDE描述表指针”寄存器（BMIDTPX），则启动DMA操作后IDE接口会先从表中找到第一个缓冲区间地址；完成第一个缓冲区间操作以后就会自动转到第二个缓冲区间，直到完成所有区间操作。</p> 
         <p>IDE硬盘的驱动DMA方式是在do_rw_disk()中开始的，在那里有个编译选项（是否支持DMA可以在编译的时候决定），我们将其读写启动的代码列出来：</p> 
         <p>读操作：</p> 
         <p>if (drive-&gt;using_dma &amp;&amp; !(HWIF(drive)-&gt;dmaproc(ide_dma_read, drive)))</p> 
         <p>return ide_started;</p> 
         <p>写操作：</p> 
         <p>if (drive-&gt;using_dma &amp;&amp; !(HWIF(drive)-&gt;dmaproc(ide_dma_write, drive)))</p> 
         <p>return ide_started;</p> 
         <p>采用DMA的时候对IDE硬盘的读/写操作的启动是通过ide_hwif_t数据结构中提供的函数指针dmaproc完成，这个指针指向函数ide_dmaproc()，第一个参数当读的时候就是ide_dma_read，当写的时候就是ide_dma_write，第二个参数是数据结构ide_drive_t，函数ide_dmaproc()定义在drivers/ide/ide-dma.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78430"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
</pre></td> 
             <td class="code" id="p784code30"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * ide_dmaproc() initiates/aborts DMA read/write operations on a drive.
 *
 * The caller is assumed to have selected the drive and programmed the drive's
 * sector address using CHS or LBA.  All that remains is to prepare for DMA
 * and then issue the actual read/write DMA/PIO command to the drive.
 *
 * For ATAPI devices, we just prepare for DMA and return. The caller should
 * then issue the packet command to the drive and call us again with
 * ide_dma_begin afterwards.
 *
 * Returns 0 if all went well.
 * Returns 1 if DMA read/write could not be started, in which case
 * the caller should revert to PIO for the current request.
 * May also be invoked from trm290.c
 */</span>
<span style="color: #993333;">int</span> ide_dmaproc <span style="color: #009900;">(</span>ide_dma_action_t func<span style="color: #339933;">,</span> ide_drive_t <span style="color: #339933;">*</span>drive<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	ide_hwif_t <span style="color: #339933;">*</span>hwif <span style="color: #339933;">=</span> HWIF<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> dma_base <span style="color: #339933;">=</span> hwif<span style="color: #339933;">-&gt;</span>dma_base<span style="color: #339933;">;</span>
	byte unit <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>select.<span style="color: #202020;">b</span>.<span style="color: #202020;">unit</span> <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0x01</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> count<span style="color: #339933;">,</span> reading <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	byte dma_stat<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">switch</span> <span style="color: #009900;">(</span>func<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">case</span> ide_dma_off<span style="color: #339933;">:</span>
			printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"%s: DMA disabled<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> drive<span style="color: #339933;">-&gt;</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">case</span> ide_dma_off_quietly<span style="color: #339933;">:</span>
			outb<span style="color: #009900;">(</span>inb<span style="color: #009900;">(</span>dma_base<span style="color: #339933;">+</span><span style="color: #0000dd;">2</span><span style="color: #009900;">)</span> <span style="color: #339933;">&amp;</span> ~<span style="color: #009900;">(</span><span style="color: #0000dd;">1</span><span style="color: #339933;">&lt;&lt;</span><span style="color: #009900;">(</span><span style="color: #0000dd;">5</span><span style="color: #339933;">+</span>unit<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span> dma_base<span style="color: #339933;">+</span><span style="color: #0000dd;">2</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">case</span> ide_dma_on<span style="color: #339933;">:</span>
			drive<span style="color: #339933;">-&gt;</span>using_dma <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>func <span style="color: #339933;">==</span> ide_dma_on<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>using_dma<span style="color: #009900;">)</span>
				outb<span style="color: #009900;">(</span>inb<span style="color: #009900;">(</span>dma_base<span style="color: #339933;">+</span><span style="color: #0000dd;">2</span><span style="color: #009900;">)</span><span style="color: #339933;">|</span><span style="color: #009900;">(</span><span style="color: #0000dd;">1</span><span style="color: #339933;">&lt;&lt;</span><span style="color: #009900;">(</span><span style="color: #0000dd;">5</span><span style="color: #339933;">+</span>unit<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span> dma_base<span style="color: #339933;">+</span><span style="color: #0000dd;">2</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">case</span> ide_dma_check<span style="color: #339933;">:</span>
			<span style="color: #b1b100;">return</span> config_drive_for_dma <span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">case</span> ide_dma_read<span style="color: #339933;">:</span>
			reading <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span> <span style="color: #339933;">&lt;&lt;</span> <span style="color: #0000dd;">3</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">case</span> ide_dma_write<span style="color: #339933;">:</span>
<span style="color: #808080; font-style: italic;">/*
 *SELECT_READ_WRITE定义如下：
 *	#define SELECT_READ_WRITE(hwif,drive,func)			\
 *	{								\
 *		if (hwif-&gt;rwproc)					\
 *			hwif-&gt;rwproc(drive,func);			\
 *	}
 *目的就是为了一些需要特殊操作的IDE硬盘附加特殊操作
 *ide_dma_read和ide_dma_write的区别就在于reading的值为0x08或0x00
 */</span>
			SELECT_READ_WRITE<span style="color: #009900;">(</span>hwif<span style="color: #339933;">,</span>drive<span style="color: #339933;">,</span>func<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span><span style="color: #009900;">(</span>count <span style="color: #339933;">=</span> ide_build_dmatable<span style="color: #009900;">(</span>drive<span style="color: #339933;">,</span> func<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>	<span style="color: #666666; font-style: italic;">//准备DMA区间表</span>
				<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* try PIO instead of DMA */</span>
<span style="color: #808080; font-style: italic;">/*
 *将DMA区间表的物理地址hwif-&gt;dmatable_dma写入描述表指针寄存器
 */</span>
			outl<span style="color: #009900;">(</span>hwif<span style="color: #339933;">-&gt;</span>dmatable_dma<span style="color: #339933;">,</span> dma_base <span style="color: #339933;">+</span> <span style="color: #0000dd;">4</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* PRD table */</span>
<span style="color: #808080; font-style: italic;">/*
 *把操作的方式（读或写）写入其“命令寄存器”
 */</span>
			outb<span style="color: #009900;">(</span>reading<span style="color: #339933;">,</span> dma_base<span style="color: #009900;">)</span><span style="color: #339933;">;</span>			<span style="color: #808080; font-style: italic;">/* specify r/w */</span>
<span style="color: #808080; font-style: italic;">/*
 *将flags中的“中断请求”和“出错”状态标志位清0
 *IDE接口的DMA控制部分共有16个字节，前8个用于接口上的第一个
 *设备ide0，后8个则用于ide1，初始化时把ide_hwif_t数据结构中的字段
 *dma_base设置成指向其DMA控制部分的起点，这里就是dma_base，
 *从地址dma_base开始就是8位的命令寄存器，从dma_base+2开始是8位
 *的状态寄存器，从dma_base+4开始是32位的描述表寄存器
 */</span>
			outb<span style="color: #009900;">(</span>inb<span style="color: #009900;">(</span>dma_base<span style="color: #339933;">+</span><span style="color: #0000dd;">2</span><span style="color: #009900;">)</span><span style="color: #339933;">|</span><span style="color: #0000dd;">6</span><span style="color: #339933;">,</span> dma_base<span style="color: #339933;">+</span><span style="color: #0000dd;">2</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* clear INTR &amp; ERROR flags */</span>
			drive<span style="color: #339933;">-&gt;</span>waiting_for_dma <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>drive<span style="color: #339933;">-&gt;</span>media <span style="color: #339933;">!=</span> ide_disk<span style="color: #009900;">)</span>
				<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *设置好本次DMA操作结束时的中断服务程序
 */</span>
			ide_set_handler<span style="color: #009900;">(</span>drive<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>ide_dma_intr<span style="color: #339933;">,</span> WAIT_CMD<span style="color: #339933;">,</span> dma_timer_expiry<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* issue cmd to drive */</span>
<span style="color: #808080; font-style: italic;">/*
 *发送命令启动硬盘操作
 */</span>
			OUT_BYTE<span style="color: #009900;">(</span>reading <span style="color: #339933;">?</span> WIN_READDMA <span style="color: #339933;">:</span> WIN_WRITEDMA<span style="color: #339933;">,</span> IDE_COMMAND_REG<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">case</span> ide_dma_begin<span style="color: #339933;">:</span>
			<span style="color: #808080; font-style: italic;">/* Note that this is done *after* the cmd has
			 * been issued to the drive, as per the BM-IDE spec.
			 * The Promise Ultra33 doesn't work correctly when
			 * we do this part before issuing the drive cmd.
			 */</span>
<span style="color: #808080; font-style: italic;">/*
 *向DMA命令寄存器发出启动命令
 *此后，IDE硬盘和DMA控制器操作对于CPU就是透明的了
 */</span>
			outb<span style="color: #009900;">(</span>inb<span style="color: #009900;">(</span>dma_base<span style="color: #009900;">)</span><span style="color: #339933;">|</span><span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> dma_base<span style="color: #009900;">)</span><span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* start DMA */</span>
			<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">case</span> ide_dma_end<span style="color: #339933;">:</span> <span style="color: #808080; font-style: italic;">/* returns 1 on error, 0 otherwise */</span>
			drive<span style="color: #339933;">-&gt;</span>waiting_for_dma <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *将DMA命令寄存器最低位清0
 */</span>
			outb<span style="color: #009900;">(</span>inb<span style="color: #009900;">(</span>dma_base<span style="color: #009900;">)</span><span style="color: #339933;">&amp;</span>~<span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> dma_base<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* stop DMA */</span>
<span style="color: #808080; font-style: italic;">/*
 *读入其状态寄存器
 */</span>
			dma_stat <span style="color: #339933;">=</span> inb<span style="color: #009900;">(</span>dma_base<span style="color: #339933;">+</span><span style="color: #0000dd;">2</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* get DMA status */</span>
<span style="color: #808080; font-style: italic;">/*
 *清除中断标志位和出错标志位
 */</span>
			outb<span style="color: #009900;">(</span>dma_stat<span style="color: #339933;">|</span><span style="color: #0000dd;">6</span><span style="color: #339933;">,</span> dma_base<span style="color: #339933;">+</span><span style="color: #0000dd;">2</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* clear the INTR &amp; ERROR bits */</span>
			ide_destroy_dmatable<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* purge DMA mappings */</span>
			<span style="color: #b1b100;">return</span> <span style="color: #009900;">(</span>dma_stat <span style="color: #339933;">&amp;</span> <span style="color: #0000dd;">7</span><span style="color: #009900;">)</span> <span style="color: #339933;">!=</span> <span style="color: #0000dd;">4</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* verify good DMA status */</span>
		<span style="color: #b1b100;">case</span> ide_dma_test_irq<span style="color: #339933;">:</span> <span style="color: #808080; font-style: italic;">/* returns 1 if dma irq issued, 0 otherwise */</span>
			dma_stat <span style="color: #339933;">=</span> inb<span style="color: #009900;">(</span>dma_base<span style="color: #339933;">+</span><span style="color: #0000dd;">2</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#if 0	/* do not set unless you know what you are doing */</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>dma_stat <span style="color: #339933;">&amp;</span> <span style="color: #0000dd;">4</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				byte stat <span style="color: #339933;">=</span> GET_STAT<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				outb<span style="color: #009900;">(</span>dma_base<span style="color: #339933;">+</span><span style="color: #0000dd;">2</span><span style="color: #339933;">,</span> dma_stat <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0xE4</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
<span style="color: #339933;">#endif</span>
			<span style="color: #b1b100;">return</span> <span style="color: #009900;">(</span>dma_stat <span style="color: #339933;">&amp;</span> <span style="color: #0000dd;">4</span><span style="color: #009900;">)</span> <span style="color: #339933;">==</span> <span style="color: #0000dd;">4</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* return 1 if INTR asserted */</span>
		<span style="color: #b1b100;">case</span> ide_dma_bad_drive<span style="color: #339933;">:</span>
		<span style="color: #b1b100;">case</span> ide_dma_good_drive<span style="color: #339933;">:</span>
			<span style="color: #b1b100;">return</span> check_drive_lists<span style="color: #009900;">(</span>drive<span style="color: #339933;">,</span> <span style="color: #009900;">(</span>func <span style="color: #339933;">==</span> ide_dma_good_drive<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">case</span> ide_dma_verbose<span style="color: #339933;">:</span>
			<span style="color: #b1b100;">return</span> report_drive_dmaing<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">case</span> ide_dma_timeout<span style="color: #339933;">:</span>
<span style="color: #339933;">#ifdef CONFIG_BLK_DEV_IDEDMA_TIMEOUT</span>
			<span style="color: #808080; font-style: italic;">/*
			 * Have to issue an abort and requeue the request
			 * DMA engine got turned off by a goofy ASIC, and
			 * we have to clean up the mess, and here is as good
			 * as any.  Do it globally for all chipsets.
			 */</span>
<span style="color: #339933;">#endif /* CONFIG_BLK_DEV_IDEDMA_TIMEOUT */</span>
		<span style="color: #b1b100;">case</span> ide_dma_retune<span style="color: #339933;">:</span>
		<span style="color: #b1b100;">case</span> ide_dma_lostirq<span style="color: #339933;">:</span>
			printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"ide_dmaproc: chipset supported %s func only: %d<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> ide_dmafunc_verbose<span style="color: #009900;">(</span>func<span style="color: #009900;">)</span><span style="color: #339933;">,</span>  func<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">default</span><span style="color: #339933;">:</span>
			printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"ide_dmaproc: unsupported %s func: %d<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> ide_dmafunc_verbose<span style="color: #009900;">(</span>func<span style="color: #009900;">)</span><span style="color: #339933;">,</span> func<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>准备DMA区间表的函数ide_build_dmatable()定义在drivers/ide/ide-dma.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78431"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
</pre></td> 
             <td class="code" id="p784code31"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * ide_build_dmatable() prepares a dma request.
 * Returns 0 if all went okay, returns 1 otherwise.
 * May also be invoked from trm290.c
 */</span>
<span style="color: #993333;">int</span> ide_build_dmatable <span style="color: #009900;">(</span>ide_drive_t <span style="color: #339933;">*</span>drive<span style="color: #339933;">,</span> ide_dma_action_t func<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
<span style="color: #808080; font-style: italic;">/*
 *table是从CPU看来的DMA所需要的页面的页面虚拟地址，这个
 *页面是在初始化时被分配好的
 *在数据结构ide_hwif_t中有两个指针，二者都指向同一个用于DMA区间表
 *的页面，不过dmatable_cpu是从CPU看来的DMA所需要的页面的页面
 *虚拟地址，而dmatable_dma通过其物理地址指向这个页面，这就是IDE接口
 *的DMA功能部分所能看到的DMA区间表
 */</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> <span style="color: #339933;">*</span>table <span style="color: #339933;">=</span> HWIF<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>dmatable_cpu<span style="color: #339933;">;</span>
<span style="color: #339933;">#ifdef CONFIG_BLK_DEV_TRM290</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> is_trm290_chipset <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>HWIF<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>chipset <span style="color: #339933;">==</span> ide_trm290<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#else</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">int</span> is_trm290_chipset <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#endif</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> count <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> i<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> scatterlist <span style="color: #339933;">*</span>sg<span style="color: #339933;">;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *根据具体操作请求建立一个“物理区间表”，把同一个操作请求中互相连续的
 *缓冲区都合并成缓冲区间，返回的是区间个数
 */</span>
	HWIF<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>sg_nents <span style="color: #339933;">=</span> i <span style="color: #339933;">=</span> ide_build_sglist<span style="color: #009900;">(</span>HWIF<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">,</span> HWGROUP<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>rq<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *sg_table指向scatterlist数组，数组中的每个成员指向一个用于DMA操作的
 *缓冲区间（注意缓冲区和缓冲区间的概念区域别），包括其起始（虚拟）地址与长度
 *scatterlist结构定义于include/asm-i386/scatterlist.h中：
 *	struct scatterlist {
 *	    char *  address;    /* Location data is to be transferred to */</span>
 <span style="color: #339933;">*</span>	    <span style="color: #993333;">char</span> <span style="color: #339933;">*</span> alt_address<span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* Location of actual if address is a 
 *				 * dma indirect buffer.  NULL otherwise */</span>
 <span style="color: #339933;">*</span>	    <span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> length<span style="color: #339933;">;</span>
 <span style="color: #339933;">*</span>	<span style="color: #009900;">}</span><span style="color: #339933;">;</span>
 <span style="color: #339933;">*/</span>
	sg <span style="color: #339933;">=</span> HWIF<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>sg_table<span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *DMA缓冲区间不能跨越64KB边界，这里需要检查，并且建立DMA区间表
 */</span>
	<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>i <span style="color: #339933;">&amp;&amp;</span> sg_dma_len<span style="color: #009900;">(</span>sg<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		u32 cur_addr<span style="color: #339933;">;</span>
		u32 cur_len<span style="color: #339933;">;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *宏操作定义如下：
 *	#define virt_to_bus virt_to_phys
 *	#define bus_to_virt phys_to_virt
 *	#define sg_dma_address(sg) (virt_to_bus((sg)-&gt;address))
 *	#define sg_dma_len(sg) ((sg)-&gt;length)
 */</span>
		cur_addr <span style="color: #339933;">=</span> sg_dma_address<span style="color: #009900;">(</span>sg<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		cur_len <span style="color: #339933;">=</span> sg_dma_len<span style="color: #009900;">(</span>sg<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/*
		 * Fill in the dma table, without crossing any 64kB boundaries.
		 * Most hardware requires 16-bit alignment of all blocks,
		 * but the trm290 requires 32-bit alignment.
		 */</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *对缓冲区进行划分
 */</span>
		<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>cur_len<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">++</span>count <span style="color: #339933;">&gt;=</span> PRD_ENTRIES<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"%s: DMA table too small<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> drive<span style="color: #339933;">-&gt;</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				pci_unmap_sg<span style="color: #009900;">(</span>HWIF<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>pci_dev<span style="color: #339933;">,</span>
					     HWIF<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>sg_table<span style="color: #339933;">,</span>
					     HWIF<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>sg_nents<span style="color: #339933;">,</span>
					     HWIF<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>sg_dma_direction<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* revert to PIO for this request */</span>
			<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
				u32 xcount<span style="color: #339933;">,</span> bcount <span style="color: #339933;">=</span> <span style="color: #208080;">0x10000</span> <span style="color: #339933;">-</span> <span style="color: #009900;">(</span>cur_addr <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0xffff</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>bcount <span style="color: #339933;">&gt;</span> cur_len<span style="color: #009900;">)</span>
					bcount <span style="color: #339933;">=</span> cur_len<span style="color: #339933;">;</span>
				<span style="color: #339933;">*</span>table<span style="color: #339933;">++</span> <span style="color: #339933;">=</span> cpu_to_le32<span style="color: #009900;">(</span>cur_addr<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				xcount <span style="color: #339933;">=</span> bcount <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0xffff</span><span style="color: #339933;">;</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>is_trm290_chipset<span style="color: #009900;">)</span>
					xcount <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>xcount <span style="color: #339933;">&gt;&gt;</span> <span style="color: #0000dd;">2</span><span style="color: #009900;">)</span> <span style="color: #339933;">-</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span> <span style="color: #339933;">&lt;&lt;</span> <span style="color: #0000dd;">16</span><span style="color: #339933;">;</span>
				<span style="color: #339933;">*</span>table<span style="color: #339933;">++</span> <span style="color: #339933;">=</span> cpu_to_le32<span style="color: #009900;">(</span>xcount<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				cur_addr <span style="color: #339933;">+=</span> bcount<span style="color: #339933;">;</span>
				cur_len <span style="color: #339933;">-=</span> bcount<span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
		<span style="color: #009900;">}</span>
&nbsp;
		sg<span style="color: #339933;">++;</span>
		i<span style="color: #339933;">--;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>count<span style="color: #009900;">)</span>
		printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"%s: empty DMA table?<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> drive<span style="color: #339933;">-&gt;</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>is_trm290_chipset<span style="color: #009900;">)</span>
		<span style="color: #339933;">*--</span>table <span style="color: #339933;">|=</span> cpu_to_le32<span style="color: #009900;">(</span><span style="color: #208080;">0x80000000</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">return</span> count<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>函数ide_build_sglist()定义在drivers/ide/ide-dma.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78432"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td> 
             <td class="code" id="p784code32"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">int</span> ide_build_sglist <span style="color: #009900;">(</span>ide_hwif_t <span style="color: #339933;">*</span>hwif<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> request <span style="color: #339933;">*</span>rq<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> buffer_head <span style="color: #339933;">*</span>bh<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> scatterlist <span style="color: #339933;">*</span>sg <span style="color: #339933;">=</span> hwif<span style="color: #339933;">-&gt;</span>sg_table<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> nents <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>rq<span style="color: #339933;">-&gt;</span>cmd <span style="color: #339933;">==</span> READ<span style="color: #009900;">)</span>
		hwif<span style="color: #339933;">-&gt;</span>sg_dma_direction <span style="color: #339933;">=</span> PCI_DMA_FROMDEVICE<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">else</span>
		hwif<span style="color: #339933;">-&gt;</span>sg_dma_direction <span style="color: #339933;">=</span> PCI_DMA_TODEVICE<span style="color: #339933;">;</span>
	bh <span style="color: #339933;">=</span> rq<span style="color: #339933;">-&gt;</span>bh<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">do</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>virt_addr <span style="color: #339933;">=</span> bh<span style="color: #339933;">-&gt;</span>b_data<span style="color: #339933;">;</span>
		<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> size <span style="color: #339933;">=</span> bh<span style="color: #339933;">-&gt;</span>b_size<span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>bh <span style="color: #339933;">=</span> bh<span style="color: #339933;">-&gt;</span>b_reqnext<span style="color: #009900;">)</span> <span style="color: #339933;">!=</span> NULL<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>virt_addr <span style="color: #339933;">+</span> size<span style="color: #009900;">)</span> <span style="color: #339933;">!=</span> <span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span><span style="color: #009900;">)</span> bh<span style="color: #339933;">-&gt;</span>b_data<span style="color: #009900;">)</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			size <span style="color: #339933;">+=</span> bh<span style="color: #339933;">-&gt;</span>b_size<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		memset<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>sg<span style="color: #009900;">[</span>nents<span style="color: #009900;">]</span><span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #339933;">*</span>sg<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		sg<span style="color: #009900;">[</span>nents<span style="color: #009900;">]</span>.<span style="color: #202020;">address</span> <span style="color: #339933;">=</span> virt_addr<span style="color: #339933;">;</span>
		sg<span style="color: #009900;">[</span>nents<span style="color: #009900;">]</span>.<span style="color: #202020;">length</span> <span style="color: #339933;">=</span> size<span style="color: #339933;">;</span>
		nents<span style="color: #339933;">++;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>bh <span style="color: #339933;">!=</span> NULL<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">return</span> pci_map_sg<span style="color: #009900;">(</span>hwif<span style="color: #339933;">-&gt;</span>pci_dev<span style="color: #339933;">,</span> sg<span style="color: #339933;">,</span> nents<span style="color: #339933;">,</span> hwif<span style="color: #339933;">-&gt;</span>sg_dma_direction<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>设置的中断服务程序ide_dma_intr()定义在drivers/ide/ide-dma.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78433"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td> 
             <td class="code" id="p784code33"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * dma_intr() is the handler for disk read/write DMA interrupts
 */</span>
ide_startstop_t ide_dma_intr <span style="color: #009900;">(</span>ide_drive_t <span style="color: #339933;">*</span>drive<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span> i<span style="color: #339933;">;</span>
	byte stat<span style="color: #339933;">,</span> dma_stat<span style="color: #339933;">;</span>
&nbsp;
	dma_stat <span style="color: #339933;">=</span> HWIF<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>dmaproc<span style="color: #009900;">(</span>ide_dma_end<span style="color: #339933;">,</span> drive<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	stat <span style="color: #339933;">=</span> GET_STAT<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>			<span style="color: #808080; font-style: italic;">/* get drive status */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>OK_STAT<span style="color: #009900;">(</span>stat<span style="color: #339933;">,</span>DRIVE_READY<span style="color: #339933;">,</span>drive<span style="color: #339933;">-&gt;</span>bad_wstat<span style="color: #339933;">|</span>DRQ_STAT<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>dma_stat<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #993333;">struct</span> request <span style="color: #339933;">*</span>rq <span style="color: #339933;">=</span> HWGROUP<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>rq<span style="color: #339933;">;</span>
			rq <span style="color: #339933;">=</span> HWGROUP<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>rq<span style="color: #339933;">;</span>
			<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>i <span style="color: #339933;">=</span> rq<span style="color: #339933;">-&gt;</span>nr_sectors<span style="color: #339933;">;</span> i <span style="color: #339933;">&gt;</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				i <span style="color: #339933;">-=</span> rq<span style="color: #339933;">-&gt;</span>current_nr_sectors<span style="color: #339933;">;</span>
				ide_end_request<span style="color: #009900;">(</span><span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> HWGROUP<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			<span style="color: #b1b100;">return</span> ide_stopped<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"%s: dma_intr: bad DMA status<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> drive<span style="color: #339933;">-&gt;</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">return</span> ide_error<span style="color: #009900;">(</span>drive<span style="color: #339933;">,</span> <span style="color: #ff0000;">"dma_intr"</span><span style="color: #339933;">,</span> stat<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>当一次中断后就表示一次DMA操作结束，就再调用一次ide_dmaproc()函数，不过，这次参数是ide_dma_end。</p> 
         <p>在ide_dma_end处执行的时候会执行一个函数ide_destroy_dmatable()，这个函数定义于drivers/ide/ide-dma.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=784&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p78434"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td> 
             <td class="code" id="p784code34"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/* Teardown mappings after DMA has completed.  */</span>
<span style="color: #993333;">void</span> ide_destroy_dmatable <span style="color: #009900;">(</span>ide_drive_t <span style="color: #339933;">*</span>drive<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> pci_dev <span style="color: #339933;">*</span>dev <span style="color: #339933;">=</span> HWIF<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>pci_dev<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> scatterlist <span style="color: #339933;">*</span>sg <span style="color: #339933;">=</span> HWIF<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>sg_table<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> nents <span style="color: #339933;">=</span> HWIF<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>sg_nents<span style="color: #339933;">;</span>
&nbsp;
	pci_unmap_sg<span style="color: #009900;">(</span>dev<span style="color: #339933;">,</span> sg<span style="color: #339933;">,</span> nents<span style="color: #339933;">,</span> HWIF<span style="color: #009900;">(</span>drive<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>sg_dma_direction<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>此函数就不多说了，最后调用的pci_unmap_sg()实际上啥也没干。</p> 
         <p>&nbsp;</p> 
         <p>历经4天，此文完毕！</p> 
         <p>&nbsp;</p> 
         <p>The End.</p> 
        </div>
       </div>
       <!-- .entry-content --> 
       <!-- .entry-meta --> 
      </article>
      <!-- #post-784 --> 
      <!-- #comments --> 
     </div>
     <!-- #content --> 
    </div>
    <!-- #primary --> 
    <!-- #secondary .widget-area --> 
   </div>
   <!-- #main --> 
   <!-- #colophon --> 
  </div>
  <!-- #page -->   
  <!-- JiaThis Button BEGIN -->  
  <!-- JiaThis Button END -->   
 </body>
</html>