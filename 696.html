<!doctype html>
<!--[if IE 6]>
<html id="ie6" lang="zh-CN">
<![endif]-->
<!--[if IE 7]>
<html id="ie7" lang="zh-CN">
<![endif]-->
<!--[if IE 8]>
<html id="ie8" lang="zh-CN">
<![endif]-->
<!--[if !(IE 6) | !(IE 7) | !(IE 8)  ]><!-->
<html lang="zh-CN">
 <!--<![endif]-->
 <head>      
  <link rel="stylesheet" type="text/css" media="all" href="stylesheets/style.css">     
  <link rel="stylesheet" id="codebox-css" href="stylesheets/codebox.css" type="text/css" media="screen">             
 </head> 
 <body class="single single-post postid-696 single-format-standard content-sidebar"> 
  <div id="page" class="hfeed"> 
   <header id="branding" role="banner"> 
    <hgroup> 
     <h1 id="site-title"><span><a href="http://codelifeliwan.github.io/" title="Code_Life_LiWan" rel="home">Code_Life_LiWan</a></span></h1> 
     <h2 id="site-description">My heart will go on and on…</h2> 
    </hgroup>  
    <!-- #access --> 
   </header>
   <!-- #branding --> 
   <div id="main" class="clearfix"> 
    <div id="primary"> 
     <div id="content" role="main"> 
      <!-- #nav-single --> 
      <article id="post-696" class="post-696 post type-post status-publish format-standard hentry category-linux_kernel_source_code_notes"> 
       <header class="entry-header"> 
        <h1 class="entry-title">Linux内核-传统UNIX进程通信（一、管道通信）</h1> 
        <div class="entry-meta"> 
         <span class="sep">Posted on </span>
         <a href="http://codelifeliwan.github.io/?p=696" title="下午 9:20" rel="bookmark"><time class="entry-date" datetime="2012-10-31T21:20:40+00:00" pubdate>31 十月, 2012</time></a>
         <span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codelifeliwan.github.io/?author=1" title="View all posts by wanli" rel="author">wanli</a></span></span> 
         <span class="sep"> — </span> 
         <span class="comments-link"> <a href="http://codelifeliwan.github.io/?p=696#respond" title="Comment on Linux内核-传统UNIX进程通信（一、管道通信）">No Comments ↓</a> </span> 
        </div>
        <!-- .entry-meta --> 
       </header>
       <!-- .entry-header --> 
       <div class="entry-content">
        <div class="entry-content"> 
         <div> 
          <p>文件系统实在是太多了，看不完了，先看后面的吧，回头再看文件系统。</p> 
          <p>对于进程通信机制有很多种。下面介绍几种：</p> 
          <p>1、管道通信（<span style="font-family: 'Times New Roman';">Pipe</span><span style="font-family: 宋体;">）：父进程和子进程之间或者两个兄弟进程之间可以通过管道来建立一种通信机制，这种方法在内存中分配临时页面来模拟文件系统进行一系列读、写等操作，读写严格遵循先入先出原则，每个管道只能是单向的，对于一个进程来说，其持有管道的一头，要么可读，要么可写。</span><br> 2、信号机制（<span style="font-family: 'Times New Roman';">Signal</span><span style="font-family: 宋体;">）：也就是前面的软中断。</span><br> 3、跟踪机制（<span style="font-family: 'Times New Roman';">Trace</span><span style="font-family: 宋体;">）：一个进程可以通过系统调用</span><span style="font-family: 'Times New Roman';">ptrace()</span><span style="font-family: 宋体;">读</span><span style="font-family: 'Times New Roman';">/</span><span style="font-family: 宋体;">写其子进程的地址空间内容，从而达到跟踪子进程执行的目的。</span><br> 4、命名管道（<span style="font-family: 'Times New Roman';">named&nbsp;pipe</span><span style="font-family: 宋体;">）：通过管道名来打开管道，使得任意进程间可通信。</span><br> 5、报文队列（<span style="font-family: 'Times New Roman';">Message</span><span style="font-family: 宋体;">）：一个进程可以通过系统调用设立一个报文队列，然后任何进程都可以通过系统调用向这个队列发送“消息”或从队列接收“消息”，从而以进程间“报文传递”的形式实现通信。</span><br> 6、共享内存：一个进程可以通过系统调用来设立一片共享内存区，然后其他进程可以共享。<br> 7、信号量（<span style="font-family: 'Times New Roman';">Semaphore</span><span style="font-family: 宋体;">）：就是前面说的信号量机制。</span><br> 8、插口（<span style="font-family: 'Times New Roman';">Socket</span><span style="font-family: 宋体;">）机制：和管道相似，但是它不仅适用于一台计算机，还适用于网络上的计算机等。</span></p> 
          <h2>管道的创建：</h2> 
          <p>这里先重点讲管道通信，管道通信的主体是系统调用<span style="font-family: 'Times New Roman';">pipe()</span><span style="font-family: 宋体;">，但是由</span><span style="font-family: 'Times New Roman';">pipe()</span><span style="font-family: 宋体;">所建立的管道的两端都在同一进程中。由于管道实际上是通过文件系统机制来实现的，创建管道的过程实际上就是创建一个无形的只存在于内存中的文件，所以其也需要</span><span style="font-family: 'Times New Roman';">file</span><span style="font-family: 宋体;">、</span><span style="font-family: 'Times New Roman';">inode</span><span style="font-family: 宋体;">、</span><span style="font-family: 'Times New Roman';">dentry</span><span style="font-family: 宋体;">等数据结构。而管道创建的时候一般是给两个进程用的，所以在创建之初就创建两个</span><span style="font-family: 'Times New Roman';">file</span><span style="font-family: 宋体;">数据结构，一个为只读端，一个为只写端。然后有一个只有两项的数组，一个存储着只读端的文件号，一个存储着只写端的文件号。</span></p> 
          <p>系统调用在<span style="font-family: 'Times New Roman';">arch/i386/kernel/sys_i386.c</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=696&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p6961"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td> 
              <td class="code" id="p696code1"><pre class="c" style="font-family:monospace;">asmlinkage <span style="color: #993333;">int</span> sys_pipe<span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> <span style="color: #339933;">*</span> fildes<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span> fd<span style="color: #009900;">[</span><span style="color: #0000dd;">2</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> error<span style="color: #339933;">;</span>
&nbsp;
	error <span style="color: #339933;">=</span> do_pipe<span style="color: #009900;">(</span>fd<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>error<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>copy_to_user<span style="color: #009900;">(</span>fildes<span style="color: #339933;">,</span> fd<span style="color: #339933;">,</span> <span style="color: #0000dd;">2</span><span style="color: #339933;">*</span><span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">int</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EFAULT<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">return</span> error<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>函数主体<span style="font-family: 'Times New Roman';">do_pipe()</span><span style="font-family: 宋体;">是在</span><span style="font-family: 'Times New Roman';">fs/pipe.c</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=696&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p6962"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
</pre></td> 
              <td class="code" id="p696code2"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">int</span> do_pipe<span style="color: #009900;">(</span><span style="color: #993333;">int</span> <span style="color: #339933;">*</span>fd<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> qstr this<span style="color: #339933;">;</span>
	<span style="color: #993333;">char</span> name<span style="color: #009900;">[</span><span style="color: #0000dd;">32</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> dentry <span style="color: #339933;">*</span>dentry<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span> inode<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span>f1<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>f2<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> error<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> i<span style="color: #339933;">,</span>j<span style="color: #339933;">;</span>
&nbsp;
	error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ENFILE<span style="color: #339933;">;</span>
	f1 <span style="color: #339933;">=</span> get_empty_filp<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//申请file数据结构空间</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>f1<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> no_files<span style="color: #339933;">;</span>
&nbsp;
	f2 <span style="color: #339933;">=</span> get_empty_filp<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//申请file数据结构空间</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>f2<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> close_f1<span style="color: #339933;">;</span>
&nbsp;
	inode <span style="color: #339933;">=</span> get_pipe_inode<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//创建临时的inode结构</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>inode<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> close_f12<span style="color: #339933;">;</span>
&nbsp;
	error <span style="color: #339933;">=</span> get_unused_fd<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>		<span style="color: #666666; font-style: italic;">//为读端分配打开文件号</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>error <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> close_f12_inode<span style="color: #339933;">;</span>
	i <span style="color: #339933;">=</span> error<span style="color: #339933;">;</span>
&nbsp;
	error <span style="color: #339933;">=</span> get_unused_fd<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>		<span style="color: #666666; font-style: italic;">//为写端分配打开文件号</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>error <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> close_f12_inode_i<span style="color: #339933;">;</span>
	j <span style="color: #339933;">=</span> error<span style="color: #339933;">;</span>
&nbsp;
	error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ENOMEM<span style="color: #339933;">;</span>
	sprintf<span style="color: #009900;">(</span>name<span style="color: #339933;">,</span> <span style="color: #ff0000;">"[%lu]"</span><span style="color: #339933;">,</span> inode<span style="color: #339933;">-&gt;</span>i_ino<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	this.<span style="color: #202020;">name</span> <span style="color: #339933;">=</span> name<span style="color: #339933;">;</span>
	this.<span style="color: #202020;">len</span> <span style="color: #339933;">=</span> strlen<span style="color: #009900;">(</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	this.<span style="color: #202020;">hash</span> <span style="color: #339933;">=</span> inode<span style="color: #339933;">-&gt;</span>i_ino<span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* will go */</span>
	dentry <span style="color: #339933;">=</span> d_alloc<span style="color: #009900;">(</span>pipe_mnt<span style="color: #339933;">-&gt;</span>mnt_sb<span style="color: #339933;">-&gt;</span>s_root<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>this<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>dentry<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> close_f12_inode_i_j<span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *对于管道的dentry数据结构只有一种操作：删除，定义于fs/pipe.c:
 *static struct dentry_operations pipefs_dentry_operations = {
 *	d_delete:	pipefs_delete_dentry,
 *};
 */</span>
	dentry<span style="color: #339933;">-&gt;</span>d_op <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>pipefs_dentry_operations<span style="color: #339933;">;</span>
	d_add<span style="color: #009900;">(</span>dentry<span style="color: #339933;">,</span> inode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//将dentry和inode关联</span>
	f1<span style="color: #339933;">-&gt;</span>f_vfsmnt <span style="color: #339933;">=</span> f2<span style="color: #339933;">-&gt;</span>f_vfsmnt <span style="color: #339933;">=</span> mntget<span style="color: #009900;">(</span>mntget<span style="color: #009900;">(</span>pipe_mnt<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	f1<span style="color: #339933;">-&gt;</span>f_dentry <span style="color: #339933;">=</span> f2<span style="color: #339933;">-&gt;</span>f_dentry <span style="color: #339933;">=</span> dget<span style="color: #009900;">(</span>dentry<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* read file  设置读端的file数据结构*/</span>
	f1<span style="color: #339933;">-&gt;</span>f_pos <span style="color: #339933;">=</span> f2<span style="color: #339933;">-&gt;</span>f_pos <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	f1<span style="color: #339933;">-&gt;</span>f_flags <span style="color: #339933;">=</span> O_RDONLY<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//只读</span>
<span style="color: #808080; font-style: italic;">/*
 *struct file_operations read_pipe_fops = {
 *	llseek:		pipe_lseek,
 *	read:		pipe_read,
 *	write:		bad_pipe_w,
 *	poll:		pipe_poll,
 *	ioctl:		pipe_ioctl,
 *	open:		pipe_read_open,
 *	release:	pipe_read_release,
 *};
 */</span>
	f1<span style="color: #339933;">-&gt;</span>f_op <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>read_pipe_fops<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//只读函数指针，在pipe.c中</span>
	f1<span style="color: #339933;">-&gt;</span>f_mode <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	f1<span style="color: #339933;">-&gt;</span>f_version <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* write file  设置写端的数据结构*/</span>
	f2<span style="color: #339933;">-&gt;</span>f_flags <span style="color: #339933;">=</span> O_WRONLY<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//只写</span>
<span style="color: #808080; font-style: italic;">/*
 *struct file_operations write_pipe_fops = {
 *	llseek:		pipe_lseek,
 *	read:		bad_pipe_r,
 *	write:		pipe_write,
 *	poll:		pipe_poll,
 *	ioctl:		pipe_ioctl,
 *	open:		pipe_write_open,
 *	release:	pipe_write_release,
 *};
 */</span>
	f2<span style="color: #339933;">-&gt;</span>f_op <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>write_pipe_fops<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//只写函数指针，在pipe.c中</span>
	f2<span style="color: #339933;">-&gt;</span>f_mode <span style="color: #339933;">=</span> <span style="color: #0000dd;">2</span><span style="color: #339933;">;</span>
	f2<span style="color: #339933;">-&gt;</span>f_version <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
	fd_install<span style="color: #009900;">(</span>i<span style="color: #339933;">,</span> f1<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	fd_install<span style="color: #009900;">(</span>j<span style="color: #339933;">,</span> f2<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	fd<span style="color: #009900;">[</span><span style="color: #0000dd;">0</span><span style="color: #009900;">]</span> <span style="color: #339933;">=</span> i<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//fd[0]存储读端文件号</span>
	fd<span style="color: #009900;">[</span><span style="color: #0000dd;">1</span><span style="color: #009900;">]</span> <span style="color: #339933;">=</span> j<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//fd[1]存储写端文件号</span>
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
close_f12_inode_i_j<span style="color: #339933;">:</span>
	put_unused_fd<span style="color: #009900;">(</span>j<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
close_f12_inode_i<span style="color: #339933;">:</span>
	put_unused_fd<span style="color: #009900;">(</span>i<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
close_f12_inode<span style="color: #339933;">:</span>
	free_page<span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span> PIPE_BASE<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	kfree<span style="color: #009900;">(</span>inode<span style="color: #339933;">-&gt;</span>i_pipe<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	inode<span style="color: #339933;">-&gt;</span>i_pipe <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	iput<span style="color: #009900;">(</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
close_f12<span style="color: #339933;">:</span>
	put_filp<span style="color: #009900;">(</span>f2<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
close_f1<span style="color: #339933;">:</span>
	put_filp<span style="color: #009900;">(</span>f1<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
no_files<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">return</span> error<span style="color: #339933;">;</span>	
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>其中分配<span style="font-family: 'Times New Roman';">inode</span><span style="font-family: 宋体;">的函数也是在</span><span style="font-family: 'Times New Roman';">pipe.c</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=696&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p6963"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
</pre></td> 
              <td class="code" id="p696code3"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span> get_pipe_inode<span style="color: #009900;">(</span><span style="color: #993333;">void</span><span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span>inode <span style="color: #339933;">=</span> get_empty_inode<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//分配新的inode结构</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>inode<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> fail_inode<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span><span style="color: #009900;">(</span><span style="color: #339933;">!</span>pipe_new<span style="color: #009900;">(</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span>		<span style="color: #666666; font-style: italic;">//分配一个页面作为管道缓冲区</span>
		<span style="color: #b1b100;">goto</span> fail_iput<span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *这里需要说明的是，在inode数据结构中有个字段i_pipe，是一个
 *指向pipe_inode_info结构的指针，当inode不是用于管道的时候这个
 *指针为空，否则这个指针指向一个pipe_inode_info数据结构，这个
 *数据结构的定义在include/linux/pipe_fs_i.h中：
 *struct pipe_inode_info {
 *	wait_queue_head_t wait;
 *	char *base;
 *	unsigned int start;
 *	unsigned int readers;
 *	unsigned int writers;
 *	unsigned int waiting_readers;
 *	unsigned int waiting_writers;
 *	unsigned int r_counter;
 *	unsigned int w_counter;
 *};
 *同时还有一些宏定义操作：
 *#define PIPE_SEM(inode)		(&amp;(inode).i_sem)
 *#define PIPE_WAIT(inode)	(&amp;(inode).i_pipe-&gt;wait)
 *#define PIPE_BASE(inode)	((inode).i_pipe-&gt;base)
 *#define PIPE_START(inode)	((inode).i_pipe-&gt;start)
 *#define PIPE_LEN(inode)		((inode).i_size)
 *#define PIPE_READERS(inode)	((inode).i_pipe-&gt;readers)
 *#define PIPE_WRITERS(inode)	((inode).i_pipe-&gt;writers)
 *#define PIPE_WAITING_READERS(inode)	((inode).i_pipe-&gt;waiting_readers)
 *#define PIPE_WAITING_WRITERS(inode)	((inode).i_pipe-&gt;waiting_writers)
 *#define PIPE_RCOUNTER(inode)	((inode).i_pipe-&gt;r_counter)
 *#define PIPE_WCOUNTER(inode)	((inode).i_pipe-&gt;w_counter)
 *
 *#define PIPE_EMPTY(inode)	(PIPE_LEN(inode) == 0)
 *#define PIPE_FULL(inode)	(PIPE_LEN(inode) == PIPE_SIZE)
 *#define PIPE_FREE(inode)	(PIPE_SIZE - PIPE_LEN(inode))
 *#define PIPE_END(inode)	((PIPE_START(inode) + PIPE_LEN(inode)) &amp; (PIPE_SIZE-1))
 *#define PIPE_MAX_RCHUNK(inode)	(PIPE_SIZE - PIPE_START(inode))
 *#define PIPE_MAX_WCHUNK(inode)	(PIPE_SIZE - PIPE_END(inode))
 */</span>
	PIPE_READERS<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">=</span> PIPE_WRITERS<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//设置读/写标志</span>
<span style="color: #808080; font-style: italic;">/*
 *在文件系统中是通过每个文件系统的函数指针来实行特定文件系统的
 *操作的，在此处管道操作的函数指针定义在pipe.c中：
 *struct file_operations rdwr_pipe_fops = {
 *	llseek:		pipe_lseek,
 *	read:		pipe_read,
 *	write:		pipe_write,
 *	poll:		pipe_poll,
 *	ioctl:		pipe_ioctl,
 *	open:		pipe_rdwr_open,
 *	release:	pipe_rdwr_release,
 *};
 */</span>
	inode<span style="color: #339933;">-&gt;</span>i_fop <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>rdwr_pipe_fops<span style="color: #339933;">;</span>		<span style="color: #666666; font-style: italic;">//设置管道操作函数指针</span>
	inode<span style="color: #339933;">-&gt;</span>i_sb <span style="color: #339933;">=</span> pipe_mnt<span style="color: #339933;">-&gt;</span>mnt_sb<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * Mark the inode dirty from the very beginning,
	 * that way it will never be moved to the dirty
	 * list because "mark_inode_dirty()" will think
	 * that it already _is_ on the dirty list.
	 */</span>
	inode<span style="color: #339933;">-&gt;</span>i_state <span style="color: #339933;">=</span> I_DIRTY<span style="color: #339933;">;</span>
	inode<span style="color: #339933;">-&gt;</span>i_mode <span style="color: #339933;">=</span> S_IFIFO <span style="color: #339933;">|</span> S_IRUSR <span style="color: #339933;">|</span> S_IWUSR<span style="color: #339933;">;</span>
	inode<span style="color: #339933;">-&gt;</span>i_uid <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>fsuid<span style="color: #339933;">;</span>
	inode<span style="color: #339933;">-&gt;</span>i_gid <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>fsgid<span style="color: #339933;">;</span>
	inode<span style="color: #339933;">-&gt;</span>i_atime <span style="color: #339933;">=</span> inode<span style="color: #339933;">-&gt;</span>i_mtime <span style="color: #339933;">=</span> inode<span style="color: #339933;">-&gt;</span>i_ctime <span style="color: #339933;">=</span> CURRENT_TIME<span style="color: #339933;">;</span>
	inode<span style="color: #339933;">-&gt;</span>i_blksize <span style="color: #339933;">=</span> PAGE_SIZE<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> inode<span style="color: #339933;">;</span>
&nbsp;
fail_iput<span style="color: #339933;">:</span>
	iput<span style="color: #009900;">(</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
fail_inode<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">return</span> NULL<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>其中<span style="font-family: 'Times New Roman';">pipe_new()</span><span style="font-family: 宋体;">函数也是在此处：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=696&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p6964"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td> 
              <td class="code" id="p696code4"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> inode<span style="color: #339933;">*</span> pipe_new<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> inode<span style="color: #339933;">*</span> inode<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> page<span style="color: #339933;">;</span>
&nbsp;
	page <span style="color: #339933;">=</span> __get_free_page<span style="color: #009900;">(</span>GFP_USER<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//分配缓冲区作为管道缓冲区</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>page<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> NULL<span style="color: #339933;">;</span>
　　<span style="color: #666666; font-style: italic;">//分配缓冲区作为pipe_inode_info数据结构</span>
	inode<span style="color: #339933;">-&gt;</span>i_pipe <span style="color: #339933;">=</span> kmalloc<span style="color: #009900;">(</span><span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> pipe_inode_info<span style="color: #009900;">)</span><span style="color: #339933;">,</span> GFP_KERNEL<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>inode<span style="color: #339933;">-&gt;</span>i_pipe<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> fail_page<span style="color: #339933;">;</span>
&nbsp;
	init_waitqueue_head<span style="color: #009900;">(</span>PIPE_WAIT<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	PIPE_BASE<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #993333;">char</span><span style="color: #339933;">*</span><span style="color: #009900;">)</span> page<span style="color: #339933;">;</span>
	PIPE_START<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">=</span> PIPE_LEN<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	PIPE_READERS<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">=</span> PIPE_WRITERS<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	PIPE_WAITING_READERS<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">=</span> PIPE_WAITING_WRITERS<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	PIPE_RCOUNTER<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">=</span> PIPE_WCOUNTER<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">return</span> inode<span style="color: #339933;">;</span>
fail_page<span style="color: #339933;">:</span>
	free_page<span style="color: #009900;">(</span>page<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> NULL<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>这样的话，一个管道就创建完成了。</p> 
          <p>管道是由一个进程创建的，创建之初管道的读写端都在这个进程中，当进程创建了新进程后其管道<span style="font-family: 'Times New Roman';">file</span><span style="font-family: 宋体;">等也同样复制到新进程中，这个时候父子进程都可以通过管道的读、写端口来进行读、写，也要注意，这里管道的单向是指对于管道本身来说是单向的，即读端不能写、写端不能读，但是对于进程来说却不是的，一个进程可以通过读端从管道中读取数据，也可以通过写端往管道中写数据，例如下面程序：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=696&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p6965"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td> 
              <td class="code" id="p696code5"><pre class="c" style="font-family:monospace;"><span style="color: #339933;">#include&lt;stdio.h&gt;</span>
<span style="color: #339933;">#include&lt;unistd.h&gt;</span>
&nbsp;
<span style="color: #993333;">int</span> main<span style="color: #009900;">(</span><span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
  pid_t tmp<span style="color: #339933;">;</span>
  <span style="color: #993333;">int</span> pipefd<span style="color: #009900;">[</span><span style="color: #0000dd;">2</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
  <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>buff<span style="color: #339933;">=</span><span style="color: #ff0000;">"Hello son!"</span><span style="color: #339933;">;</span>
  <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>buff2<span style="color: #339933;">=</span><span style="color: #ff0000;">"Hello father!"</span><span style="color: #339933;">;</span>
  <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>buff1<span style="color: #009900;">[</span><span style="color: #0000dd;">1025</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
  pipe<span style="color: #009900;">(</span>pipefd<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  <span style="color: #b1b100;">while</span><span style="color: #009900;">(</span><span style="color: #009900;">(</span>tmp<span style="color: #339933;">=</span>fork<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">&lt;</span><span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  <span style="color: #b1b100;">if</span><span style="color: #009900;">(</span>tmp<span style="color: #339933;">&gt;</span><span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #009900;">{</span>
    write<span style="color: #009900;">(</span>pipefd<span style="color: #009900;">[</span><span style="color: #0000dd;">1</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span>buff<span style="color: #339933;">,</span><span style="color: #0000dd;">1024</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    wait<span style="color: #009900;">(</span>tmp<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    read<span style="color: #009900;">(</span>pipefd<span style="color: #009900;">[</span><span style="color: #0000dd;">0</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span>buff1<span style="color: #339933;">,</span><span style="color: #0000dd;">1024</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: #009900;">(</span><span style="color: #ff0000;">"I am father ---%s---<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span>buff1<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">}</span><span style="color: #b1b100;">else</span><span style="color: #009900;">{</span>
    read<span style="color: #009900;">(</span>pipefd<span style="color: #009900;">[</span><span style="color: #0000dd;">0</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span>buff1<span style="color: #339933;">,</span><span style="color: #0000dd;">1024</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: #009900;">(</span><span style="color: #ff0000;">"I am child ---%s---<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span>buff1<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    write<span style="color: #009900;">(</span>pipefd<span style="color: #009900;">[</span><span style="color: #0000dd;">1</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span>buff2<span style="color: #339933;">,</span><span style="color: #0000dd;">1024</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">}</span>
  <span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>这个程序中管道是公用的，父子进程都可以通过读、写端来读、写数据，但是也可以使用<span style="font-family: 'Times New Roman';">close()</span><span style="font-family: 宋体;">来关闭父进程或者子进程中读或者写端，使得父进程或者子进程只能读或写。</span></p> 
          <h2>管道的读操作：</h2> 
          <p>管道的读操作在内核中经过<span style="font-family: 'Times New Roman';">read_pipe_fops</span><span style="font-family: 宋体;">中的函数指针最终到达</span><span style="font-family: 'Times New Roman';">pipe_read()</span><span style="font-family: 宋体;">函数，这个函数代码是在</span><span style="font-family: 'Times New Roman';">pipe.c</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=696&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p6966"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
</pre></td> 
              <td class="code" id="p696code6"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> ssize_t
pipe_read<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span>filp<span style="color: #339933;">,</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>buf<span style="color: #339933;">,</span> size_t count<span style="color: #339933;">,</span> loff_t <span style="color: #339933;">*</span>ppos<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span>inode <span style="color: #339933;">=</span> filp<span style="color: #339933;">-&gt;</span>f_dentry<span style="color: #339933;">-&gt;</span>d_inode<span style="color: #339933;">;</span>
	ssize_t size<span style="color: #339933;">,</span> read<span style="color: #339933;">,</span> ret<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Seeks are not allowed on pipes.  */</span>
	ret <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ESPIPE<span style="color: #339933;">;</span>
	read <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>ppos <span style="color: #339933;">!=</span> <span style="color: #339933;">&amp;</span>filp<span style="color: #339933;">-&gt;</span>f_pos<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out_nolock<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Always return 0 on null read.  */</span>
	ret <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>count <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out_nolock<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Get the pipe semaphore */</span>
	ret <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ERESTARTSYS<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>down_interruptible<span style="color: #009900;">(</span>PIPE_SEM<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out_nolock<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>PIPE_EMPTY<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//当前管道为空，管道中无数据</span>
do_more_read<span style="color: #339933;">:</span>
		ret <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>PIPE_WRITERS<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span>	<span style="color: #666666; font-style: italic;">//writers=0，无写者了，那么退出</span>
			<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
&nbsp;
		ret <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EAGAIN<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>filp<span style="color: #339933;">-&gt;</span>f_flags <span style="color: #339933;">&amp;</span> O_NONBLOCK<span style="color: #009900;">)</span>	<span style="color: #666666; font-style: italic;">//当无数据时不应等待</span>
			<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span><span style="color: #339933;">;;</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//管道无数据，等待</span>
			PIPE_WAITING_READERS<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">++;</span>
			pipe_wait<span style="color: #009900;">(</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			PIPE_WAITING_READERS<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">--;</span>
			ret <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ERESTARTSYS<span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>signal_pending<span style="color: #009900;">(</span>current<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
			ret <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>PIPE_EMPTY<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>PIPE_WRITERS<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Read what data is available.  */</span>
<span style="color: #808080; font-style: italic;">/*
 *在Linux中这一个页面的管道缓冲区使用的是循环缓冲（循环队列）方式，
 *所以这里需要循环操作
 */</span>
	ret <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EFAULT<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>count <span style="color: #339933;">&gt;</span> <span style="color: #0000dd;">0</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">(</span>size <span style="color: #339933;">=</span> PIPE_LEN<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">char</span> <span style="color: #339933;">*</span>pipebuf <span style="color: #339933;">=</span> PIPE_BASE<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">+</span> PIPE_START<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//开始部位</span>
		ssize_t chars <span style="color: #339933;">=</span> PIPE_MAX_RCHUNK<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//计算可读字节数</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>chars <span style="color: #339933;">&gt;</span> count<span style="color: #009900;">)</span>
			chars <span style="color: #339933;">=</span> count<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>chars <span style="color: #339933;">&gt;</span> size<span style="color: #009900;">)</span>
			chars <span style="color: #339933;">=</span> size<span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>copy_to_user<span style="color: #009900;">(</span>buf<span style="color: #339933;">,</span> pipebuf<span style="color: #339933;">,</span> chars<span style="color: #009900;">)</span><span style="color: #009900;">)</span>	<span style="color: #666666; font-style: italic;">//将管道数据copy到buf数组</span>
			<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
&nbsp;
		read <span style="color: #339933;">+=</span> chars<span style="color: #339933;">;</span>
		PIPE_START<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">+=</span> chars<span style="color: #339933;">;</span>
		PIPE_START<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;=</span> <span style="color: #009900;">(</span>PIPE_SIZE <span style="color: #339933;">-</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		PIPE_LEN<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">-=</span> chars<span style="color: #339933;">;</span>
		count <span style="color: #339933;">-=</span> chars<span style="color: #339933;">;</span>
		buf <span style="color: #339933;">+=</span> chars<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Cache behaviour optimization */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>PIPE_LEN<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		PIPE_START<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>count <span style="color: #339933;">&amp;&amp;</span> PIPE_WAITING_WRITERS<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span><span style="color: #009900;">(</span>filp<span style="color: #339933;">-&gt;</span>f_flags <span style="color: #339933;">&amp;</span> O_NONBLOCK<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #808080; font-style: italic;">/*
		 * We know that we are going to sleep: signal
		 * writers synchronously that there is more
		 * room.
		 */</span>
		wake_up_interruptible_sync<span style="color: #009900;">(</span>PIPE_WAIT<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>PIPE_EMPTY<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			BUG<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> do_more_read<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #808080; font-style: italic;">/* Signal writers asynchronously that there is more room.  */</span>
	wake_up_interruptible<span style="color: #009900;">(</span>PIPE_WAIT<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	ret <span style="color: #339933;">=</span> read<span style="color: #339933;">;</span>
out<span style="color: #339933;">:</span>
	up<span style="color: #009900;">(</span>PIPE_SEM<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
out_nolock<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>read<span style="color: #009900;">)</span>
		ret <span style="color: #339933;">=</span> read<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> ret<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>pipe_wait()<span style="font-family: 宋体;">代码如下：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=696&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p6967"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td> 
              <td class="code" id="p696code7"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">void</span> pipe_wait<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span> inode<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	DECLARE_WAITQUEUE<span style="color: #009900;">(</span>wait<span style="color: #339933;">,</span> current<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	current<span style="color: #339933;">-&gt;</span>state <span style="color: #339933;">=</span> TASK_INTERRUPTIBLE<span style="color: #339933;">;</span>
	add_wait_queue<span style="color: #009900;">(</span>PIPE_WAIT<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>wait<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	up<span style="color: #009900;">(</span>PIPE_SEM<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	schedule<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	remove_wait_queue<span style="color: #009900;">(</span>PIPE_WAIT<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>wait<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	current<span style="color: #339933;">-&gt;</span>state <span style="color: #339933;">=</span> TASK_RUNNING<span style="color: #339933;">;</span>
	down<span style="color: #009900;">(</span>PIPE_SEM<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>读管道的时候有三种情况：</p> 
          <p>1<span style="font-family: 宋体;">）读到了所要求的长度，这种情况最普通，直接返回长度等即可。</span></p> 
          <p>2<span style="font-family: 宋体;">）管道数据已经读完，但是没有读到所要求的长度，这时候返回读取的实际长度。</span></p> 
          <p>3<span style="font-family: 宋体;">）读到了所要求的长度，但管道中数据有剩余，返回要求读取的长度，剩下的下次再读。</span></p> 
          <p>但是还有一种情况就是要求通信的数据量实在是太大了，大于一个页面，这个时候肯定是不能一次通信完的，所以若进程将管道的缓冲已经写满了，这个时候写进程得停下来等待，等到缓冲区有空间了再唤醒写进程继续。</p> 
          <h2>管道的写操作：</h2> 
          <p>同样，管道的写操作是<span style="font-family: 'Times New Roman';">sys_write()</span><span style="font-family: 宋体;">通过数据结构转换成</span><span style="font-family: 'Times New Roman';">pipe_write()</span><span style="font-family: 宋体;">，定义在</span><span style="font-family: 'Times New Roman';">pipe.c</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=696&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p6968"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
</pre></td> 
              <td class="code" id="p696code8"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> ssize_t
pipe_write<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span>filp<span style="color: #339933;">,</span> <span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>buf<span style="color: #339933;">,</span> size_t count<span style="color: #339933;">,</span> loff_t <span style="color: #339933;">*</span>ppos<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span>inode <span style="color: #339933;">=</span> filp<span style="color: #339933;">-&gt;</span>f_dentry<span style="color: #339933;">-&gt;</span>d_inode<span style="color: #339933;">;</span>
	ssize_t free<span style="color: #339933;">,</span> written<span style="color: #339933;">,</span> ret<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Seeks are not allowed on pipes.  */</span>
	ret <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ESPIPE<span style="color: #339933;">;</span>
	written <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>ppos <span style="color: #339933;">!=</span> <span style="color: #339933;">&amp;</span>filp<span style="color: #339933;">-&gt;</span>f_pos<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out_nolock<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Null write succeeds.  */</span>
	ret <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>count <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out_nolock<span style="color: #339933;">;</span>
&nbsp;
	ret <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ERESTARTSYS<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>down_interruptible<span style="color: #009900;">(</span>PIPE_SEM<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out_nolock<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* No readers yields SIGPIPE.  */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>PIPE_READERS<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> sigpipe<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* If count &lt;= PIPE_BUF, we have to make it atomic.  */</span>
	free <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>count <span style="color: #339933;">&lt;=</span> PIPE_BUF <span style="color: #339933;">?</span> count <span style="color: #339933;">:</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Wait, or check for, available space.  */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>filp<span style="color: #339933;">-&gt;</span>f_flags <span style="color: #339933;">&amp;</span> O_NONBLOCK<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		ret <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EAGAIN<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>PIPE_FREE<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">&lt;</span> free<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>PIPE_FREE<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">&lt;</span> free<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			PIPE_WAITING_WRITERS<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">++;</span>
			pipe_wait<span style="color: #009900;">(</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			PIPE_WAITING_WRITERS<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">--;</span>
			ret <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ERESTARTSYS<span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>signal_pending<span style="color: #009900;">(</span>current<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
&nbsp;
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>PIPE_READERS<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				<span style="color: #b1b100;">goto</span> sigpipe<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Copy into available space.  */</span>
	ret <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EFAULT<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>count <span style="color: #339933;">&gt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">int</span> space<span style="color: #339933;">;</span>
		<span style="color: #993333;">char</span> <span style="color: #339933;">*</span>pipebuf <span style="color: #339933;">=</span> PIPE_BASE<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">+</span> PIPE_END<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		ssize_t chars <span style="color: #339933;">=</span> PIPE_MAX_WCHUNK<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>space <span style="color: #339933;">=</span> PIPE_FREE<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>chars <span style="color: #339933;">&gt;</span> count<span style="color: #009900;">)</span>
				chars <span style="color: #339933;">=</span> count<span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>chars <span style="color: #339933;">&gt;</span> space<span style="color: #009900;">)</span>
				chars <span style="color: #339933;">=</span> space<span style="color: #339933;">;</span>
&nbsp;
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>copy_from_user<span style="color: #009900;">(</span>pipebuf<span style="color: #339933;">,</span> buf<span style="color: #339933;">,</span> chars<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
&nbsp;
			written <span style="color: #339933;">+=</span> chars<span style="color: #339933;">;</span>
			PIPE_LEN<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span> <span style="color: #339933;">+=</span> chars<span style="color: #339933;">;</span>
			count <span style="color: #339933;">-=</span> chars<span style="color: #339933;">;</span>
			buf <span style="color: #339933;">+=</span> chars<span style="color: #339933;">;</span>
			space <span style="color: #339933;">=</span> PIPE_FREE<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
&nbsp;
		ret <span style="color: #339933;">=</span> written<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>filp<span style="color: #339933;">-&gt;</span>f_flags <span style="color: #339933;">&amp;</span> O_NONBLOCK<span style="color: #009900;">)</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">do</span> <span style="color: #009900;">{</span>
			<span style="color: #808080; font-style: italic;">/*
			 * Synchronous wake-up: it knows that this process
			 * is going to give up this CPU, so it doesnt have
			 * to do idle reschedules.
			 */</span>
			wake_up_interruptible_sync<span style="color: #009900;">(</span>PIPE_WAIT<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			PIPE_WAITING_WRITERS<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">++;</span>
			pipe_wait<span style="color: #009900;">(</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			PIPE_WAITING_WRITERS<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">--;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>signal_pending<span style="color: #009900;">(</span>current<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>PIPE_READERS<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				<span style="color: #b1b100;">goto</span> sigpipe<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span> <span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>PIPE_FREE<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		ret <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EFAULT<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Signal readers asynchronously that there is more data.  */</span>
	wake_up_interruptible<span style="color: #009900;">(</span>PIPE_WAIT<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	inode<span style="color: #339933;">-&gt;</span>i_ctime <span style="color: #339933;">=</span> inode<span style="color: #339933;">-&gt;</span>i_mtime <span style="color: #339933;">=</span> CURRENT_TIME<span style="color: #339933;">;</span>
	mark_inode_dirty<span style="color: #009900;">(</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
out<span style="color: #339933;">:</span>
	up<span style="color: #009900;">(</span>PIPE_SEM<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
out_nolock<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>written<span style="color: #009900;">)</span>
		ret <span style="color: #339933;">=</span> written<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> ret<span style="color: #339933;">;</span>
&nbsp;
sigpipe<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>written<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
	up<span style="color: #009900;">(</span>PIPE_SEM<span style="color: #009900;">(</span><span style="color: #339933;">*</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	send_sig<span style="color: #009900;">(</span>SIGPIPE<span style="color: #339933;">,</span> current<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EPIPE<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>代码比较简单但是比较长，这里只说一点，那就是当写入缓冲区的时候先检验写入数据的长度，如果小于一个页面，那么为了保证操作的原子性，就得等到缓冲区中有足够容纳所有数据的空间时才写入，如果大于一个页面，那么就不保证原子性了，而是只要有空间就往里面写。</p> 
          <p>管道通信是一种典型的“生产者<span style="font-family: 'Times New Roman';">-</span><span style="font-family: 宋体;">消费者”模式。</span></p> 
          <h2>命名管道：</h2> 
          <p>前面说的管道是“无名管道”，而现在说的则是命名管道，无名管道只能用于父子、兄弟等有继承关系的进程之间通信，因为其他进程无法检索到非本进程的管道，而有名管道使用了命名机制来访问管道，使得任意两个进程之间都能通过管道来进行通信。</p> 
          <p>命名管道实际上就是在“普通文件”、“块设备文件”和字符设备文件中加了一种文件<span style="font-family: 'Times New Roman';">FIFO</span><span style="font-family: 宋体;">文件，即先入先出文件，对这种文件的访问完全遵循“先入先出”原则。</span></p> 
          <p>文件的操作跳转表如下所示（<span style="font-family: 'Times New Roman';">pipe.c</span><span style="font-family: 宋体;">）：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=696&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p6969"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td> 
              <td class="code" id="p696code9"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * The file_operations structs are not static because they
 * are also used in linux/fs/fifo.c to do operations on FIFOs.
 */</span>
<span style="color: #993333;">struct</span> file_operations read_fifo_fops <span style="color: #339933;">=</span> <span style="color: #009900;">{</span>
	llseek<span style="color: #339933;">:</span>		pipe_lseek<span style="color: #339933;">,</span>
	read<span style="color: #339933;">:</span>		pipe_read<span style="color: #339933;">,</span>
	write<span style="color: #339933;">:</span>		bad_pipe_w<span style="color: #339933;">,</span>
	poll<span style="color: #339933;">:</span>		fifo_poll<span style="color: #339933;">,</span>
	ioctl<span style="color: #339933;">:</span>		pipe_ioctl<span style="color: #339933;">,</span>
	open<span style="color: #339933;">:</span>		pipe_read_open<span style="color: #339933;">,</span>
	release<span style="color: #339933;">:</span>	pipe_read_release<span style="color: #339933;">,</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #993333;">struct</span> file_operations write_fifo_fops <span style="color: #339933;">=</span> <span style="color: #009900;">{</span>
	llseek<span style="color: #339933;">:</span>		pipe_lseek<span style="color: #339933;">,</span>
	read<span style="color: #339933;">:</span>		bad_pipe_r<span style="color: #339933;">,</span>
	write<span style="color: #339933;">:</span>		pipe_write<span style="color: #339933;">,</span>
	poll<span style="color: #339933;">:</span>		fifo_poll<span style="color: #339933;">,</span>
	ioctl<span style="color: #339933;">:</span>		pipe_ioctl<span style="color: #339933;">,</span>
	open<span style="color: #339933;">:</span>		pipe_write_open<span style="color: #339933;">,</span>
	release<span style="color: #339933;">:</span>	pipe_write_release<span style="color: #339933;">,</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #993333;">struct</span> file_operations rdwr_fifo_fops <span style="color: #339933;">=</span> <span style="color: #009900;">{</span>
	llseek<span style="color: #339933;">:</span>		pipe_lseek<span style="color: #339933;">,</span>
	read<span style="color: #339933;">:</span>		pipe_read<span style="color: #339933;">,</span>
	write<span style="color: #339933;">:</span>		pipe_write<span style="color: #339933;">,</span>
	poll<span style="color: #339933;">:</span>		fifo_poll<span style="color: #339933;">,</span>
	ioctl<span style="color: #339933;">:</span>		pipe_ioctl<span style="color: #339933;">,</span>
	open<span style="color: #339933;">:</span>		pipe_rdwr_open<span style="color: #339933;">,</span>
	release<span style="color: #339933;">:</span>	pipe_rdwr_release<span style="color: #339933;">,</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>至于函数就不多说了，以后有必要的话会补充。</p> 
          <p>&nbsp;</p> 
          <p>The&nbsp;End.</p> 
          <p>&nbsp;</p> 
         </div> 
        </div>
       </div>
       <!-- .entry-content --> 
       <!-- .entry-meta --> 
      </article>
      <!-- #post-696 --> 
      <!-- #comments --> 
     </div>
     <!-- #content --> 
    </div>
    <!-- #primary --> 
    <!-- #secondary .widget-area --> 
   </div>
   <!-- #main --> 
   <!-- #colophon --> 
  </div>
  <!-- #page -->   
  <!-- JiaThis Button BEGIN -->  
  <!-- JiaThis Button END -->   
 </body>
</html>