<!doctype html>
<!--[if IE 6]>
<html id="ie6" lang="zh-CN">
<![endif]-->
<!--[if IE 7]>
<html id="ie7" lang="zh-CN">
<![endif]-->
<!--[if IE 8]>
<html id="ie8" lang="zh-CN">
<![endif]-->
<!--[if !(IE 6) | !(IE 7) | !(IE 8)  ]><!-->
<html lang="zh-CN">
 <!--<![endif]-->
 <head>      
  <link rel="stylesheet" type="text/css" media="all" href="stylesheets/style.css">     
  <link rel="stylesheet" id="codebox-css" href="stylesheets/codebox.css" type="text/css" media="screen">             
 </head> 
 <body class="single single-post postid-649 single-format-standard content-sidebar"> 
  <div id="page" class="hfeed"> 
   <header id="branding" role="banner"> 
    <hgroup> 
     <h1 id="site-title"><span><a href="http://codelifeliwan.github.io/" title="Code_Life_LiWan" rel="home">Code_Life_LiWan</a></span></h1> 
     <h2 id="site-description">My heart will go on and on…</h2> 
    </hgroup>  
    <!-- #access --> 
   </header>
   <!-- #branding --> 
   <div id="main" class="clearfix"> 
    <div id="primary"> 
     <div id="content" role="main"> 
      <!-- #nav-single --> 
      <article id="post-649" class="post-649 post type-post status-publish format-standard hentry category-linux_kernel_source_code_notes"> 
       <header class="entry-header"> 
        <h1 class="entry-title">Linux内核-进程管理（三、进程退出与等待）</h1> 
        <div class="entry-meta"> 
         <span class="sep">Posted on </span>
         <a href="http://codelifeliwan.github.io/?p=649" title="下午 4:02" rel="bookmark"><time class="entry-date" datetime="2012-10-14T16:02:44+00:00" pubdate>14 十月, 2012</time></a>
         <span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codelifeliwan.github.io/?author=1" title="View all posts by wanli" rel="author">wanli</a></span></span> 
         <span class="sep"> — </span> 
         <span class="comments-link"> <a href="http://codelifeliwan.github.io/?p=649#comments" title="Comment on Linux内核-进程管理（三、进程退出与等待）">2 Comments ↓</a> </span> 
        </div>
        <!-- .entry-meta --> 
       </header>
       <!-- .entry-header --> 
       <div class="entry-content">
        <div class="entry-content"> 
         <h2>1<span style="font-family: 'DejaVu Sans';">、进程退出</span></h2> 
         <p><span style="font-family: 'AR PL UKai CN';">前面说到过，在每个进程结束后都有个</span><span style="font-family: 'AR PL UKai CN';">exit()</span><span style="font-family: 'AR PL UKai CN';">系统调用，也就是进程退出的系统调用，下面就来看看</span><span style="font-family: 'AR PL UKai CN';">exit()</span><span style="font-family: 'AR PL UKai CN';">系统调用的具体情况：</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';"> exit()</span><span style="font-family: 'AR PL UKai CN';">的实现是在</span><span style="font-family: 'AR PL UKai CN';">kernel/exit.c</span><span style="font-family: 'AR PL UKai CN';">中：</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';"> asmlinkage long sys_exit(int error_code) </span></p> 
         <p><span style="font-family: 'AR PL UKai CN';"> { </span></p> 
         <p><span style="font-family: 'AR PL UKai CN';"> do_exit((error_code&amp;0xff)&lt;&lt;8); </span></p> 
         <p><span style="font-family: 'AR PL UKai CN';"> }</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">传入的参数是退出代码，一般也很少使用。函数的主体是</span><span style="font-family: 'AR PL UKai CN';">do_exit()</span><span style="font-family: 'AR PL UKai CN';">，这个函数也是在</span><span style="font-family: 'AR PL UKai CN';">kernel/exit.c</span><span style="font-family: 'AR PL UKai CN';">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=649&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6491"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td> 
             <td class="code" id="p649code1"><pre class="c" style="font-family:monospace;">NORET_TYPE <span style="color: #993333;">void</span> do_exit<span style="color: #009900;">(</span><span style="color: #993333;">long</span> code<span style="color: #009900;">)</span> 
<span style="color: #009900;">{</span> 
	<span style="color: #993333;">struct</span> task_struct <span style="color: #339933;">*</span>tsk <span style="color: #339933;">=</span> current<span style="color: #339933;">;</span> 
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>in_interrupt<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> 
		panic<span style="color: #009900;">(</span><span style="color: #ff0000;">"Aiee, killing interrupt handler!"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>tsk<span style="color: #339933;">-&gt;</span>pid<span style="color: #009900;">)</span> 
		panic<span style="color: #009900;">(</span><span style="color: #ff0000;">"Attempted to kill the idle task!"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tsk<span style="color: #339933;">-&gt;</span>pid <span style="color: #339933;">==</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span> 
		panic<span style="color: #009900;">(</span><span style="color: #ff0000;">"Attempted to kill init!"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	tsk<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">|=</span> PF_EXITING<span style="color: #339933;">;</span> 
	del_timer_sync<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tsk<span style="color: #339933;">-&gt;</span>real_timer<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
&nbsp;
fake_volatile<span style="color: #339933;">:</span> 
<span style="color: #339933;">#ifdef CONFIG_BSD_PROCESS_ACCT </span>
	acct_process<span style="color: #009900;">(</span>code<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
<span style="color: #339933;">#endif </span>
	__exit_mm<span style="color: #009900;">(</span>tsk<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
&nbsp;
	lock_kernel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	sem_exit<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	__exit_files<span style="color: #009900;">(</span>tsk<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	__exit_fs<span style="color: #009900;">(</span>tsk<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	exit_sighand<span style="color: #009900;">(</span>tsk<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	exit_thread<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>leader<span style="color: #009900;">)</span> 
		disassociate_ctty<span style="color: #009900;">(</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
&nbsp;
	put_exec_domain<span style="color: #009900;">(</span>tsk<span style="color: #339933;">-&gt;</span>exec_domain<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tsk<span style="color: #339933;">-&gt;</span>binfmt <span style="color: #339933;">&amp;&amp;</span> tsk<span style="color: #339933;">-&gt;</span>binfmt<span style="color: #339933;">-&gt;</span>module<span style="color: #009900;">)</span> 
		__MOD_DEC_USE_COUNT<span style="color: #009900;">(</span>tsk<span style="color: #339933;">-&gt;</span>binfmt<span style="color: #339933;">-&gt;</span>module<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
&nbsp;
	tsk<span style="color: #339933;">-&gt;</span>exit_code <span style="color: #339933;">=</span> code<span style="color: #339933;">;</span> 
	exit_notify<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	schedule<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	BUG<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
<span style="color: #808080; font-style: italic;">/* 
 * In order to get rid of the "volatile function does return" message 
 * I did this little loop that confuses gcc to think do_exit really 
 * is volatile. In fact it's schedule() that is volatile in some 
 * circumstances: when current-&gt;state = ZOMBIE, schedule() never 
 * returns. 
 * 
 * In fact the natural way to do all this is to have the label and the 
 * goto right after each other, but I put the fake_volatile label at 
 * the start of the function just in case something /really/ bad 
 * happens, and the schedule returns. This way we can try again. I'm 
 * not paranoid: it's just that everybody is out to get me. 
 */</span> 
	<span style="color: #b1b100;">goto</span> fake_volatile<span style="color: #339933;">;</span> 
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p><span style="font-family: 'AR PL UKai CN';">函数首先申请了一个当前进程的指针，也就是将要退出的进程的指针，注意：执行此函数是本进程执行的。首先判断是否正在处于中断中，中断程序是不允许调用此函数的。然后判断是否是</span><span style="font-family: 'AR PL UKai CN';">0</span><span style="font-family: 'AR PL UKai CN';">号进程，</span><span style="font-family: 'AR PL UKai CN';">0</span><span style="font-family: 'AR PL UKai CN';">号进程不允许退出（即使系统崩溃，</span><span style="font-family: 'AR PL UKai CN';">1</span><span style="font-family: 'AR PL UKai CN';">号进程退出，</span><span style="font-family: 'AR PL UKai CN';">0</span><span style="font-family: 'AR PL UKai CN';">号进程也不退出？）然后判断是否是</span><span style="font-family: 'AR PL UKai CN';">1</span><span style="font-family: 'AR PL UKai CN';">号进程，</span><span style="font-family: 'AR PL UKai CN';">1</span><span style="font-family: 'AR PL UKai CN';">号进程是几乎所有进程（</span><span style="font-family: 'AR PL UKai CN';">0</span><span style="font-family: 'AR PL UKai CN';">号除外）的祖先进程，一般不允许退出，除非系统瘫痪、崩溃或者不能启动等情况。然后将当前进程的标志设置成正在退出。</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">至于函数</span><span style="font-family: 'AR PL UKai CN';">del_timer_sync()</span><span style="font-family: 'AR PL UKai CN';">是在进程设置了实时定时器的时候使用的，进程设置了实时定时器的时候内核会将其挂入定时器队列，而在进程退出的时候要将其从队列中脱离。</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">紧跟着，进程退出的时候要释放其资源，所以</span><span style="font-family: 'AR PL UKai CN';">__exit_mm()</span><span style="font-family: 'AR PL UKai CN';">用来释放存储空间、</span><span style="font-family: 'AR PL UKai CN';">__exit_files()</span><span style="font-family: 'AR PL UKai CN';">用来释放所打开的文件、</span><span style="font-family: 'AR PL UKai CN';">__exit_fs()</span><span style="font-family: 'AR PL UKai CN';">用来释放工作目录等等。特殊的，</span><span style="font-family: 'AR PL UKai CN';">sem_exit()</span><span style="font-family: 'AR PL UKai CN';">用来撤销信号量等。然后将其从相应的执行域中去除，然后使用</span><span style="font-family: 'AR PL UKai CN';">exit_notify()</span><span style="font-family: 'AR PL UKai CN';">来告诉和唤醒父进程，让父进程来回收系统堆栈以及</span><span style="font-family: 'AR PL UKai CN';">task_struct</span><span style="font-family: 'AR PL UKai CN';">结构，并且把自己的进程状态改成</span><span style="font-family: 'AR PL UKai CN';">TASK_ZOMBIE</span><span style="font-family: 'AR PL UKai CN';">也就是僵死状态，不再受调度程序调度。最后调用调度程序</span><span style="font-family: 'AR PL UKai CN';">schedule()</span><span style="font-family: 'AR PL UKai CN';">。注意在此处调用调度程序导致了</span><span style="font-family: 'AR PL UKai CN';">exit()</span><span style="font-family: 'AR PL UKai CN';">不返回，因为在调用</span><span style="font-family: 'AR PL UKai CN';">schedule()</span><span style="font-family: 'AR PL UKai CN';">之前已经将进程设置成了</span><span style="font-family: 'AR PL UKai CN';">TASK_ZOMBIE</span><span style="font-family: 'AR PL UKai CN';">，已经不受调度程序调度了，所以这了就不会再返回了，返回就是出错了，大体流程如下：</span></p> 
         <p><a href="uploads/2012/10/snapshot1.png"><img class="aligncenter size-full wp-image-651" title="snapshot1" src="uploads/2012/10/snapshot1.png" alt="" width="322" height="537"></a></p> 
         <p><span style="font-family: 'AR PL UKai CN';">关于释放内存的函数</span><span style="font-family: 'AR PL UKai CN';">__exit_mm()</span><span style="font-family: 'AR PL UKai CN';">的函数也是在</span><span style="font-family: 'AR PL UKai CN';">exit.c</span><span style="font-family: 'AR PL UKai CN';">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=649&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6492"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td> 
             <td class="code" id="p649code2"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #000000; font-weight: bold;">inline</span> <span style="color: #993333;">void</span> __exit_mm<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> task_struct <span style="color: #339933;">*</span> tsk<span style="color: #009900;">)</span> 
<span style="color: #009900;">{</span> 
	<span style="color: #993333;">struct</span> mm_struct <span style="color: #339933;">*</span> mm <span style="color: #339933;">=</span> tsk<span style="color: #339933;">-&gt;</span>mm<span style="color: #339933;">;</span> 
&nbsp;
	mm_release<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>mm<span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
		atomic_inc<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>mm<span style="color: #339933;">-&gt;</span>mm_count<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>mm <span style="color: #339933;">!=</span> tsk<span style="color: #339933;">-&gt;</span>active_mm<span style="color: #009900;">)</span> BUG<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		<span style="color: #808080; font-style: italic;">/* more a memory barrier than a real lock */</span> 
		task_lock<span style="color: #009900;">(</span>tsk<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		tsk<span style="color: #339933;">-&gt;</span>mm <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span> 
		task_unlock<span style="color: #009900;">(</span>tsk<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		enter_lazy_tlb<span style="color: #009900;">(</span>mm<span style="color: #339933;">,</span> current<span style="color: #339933;">,</span> smp_processor_id<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		mmput<span style="color: #009900;">(</span>mm<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #009900;">}</span> 
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p><span style="font-family: 'AR PL UKai CN';">首先调用</span><span style="font-family: 'AR PL UKai CN';">mm_release()</span><span style="font-family: 'AR PL UKai CN';">函数来对父进程执行一次</span><span style="font-family: 'AR PL UKai CN';">up()</span><span style="font-family: 'AR PL UKai CN';">操作，这个考虑是在进程创建的时候置位了</span><span style="font-family: 'AR PL UKai CN';">PF_VFORK</span><span style="font-family: 'AR PL UKai CN';">位，父进程处于</span><span style="font-family: 'AR PL UKai CN';">down()</span><span style="font-family: 'AR PL UKai CN';">状态，等待子进程执行完成，所以这里需要</span><span style="font-family: 'AR PL UKai CN';">up()</span><span style="font-family: 'AR PL UKai CN';">一下。</span><span style="font-family: 'AR PL UKai CN';">mm_release()</span><span style="font-family: 'AR PL UKai CN';">函数定义在</span><span style="font-family: 'AR PL UKai CN';">kernel/fork.c</span><span style="font-family: 'AR PL UKai CN';">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=649&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6493"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td> 
             <td class="code" id="p649code3"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">void</span> mm_release<span style="color: #009900;">(</span><span style="color: #993333;">void</span><span style="color: #009900;">)</span> 
<span style="color: #009900;">{</span> 
	<span style="color: #993333;">struct</span> task_struct <span style="color: #339933;">*</span>tsk <span style="color: #339933;">=</span> current<span style="color: #339933;">;</span> 
&nbsp;
	<span style="color: #808080; font-style: italic;">/* notify parent sleeping on vfork() */</span> 
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tsk<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">&amp;</span> PF_VFORK<span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
		tsk<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">&amp;=</span> ~PF_VFORK<span style="color: #339933;">;</span> 
		up<span style="color: #009900;">(</span>tsk<span style="color: #339933;">-&gt;</span>p_opptr<span style="color: #339933;">-&gt;</span>vfork_sem<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #009900;">}</span> 
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p><span style="font-family: 'AR PL UKai CN';">真正的释放空间是通过</span><span style="font-family: 'AR PL UKai CN';">mmput()</span><span style="font-family: 'AR PL UKai CN';">来完成的，</span><span style="font-family: 'AR PL UKai CN';">mmput</span><span style="font-family: 'AR PL UKai CN';">也是定义在</span><span style="font-family: 'AR PL UKai CN';">fork.c</span><span style="font-family: 'AR PL UKai CN';">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=649&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6494"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td> 
             <td class="code" id="p649code4"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">void</span> mmput<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> mm_struct <span style="color: #339933;">*</span>mm<span style="color: #009900;">)</span> 
<span style="color: #009900;">{</span> 
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>atomic_dec_and_lock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>mm<span style="color: #339933;">-&gt;</span>mm_users<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>mmlist_lock<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
		list_del<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>mm<span style="color: #339933;">-&gt;</span>mmlist<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		spin_unlock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>mmlist_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		exit_mmap<span style="color: #009900;">(</span>mm<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		mmdrop<span style="color: #009900;">(</span>mm<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #009900;">}</span> 
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p><span style="font-family: 'AR PL UKai CN';">mmput()</span><span style="font-family: 'AR PL UKai CN';">函数中将</span><span style="font-family: 'AR PL UKai CN';">mm_users</span><span style="font-family: 'AR PL UKai CN';">递减</span><span style="font-family: 'AR PL UKai CN';">1</span><span style="font-family: 'AR PL UKai CN';">，如果递减过后变成了</span><span style="font-family: 'AR PL UKai CN';">0</span><span style="font-family: 'AR PL UKai CN';">，那么就需要真正释放内存空间了，否则的话只需递减即可，因为还有其他进程需要使用或者共享内存。</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">当递减至</span><span style="font-family: 'AR PL UKai CN';">0</span><span style="font-family: 'AR PL UKai CN';">时需要执行一系列操作，首先就是将其内存管理数据结构从内存管理队列中删除。然后使用</span><span style="font-family: 'AR PL UKai CN';">exit_mmap()</span><span style="font-family: 'AR PL UKai CN';">来释放其</span><span style="font-family: 'AR PL UKai CN';">mm_struct</span><span style="font-family: 'AR PL UKai CN';">下面的所有</span><span style="font-family: 'AR PL UKai CN';">vm_area_struct</span><span style="font-family: 'AR PL UKai CN';">数据结构。并且将页面表中与用户空间相对应的表项都设置成</span><span style="font-family: 'AR PL UKai CN';">0</span><span style="font-family: 'AR PL UKai CN';">，使整个用户空间都变成一个“空壳”，最后通过</span><span style="font-family: 'AR PL UKai CN';">mmdrop()</span><span style="font-family: 'AR PL UKai CN';">来将页面表、页面目录包括</span><span style="font-family: 'AR PL UKai CN';">mm_struct</span><span style="font-family: 'AR PL UKai CN';">本身，也全部释放。</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">exit_mmap()</span><span style="font-family: 'AR PL UKai CN';">函数是在</span><span style="font-family: 'AR PL UKai CN';">mm/mmap.c</span><span style="font-family: 'AR PL UKai CN';">中定义的：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=649&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6495"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td> 
             <td class="code" id="p649code5"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/* Release all mmaps. */</span> 
<span style="color: #993333;">void</span> exit_mmap<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> mm_struct <span style="color: #339933;">*</span> mm<span style="color: #009900;">)</span> 
<span style="color: #009900;">{</span> 
	<span style="color: #993333;">struct</span> vm_area_struct <span style="color: #339933;">*</span> mpnt<span style="color: #339933;">;</span> 
&nbsp;
	release_segments<span style="color: #009900;">(</span>mm<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	spin_lock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>mm<span style="color: #339933;">-&gt;</span>page_table_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	mpnt <span style="color: #339933;">=</span> mm<span style="color: #339933;">-&gt;</span>mmap<span style="color: #339933;">;</span> 
	mm<span style="color: #339933;">-&gt;</span>mmap <span style="color: #339933;">=</span> mm<span style="color: #339933;">-&gt;</span>mmap_avl <span style="color: #339933;">=</span> mm<span style="color: #339933;">-&gt;</span>mmap_cache <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span> 
	spin_unlock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>mm<span style="color: #339933;">-&gt;</span>page_table_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	mm<span style="color: #339933;">-&gt;</span>rss <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> 
	mm<span style="color: #339933;">-&gt;</span>total_vm <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> 
	mm<span style="color: #339933;">-&gt;</span>locked_vm <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> 
	<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>mpnt<span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
		<span style="color: #993333;">struct</span> vm_area_struct <span style="color: #339933;">*</span> next <span style="color: #339933;">=</span> mpnt<span style="color: #339933;">-&gt;</span>vm_next<span style="color: #339933;">;</span> 
		<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> start <span style="color: #339933;">=</span> mpnt<span style="color: #339933;">-&gt;</span>vm_start<span style="color: #339933;">;</span> 
		<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> end <span style="color: #339933;">=</span> mpnt<span style="color: #339933;">-&gt;</span>vm_end<span style="color: #339933;">;</span> 
		<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> size <span style="color: #339933;">=</span> end <span style="color: #339933;">-</span> start<span style="color: #339933;">;</span> 
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>mpnt<span style="color: #339933;">-&gt;</span>vm_ops<span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>mpnt<span style="color: #339933;">-&gt;</span>vm_ops<span style="color: #339933;">-&gt;</span>close<span style="color: #009900;">)</span> 
				mpnt<span style="color: #339933;">-&gt;</span>vm_ops<span style="color: #339933;">-&gt;</span>close<span style="color: #009900;">(</span>mpnt<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		<span style="color: #009900;">}</span> 
		mm<span style="color: #339933;">-&gt;</span>map_count<span style="color: #339933;">--;</span> 
		remove_shared_vm_struct<span style="color: #009900;">(</span>mpnt<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		flush_cache_range<span style="color: #009900;">(</span>mm<span style="color: #339933;">,</span> start<span style="color: #339933;">,</span> end<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		zap_page_range<span style="color: #009900;">(</span>mm<span style="color: #339933;">,</span> start<span style="color: #339933;">,</span> size<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>mpnt<span style="color: #339933;">-&gt;</span>vm_file<span style="color: #009900;">)</span> 
			fput<span style="color: #009900;">(</span>mpnt<span style="color: #339933;">-&gt;</span>vm_file<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		kmem_cache_free<span style="color: #009900;">(</span>vm_area_cachep<span style="color: #339933;">,</span> mpnt<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		mpnt <span style="color: #339933;">=</span> next<span style="color: #339933;">;</span> 
	<span style="color: #009900;">}</span> 
&nbsp;
	<span style="color: #808080; font-style: italic;">/* This is just debugging */</span> 
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>mm<span style="color: #339933;">-&gt;</span>map_count<span style="color: #009900;">)</span> 
		printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"exit_mmap: map count is %d<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> mm<span style="color: #339933;">-&gt;</span>map_count<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
&nbsp;
	clear_page_tables<span style="color: #009900;">(</span>mm<span style="color: #339933;">,</span> FIRST_USER_PGD_NR<span style="color: #339933;">,</span> USER_PTRS_PER_PGD<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p><span style="font-family: 'AR PL UKai CN';">功能就是循环释放管理区然后调用</span><span style="font-family: 'AR PL UKai CN';">clear_page_tables</span><span style="font-family: 'AR PL UKai CN';">来将页表清零。</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">而</span><span style="font-family: 'AR PL UKai CN';">mmdrop()</span><span style="font-family: 'AR PL UKai CN';">函数定义在</span><span style="font-family: 'AR PL UKai CN';">include/linuc/sched.h</span><span style="font-family: 'AR PL UKai CN';">中，这里不详说。</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">回到</span><span style="font-family: 'AR PL UKai CN';">do_exit()</span><span style="font-family: 'AR PL UKai CN';">中，其他的几个</span><span style="font-family: 'AR PL UKai CN';">exit</span><span style="font-family: 'AR PL UKai CN';">也都类似，需要重点说明的是</span><span style="font-family: 'AR PL UKai CN';">exit_notify()</span><span style="font-family: 'AR PL UKai CN';">函数。它告诉父进程子进程已经退出，需要父进程来回收子进程的系统堆栈以及</span><span style="font-family: 'AR PL UKai CN';">task_struct</span><span style="font-family: 'AR PL UKai CN';">结构等，还需要把自己的状态设置为</span><span style="font-family: 'AR PL UKai CN';">TASK_ZOMBIE</span><span style="font-family: 'AR PL UKai CN';">。</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">exit_notify()</span><span style="font-family: 'AR PL UKai CN';">函数定义在</span><span style="font-family: 'AR PL UKai CN';">kernel/exit.c</span><span style="font-family: 'AR PL UKai CN';">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=649&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6496"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
</pre></td> 
             <td class="code" id="p649code6"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">void</span> exit_notify<span style="color: #009900;">(</span><span style="color: #993333;">void</span><span style="color: #009900;">)</span> 
<span style="color: #009900;">{</span> 
	<span style="color: #993333;">struct</span> task_struct <span style="color: #339933;">*</span> p<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>t<span style="color: #339933;">;</span> 
&nbsp;
	forget_original_parent<span style="color: #009900;">(</span>current<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #808080; font-style: italic;">/* 
	 * Check to see if any process groups have become orphaned 
	 * as a result of our exiting, and if they have any stopped 
	 * jobs, send them a SIGHUP and then a SIGCONT.  (POSIX 3.2.2.2) 
	 * 
	 * Case i: Our father is in a different pgrp than we are 
	 * and we were the only connection outside, so our pgrp 
	 * is about to become orphaned. 
	 */</span> 
&nbsp;
	t <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>p_pptr<span style="color: #339933;">;</span> 
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>t<span style="color: #339933;">-&gt;</span>pgrp <span style="color: #339933;">!=</span> current<span style="color: #339933;">-&gt;</span>pgrp<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> 
	    <span style="color: #009900;">(</span>t<span style="color: #339933;">-&gt;</span>session <span style="color: #339933;">==</span> current<span style="color: #339933;">-&gt;</span>session<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> 
	    will_become_orphaned_pgrp<span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>pgrp<span style="color: #339933;">,</span> current<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> 
	    has_stopped_jobs<span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>pgrp<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
		kill_pg<span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>pgrp<span style="color: #339933;">,</span>SIGHUP<span style="color: #339933;">,</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		kill_pg<span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>pgrp<span style="color: #339933;">,</span>SIGCONT<span style="color: #339933;">,</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #009900;">}</span> 
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Let father know we died 
	 * 
	 * Thread signals are configurable, but you aren't going to use 
	 * that to send signals to arbitary processes. 
	 * That stops right now. 
	 * 
	 * If the parent exec id doesn't match the exec id we saved 
	 * when we started then we know the parent has changed security 
	 * domain. 
	 * 
	 * If our self_exec id doesn't match our parent_exec_id then 
	 * we have changed execution domain as these two values started 
	 * the same after a fork. 
	 *	 
	 */</span> 
&nbsp;
	<span style="color: #b1b100;">if</span><span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>exit_signal <span style="color: #339933;">!=</span> SIGCHLD <span style="color: #339933;">&amp;&amp;</span> 
	    <span style="color: #009900;">(</span> current<span style="color: #339933;">-&gt;</span>parent_exec_id <span style="color: #339933;">!=</span> t<span style="color: #339933;">-&gt;</span>self_exec_id  <span style="color: #339933;">||</span> 
	      current<span style="color: #339933;">-&gt;</span>self_exec_id <span style="color: #339933;">!=</span> current<span style="color: #339933;">-&gt;</span>parent_exec_id<span style="color: #009900;">)</span> 
	    <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span>capable<span style="color: #009900;">(</span>CAP_KILL<span style="color: #009900;">)</span><span style="color: #009900;">)</span> 
		current<span style="color: #339933;">-&gt;</span>exit_signal <span style="color: #339933;">=</span> SIGCHLD<span style="color: #339933;">;</span> 
&nbsp;
&nbsp;
	<span style="color: #808080; font-style: italic;">/* 
	 * This loop does two things: 
	 * 
  	 * A.  Make init inherit all the child processes 
	 * B.  Check to see if any process groups have become orphaned 
	 *	as a result of our exiting, and if they have any stopped 
	 *	jobs, send them a SIGHUP and then a SIGCONT.  (POSIX 3.2.2.2) 
	 */</span> 
&nbsp;
	write_lock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tasklist_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	current<span style="color: #339933;">-&gt;</span>state <span style="color: #339933;">=</span> TASK_ZOMBIE<span style="color: #339933;">;</span> 
	do_notify_parent<span style="color: #009900;">(</span>current<span style="color: #339933;">,</span> current<span style="color: #339933;">-&gt;</span>exit_signal<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>p_cptr <span style="color: #339933;">!=</span> NULL<span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
		p <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>p_cptr<span style="color: #339933;">;</span> 
		current<span style="color: #339933;">-&gt;</span>p_cptr <span style="color: #339933;">=</span> p<span style="color: #339933;">-&gt;</span>p_osptr<span style="color: #339933;">;</span> 
		p<span style="color: #339933;">-&gt;</span>p_ysptr <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span> 
		p<span style="color: #339933;">-&gt;</span>ptrace <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> 
&nbsp;
		p<span style="color: #339933;">-&gt;</span>p_pptr <span style="color: #339933;">=</span> p<span style="color: #339933;">-&gt;</span>p_opptr<span style="color: #339933;">;</span> 
		p<span style="color: #339933;">-&gt;</span>p_osptr <span style="color: #339933;">=</span> p<span style="color: #339933;">-&gt;</span>p_pptr<span style="color: #339933;">-&gt;</span>p_cptr<span style="color: #339933;">;</span> 
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>p_osptr<span style="color: #009900;">)</span> 
			p<span style="color: #339933;">-&gt;</span>p_osptr<span style="color: #339933;">-&gt;</span>p_ysptr <span style="color: #339933;">=</span> p<span style="color: #339933;">;</span> 
		p<span style="color: #339933;">-&gt;</span>p_pptr<span style="color: #339933;">-&gt;</span>p_cptr <span style="color: #339933;">=</span> p<span style="color: #339933;">;</span> 
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>state <span style="color: #339933;">==</span> TASK_ZOMBIE<span style="color: #009900;">)</span> 
			do_notify_parent<span style="color: #009900;">(</span>p<span style="color: #339933;">,</span> p<span style="color: #339933;">-&gt;</span>exit_signal<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		<span style="color: #808080; font-style: italic;">/* 
		 * process group orphan check 
		 * Case ii: Our child is in a different pgrp 
		 * than we are, and it was the only connection 
		 * outside, so the child pgrp is now orphaned. 
		 */</span> 
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>pgrp <span style="color: #339933;">!=</span> current<span style="color: #339933;">-&gt;</span>pgrp<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> 
		    <span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>session <span style="color: #339933;">==</span> current<span style="color: #339933;">-&gt;</span>session<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
			<span style="color: #993333;">int</span> pgrp <span style="color: #339933;">=</span> p<span style="color: #339933;">-&gt;</span>pgrp<span style="color: #339933;">;</span> 
&nbsp;
			write_unlock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tasklist_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>is_orphaned_pgrp<span style="color: #009900;">(</span>pgrp<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> has_stopped_jobs<span style="color: #009900;">(</span>pgrp<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
				kill_pg<span style="color: #009900;">(</span>pgrp<span style="color: #339933;">,</span>SIGHUP<span style="color: #339933;">,</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
				kill_pg<span style="color: #009900;">(</span>pgrp<span style="color: #339933;">,</span>SIGCONT<span style="color: #339933;">,</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
			<span style="color: #009900;">}</span> 
			write_lock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tasklist_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		<span style="color: #009900;">}</span> 
	<span style="color: #009900;">}</span> 
	write_unlock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tasklist_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p><span style="font-family: 'AR PL UKai CN';">在进程创建的时候说过两个父进程指针：</span><span style="font-family: 'AR PL UKai CN';">p_pptr</span><span style="font-family: 'AR PL UKai CN';">和</span><span style="font-family: 'AR PL UKai CN';">p_opptr</span><span style="font-family: 'AR PL UKai CN';">。其中，</span><span style="font-family: 'AR PL UKai CN';">p_opptr</span><span style="font-family: 'AR PL UKai CN';">指向其“生父”，也就是创建此进程的进程，而</span><span style="font-family: 'AR PL UKai CN';">p_pptr</span><span style="font-family: 'AR PL UKai CN';">指向其“养父”，也就是目前的父亲，大部分情况下这两个指针是相同的。但是也有不同的时候，当进程</span><span style="font-family: 'AR PL UKai CN';">A</span><span style="font-family: 'AR PL UKai CN';">跟踪进程</span><span style="font-family: 'AR PL UKai CN';">B</span><span style="font-family: 'AR PL UKai CN';">的时候进程</span><span style="font-family: 'AR PL UKai CN';">A</span><span style="font-family: 'AR PL UKai CN';">暂时就是进程</span><span style="font-family: 'AR PL UKai CN';">B</span><span style="font-family: 'AR PL UKai CN';">的“养父”。那么当一个进程如果在其子进程结束之间要</span><span style="font-family: 'AR PL UKai CN';">exit</span><span style="font-family: 'AR PL UKai CN';">的话，就要将子进程托付给其他进程，如果要</span><span style="font-family: 'AR PL UKai CN';">exit</span><span style="font-family: 'AR PL UKai CN';">的是一个线程，那么就要将子进程托付给同一线程组的下一个线程，使子进程的</span><span style="font-family: 'AR PL UKai CN';">p_opptr</span><span style="font-family: 'AR PL UKai CN';">指针指向这个线程，否则的话就托付给初始进程</span><span style="font-family: 'AR PL UKai CN';">init</span><span style="font-family: 'AR PL UKai CN';">，这个事情是在</span><span style="font-family: 'AR PL UKai CN';">forget_original_parent</span><span style="font-family: 'AR PL UKai CN';">函数中实现的（</span><span style="font-family: 'AR PL UKai CN';">exit.c</span><span style="font-family: 'AR PL UKai CN';">）：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=649&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6497"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td> 
             <td class="code" id="p649code7"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #000000; font-weight: bold;">inline</span> <span style="color: #993333;">void</span> forget_original_parent<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> task_struct <span style="color: #339933;">*</span> father<span style="color: #009900;">)</span> 
<span style="color: #009900;">{</span> 
	<span style="color: #993333;">struct</span> task_struct <span style="color: #339933;">*</span> p<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>reaper<span style="color: #339933;">;</span> 
&nbsp;
	read_lock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tasklist_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Next in our thread group */</span> 
	reaper <span style="color: #339933;">=</span> next_thread<span style="color: #009900;">(</span>father<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>reaper <span style="color: #339933;">==</span> father<span style="color: #009900;">)</span> 
		reaper <span style="color: #339933;">=</span> child_reaper<span style="color: #339933;">;</span> 
&nbsp;
	for_each_task<span style="color: #009900;">(</span>p<span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>p_opptr <span style="color: #339933;">==</span> father<span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
			<span style="color: #808080; font-style: italic;">/* We dont want people slaying init */</span> 
			p<span style="color: #339933;">-&gt;</span>exit_signal <span style="color: #339933;">=</span> SIGCHLD<span style="color: #339933;">;</span> 
			p<span style="color: #339933;">-&gt;</span>self_exec_id<span style="color: #339933;">++;</span> 
			p<span style="color: #339933;">-&gt;</span>p_opptr <span style="color: #339933;">=</span> reaper<span style="color: #339933;">;</span> 
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>pdeath_signal<span style="color: #009900;">)</span> send_sig<span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>pdeath_signal<span style="color: #339933;">,</span> p<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		<span style="color: #009900;">}</span> 
	<span style="color: #009900;">}</span> 
	read_unlock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tasklist_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p><span style="font-family: 'AR PL UKai CN';">其中</span><span style="font-family: 'AR PL UKai CN';">for_each_task(p)</span><span style="font-family: 'AR PL UKai CN';">定义如下（</span><span style="font-family: 'AR PL UKai CN';">include/linux/sched.h</span><span style="font-family: 'AR PL UKai CN';">）：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=649&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6498"> 
             <td class="line_numbers"><pre>1
2
</pre></td> 
             <td class="code" id="p649code8"><pre class="c" style="font-family:monospace;"><span style="color: #339933;">#define for_each_task(p) \ </span>
	<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>p <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>init_task <span style="color: #339933;">;</span> <span style="color: #009900;">(</span>p <span style="color: #339933;">=</span> p<span style="color: #339933;">-&gt;</span>next_task<span style="color: #009900;">)</span> <span style="color: #339933;">!=</span> <span style="color: #339933;">&amp;</span>init_task <span style="color: #339933;">;</span> <span style="color: #009900;">)</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p><span style="font-family: 'AR PL UKai CN';">函数就是循环搜索所有进程，凡是发现其生父时</span><span style="font-family: 'AR PL UKai CN';">father</span><span style="font-family: 'AR PL UKai CN';">的就将其</span><span style="font-family: 'AR PL UKai CN';">p_opptr</span><span style="font-family: 'AR PL UKai CN';">改成</span><span style="font-family: 'AR PL UKai CN';">child_reaper</span><span style="font-family: 'AR PL UKai CN';">即</span><span style="font-family: 'AR PL UKai CN';">init</span><span style="font-family: 'AR PL UKai CN';">进程，</span><span style="font-family: 'AR PL UKai CN';">next_thread</span><span style="font-family: 'AR PL UKai CN';">是搜索线程，当搜索不到的时候就不是线程，而是进程，</span><span style="font-family: 'AR PL UKai CN';">reaper</span><span style="font-family: 'AR PL UKai CN';">就指向自身，这时候</span><span style="font-family: 'AR PL UKai CN';">reaper</span><span style="font-family: 'AR PL UKai CN';">就要指向</span><span style="font-family: 'AR PL UKai CN';">init</span><span style="font-family: 'AR PL UKai CN';">了。</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">下面说的进程的父进程就是其养父了，也就是</span><span style="font-family: 'AR PL UKai CN';">t</span><span style="font-family: 'AR PL UKai CN';">。</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">当一个用户登录到系统后会启动很多进程，使用同一个控制终端（或模拟终端）的进程属于同一个</span><span style="font-family: 'AR PL UKai CN';">session</span><span style="font-family: 'AR PL UKai CN';">，在同一条命令或者执行程序中启动的不同进程属于同一个组，每个</span><span style="font-family: 'AR PL UKai CN';">session</span><span style="font-family: 'AR PL UKai CN';">和组中最早创建的那个进程的</span><span style="font-family: 'AR PL UKai CN';">pid</span><span style="font-family: 'AR PL UKai CN';">就是</span><span style="font-family: 'AR PL UKai CN';">session</span><span style="font-family: 'AR PL UKai CN';">号或者组号。</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">如果当前进程与父进程属于不同组，不同</span><span style="font-family: 'AR PL UKai CN';">session</span><span style="font-family: 'AR PL UKai CN';">，但是又是其所在组与父进程之间唯一的纽带，那么一旦当前进程不存在以后，整个进程组就成了“孤儿”，这时候按照</span><span style="font-family: 'AR PL UKai CN';">POSIX 3.2.2.2</span><span style="font-family: 'AR PL UKai CN';">的规定，要给这个进程组中所有的进程都先发送一个</span><span style="font-family: 'AR PL UKai CN';">SIGHUP</span><span style="font-family: 'AR PL UKai CN';">信号，然后再发送一个</span><span style="font-family: 'AR PL UKai CN';">SIGCONT</span><span style="font-family: 'AR PL UKai CN';">信号，这就时</span><span style="font-family: 'AR PL UKai CN';">kill_pg()</span><span style="font-family: 'AR PL UKai CN';">函数的目的。</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">在</span><span style="font-family: 'AR PL UKai CN';">exit_notify()</span><span style="font-family: 'AR PL UKai CN';">中还有一个需要讲的是</span><span style="font-family: 'AR PL UKai CN';">do_notify_parent()</span><span style="font-family: 'AR PL UKai CN';">函数，这个函数就是用来给父进程发送信号通知父进程子进程已经结束，父进程应该进行对子进程的进一步回收。</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">do_notify_parent()</span><span style="font-family: 'AR PL UKai CN';">函数是在</span><span style="font-family: 'AR PL UKai CN';">kernel/signal.c</span><span style="font-family: 'AR PL UKai CN';">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=649&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6499"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td> 
             <td class="code" id="p649code9"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">void</span> do_notify_parent<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> task_struct <span style="color: #339933;">*</span>tsk<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> sig<span style="color: #009900;">)</span> 
<span style="color: #009900;">{</span> 
	<span style="color: #993333;">struct</span> siginfo info<span style="color: #339933;">;</span> 
	<span style="color: #993333;">int</span> why<span style="color: #339933;">,</span> status<span style="color: #339933;">;</span> 
&nbsp;
	info.<span style="color: #202020;">si_signo</span> <span style="color: #339933;">=</span> sig<span style="color: #339933;">;</span> 
	info.<span style="color: #202020;">si_errno</span> <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> 
	info.<span style="color: #202020;">si_pid</span> <span style="color: #339933;">=</span> tsk<span style="color: #339933;">-&gt;</span>pid<span style="color: #339933;">;</span> 
	info.<span style="color: #202020;">si_uid</span> <span style="color: #339933;">=</span> tsk<span style="color: #339933;">-&gt;</span>uid<span style="color: #339933;">;</span> 
&nbsp;
	<span style="color: #808080; font-style: italic;">/* FIXME: find out whether or not this is supposed to be c*time. */</span> 
	info.<span style="color: #202020;">si_utime</span> <span style="color: #339933;">=</span> tsk<span style="color: #339933;">-&gt;</span>times.<span style="color: #202020;">tms_utime</span><span style="color: #339933;">;</span> 
	info.<span style="color: #202020;">si_stime</span> <span style="color: #339933;">=</span> tsk<span style="color: #339933;">-&gt;</span>times.<span style="color: #202020;">tms_stime</span><span style="color: #339933;">;</span> 
&nbsp;
	status <span style="color: #339933;">=</span> tsk<span style="color: #339933;">-&gt;</span>exit_code <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0x7f</span><span style="color: #339933;">;</span> 
	why <span style="color: #339933;">=</span> SI_KERNEL<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* shouldn't happen */</span> 
	<span style="color: #b1b100;">switch</span> <span style="color: #009900;">(</span>tsk<span style="color: #339933;">-&gt;</span>state<span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
	<span style="color: #b1b100;">case</span> TASK_STOPPED<span style="color: #339933;">:</span> 
		<span style="color: #808080; font-style: italic;">/* FIXME -- can we deduce CLD_TRAPPED or CLD_CONTINUED? */</span> 
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tsk<span style="color: #339933;">-&gt;</span>ptrace <span style="color: #339933;">&amp;</span> PT_PTRACED<span style="color: #009900;">)</span> 
			why <span style="color: #339933;">=</span> CLD_TRAPPED<span style="color: #339933;">;</span> 
		<span style="color: #b1b100;">else</span> 
			why <span style="color: #339933;">=</span> CLD_STOPPED<span style="color: #339933;">;</span> 
		<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span> 
&nbsp;
	<span style="color: #b1b100;">default</span><span style="color: #339933;">:</span> 
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tsk<span style="color: #339933;">-&gt;</span>exit_code <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0x80</span><span style="color: #009900;">)</span> 
			why <span style="color: #339933;">=</span> CLD_DUMPED<span style="color: #339933;">;</span> 
		<span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tsk<span style="color: #339933;">-&gt;</span>exit_code <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0x7f</span><span style="color: #009900;">)</span> 
			why <span style="color: #339933;">=</span> CLD_KILLED<span style="color: #339933;">;</span> 
		<span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span> 
			why <span style="color: #339933;">=</span> CLD_EXITED<span style="color: #339933;">;</span> 
			status <span style="color: #339933;">=</span> tsk<span style="color: #339933;">-&gt;</span>exit_code <span style="color: #339933;">&gt;&gt;</span> <span style="color: #0000dd;">8</span><span style="color: #339933;">;</span> 
		<span style="color: #009900;">}</span> 
		<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span> 
	<span style="color: #009900;">}</span> 
	info.<span style="color: #202020;">si_code</span> <span style="color: #339933;">=</span> why<span style="color: #339933;">;</span> 
	info.<span style="color: #202020;">si_status</span> <span style="color: #339933;">=</span> status<span style="color: #339933;">;</span> 
&nbsp;
	send_sig_info<span style="color: #009900;">(</span>sig<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>info<span style="color: #339933;">,</span> tsk<span style="color: #339933;">-&gt;</span>p_pptr<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	wake_up_parent<span style="color: #009900;">(</span>tsk<span style="color: #339933;">-&gt;</span>p_pptr<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p><span style="font-family: 'AR PL UKai CN';">这个函数中使用</span><span style="font-family: 'AR PL UKai CN';">send_sig_info()</span><span style="font-family: 'AR PL UKai CN';">来给父进程发送信号（在</span><span style="font-family: 'AR PL UKai CN';">exit_notify()</span><span style="font-family: 'AR PL UKai CN';">中下面将</span><span style="font-family: 'AR PL UKai CN';">p_pptr</span><span style="font-family: 'AR PL UKai CN';">和</span><span style="font-family: 'AR PL UKai CN';">p_opptr</span><span style="font-family: 'AR PL UKai CN';">设置为相同）。然后唤醒父进程。</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">当这个函数返回到</span><span style="font-family: 'AR PL UKai CN';">exit_notify()</span><span style="font-family: 'AR PL UKai CN';">之后就不断的进行解链，就是将进程之间的连接解除，并且释放</span><span style="font-family: 'AR PL UKai CN';">tty</span><span style="font-family: 'AR PL UKai CN';">等。</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">从</span><span style="font-family: 'AR PL UKai CN';">exit_notify()</span><span style="font-family: 'AR PL UKai CN';">返回之后就进行进程调度</span><span style="font-family: 'AR PL UKai CN';">schedule()</span><span style="font-family: 'AR PL UKai CN';">，所以</span><span style="font-family: 'AR PL UKai CN';">do_exit()</span><span style="font-family: 'AR PL UKai CN';">不返回。</span></p> 
         <h2>2<span style="font-family: 'DejaVu Sans';">、进程等待</span></h2> 
         <p><span style="font-family: 'AR PL UKai CN';">wait4()</span><span style="font-family: 'AR PL UKai CN';">系统调用在内核中的入口是</span><span style="font-family: 'AR PL UKai CN';">sys_wait4()</span><span style="font-family: 'AR PL UKai CN';">在</span><span style="font-family: 'AR PL UKai CN';">exit.c</span><span style="font-family: 'AR PL UKai CN';">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=649&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p64910"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
</pre></td> 
             <td class="code" id="p649code10"><pre class="c" style="font-family:monospace;">asmlinkage <span style="color: #993333;">long</span> sys_wait4<span style="color: #009900;">(</span>pid_t pid<span style="color: #339933;">,</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> <span style="color: #339933;">*</span> stat_addr<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> options<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> rusage <span style="color: #339933;">*</span> ru<span style="color: #009900;">)</span> 
<span style="color: #009900;">{</span> 
	<span style="color: #993333;">int</span> flag<span style="color: #339933;">,</span> retval<span style="color: #339933;">;</span> 
	DECLARE_WAITQUEUE<span style="color: #009900;">(</span>wait<span style="color: #339933;">,</span> current<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #993333;">struct</span> task_struct <span style="color: #339933;">*</span>tsk<span style="color: #339933;">;</span> 
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>options <span style="color: #339933;">&amp;</span> ~<span style="color: #009900;">(</span>WNOHANG<span style="color: #339933;">|</span>WUNTRACED<span style="color: #339933;">|</span>__WNOTHREAD<span style="color: #339933;">|</span>__WCLONE<span style="color: #339933;">|</span>__WALL<span style="color: #009900;">)</span><span style="color: #009900;">)</span> 
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EINVAL<span style="color: #339933;">;</span> 
&nbsp;
	add_wait_queue<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>current<span style="color: #339933;">-&gt;</span>wait_chldexit<span style="color: #339933;">,&amp;</span>wait<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
repeat<span style="color: #339933;">:</span> 
	flag <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> 
	current<span style="color: #339933;">-&gt;</span>state <span style="color: #339933;">=</span> TASK_INTERRUPTIBLE<span style="color: #339933;">;</span> 
	read_lock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tasklist_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	tsk <span style="color: #339933;">=</span> current<span style="color: #339933;">;</span> 
	<span style="color: #b1b100;">do</span> <span style="color: #009900;">{</span> 
		<span style="color: #993333;">struct</span> task_struct <span style="color: #339933;">*</span>p<span style="color: #339933;">;</span> 
	 	<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>p <span style="color: #339933;">=</span> tsk<span style="color: #339933;">-&gt;</span>p_cptr <span style="color: #339933;">;</span> p <span style="color: #339933;">;</span> p <span style="color: #339933;">=</span> p<span style="color: #339933;">-&gt;</span>p_osptr<span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>pid<span style="color: #339933;">&gt;</span><span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>pid <span style="color: #339933;">!=</span> pid<span style="color: #009900;">)</span> 
					<span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span> 
			<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>pid<span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>pgrp <span style="color: #339933;">!=</span> current<span style="color: #339933;">-&gt;</span>pgrp<span style="color: #009900;">)</span> 
					<span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span> 
			<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>pid <span style="color: #339933;">!=</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>pgrp <span style="color: #339933;">!=</span> <span style="color: #339933;">-</span>pid<span style="color: #009900;">)</span> 
					<span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span> 
			<span style="color: #009900;">}</span> 
			<span style="color: #808080; font-style: italic;">/* Wait for all children (clone and not) if __WALL is set; 
			 * otherwise, wait for clone children *only* if __WCLONE is 
			 * set; otherwise, wait for non-clone children *only*.  (Note: 
			 * A "clone" child here is one that reports to its parent 
			 * using a signal other than SIGCHLD.) */</span> 
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>exit_signal <span style="color: #339933;">!=</span> SIGCHLD<span style="color: #009900;">)</span> <span style="color: #339933;">^</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>options <span style="color: #339933;">&amp;</span> __WCLONE<span style="color: #009900;">)</span> <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> 
			    <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span><span style="color: #009900;">(</span>options <span style="color: #339933;">&amp;</span> __WALL<span style="color: #009900;">)</span><span style="color: #009900;">)</span> 
				<span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span> 
			flag <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span> 
			<span style="color: #b1b100;">switch</span> <span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>state<span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
			<span style="color: #b1b100;">case</span> TASK_STOPPED<span style="color: #339933;">:</span> 
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>p<span style="color: #339933;">-&gt;</span>exit_code<span style="color: #009900;">)</span> 
					<span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span> 
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span><span style="color: #009900;">(</span>options <span style="color: #339933;">&amp;</span> WUNTRACED<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span><span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>ptrace <span style="color: #339933;">&amp;</span> PT_PTRACED<span style="color: #009900;">)</span><span style="color: #009900;">)</span> 
					<span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span> 
				read_unlock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tasklist_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
				retval <span style="color: #339933;">=</span> ru <span style="color: #339933;">?</span> getrusage<span style="color: #009900;">(</span>p<span style="color: #339933;">,</span> RUSAGE_BOTH<span style="color: #339933;">,</span> ru<span style="color: #009900;">)</span> <span style="color: #339933;">:</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> 
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>retval <span style="color: #339933;">&amp;&amp;</span> stat_addr<span style="color: #009900;">)</span> 
					retval <span style="color: #339933;">=</span> put_user<span style="color: #009900;">(</span><span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>exit_code <span style="color: #339933;">&lt;&lt;</span> <span style="color: #0000dd;">8</span><span style="color: #009900;">)</span> <span style="color: #339933;">|</span> <span style="color: #208080;">0x7f</span><span style="color: #339933;">,</span> stat_addr<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>retval<span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
					p<span style="color: #339933;">-&gt;</span>exit_code <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> 
					retval <span style="color: #339933;">=</span> p<span style="color: #339933;">-&gt;</span>pid<span style="color: #339933;">;</span> 
				<span style="color: #009900;">}</span> 
				<span style="color: #b1b100;">goto</span> end_wait4<span style="color: #339933;">;</span> 
			<span style="color: #b1b100;">case</span> TASK_ZOMBIE<span style="color: #339933;">:</span> 
				current<span style="color: #339933;">-&gt;</span>times.<span style="color: #202020;">tms_cutime</span> <span style="color: #339933;">+=</span> p<span style="color: #339933;">-&gt;</span>times.<span style="color: #202020;">tms_utime</span> <span style="color: #339933;">+</span> p<span style="color: #339933;">-&gt;</span>times.<span style="color: #202020;">tms_cutime</span><span style="color: #339933;">;</span> 
				current<span style="color: #339933;">-&gt;</span>times.<span style="color: #202020;">tms_cstime</span> <span style="color: #339933;">+=</span> p<span style="color: #339933;">-&gt;</span>times.<span style="color: #202020;">tms_stime</span> <span style="color: #339933;">+</span> p<span style="color: #339933;">-&gt;</span>times.<span style="color: #202020;">tms_cstime</span><span style="color: #339933;">;</span> 
				read_unlock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tasklist_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
				retval <span style="color: #339933;">=</span> ru <span style="color: #339933;">?</span> getrusage<span style="color: #009900;">(</span>p<span style="color: #339933;">,</span> RUSAGE_BOTH<span style="color: #339933;">,</span> ru<span style="color: #009900;">)</span> <span style="color: #339933;">:</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> 
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>retval <span style="color: #339933;">&amp;&amp;</span> stat_addr<span style="color: #009900;">)</span> 
					retval <span style="color: #339933;">=</span> put_user<span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>exit_code<span style="color: #339933;">,</span> stat_addr<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>retval<span style="color: #009900;">)</span> 
					<span style="color: #b1b100;">goto</span> end_wait4<span style="color: #339933;">;</span> 
				retval <span style="color: #339933;">=</span> p<span style="color: #339933;">-&gt;</span>pid<span style="color: #339933;">;</span> 
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>p_opptr <span style="color: #339933;">!=</span> p<span style="color: #339933;">-&gt;</span>p_pptr<span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
					write_lock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tasklist_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
					REMOVE_LINKS<span style="color: #009900;">(</span>p<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
					p<span style="color: #339933;">-&gt;</span>p_pptr <span style="color: #339933;">=</span> p<span style="color: #339933;">-&gt;</span>p_opptr<span style="color: #339933;">;</span> 
					SET_LINKS<span style="color: #009900;">(</span>p<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
					do_notify_parent<span style="color: #009900;">(</span>p<span style="color: #339933;">,</span> SIGCHLD<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
					write_unlock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tasklist_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
				<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> 
					release_task<span style="color: #009900;">(</span>p<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
				<span style="color: #b1b100;">goto</span> end_wait4<span style="color: #339933;">;</span> 
			<span style="color: #b1b100;">default</span><span style="color: #339933;">:</span> 
				<span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span> 
			<span style="color: #009900;">}</span> 
		<span style="color: #009900;">}</span> 
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>options <span style="color: #339933;">&amp;</span> __WNOTHREAD<span style="color: #009900;">)</span> 
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span> 
		tsk <span style="color: #339933;">=</span> next_thread<span style="color: #009900;">(</span>tsk<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>tsk <span style="color: #339933;">!=</span> current<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	read_unlock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tasklist_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>flag<span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
		retval <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> 
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>options <span style="color: #339933;">&amp;</span> WNOHANG<span style="color: #009900;">)</span> 
			<span style="color: #b1b100;">goto</span> end_wait4<span style="color: #339933;">;</span> 
		retval <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ERESTARTSYS<span style="color: #339933;">;</span> 
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>signal_pending<span style="color: #009900;">(</span>current<span style="color: #009900;">)</span><span style="color: #009900;">)</span> 
			<span style="color: #b1b100;">goto</span> end_wait4<span style="color: #339933;">;</span> 
		schedule<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		<span style="color: #b1b100;">goto</span> repeat<span style="color: #339933;">;</span> 
	<span style="color: #009900;">}</span> 
	retval <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ECHILD<span style="color: #339933;">;</span> 
end_wait4<span style="color: #339933;">:</span> 
	current<span style="color: #339933;">-&gt;</span>state <span style="color: #339933;">=</span> TASK_RUNNING<span style="color: #339933;">;</span> 
	remove_wait_queue<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>current<span style="color: #339933;">-&gt;</span>wait_chldexit<span style="color: #339933;">,&amp;</span>wait<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #b1b100;">return</span> retval<span style="color: #339933;">;</span> 
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p><span style="font-family: 'AR PL UKai CN';">其中，传入参数</span><span style="font-family: 'AR PL UKai CN';">pid</span><span style="font-family: 'AR PL UKai CN';">是某一个子进程的</span><span style="font-family: 'AR PL UKai CN';">pid</span><span style="font-family: 'AR PL UKai CN';">，在开头使用</span><span style="font-family: 'AR PL UKai CN';">DECLARE_WAITQUEUE()</span><span style="font-family: 'AR PL UKai CN';">来在当前进程的系统堆栈上分配一个</span><span style="font-family: 'AR PL UKai CN';">wait_queue_t</span><span style="font-family: 'AR PL UKai CN';">数据结构，这个数据结构及其操作定义在</span><span style="font-family: 'AR PL UKai CN';">include/linux/wait.h</span><span style="font-family: 'AR PL UKai CN';">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=649&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p64911"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td> 
             <td class="code" id="p649code11"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> __wait_queue <span style="color: #009900;">{</span> 
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> flags<span style="color: #339933;">;</span> 
<span style="color: #339933;">#define WQ_FLAG_EXCLUSIVE	0x01 </span>
	<span style="color: #993333;">struct</span> task_struct <span style="color: #339933;">*</span> task<span style="color: #339933;">;</span> 
	<span style="color: #993333;">struct</span> list_head task_list<span style="color: #339933;">;</span> 
<span style="color: #339933;">#if WAITQUEUE_DEBUG </span>
	<span style="color: #993333;">long</span> __magic<span style="color: #339933;">;</span> 
	<span style="color: #993333;">long</span> __waker<span style="color: #339933;">;</span> 
<span style="color: #339933;">#endif </span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span> 
<span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span> __wait_queue wait_queue_t<span style="color: #339933;">;</span>
&nbsp;
<span style="color: #993333;">struct</span> __wait_queue_head <span style="color: #009900;">{</span> 
	wq_lock_t lock<span style="color: #339933;">;</span> 
	<span style="color: #993333;">struct</span> list_head task_list<span style="color: #339933;">;</span> 
<span style="color: #339933;">#if WAITQUEUE_DEBUG </span>
	<span style="color: #993333;">long</span> __magic<span style="color: #339933;">;</span> 
	<span style="color: #993333;">long</span> __creator<span style="color: #339933;">;</span> 
<span style="color: #339933;">#endif </span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span> 
<span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span> __wait_queue_head wait_queue_head_t<span style="color: #339933;">;</span> 
&nbsp;
<span style="color: #339933;">#if WAITQUEUE_DEBUG </span>
<span style="color: #339933;"># define __WAITQUEUE_DEBUG_INIT(name) \ </span>
		<span style="color: #339933;">,</span> <span style="color: #009900;">(</span><span style="color: #993333;">long</span><span style="color: #009900;">)</span><span style="color: #339933;">&amp;</span><span style="color: #009900;">(</span>name<span style="color: #009900;">)</span>.__magic<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span> 
<span style="color: #339933;"># define __WAITQUEUE_HEAD_DEBUG_INIT(name) \ </span>
		<span style="color: #339933;">,</span> <span style="color: #009900;">(</span><span style="color: #993333;">long</span><span style="color: #009900;">)</span><span style="color: #339933;">&amp;</span><span style="color: #009900;">(</span>name<span style="color: #009900;">)</span>.__magic<span style="color: #339933;">,</span> <span style="color: #009900;">(</span><span style="color: #993333;">long</span><span style="color: #009900;">)</span><span style="color: #339933;">&amp;</span><span style="color: #009900;">(</span>name<span style="color: #009900;">)</span>.__magic 
<span style="color: #339933;">#else </span>
<span style="color: #339933;"># define __WAITQUEUE_DEBUG_INIT(name) </span>
<span style="color: #339933;"># define __WAITQUEUE_HEAD_DEBUG_INIT(name) </span>
<span style="color: #339933;">#endif </span>
&nbsp;
<span style="color: #339933;">#define __WAITQUEUE_INITIALIZER(name,task) \ </span>
	<span style="color: #009900;">{</span> <span style="color: #208080;">0x0</span><span style="color: #339933;">,</span> task<span style="color: #339933;">,</span> <span style="color: #009900;">{</span> NULL<span style="color: #339933;">,</span> NULL <span style="color: #009900;">}</span> __WAITQUEUE_DEBUG_INIT<span style="color: #009900;">(</span>name<span style="color: #009900;">)</span><span style="color: #009900;">}</span> 
<span style="color: #339933;">#define DECLARE_WAITQUEUE(name,task) \ </span>
	wait_queue_t name <span style="color: #339933;">=</span> __WAITQUEUE_INITIALIZER<span style="color: #009900;">(</span>name<span style="color: #339933;">,</span>task<span style="color: #009900;">)</span> 
&nbsp;
<span style="color: #339933;">#define __WAIT_QUEUE_HEAD_INITIALIZER(name) \ </span>
<span style="color: #009900;">{</span> WAITQUEUE_RW_LOCK_UNLOCKED<span style="color: #339933;">,</span> <span style="color: #009900;">{</span> <span style="color: #339933;">&amp;</span><span style="color: #009900;">(</span>name<span style="color: #009900;">)</span>.<span style="color: #202020;">task_list</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span><span style="color: #009900;">(</span>name<span style="color: #009900;">)</span>.<span style="color: #202020;">task_list</span> <span style="color: #009900;">}</span> \ 
		__WAITQUEUE_HEAD_DEBUG_INIT<span style="color: #009900;">(</span>name<span style="color: #009900;">)</span><span style="color: #009900;">}</span> 
&nbsp;
<span style="color: #339933;">#define DECLARE_WAIT_QUEUE_HEAD(name) \ </span>
	wait_queue_head_t name <span style="color: #339933;">=</span> __WAIT_QUEUE_HEAD_INITIALIZER<span style="color: #009900;">(</span>name<span style="color: #009900;">)</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p><span style="font-family: 'AR PL UKai CN';">wait_queue_head_t</span><span style="font-family: 'AR PL UKai CN';">数据结构是一个进程需要等待的进程队列的头部，在</span><span style="font-family: 'AR PL UKai CN';">task_struct</span><span style="font-family: 'AR PL UKai CN';">中的</span><span style="font-family: 'AR PL UKai CN';">wait_chldexit</span><span style="font-family: 'AR PL UKai CN';">就是此类型。</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">然后通过</span><span style="font-family: 'AR PL UKai CN';">add_wait_queue()</span><span style="font-family: 'AR PL UKai CN';">将刚刚建立的</span><span style="font-family: 'AR PL UKai CN';">wait_queue_t</span><span style="font-family: 'AR PL UKai CN';">加入到进程的</span><span style="font-family: 'AR PL UKai CN';">wait_queue_head_t</span><span style="font-family: 'AR PL UKai CN';">中（</span><span style="font-family: 'AR PL UKai CN';">wait_chldexit</span><span style="font-family: 'AR PL UKai CN';">）。</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">接下来就是不断循环检测子进程是否为需要等待的进程。检测到以后检测子进程的状态，然后就是不断循环直到满足下列条件之一才结束：</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">1</span><span style="font-family: 'AR PL UKai CN';">、所等待子进程状态变成</span><span style="font-family: 'AR PL UKai CN';">TASK_STOPPED</span><span style="font-family: 'AR PL UKai CN';">或者</span><span style="font-family: 'AR PL UKai CN';">TASK_ZOMBIE</span><span style="font-family: 'AR PL UKai CN';">。</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">2</span><span style="font-family: 'AR PL UKai CN';">、所等待子进程不存在或者不是其子进程。</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">3</span><span style="font-family: 'AR PL UKai CN';">、所等待子进程存在，并且不在上面两个状态，而调用参数</span><span style="font-family: 'AR PL UKai CN';">options</span><span style="font-family: 'AR PL UKai CN';">中的</span><span style="font-family: 'AR PL UKai CN';">WNOHANG</span><span style="font-family: 'AR PL UKai CN';">标志位为</span><span style="font-family: 'AR PL UKai CN';">1</span><span style="font-family: 'AR PL UKai CN';">，或者进程收到了其他信号。</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">否则的话进程将自身设置为</span><span style="font-family: 'AR PL UKai CN';">TASK_INTERRUPTIBLE</span><span style="font-family: 'AR PL UKai CN';">并调用</span><span style="font-family: 'AR PL UKai CN';">schedule()</span><span style="font-family: 'AR PL UKai CN';">让自身睡眠，等待唤醒。</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">需要说明的是，当子进程</span><span style="font-family: 'AR PL UKai CN';">exit</span><span style="font-family: 'AR PL UKai CN';">时唤醒父进程，那么父进程就转到</span><span style="font-family: 'AR PL UKai CN';">repeat</span><span style="font-family: 'AR PL UKai CN';">处再次扫描子进程，然后扫描到</span><span style="font-family: 'AR PL UKai CN';">TASK_ZOMBIE</span><span style="font-family: 'AR PL UKai CN';">就使用</span><span style="font-family: 'AR PL UKai CN';">release_task()</span><span style="font-family: 'AR PL UKai CN';">释放子进程，函数在</span><span style="font-family: 'AR PL UKai CN';">exit.c</span><span style="font-family: 'AR PL UKai CN';">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=649&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p64912"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td> 
             <td class="code" id="p649code12"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">void</span> release_task<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> task_struct <span style="color: #339933;">*</span> p<span style="color: #009900;">)</span> 
<span style="color: #009900;">{</span> 
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>p <span style="color: #339933;">!=</span> current<span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
<span style="color: #339933;">#ifdef CONFIG_SMP </span>
		<span style="color: #808080; font-style: italic;">/* 
		 * Wait to make sure the process isn't on the 
		 * runqueue (active on some other CPU still) 
		 */</span> 
		<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span><span style="color: #339933;">;;</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span> 
			task_lock<span style="color: #009900;">(</span>p<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>p<span style="color: #339933;">-&gt;</span>has_cpu<span style="color: #009900;">)</span> 
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span> 
			task_unlock<span style="color: #009900;">(</span>p<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
			<span style="color: #b1b100;">do</span> <span style="color: #009900;">{</span> 
				barrier<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
			<span style="color: #009900;">}</span> <span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>has_cpu<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		<span style="color: #009900;">}</span> 
		task_unlock<span style="color: #009900;">(</span>p<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
<span style="color: #339933;">#endif </span>
		atomic_dec<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>p<span style="color: #339933;">-&gt;</span>user<span style="color: #339933;">-&gt;</span>processes<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		free_uid<span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>user<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		unhash_process<span style="color: #009900;">(</span>p<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
&nbsp;
		release_thread<span style="color: #009900;">(</span>p<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
		current<span style="color: #339933;">-&gt;</span>cmin_flt <span style="color: #339933;">+=</span> p<span style="color: #339933;">-&gt;</span>min_flt <span style="color: #339933;">+</span> p<span style="color: #339933;">-&gt;</span>cmin_flt<span style="color: #339933;">;</span> 
		current<span style="color: #339933;">-&gt;</span>cmaj_flt <span style="color: #339933;">+=</span> p<span style="color: #339933;">-&gt;</span>maj_flt <span style="color: #339933;">+</span> p<span style="color: #339933;">-&gt;</span>cmaj_flt<span style="color: #339933;">;</span> 
		current<span style="color: #339933;">-&gt;</span>cnswap <span style="color: #339933;">+=</span> p<span style="color: #339933;">-&gt;</span>nswap <span style="color: #339933;">+</span> p<span style="color: #339933;">-&gt;</span>cnswap<span style="color: #339933;">;</span> 
		<span style="color: #808080; font-style: italic;">/* 
		 * Potentially available timeslices are retrieved 
		 * here - this way the parent does not get penalized 
		 * for creating too many processes. 
		 * 
		 * (this cannot be used to artificially 'generate' 
		 * timeslices, because any timeslice recovered here 
		 * was given away by the parent in the first place.) 
		 */</span> 
		current<span style="color: #339933;">-&gt;</span>counter <span style="color: #339933;">+=</span> p<span style="color: #339933;">-&gt;</span>counter<span style="color: #339933;">;</span> 
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>counter <span style="color: #339933;">&gt;=</span> MAX_COUNTER<span style="color: #009900;">)</span> 
			current<span style="color: #339933;">-&gt;</span>counter <span style="color: #339933;">=</span> MAX_COUNTER<span style="color: #339933;">;</span> 
		free_task_struct<span style="color: #009900;">(</span>p<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span> 
		printk<span style="color: #009900;">(</span><span style="color: #ff0000;">"task releasing itself<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #009900;">}</span> 
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p><span style="font-family: 'AR PL UKai CN';">函数比较简单，不多说了。</span></p> 
         <p>&nbsp;</p> 
         <p><span style="font-family: 'AR PL UKai CN';">历经大约一个星期，终于把自己电脑配置完成并且把</span><span style="font-family: 'AR PL UKai CN';">LFS</span><span style="font-family: 'AR PL UKai CN';">编译完成，兴奋中</span><span style="font-family: 'AR PL UKai CN';">…</span></p> 
         <p><span style="font-family: 'AR PL UKai CN';">The End.</span></p> 
        </div>
       </div>
       <!-- .entry-content --> 
       <!-- .entry-meta --> 
      </article>
      <!-- #post-649 --> 
      <!-- #comments --> 
     </div>
     <!-- #content --> 
    </div>
    <!-- #primary --> 
    <!-- #secondary .widget-area --> 
   </div>
   <!-- #main --> 
   <!-- #colophon --> 
  </div>
  <!-- #page -->   
  <!-- JiaThis Button BEGIN -->  
  <!-- JiaThis Button END -->   
 </body>
</html>