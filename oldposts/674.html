<!doctype html>
<!--[if IE 6]>
<html id="ie6" lang="zh-CN">
<![endif]-->
<!--[if IE 7]>
<html id="ie7" lang="zh-CN">
<![endif]-->
<!--[if IE 8]>
<html id="ie8" lang="zh-CN">
<![endif]-->
<!--[if !(IE 6) | !(IE 7) | !(IE 8)  ]><!-->
<html lang="zh-CN">
 <!--<![endif]-->
 <head>      
  <link rel="stylesheet" type="text/css" media="all" href="stylesheets/style.css">     
  <link rel="stylesheet" id="codebox-css" href="stylesheets/codebox.css" type="text/css" media="screen">             
 </head> 
 <body class="single single-post postid-674 single-format-standard content-sidebar"> 
  <div id="page" class="hfeed"> 
   <header id="branding" role="banner"> 
    <hgroup> 
     <h1 id="site-title"><span><a href="http://codelifeliwan.github.io/" title="Code_Life_LiWan" rel="home">Code_Life_LiWan</a></span></h1> 
     <h2 id="site-description">My heart will go on and on…</h2> 
    </hgroup>  
    <!-- #access --> 
   </header>
   <!-- #branding --> 
   <div id="main" class="clearfix"> 
    <div id="primary"> 
     <div id="content" role="main"> 
      <!-- #nav-single --> 
      <article id="post-674" class="post-674 post type-post status-publish format-standard hentry category-linux_kernel_source_code_notes"> 
       <header class="entry-header"> 
        <h1 class="entry-title">Linux内核-文件系统（一、文件系统概述）</h1> 
        <div class="entry-meta"> 
         <span class="sep">Posted on </span>
         <a href="http://codelifeliwan.github.io/?p=674" title="下午 3:34" rel="bookmark"><time class="entry-date" datetime="2012-10-24T15:34:17+00:00" pubdate>24 十月, 2012</time></a>
         <span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codelifeliwan.github.io/?author=1" title="View all posts by wanli" rel="author">wanli</a></span></span> 
         <span class="sep"> — </span> 
         <span class="comments-link"> <a href="http://codelifeliwan.github.io/?p=674#respond" title="Comment on Linux内核-文件系统（一、文件系统概述）">No Comments ↓</a> </span> 
        </div>
        <!-- .entry-meta --> 
       </header>
       <!-- .entry-header --> 
       <div class="entry-content">
        <div class="entry-content"> 
         <p><span style="font-family: 'DejaVu Sans';">结束了进程管理，下面是文件系统，文件系统比较多，两个星期可能看不完 </span><img src="http://codelifeliwan.github.io/wp-includes/images/smilies/icon_sad.gif" alt=":-(" class="wp-smiley"></p> 
         <p><span style="font-family: 'DejaVu Sans';">文件系统概述这一节非常重要。</span></p> 
         <p><span style="font-family: 'DejaVu Sans';">本章讲的是文件系统的实现细节，当然目前的文件系统已经发展到</span>Ext4<span style="font-family: 'DejaVu Sans';">了，而在</span>Linux2.4<span style="font-family: 'DejaVu Sans';">中仍然是</span>Ext2<span style="font-family: 'DejaVu Sans';">的文件系统，总体上大同小异，</span>Ext2<span style="font-family: 'DejaVu Sans';">懂了，看</span>Ext3<span style="font-family: 'DejaVu Sans';">和</span>Ext4<span style="font-family: 'DejaVu Sans';">也就没啥障碍了。</span></p> 
         <h2><span style="font-family: 'DejaVu Sans';">一、总体概揽</span></h2> 
         <p>Linux<span style="font-family: 'DejaVu Sans';">效仿了传统</span>UNIX<span style="font-family: 'DejaVu Sans';">但并不是抄袭，在</span>Linux<span style="font-family: 'DejaVu Sans';">中几乎把所有设备等全部看成文件，把不同的文件系统等统一化，使用相同的系统调用等来进行操作，也就是对于一般程序员来说，根本就不必管这些东西，只要调用通用的系统调用即可。</span></p> 
         <p><span style="font-family: 'DejaVu Sans';">真正将不同的文件系统等区分开来的是在底层，使用统一的“操作跳转接口”来对不同的文件进行不同的操作。</span></p> 
         <p><span style="font-family: 'DejaVu Sans';">比如一个非常通用的跳转接口就是文件的操作接口</span>file_operations<span style="font-family: 'DejaVu Sans';">，定义在</span>include/linux/fs.h<span style="font-family: 'DejaVu Sans';">中：</span></p> 
         <div class="wp_codebox_msgheader wp_codebox_hide"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left"><a href="javascript:;" onclick="javascript:showCodeTxt('p674code1'); return false;">View Code</a> C</span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6741"> 
             <td class="code" id="p674code1"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> file_operations <span style="color: #009900;">{</span> 
	<span style="color: #993333;">struct</span> module <span style="color: #339933;">*</span>owner<span style="color: #339933;">;</span> 
	loff_t <span style="color: #009900;">(</span><span style="color: #339933;">*</span>llseek<span style="color: #009900;">)</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> file <span style="color: #339933;">*,</span> loff_t<span style="color: #339933;">,</span> <span style="color: #993333;">int</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	ssize_t <span style="color: #009900;">(</span><span style="color: #339933;">*</span>read<span style="color: #009900;">)</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> file <span style="color: #339933;">*,</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*,</span> size_t<span style="color: #339933;">,</span> loff_t <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	ssize_t <span style="color: #009900;">(</span><span style="color: #339933;">*</span>write<span style="color: #009900;">)</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> file <span style="color: #339933;">*,</span> <span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*,</span> size_t<span style="color: #339933;">,</span> loff_t <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #993333;">int</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>readdir<span style="color: #009900;">)</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> file <span style="color: #339933;">*,</span> <span style="color: #993333;">void</span> <span style="color: #339933;">*,</span> filldir_t<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>poll<span style="color: #009900;">)</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> file <span style="color: #339933;">*,</span> <span style="color: #993333;">struct</span> poll_table_struct <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #993333;">int</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>ioctl<span style="color: #009900;">)</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> inode <span style="color: #339933;">*,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span><span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #993333;">int</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>mmap<span style="color: #009900;">)</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> file <span style="color: #339933;">*,</span> <span style="color: #993333;">struct</span> vm_area_struct <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #993333;">int</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>open<span style="color: #009900;">)</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> inode <span style="color: #339933;">*,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #993333;">int</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>flush<span style="color: #009900;">)</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #993333;">int</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>release<span style="color: #009900;">)</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> inode <span style="color: #339933;">*,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #993333;">int</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>fsync<span style="color: #009900;">)</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> file <span style="color: #339933;">*,</span> <span style="color: #993333;">struct</span> dentry <span style="color: #339933;">*,</span> <span style="color: #993333;">int</span> datasync<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #993333;">int</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>fasync<span style="color: #009900;">)</span> <span style="color: #009900;">(</span><span style="color: #993333;">int</span><span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*,</span> <span style="color: #993333;">int</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	<span style="color: #993333;">int</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>lock<span style="color: #009900;">)</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> file <span style="color: #339933;">*,</span> <span style="color: #993333;">int</span><span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> file_lock <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	ssize_t <span style="color: #009900;">(</span><span style="color: #339933;">*</span>readv<span style="color: #009900;">)</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> file <span style="color: #339933;">*,</span> <span style="color: #993333;">const</span> <span style="color: #993333;">struct</span> iovec <span style="color: #339933;">*,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #339933;">,</span> loff_t <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
	ssize_t <span style="color: #009900;">(</span><span style="color: #339933;">*</span>writev<span style="color: #009900;">)</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> file <span style="color: #339933;">*,</span> <span style="color: #993333;">const</span> <span style="color: #993333;">struct</span> iovec <span style="color: #339933;">*,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #339933;">,</span> loff_t <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p><span style="font-family: 'DejaVu Sans';">对于每种文件系统，</span>file_operations<span style="font-family: 'DejaVu Sans';">结构是这种文件系统总所有文件等共用的，来定义对此文件系统文件等的一系列操作，当然除了</span>file_operations<span style="font-family: 'DejaVu Sans';">以外还有其他的跳转接口，到以后再介绍。</span></p> 
         <p><span style="font-family: 'DejaVu Sans';">总体来说是分下面几层的：</span><br> <a href="uploads/2012/10/1.png"><img class="aligncenter size-full wp-image-675" title="1" src="uploads/2012/10/1.png" alt="" width="544" height="420"></a><br> <span style="font-family: 'DejaVu Sans';">二、内存模块</span></p> 
         <p><span style="font-family: 'DejaVu Sans';">在内存里面，有着文件系统的相关信息，主要有两个，一个是</span>inode<span style="font-family: 'DejaVu Sans';">，一个是</span>dentry<span style="font-family: 'DejaVu Sans';">。其中这两个信息描述的侧重点不一样，</span>inode<span style="font-family: 'DejaVu Sans';">是侧重于物理信息，</span>dentry<span style="font-family: 'DejaVu Sans';">是侧重于逻辑信息。为什么会有这样的区分呢？因为</span>inode<span style="font-family: 'DejaVu Sans';">可以表示一个文件在磁盘的什么位置，这个位置是唯一的，但是一个文件的文件名不是唯一的，比如在与此文件不同的目录下建立一个此文件的链接，那么无论是链接还是本文件所指的文件都是同一个，在物理上统一，但是在逻辑上不统一，新建的链接有着新的文件名等信息，在不同进程中打开也不同。一个文件只有一个</span>inode<span style="font-family: 'DejaVu Sans';">结构，但是可以有多个</span>dentry<span style="font-family: 'DejaVu Sans';">结构，所以它们是一对多的关系。</span></p> 
         <p><span style="font-family: 'DejaVu Sans';">其中，</span>inode<span style="font-family: 'DejaVu Sans';">数据结构定义在</span>include/linux/fs.h<span style="font-family: 'DejaVu Sans';">中：</span></p> 
         <div class="wp_codebox_msgheader wp_codebox_hide"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left"><a href="javascript:;" onclick="javascript:showCodeTxt('p674code2'); return false;">View Code</a> C</span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6742"> 
             <td class="code" id="p674code2"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> inode <span style="color: #009900;">{</span> 
	<span style="color: #993333;">struct</span> list_head	i_hash<span style="color: #339933;">;</span> 
	<span style="color: #993333;">struct</span> list_head	i_list<span style="color: #339933;">;</span> 
	<span style="color: #993333;">struct</span> list_head	i_dentry<span style="color: #339933;">;</span> 	<span style="color: #666666; font-style: italic;">//构成其dentry结构队列</span>
&nbsp;
	<span style="color: #993333;">struct</span> list_head	i_dirty_buffers<span style="color: #339933;">;</span> 
&nbsp;
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span>		i_ino<span style="color: #339933;">;</span> 	<span style="color: #666666; font-style: italic;">//唯一的节点号</span>
	atomic_t		i_count<span style="color: #339933;">;</span> 		<span style="color: #666666; font-style: italic;">//此节点的共享计数</span>
	kdev_t			i_dev<span style="color: #339933;">;</span> 	<span style="color: #666666; font-style: italic;">//除特殊文件外，一个索引节点所在的设备</span>
	umode_t			i_mode<span style="color: #339933;">;</span> 
	nlink_t			i_nlink<span style="color: #339933;">;</span> 	<span style="color: #666666; font-style: italic;">//文件链接数目</span>
	uid_t			i_uid<span style="color: #339933;">;</span> 	<span style="color: #666666; font-style: italic;">//用户号，与i_gid一起指明文件主</span>
	gid_t			i_gid<span style="color: #339933;">;</span> 	<span style="color: #666666; font-style: italic;">//用户组号</span>
	kdev_t			i_rdev<span style="color: #339933;">;</span> 	<span style="color: #666666; font-style: italic;">//若节点本身代表设备，此为设备号</span>
	loff_t			i_size<span style="color: #339933;">;</span> 	<span style="color: #666666; font-style: italic;">//对有数据的文件，代表当前数据大小</span>
	time_t			i_atime<span style="color: #339933;">;</span> 	<span style="color: #666666; font-style: italic;">//最后一次访问该文件时间</span>
	time_t			i_mtime<span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">//最后一次修改该文件时间</span>
	time_t			i_ctime<span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">//文件创建时间</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span>		i_blksize<span style="color: #339933;">;</span> 
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span>		i_blocks<span style="color: #339933;">;</span> 
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span>		i_version<span style="color: #339933;">;</span> 
	<span style="color: #993333;">struct</span> semaphore	i_sem<span style="color: #339933;">;</span> 
	<span style="color: #993333;">struct</span> semaphore	i_zombie<span style="color: #339933;">;</span> 
	<span style="color: #993333;">struct</span> inode_operations	<span style="color: #339933;">*</span>i_op<span style="color: #339933;">;</span> 	<span style="color: #666666; font-style: italic;">//指向节点操作接口</span>
	<span style="color: #993333;">struct</span> file_operations	<span style="color: #339933;">*</span>i_fop<span style="color: #339933;">;</span>		<span style="color: #666666; font-style: italic;">//指向file_operations操作接口</span>
	<span style="color: #993333;">struct</span> super_block	<span style="color: #339933;">*</span>i_sb<span style="color: #339933;">;</span> 
	wait_queue_head_t	i_wait<span style="color: #339933;">;</span> 
	<span style="color: #993333;">struct</span> file_lock	<span style="color: #339933;">*</span>i_flock<span style="color: #339933;">;</span> 
	<span style="color: #993333;">struct</span> address_space	<span style="color: #339933;">*</span>i_mapping<span style="color: #339933;">;</span> 
	<span style="color: #993333;">struct</span> address_space	i_data<span style="color: #339933;">;</span>	 
	<span style="color: #993333;">struct</span> dquot		<span style="color: #339933;">*</span>i_dquot<span style="color: #009900;">[</span>MAXQUOTAS<span style="color: #009900;">]</span><span style="color: #339933;">;</span> 
	<span style="color: #993333;">struct</span> pipe_inode_info	<span style="color: #339933;">*</span>i_pipe<span style="color: #339933;">;</span> 
	<span style="color: #993333;">struct</span> block_device	<span style="color: #339933;">*</span>i_bdev<span style="color: #339933;">;</span> 
&nbsp;
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span>		i_dnotify_mask<span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* Directory notify events */</span> 
	<span style="color: #993333;">struct</span> dnotify_struct	<span style="color: #339933;">*</span>i_dnotify<span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* for directory notifications */</span> 
&nbsp;
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span>		i_state<span style="color: #339933;">;</span> 
&nbsp;
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span>		i_flags<span style="color: #339933;">;</span> 
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span>		i_sock<span style="color: #339933;">;</span> 
&nbsp;
	atomic_t		i_writecount<span style="color: #339933;">;</span> 
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span>		i_attr_flags<span style="color: #339933;">;</span> 
	__u32			i_generation<span style="color: #339933;">;</span> 
	<span style="color: #993333;">union</span> <span style="color: #009900;">{</span> 	<span style="color: #666666; font-style: italic;">//文件系统类型</span>
		<span style="color: #993333;">struct</span> minix_inode_info		minix_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> ext2_inode_info		ext2_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> hpfs_inode_info		hpfs_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> ntfs_inode_info		ntfs_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> msdos_inode_info		msdos_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> umsdos_inode_info	umsdos_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> iso_inode_info		isofs_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> nfs_inode_info		nfs_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> sysv_inode_info		sysv_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> affs_inode_info		affs_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> ufs_inode_info		ufs_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> efs_inode_info		efs_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> romfs_inode_info		romfs_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> shmem_inode_info		shmem_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> coda_inode_info		coda_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> smb_inode_info		smbfs_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> hfs_inode_info		hfs_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> adfs_inode_info		adfs_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> qnx4_inode_info		qnx4_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> bfs_inode_info		bfs_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> udf_inode_info		udf_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> ncp_inode_info		ncpfs_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> proc_inode_info		proc_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> socket			socket_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> usbdev_inode_info        usbdev_i<span style="color: #339933;">;</span> 
		<span style="color: #993333;">void</span>				<span style="color: #339933;">*</span>generic_ip<span style="color: #339933;">;</span> 
	<span style="color: #009900;">}</span> u<span style="color: #339933;">;</span> 
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>dentry<span style="font-family: 'DejaVu Sans';">数据结构是定义在</span>include/linux/dcache.h<span style="font-family: 'DejaVu Sans';">中：</span></p> 
         <div class="wp_codebox_msgheader wp_codebox_hide"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left"><a href="javascript:;" onclick="javascript:showCodeTxt('p674code3'); return false;">View Code</a> C</span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6743"> 
             <td class="code" id="p674code3"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> dentry <span style="color: #009900;">{</span> 
	atomic_t d_count<span style="color: #339933;">;</span> 
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> d_flags<span style="color: #339933;">;</span> 
	<span style="color: #993333;">struct</span> inode  <span style="color: #339933;">*</span> d_inode<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Where the name belongs to - NULL is negative */</span> 
	<span style="color: #993333;">struct</span> dentry <span style="color: #339933;">*</span> d_parent<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* parent directory */</span> 
	<span style="color: #993333;">struct</span> list_head d_vfsmnt<span style="color: #339933;">;</span> 
	<span style="color: #993333;">struct</span> list_head d_hash<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* lookup hash list */</span> 
	<span style="color: #993333;">struct</span> list_head d_lru<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* d_count = 0 LRU list */</span> 
	<span style="color: #993333;">struct</span> list_head d_child<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* child of parent list */</span> 
	<span style="color: #993333;">struct</span> list_head d_subdirs<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* our children */</span> 
	<span style="color: #993333;">struct</span> list_head d_alias<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* inode alias list */</span> 
	<span style="color: #993333;">struct</span> qstr d_name<span style="color: #339933;">;</span> 
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> d_time<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* used by d_revalidate */</span> 
	<span style="color: #993333;">struct</span> dentry_operations  <span style="color: #339933;">*</span>d_op<span style="color: #339933;">;</span> 
	<span style="color: #993333;">struct</span> super_block <span style="color: #339933;">*</span> d_sb<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* The root of the dentry tree */</span> 
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> d_reftime<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* last time referenced */</span> 
	<span style="color: #993333;">void</span> <span style="color: #339933;">*</span> d_fsdata<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* fs-specific data */</span> 
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> d_iname<span style="color: #009900;">[</span>DNAME_INLINE_LEN<span style="color: #009900;">]</span><span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* small names */</span> 
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p><span style="font-family: 'DejaVu Sans';">这里可以看到</span>dentry<span style="font-family: 'DejaVu Sans';">结构里面有个</span>inode<span style="font-family: 'DejaVu Sans';">结构</span>d_inode<span style="font-family: 'DejaVu Sans';">，指向真正的</span>inode<span style="font-family: 'DejaVu Sans';">结构。</span></p> 
         <p><span style="font-family: 'DejaVu Sans';">介绍完这两个数据结构以后我们看看在</span>task_struct<span style="font-family: 'DejaVu Sans';">结构中的部分文件有关内容：</span></p> 
         <p><span style="font-family: 'DejaVu Sans';">在</span>task_struct<span style="font-family: 'DejaVu Sans';">中有两个文件相关：</span></p> 
         <p>struct fs_struct *fs;</p> 
         <p>struct files_struct *files;</p> 
         <p>fs_struct<span style="font-family: 'DejaVu Sans';">结构定义如下（</span>include/linux/fs_struct.h<span style="font-family: 'DejaVu Sans';">）：</span></p> 
         <div class="wp_codebox_msgheader wp_codebox_hide"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left"><a href="javascript:;" onclick="javascript:showCodeTxt('p674code4'); return false;">View Code</a> C</span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6744"> 
             <td class="code" id="p674code4"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> fs_struct <span style="color: #009900;">{</span> 
	atomic_t count<span style="color: #339933;">;</span> 
	rwlock_t lock<span style="color: #339933;">;</span> 
	<span style="color: #993333;">int</span> umask<span style="color: #339933;">;</span> 
	<span style="color: #993333;">struct</span> dentry <span style="color: #339933;">*</span> root<span style="color: #339933;">,</span> <span style="color: #339933;">*</span> pwd<span style="color: #339933;">,</span> <span style="color: #339933;">*</span> altroot<span style="color: #339933;">;</span> 
	<span style="color: #993333;">struct</span> vfsmount <span style="color: #339933;">*</span> rootmnt<span style="color: #339933;">,</span> <span style="color: #339933;">*</span> pwdmnt<span style="color: #339933;">,</span> <span style="color: #339933;">*</span> altrootmnt<span style="color: #339933;">;</span> 
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p><span style="font-family: 'DejaVu Sans';">这三个</span>dentry<span style="font-family: 'DejaVu Sans';">中，</span>root<span style="font-family: 'DejaVu Sans';">指向根目录，</span>pwd<span style="font-family: 'DejaVu Sans';">指向当前目录，</span>altroot<span style="font-family: 'DejaVu Sans';">指向为用户设置的“替换根目录”。</span></p> 
         <p>files<span style="font-family: 'DejaVu Sans';">是记录已打开文件表，进程每打开一个文件，就会通过一个打开的文件号</span>fid<span style="font-family: 'DejaVu Sans';">来访问这个文件，</span>fid<span style="font-family: 'DejaVu Sans';">实际上是相应</span>file<span style="font-family: 'DejaVu Sans';">结构在数组中的下标，指向特定的</span>file<span style="font-family: 'DejaVu Sans';">结构，每个</span>file<span style="font-family: 'DejaVu Sans';">结构中都有一个</span>dentry<span style="font-family: 'DejaVu Sans';">指针指向文件的</span>dentry<span style="font-family: 'DejaVu Sans';">结构，这个</span>dentry<span style="font-family: 'DejaVu Sans';">结构并不是这个进程特有的，而是通用的，每个文件只有一个</span>dentry<span style="font-family: 'DejaVu Sans';">结构，而可能有多个进程打开它，所以当每个进程打开的是同一个文件的时候，其所指的</span>dentry<span style="font-family: 'DejaVu Sans';">结构是同一个。</span></p> 
         <p><span style="font-family: 'DejaVu Sans';">总的来说，在进程中，有如下图示：</span></p> 
         <p><a href="uploads/2012/10/linux5.png"><img class="aligncenter size-full wp-image-676" title="linux5" src="uploads/2012/10/linux5.png" alt="" width="784" height="567"></a></p> 
         <h2><span style="font-family: 'DejaVu Sans';">三、磁盘模块</span></h2> 
         <p><span style="font-family: 'DejaVu Sans';">与</span>inode<span style="font-family: 'DejaVu Sans';">和</span>dentry<span style="font-family: 'DejaVu Sans';">相对应，在磁盘中也有相应数据结构，不过它们不是存储在内存中哦给的，而是在磁盘中的，对于</span>Ext2<span style="font-family: 'DejaVu Sans';">文件系统而言，</span>inode<span style="font-family: 'DejaVu Sans';">对应的数据结构是</span>ext2_inode<span style="font-family: 'DejaVu Sans';">，数据结构定义如下（</span>include/linux/ext2_fs.h<span style="font-family: 'DejaVu Sans';">）：</span></p> 
         <div class="wp_codebox_msgheader wp_codebox_hide"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left"><a href="javascript:;" onclick="javascript:showCodeTxt('p674code5'); return false;">View Code</a> C</span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6745"> 
             <td class="code" id="p674code5"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> ext2_inode <span style="color: #009900;">{</span> 
	__u16	i_mode<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* File mode */</span> 
	__u16	i_uid<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* Low 16 bits of Owner Uid */</span> 
	__u32	i_size<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* Size in bytes */</span> 
	__u32	i_atime<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Access time */</span> 
	__u32	i_ctime<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Creation time */</span> 
	__u32	i_mtime<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Modification time */</span> 
	__u32	i_dtime<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Deletion Time */</span> 
	__u16	i_gid<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* Low 16 bits of Group Id */</span> 
	__u16	i_links_count<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Links count */</span> 
	__u32	i_blocks<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Blocks count */</span> 
	__u32	i_flags<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* File flags */</span> 
	<span style="color: #993333;">union</span> <span style="color: #009900;">{</span> 
		<span style="color: #993333;">struct</span> <span style="color: #009900;">{</span> 
			__u32  l_i_reserved1<span style="color: #339933;">;</span> 
		<span style="color: #009900;">}</span> linux1<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> <span style="color: #009900;">{</span> 
			__u32  h_i_translator<span style="color: #339933;">;</span> 
		<span style="color: #009900;">}</span> hurd1<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> <span style="color: #009900;">{</span> 
			__u32  m_i_reserved1<span style="color: #339933;">;</span> 
		<span style="color: #009900;">}</span> masix1<span style="color: #339933;">;</span> 
	<span style="color: #009900;">}</span> osd1<span style="color: #339933;">;</span>				<span style="color: #808080; font-style: italic;">/* OS dependent 1 */</span> 
	__u32	i_block<span style="color: #009900;">[</span>EXT2_N_BLOCKS<span style="color: #009900;">]</span><span style="color: #339933;">;</span><span style="color: #808080; font-style: italic;">/* Pointers to blocks */</span> 
	__u32	i_generation<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* File version (for NFS) */</span> 
	__u32	i_file_acl<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* File ACL */</span> 
	__u32	i_dir_acl<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Directory ACL */</span> 
	__u32	i_faddr<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Fragment address */</span> 
	<span style="color: #993333;">union</span> <span style="color: #009900;">{</span> 
		<span style="color: #993333;">struct</span> <span style="color: #009900;">{</span> 
			__u8	l_i_frag<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Fragment number */</span> 
			__u8	l_i_fsize<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Fragment size */</span> 
			__u16	i_pad1<span style="color: #339933;">;</span> 
			__u16	l_i_uid_high<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* these 2 fields    */</span> 
			__u16	l_i_gid_high<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* were reserved2[0] */</span> 
			__u32	l_i_reserved2<span style="color: #339933;">;</span> 
		<span style="color: #009900;">}</span> linux2<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> <span style="color: #009900;">{</span> 
			__u8	h_i_frag<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Fragment number */</span> 
			__u8	h_i_fsize<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Fragment size */</span> 
			__u16	h_i_mode_high<span style="color: #339933;">;</span> 
			__u16	h_i_uid_high<span style="color: #339933;">;</span> 
			__u16	h_i_gid_high<span style="color: #339933;">;</span> 
			__u32	h_i_author<span style="color: #339933;">;</span> 
		<span style="color: #009900;">}</span> hurd2<span style="color: #339933;">;</span> 
		<span style="color: #993333;">struct</span> <span style="color: #009900;">{</span> 
			__u8	m_i_frag<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Fragment number */</span> 
			__u8	m_i_fsize<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Fragment size */</span> 
			__u16	m_pad1<span style="color: #339933;">;</span> 
			__u32	m_i_reserved2<span style="color: #009900;">[</span><span style="color: #0000dd;">2</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span> 
		<span style="color: #009900;">}</span> masix2<span style="color: #339933;">;</span> 
	<span style="color: #009900;">}</span> osd2<span style="color: #339933;">;</span>				<span style="color: #808080; font-style: italic;">/* OS dependent 2 */</span> 
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p><span style="font-family: 'DejaVu Sans';">文件的存储是按照树形结构存储的，以根目录为树根，各个具体的文件为树叶。其中通过各个索引节点等来进行遍历搜索。在</span>ext2_inode<span style="font-family: 'DejaVu Sans';">没有文件名，文件名是存储在与</span>ext2_dir_entry_2<span style="font-family: 'DejaVu Sans';">中，这个数据结构是与</span>dentry<span style="font-family: 'DejaVu Sans';">相对应（事实上这些都是一些对</span>inode<span style="font-family: 'DejaVu Sans';">和</span>dentry<span style="font-family: 'DejaVu Sans';">的扩充）。</span></p> 
         <div class="wp_codebox_msgheader wp_codebox_hide"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left"><a href="javascript:;" onclick="javascript:showCodeTxt('p674code6'); return false;">View Code</a> C</span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p6746"> 
             <td class="code" id="p674code6"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> ext2_dir_entry_2 <span style="color: #009900;">{</span> 
	__u32	inode<span style="color: #339933;">;</span>			<span style="color: #808080; font-style: italic;">/* Inode number */</span> 
	__u16	rec_len<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* Directory entry length */</span> 
	__u8	name_len<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* Name length */</span> 
	__u8	file_type<span style="color: #339933;">;</span> 
	<span style="color: #993333;">char</span>	name<span style="color: #009900;">[</span>EXT2_NAME_LEN<span style="color: #009900;">]</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* File name */</span> 
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p><span style="font-family: 'DejaVu Sans';">磁盘上的“超级块”存储的是系统的“根目录”信息，目录本身也是一种文件，目录的目录项又在另一个目录中，这样的话从根目录开始遍历就可以找到所有节点和文件。</span></p> 
         <p><span style="font-family: 'DejaVu Sans';">从磁盘的角度来看，一个磁盘分区可以分为以下几个区：</span></p> 
         <table width="665" cellspacing="0" cellpadding="4"> 
          <colgroup> 
           <col width="39"> 
           <col width="39"> 
           <col width="102"> 
           <col width="319"> 
           <col width="124"> 
          </colgroup> 
          <tbody> 
           <tr valign="TOP"> 
            <td width="39"><span style="font-family: 'DejaVu Sans';">引导</span></td> 
            <td width="39"><span style="font-family: 'DejaVu Sans';">超级快</span></td> 
            <td width="102"><span style="font-family: 'DejaVu Sans';">索引节点部分</span></td> 
            <td width="319"><span style="font-family: 'DejaVu Sans';">数据部分</span></td> 
            <td width="124"></td> 
           </tr> 
          </tbody> 
         </table> 
         <p><span style="font-family: 'DejaVu Sans';">需要指出的是在磁盘上每个文件都有目录项和索引节点，但是只有在需要时才在内存中为之建立起相应的</span>dentry<span style="font-family: 'DejaVu Sans';">和</span>inode<span style="font-family: 'DejaVu Sans';">数据结构。</span></p> 
         <p>The End.</p> 
        </div>
       </div>
       <!-- .entry-content --> 
       <!-- .entry-meta --> 
      </article>
      <!-- #post-674 --> 
      <!-- #comments --> 
     </div>
     <!-- #content --> 
    </div>
    <!-- #primary --> 
    <!-- #secondary .widget-area --> 
   </div>
   <!-- #main --> 
   <!-- #colophon --> 
  </div>
  <!-- #page -->   
  <!-- JiaThis Button BEGIN -->  
  <!-- JiaThis Button END -->   
 </body>
</html>