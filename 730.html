<!doctype html>
<!--[if IE 6]>
<html id="ie6" lang="zh-CN">
<![endif]-->
<!--[if IE 7]>
<html id="ie7" lang="zh-CN">
<![endif]-->
<!--[if IE 8]>
<html id="ie8" lang="zh-CN">
<![endif]-->
<!--[if !(IE 6) | !(IE 7) | !(IE 8)  ]><!-->
<html lang="zh-CN">
 <!--<![endif]-->
 <head>      
  <link rel="stylesheet" type="text/css" media="all" href="stylesheets/style.css">     
  <link rel="stylesheet" id="codebox-css" href="stylesheets/codebox.css" type="text/css" media="screen">             
 </head> 
 <body class="single single-post postid-730 single-format-standard content-sidebar"> 
  <div id="page" class="hfeed"> 
   <header id="branding" role="banner"> 
    <hgroup> 
     <h1 id="site-title"><span><a href="http://codelifeliwan.github.io/" title="Code_Life_LiWan" rel="home">Code_Life_LiWan</a></span></h1> 
     <h2 id="site-description">My heart will go on and on…</h2> 
    </hgroup>  
    <!-- #access --> 
   </header>
   <!-- #branding --> 
   <div id="main" class="clearfix"> 
    <div id="primary"> 
     <div id="content" role="main"> 
      <!-- #nav-single --> 
      <article id="post-730" class="post-730 post type-post status-publish format-standard hentry category-linux_kernel_source_code_notes"> 
       <header class="entry-header"> 
        <h1 class="entry-title">Linux内核-基于socket的进程通信（三、报文的发送、接收与插口的关闭）</h1> 
        <div class="entry-meta"> 
         <span class="sep">Posted on </span>
         <a href="http://codelifeliwan.github.io/?p=730" title="下午 4:57" rel="bookmark"><time class="entry-date" datetime="2012-12-05T16:57:33+00:00" pubdate>5 十二月, 2012</time></a>
         <span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codelifeliwan.github.io/?author=1" title="View all posts by wanli" rel="author">wanli</a></span></span> 
         <span class="sep"> — </span> 
         <span class="comments-link"> <a href="http://codelifeliwan.github.io/?p=730#respond" title="Comment on Linux内核-基于socket的进程通信（三、报文的发送、接收与插口的关闭）">No Comments ↓</a> </span> 
        </div>
        <!-- .entry-meta --> 
       </header>
       <!-- .entry-header --> 
       <div class="entry-content">
        <div class="entry-content"> 
         <div> 
          <p>前面我们讲了插口的一系列操作，在这篇中讲报文的发送接收与插口的关闭操作。</p> 
          <p>因为报文的发送接收比较复杂，所以还是和前面一样，我们先讲数据结构及其关系，当数据结构理清了，操作自然不成问题。</p> 
          <h2>数据结构说明：</h2> 
          <p>我们知道，当发送报文的时候，每个报文都有一个报文头部，在<span style="font-family: 'Times New Roman';">Linux</span><span style="font-family: 宋体;">中这个头部结构是</span><span style="font-family: 'Times New Roman';">msghdr</span><span style="font-family: 宋体;">，定义在</span><span style="font-family: 'Times New Roman';">include/linux/socket.h</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=730&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p7301"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td> 
              <td class="code" id="p730code1"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> msghdr <span style="color: #009900;">{</span>
	<span style="color: #993333;">void</span>	<span style="color: #339933;">*</span>	msg_name<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Socket name			*/</span>
	<span style="color: #993333;">int</span>		msg_namelen<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Length of name		*/</span>
	<span style="color: #993333;">struct</span> iovec <span style="color: #339933;">*</span>	msg_iov<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Data blocks			*/</span>
	__kernel_size_t	msg_iovlen<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Number of blocks		*/</span>
	<span style="color: #993333;">void</span> 	<span style="color: #339933;">*</span>	msg_control<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Per protocol magic (eg BSD file descriptor passing) */</span>
	__kernel_size_t	msg_controllen<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Length of cmsg list */</span>
	<span style="color: #993333;">unsigned</span>	msg_flags<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *	POSIX 1003.1g - ancillary data object information
 *	Ancillary data consits of a sequence of pairs of
 *	(cmsghdr, cmsg_data[])
 */</span>
&nbsp;
<span style="color: #993333;">struct</span> cmsghdr <span style="color: #009900;">{</span>
	__kernel_size_t	cmsg_len<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* data byte count, including hdr */</span>
        <span style="color: #993333;">int</span>		cmsg_level<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* originating protocol */</span>
        <span style="color: #993333;">int</span>		cmsg_type<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* protocol-specific type */</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>其中，在<span style="font-family: 'Times New Roman';">msghdr</span><span style="font-family: 宋体;">结构中，</span><span style="font-family: 'Times New Roman';">msg_name</span><span style="font-family: 宋体;">指针指向</span><span style="font-family: 'Times New Roman';">sock_addr</span><span style="font-family: 宋体;">；</span><span style="font-family: 'Times New Roman';">msg_namelen</span><span style="font-family: 宋体;">是</span><span style="font-family: 'Times New Roman';">socket</span><span style="font-family: 宋体;">的长度；</span><span style="font-family: 'Times New Roman';">msg_iov</span><span style="font-family: 宋体;">指向</span><span style="font-family: 'Times New Roman';">iovec</span><span style="font-family: 宋体;">结构数组，即</span><span style="font-family: 'Times New Roman';">io</span><span style="font-family: 宋体;">向量；</span><span style="font-family: 'Times New Roman';">msg_iovlen</span><span style="font-family: 宋体;">是缓冲区数量（？）；</span><span style="font-family: 'Times New Roman';">msg_control</span><span style="font-family: 宋体;">指向</span><span style="font-family: 'Times New Roman';">cmsghdr</span><span style="font-family: 宋体;">结构，是报文的控制结构，还有可能附加一个</span><span style="font-family: 'Times New Roman';">cmsg_data[]</span><span style="font-family: 宋体;">数组；</span><span style="font-family: 'Times New Roman';">msg_name</span><span style="font-family: 宋体;">、</span><span style="font-family: 'Times New Roman';">msg_namelen</span><span style="font-family: 宋体;">、</span><span style="font-family: 'Times New Roman';">msg_flags</span><span style="font-family: 宋体;">分别对应发送的参数</span><span style="font-family: 'Times New Roman';">addr</span><span style="font-family: 宋体;">，</span><span style="font-family: 'Times New Roman';">addr_len</span><span style="font-family: 宋体;">，</span><span style="font-family: 'Times New Roman';">flags</span><span style="font-family: 宋体;">。</span></p> 
          <p>需要说明的是，<span style="font-family: 'Times New Roman';">iovec</span><span style="font-family: 宋体;">是一个所谓的“</span><span style="font-family: 'Times New Roman';">io</span><span style="font-family: 宋体;">向量”，其中包含了一个缓冲区指针和缓冲区数据长度，定义在</span><span style="font-family: 'Times New Roman';">include/linux/uio.h</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=730&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p7302"> 
              <td class="line_numbers"><pre>1
2
3
4
5
</pre></td> 
              <td class="code" id="p730code2"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> iovec
<span style="color: #009900;">{</span>
	<span style="color: #993333;">void</span> <span style="color: #339933;">*</span>iov_base<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* BSD uses caddr_t (1003.1g requires void *) */</span>
	__kernel_size_t iov_len<span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* Must be size_t (1003.1g) */</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>总的来说，这些数据结构关系如下：</p> 
          <p><a href="uploads/2012/12/1.jpg"><img class="aligncenter size-full wp-image-731" title="1" src="uploads/2012/12/1.jpg" alt="" width="606" height="546"></a></p> 
          <p>在发送接收报文的时候有时候需要一些附加信息，比如对方进程的身份，同时插口还允许一个进程把它的若干个已打开文件的访问权限“授予”给另一个进程，一个进程可以同时打开的文件数是<span style="font-family: 'Times New Roman';">OPEN_MAX</span><span style="font-family: 宋体;">，定义为</span><span style="font-family: 'Times New Roman';">256</span><span style="font-family: 宋体;">，但是插口本身也打开了一个文件，所以这里需要为插口本身保留一个减去</span><span style="font-family: 'Times New Roman';">1</span><span style="font-family: 宋体;">。这就需要</span><span style="font-family: 'Times New Roman';">scm_cookie</span><span style="font-family: 宋体;">数据结构：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=730&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p7303"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td> 
              <td class="code" id="p730code3"><pre class="c" style="font-family:monospace;"><span style="color: #339933;">#define SCM_MAX_FD	(OPEN_MAX-1)</span>
&nbsp;
<span style="color: #993333;">struct</span> scm_fp_list
<span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span>		count<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//文件数目</span>
	<span style="color: #993333;">struct</span> file	<span style="color: #339933;">*</span>fp<span style="color: #009900;">[</span>SCM_MAX_FD<span style="color: #009900;">]</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//文件指针数组</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #993333;">struct</span> scm_cookie
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> ucred		creds<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* Skb credentials	*/</span>
	<span style="color: #993333;">struct</span> scm_fp_list	<span style="color: #339933;">*</span>fp<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* Passed files		*/</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span>		seq<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* Connection seqno	*/</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>在<span style="font-family: 'Times New Roman';">scm_cookie</span><span style="font-family: 宋体;">中，</span><span style="font-family: 'Times New Roman';">fp</span><span style="font-family: 宋体;">就是</span><span style="font-family: 'Times New Roman';">scm_fp_list</span><span style="font-family: 宋体;">指针，还有另一个</span><span style="font-family: 'Times New Roman';">creds</span><span style="font-family: 宋体;">代表对方进程的身份，这个结构定义在</span><span style="font-family: 'Times New Roman';">include/linux/socket.h</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=730&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p7304"> 
              <td class="line_numbers"><pre>1
2
3
4
5
</pre></td> 
              <td class="code" id="p730code4"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> ucred <span style="color: #009900;">{</span>
	__u32	pid<span style="color: #339933;">;</span>
	__u32	uid<span style="color: #339933;">;</span>
	__u32	gid<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>里面包含了进程号、用户号和组号。</p> 
          <p>前面说报文头部的时候有个<span style="font-family: 'Times New Roman';">cmsghdr</span><span style="font-family: 宋体;">结构用来保存附加信息，事实上在真正操作的时候就是将</span><span style="font-family: 'Times New Roman';">scm_cookie</span><span style="font-family: 宋体;">和</span><span style="font-family: 'Times New Roman';">cmsghdr</span><span style="font-family: 宋体;">组合起来使用的。</span></p> 
          <p>综合来说，报文的发送与接收大概是这个样子的：</p> 
          <p>1、发送方根据一系列信息组合一个报文头部<span style="font-family: 'Times New Roman';">msghdr</span><span style="font-family: 宋体;">结构和</span><span style="font-family: 'Times New Roman';">iovec</span><span style="font-family: 宋体;">结构，把要发送数据挂入</span><span style="font-family: 'Times New Roman';">iovec</span><span style="font-family: 宋体;">结构。</span><br> 2、发送方根据一系列信息设置附加信息<span style="font-family: 'Times New Roman';">cmsghdr</span><span style="font-family: 宋体;">结构，同时根据需要将</span><span style="font-family: 'Times New Roman';">scm_cookie</span><span style="font-family: 宋体;">结构信息挂入拷贝至紧挨着</span><span style="font-family: 'Times New Roman';">cmsghdr</span><span style="font-family: 宋体;">结构。</span><br> 3、发送方在内核申请<span style="font-family: 'Times New Roman';">sk_buff</span><span style="font-family: 宋体;">结构，包括所需的缓冲区，将以上信息都拷贝进去，并且做相关处理，注意原来</span><span style="font-family: 'Times New Roman';">iovec</span><span style="font-family: 宋体;">的缓冲区是在用户空间的。</span><br> 4、将<span style="font-family: 'Times New Roman';">sk_buff</span><span style="font-family: 宋体;">结构挂入接收放的</span><span style="font-family: 'Times New Roman';">sock</span><span style="font-family: 宋体;">结构的接收队列中。</span><br> 5、接收方也根据一系列信息组装起来一个<span style="font-family: 'Times New Roman';">cmsghdr</span><span style="font-family: 宋体;">结构，包括</span><span style="font-family: 'Times New Roman';">iovec</span><span style="font-family: 宋体;">结构，并让</span><span style="font-family: 'Times New Roman';">iovec</span><span style="font-family: 宋体;">结构的缓冲区指针指向想要存放数据的缓冲区。</span><br> 6、接收方从队列中摘取<span style="font-family: 'Times New Roman';">sk_buff</span><span style="font-family: 宋体;">结构，并做相关的拷贝处理，将</span><span style="font-family: 'Times New Roman';">sk_buff</span><span style="font-family: 宋体;">中的数据拷贝到</span><span style="font-family: 'Times New Roman';">iovec</span><span style="font-family: 宋体;">指定的缓冲区，其他信息拷贝到接收方的</span><span style="font-family: 'Times New Roman';">scm_cookie</span><span style="font-family: 宋体;">，并做相关处理。</span><br> 7、若有需要，接收方拷贝发送方的地址。</p> 
          <p>&nbsp;</p> 
          <p>好了，说完了数据结构就来看看方法的具体实现。</p> 
          <h2>报文的发送：</h2> 
          <p>在用户空间中，报文的发送有多种形式，发送的函数有<span style="font-family: 'Times New Roman';">send()</span><span style="font-family: 宋体;">、</span><span style="font-family: 'Times New Roman';">sendto()</span><span style="font-family: 宋体;">、</span><span style="font-family: 'Times New Roman';">sendmsg()</span><span style="font-family: 宋体;">、</span><span style="font-family: 'Times New Roman';">write()</span><span style="font-family: 宋体;">四个，最后具体都是使用</span><span style="font-family: 'Times New Roman';">sock_sendmsg()</span><span style="font-family: 宋体;">来实现的。</span></p> 
          <p>需要说明的是<span style="font-family: 'Times New Roman';">write()</span><span style="font-family: 宋体;">函数是使用文件系统的概念，在</span><span style="font-family: 'Times New Roman';">socket</span><span style="font-family: 宋体;">域的情况下</span><span style="font-family: 'Times New Roman';">file</span><span style="font-family: 宋体;">结构中的</span><span style="font-family: 'Times New Roman';">f_op</span><span style="font-family: 宋体;">指针指向的是</span><span style="font-family: 'Times New Roman';">socket_file_ops</span><span style="font-family: 宋体;">，定义在</span><span style="font-family: 'Times New Roman';">net/socket.c</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=730&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p7305"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td> 
              <td class="code" id="p730code5"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">struct</span> file_operations socket_file_ops <span style="color: #339933;">=</span> <span style="color: #009900;">{</span>
	llseek<span style="color: #339933;">:</span>		sock_lseek<span style="color: #339933;">,</span>
	read<span style="color: #339933;">:</span>		sock_read<span style="color: #339933;">,</span>
	write<span style="color: #339933;">:</span>		sock_write<span style="color: #339933;">,</span>
	poll<span style="color: #339933;">:</span>		sock_poll<span style="color: #339933;">,</span>
	ioctl<span style="color: #339933;">:</span>		sock_ioctl<span style="color: #339933;">,</span>
	mmap<span style="color: #339933;">:</span>		sock_mmap<span style="color: #339933;">,</span>
	open<span style="color: #339933;">:</span>		sock_no_open<span style="color: #339933;">,</span>	<span style="color: #808080; font-style: italic;">/* special open code to disallow open via /proc */</span>
	release<span style="color: #339933;">:</span>	sock_close<span style="color: #339933;">,</span>
	fasync<span style="color: #339933;">:</span>		sock_fasync<span style="color: #339933;">,</span>
	readv<span style="color: #339933;">:</span>		sock_readv<span style="color: #339933;">,</span>
	writev<span style="color: #339933;">:</span>		sock_writev
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>具体的函数是<span style="font-family: 'Times New Roman';">sock_write()</span><span style="font-family: 宋体;">。</span></p> 
          <p>具体的<span style="font-family: 'Times New Roman';">sock_write()</span><span style="font-family: 宋体;">函数在</span><span style="font-family: 'Times New Roman';">net/socket.c</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=730&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p7306"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td> 
              <td class="code" id="p730code6"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 *	Write data to a socket. We verify that the user area ubuf..ubuf+size-1
 *	is readable by the user process.
 */</span>
&nbsp;
<span style="color: #993333;">static</span> ssize_t sock_write<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span>file<span style="color: #339933;">,</span> <span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>ubuf<span style="color: #339933;">,</span>
			  size_t size<span style="color: #339933;">,</span> loff_t <span style="color: #339933;">*</span>ppos<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> socket <span style="color: #339933;">*</span>sock<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> msghdr msg<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> iovec iov<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>ppos <span style="color: #339933;">!=</span> <span style="color: #339933;">&amp;</span>file<span style="color: #339933;">-&gt;</span>f_pos<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>ESPIPE<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span><span style="color: #009900;">(</span>size<span style="color: #339933;">==</span><span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>		<span style="color: #808080; font-style: italic;">/* Match SYS5 behaviour */</span>
		<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
	sock <span style="color: #339933;">=</span> socki_lookup<span style="color: #009900;">(</span>file<span style="color: #339933;">-&gt;</span>f_dentry<span style="color: #339933;">-&gt;</span>d_inode<span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
&nbsp;
	msg.<span style="color: #202020;">msg_name</span><span style="color: #339933;">=</span>NULL<span style="color: #339933;">;</span>
	msg.<span style="color: #202020;">msg_namelen</span><span style="color: #339933;">=</span><span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	msg.<span style="color: #202020;">msg_iov</span><span style="color: #339933;">=&amp;</span>iov<span style="color: #339933;">;</span>
	msg.<span style="color: #202020;">msg_iovlen</span><span style="color: #339933;">=</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	msg.<span style="color: #202020;">msg_control</span><span style="color: #339933;">=</span>NULL<span style="color: #339933;">;</span>
	msg.<span style="color: #202020;">msg_controllen</span><span style="color: #339933;">=</span><span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	msg.<span style="color: #202020;">msg_flags</span><span style="color: #339933;">=!</span><span style="color: #009900;">(</span>file<span style="color: #339933;">-&gt;</span>f_flags <span style="color: #339933;">&amp;</span> O_NONBLOCK<span style="color: #009900;">)</span> <span style="color: #339933;">?</span> <span style="color: #0000dd;">0</span> <span style="color: #339933;">:</span> MSG_DONTWAIT<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>sock<span style="color: #339933;">-&gt;</span>type <span style="color: #339933;">==</span> SOCK_SEQPACKET<span style="color: #009900;">)</span>
		msg.<span style="color: #202020;">msg_flags</span> <span style="color: #339933;">|=</span> MSG_EOR<span style="color: #339933;">;</span>
	iov.<span style="color: #202020;">iov_base</span><span style="color: #339933;">=</span><span style="color: #009900;">(</span><span style="color: #993333;">void</span> <span style="color: #339933;">*</span><span style="color: #009900;">)</span>ubuf<span style="color: #339933;">;</span>
	iov.<span style="color: #202020;">iov_len</span><span style="color: #339933;">=</span>size<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">return</span> sock_sendmsg<span style="color: #009900;">(</span>sock<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>msg<span style="color: #339933;">,</span> size<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>结合前面的数据结构说明，这里应该比较简单。</p> 
          <p>再来看看函数<span style="font-family: 'Times New Roman';">sys_sendto()</span><span style="font-family: 宋体;">，这个函数也是在</span><span style="font-family: 'Times New Roman';">net/socket.c</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=730&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p7307"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td> 
              <td class="code" id="p730code7"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 *	Send a datagram to a given address. We move the address into kernel
 *	space and check the user space data area is readable before invoking
 *	the protocol.
 */</span>
&nbsp;
asmlinkage <span style="color: #993333;">long</span> sys_sendto<span style="color: #009900;">(</span><span style="color: #993333;">int</span> fd<span style="color: #339933;">,</span> <span style="color: #993333;">void</span> <span style="color: #339933;">*</span> buff<span style="color: #339933;">,</span> size_t len<span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> flags<span style="color: #339933;">,</span>
			   <span style="color: #993333;">struct</span> sockaddr <span style="color: #339933;">*</span>addr<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> addr_len<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> socket <span style="color: #339933;">*</span>sock<span style="color: #339933;">;</span>
	<span style="color: #993333;">char</span> address<span style="color: #009900;">[</span>MAX_SOCK_ADDR<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> err<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> msghdr msg<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> iovec iov<span style="color: #339933;">;</span>
&nbsp;
	sock <span style="color: #339933;">=</span> sockfd_lookup<span style="color: #009900;">(</span>fd<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>err<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>sock<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
	iov.<span style="color: #202020;">iov_base</span><span style="color: #339933;">=</span>buff<span style="color: #339933;">;</span>
	iov.<span style="color: #202020;">iov_len</span><span style="color: #339933;">=</span>len<span style="color: #339933;">;</span>
	msg.<span style="color: #202020;">msg_name</span><span style="color: #339933;">=</span>NULL<span style="color: #339933;">;</span>
	msg.<span style="color: #202020;">msg_iov</span><span style="color: #339933;">=&amp;</span>iov<span style="color: #339933;">;</span>
	msg.<span style="color: #202020;">msg_iovlen</span><span style="color: #339933;">=</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	msg.<span style="color: #202020;">msg_control</span><span style="color: #339933;">=</span>NULL<span style="color: #339933;">;</span>
	msg.<span style="color: #202020;">msg_controllen</span><span style="color: #339933;">=</span><span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	msg.<span style="color: #202020;">msg_namelen</span><span style="color: #339933;">=</span>addr_len<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span><span style="color: #009900;">(</span>addr<span style="color: #009900;">)</span>
	<span style="color: #009900;">{</span>
		err <span style="color: #339933;">=</span> move_addr_to_kernel<span style="color: #009900;">(</span>addr<span style="color: #339933;">,</span> addr_len<span style="color: #339933;">,</span> address<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>err <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> out_put<span style="color: #339933;">;</span>
		msg.<span style="color: #202020;">msg_name</span><span style="color: #339933;">=</span>address<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>sock<span style="color: #339933;">-&gt;</span>file<span style="color: #339933;">-&gt;</span>f_flags <span style="color: #339933;">&amp;</span> O_NONBLOCK<span style="color: #009900;">)</span>
		flags <span style="color: #339933;">|=</span> MSG_DONTWAIT<span style="color: #339933;">;</span>
	msg.<span style="color: #202020;">msg_flags</span> <span style="color: #339933;">=</span> flags<span style="color: #339933;">;</span>
	err <span style="color: #339933;">=</span> sock_sendmsg<span style="color: #009900;">(</span>sock<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>msg<span style="color: #339933;">,</span> len<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
out_put<span style="color: #339933;">:</span>		
	sockfd_put<span style="color: #009900;">(</span>sock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
out<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">return</span> err<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>可见，这两个函数几乎差不多，到最后都是使用<span style="font-family: 'Times New Roman';">sock_sendmsg()</span><span style="font-family: 宋体;">来实现，不过一般对于有连接的我们习惯使用</span><span style="font-family: 'Times New Roman';">write()</span><span style="font-family: 宋体;">函数，而对无连接的我们使用</span><span style="font-family: 'Times New Roman';">sendto()</span><span style="font-family: 宋体;">函数，因为有连接是面向数据流的，而无连接的是面向报文的，有连接的插口可以连续接收多次报文而无连接的只能接收一次。也就是说无连接的插口对于多余的未能接收完的报文丢弃，而有连接却能全部连续接收。</span></p> 
          <p>函数<span style="font-family: 'Times New Roman';">sock_sendmsg()</span><span style="font-family: 宋体;">的定义在</span><span style="font-family: 'Times New Roman';">net/socket.c</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=730&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p7308"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td> 
              <td class="code" id="p730code8"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">int</span> sock_sendmsg<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> socket <span style="color: #339933;">*</span>sock<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> msghdr <span style="color: #339933;">*</span>msg<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> size<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span> err<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> scm_cookie scm<span style="color: #339933;">;</span>
&nbsp;
	err <span style="color: #339933;">=</span> scm_send<span style="color: #009900;">(</span>sock<span style="color: #339933;">,</span> msg<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>scm<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>err <span style="color: #339933;">&gt;=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		err <span style="color: #339933;">=</span> sock<span style="color: #339933;">-&gt;</span>ops<span style="color: #339933;">-&gt;</span>sendmsg<span style="color: #009900;">(</span>sock<span style="color: #339933;">,</span> msg<span style="color: #339933;">,</span> size<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>scm<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		scm_destroy<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>scm<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">return</span> err<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>函数<span style="font-family: 'Times New Roman';">scm_send()</span><span style="font-family: 宋体;">是用来对发送者的身份以及附加控制信息进行的处理，函数定义在</span><span style="font-family: 'Times New Roman';">include/net/scm.h</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=730&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p7309"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td> 
              <td class="code" id="p730code9"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> __inline__ <span style="color: #993333;">int</span> scm_send<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> socket <span style="color: #339933;">*</span>sock<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> msghdr <span style="color: #339933;">*</span>msg<span style="color: #339933;">,</span>
			       <span style="color: #993333;">struct</span> scm_cookie <span style="color: #339933;">*</span>scm<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	memset<span style="color: #009900;">(</span>scm<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #339933;">*</span>scm<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	scm<span style="color: #339933;">-&gt;</span>creds.<span style="color: #202020;">uid</span> <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>uid<span style="color: #339933;">;</span>
	scm<span style="color: #339933;">-&gt;</span>creds.<span style="color: #202020;">gid</span> <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>gid<span style="color: #339933;">;</span>
	scm<span style="color: #339933;">-&gt;</span>creds.<span style="color: #202020;">pid</span> <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>pid<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>msg<span style="color: #339933;">-&gt;</span>msg_controllen <span style="color: #339933;">&lt;=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> __scm_send<span style="color: #009900;">(</span>sock<span style="color: #339933;">,</span> msg<span style="color: #339933;">,</span> scm<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>函数<span style="font-family: 'Times New Roman';">__scm_send()</span><span style="font-family: 宋体;">定义在</span><span style="font-family: 'Times New Roman';">net/core/scm.c</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=730&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p73010"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre></td> 
              <td class="code" id="p730code10"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">int</span> __scm_send<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> socket <span style="color: #339933;">*</span>sock<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> msghdr <span style="color: #339933;">*</span>msg<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> scm_cookie <span style="color: #339933;">*</span>p<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> cmsghdr <span style="color: #339933;">*</span>cmsg<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> err<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>cmsg <span style="color: #339933;">=</span> CMSG_FIRSTHDR<span style="color: #009900;">(</span>msg<span style="color: #009900;">)</span><span style="color: #339933;">;</span> cmsg<span style="color: #339933;">;</span> cmsg <span style="color: #339933;">=</span> CMSG_NXTHDR<span style="color: #009900;">(</span>msg<span style="color: #339933;">,</span> cmsg<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
	<span style="color: #009900;">{</span>
		err <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EINVAL<span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/* Verify that cmsg_len is at least sizeof(struct cmsghdr) */</span>
		<span style="color: #808080; font-style: italic;">/* The first check was omitted in &lt;= 2.2.5. The reasoning was
		   that parser checks cmsg_len in any case, so that
		   additional check would be work duplication.
		   But if cmsg_level is not SOL_SOCKET, we do not check 
		   for too short ancillary data object at all! Oops.
		   OK, let's add it...
		 */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>cmsg<span style="color: #339933;">-&gt;</span>cmsg_len <span style="color: #339933;">&lt;</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> cmsghdr<span style="color: #009900;">)</span> <span style="color: #339933;">||</span>
		    <span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #993333;">char</span><span style="color: #339933;">*</span><span style="color: #009900;">)</span>cmsg <span style="color: #339933;">-</span> <span style="color: #009900;">(</span><span style="color: #993333;">char</span><span style="color: #339933;">*</span><span style="color: #009900;">)</span>msg<span style="color: #339933;">-&gt;</span>msg_control<span style="color: #009900;">)</span>
				    <span style="color: #339933;">+</span> cmsg<span style="color: #339933;">-&gt;</span>cmsg_len<span style="color: #009900;">)</span> <span style="color: #339933;">&gt;</span> msg<span style="color: #339933;">-&gt;</span>msg_controllen<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> error<span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>cmsg<span style="color: #339933;">-&gt;</span>cmsg_level <span style="color: #339933;">!=</span> SOL_SOCKET<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">switch</span> <span style="color: #009900;">(</span>cmsg<span style="color: #339933;">-&gt;</span>cmsg_type<span style="color: #009900;">)</span>
		<span style="color: #009900;">{</span>
		<span style="color: #b1b100;">case</span> SCM_RIGHTS<span style="color: #339933;">:</span>
			err<span style="color: #339933;">=</span>scm_fp_copy<span style="color: #009900;">(</span>cmsg<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>p<span style="color: #339933;">-&gt;</span>fp<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>err<span style="color: #339933;">&lt;</span><span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
				<span style="color: #b1b100;">goto</span> error<span style="color: #339933;">;</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">case</span> SCM_CREDENTIALS<span style="color: #339933;">:</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>cmsg<span style="color: #339933;">-&gt;</span>cmsg_len <span style="color: #339933;">!=</span> CMSG_LEN<span style="color: #009900;">(</span><span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> ucred<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				<span style="color: #b1b100;">goto</span> error<span style="color: #339933;">;</span>
			memcpy<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>p<span style="color: #339933;">-&gt;</span>creds<span style="color: #339933;">,</span> CMSG_DATA<span style="color: #009900;">(</span>cmsg<span style="color: #009900;">)</span><span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> ucred<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			err <span style="color: #339933;">=</span> scm_check_creds<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>p<span style="color: #339933;">-&gt;</span>creds<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>err<span style="color: #009900;">)</span>
				<span style="color: #b1b100;">goto</span> error<span style="color: #339933;">;</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">default</span><span style="color: #339933;">:</span>
			<span style="color: #b1b100;">goto</span> error<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>fp <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span>p<span style="color: #339933;">-&gt;</span>fp<span style="color: #339933;">-&gt;</span>count<span style="color: #009900;">)</span>
	<span style="color: #009900;">{</span>
		kfree<span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>fp<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		p<span style="color: #339933;">-&gt;</span>fp <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
error<span style="color: #339933;">:</span>
	scm_destroy<span style="color: #009900;">(</span>p<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> err<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>把一些主要和附加信息搭到报文上以后，就要通过具体的函数将报文发送出去了。对于无连接插口来说，函数<span style="font-family: 'Times New Roman';">sock_sendmsg()</span><span style="font-family: 宋体;">最终要调用的是</span><span style="font-family: 'Times New Roman';">unix_dgram_send()</span><span style="font-family: 宋体;">，函数定义在</span><span style="font-family: 'Times New Roman';">net/unix/af_unix.c</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=730&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p73011"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
</pre></td> 
              <td class="code" id="p730code11"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">int</span> unix_dgram_sendmsg<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> socket <span style="color: #339933;">*</span>sock<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> msghdr <span style="color: #339933;">*</span>msg<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> len<span style="color: #339933;">,</span>
			      <span style="color: #993333;">struct</span> scm_cookie <span style="color: #339933;">*</span>scm<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> sock <span style="color: #339933;">*</span>sk <span style="color: #339933;">=</span> sock<span style="color: #339933;">-&gt;</span>sk<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> sockaddr_un <span style="color: #339933;">*</span>sunaddr<span style="color: #339933;">=</span>msg<span style="color: #339933;">-&gt;</span>msg_name<span style="color: #339933;">;</span>
	unix_socket <span style="color: #339933;">*</span>other <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> namelen <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* fake GCC */</span>
	<span style="color: #993333;">int</span> err<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> hash<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> sk_buff <span style="color: #339933;">*</span>skb<span style="color: #339933;">;</span>
	<span style="color: #993333;">long</span> timeo<span style="color: #339933;">;</span>
&nbsp;
	err <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EOPNOTSUPP<span style="color: #339933;">;</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *参数flags中有个标志位MSG_OOB，表示此次接收的是out-of-band报文
　　 *在有连接模式中，普通的数据报文在发送时都编上号，接收是按照次序接收
　　 *但是有些报文用于控制目的而需要优先传递，此种“编外”报文就称为OOB报文
　　 *在无连接模式中每个报文都是独立的，不存在“次序”的概念，因此也不存在
　　 *OOB报文，所以MSG_OOB位不应该为1
　　 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>msg<span style="color: #339933;">-&gt;</span>msg_flags<span style="color: #339933;">&amp;</span>MSG_OOB<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>msg<span style="color: #339933;">-&gt;</span>msg_namelen<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//若调用参数提供了对方地址</span>
　　<span style="color: #666666; font-style: italic;">//将地址规格化</span>
		err <span style="color: #339933;">=</span> unix_mkname<span style="color: #009900;">(</span>sunaddr<span style="color: #339933;">,</span> msg<span style="color: #339933;">-&gt;</span>msg_namelen<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>hash<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>err <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
		namelen <span style="color: #339933;">=</span> err<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//否则认为已经调用过connect()</span>
		sunaddr <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
		err <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ENOTCONN<span style="color: #339933;">;</span>
		other <span style="color: #339933;">=</span> unix_peer_get<span style="color: #009900;">(</span>sk<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//找到对方的socket结构</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>other<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
　　<span style="color: #808080; font-style: italic;">/*
　　 *passcred表示要随报文传送与插口相关的信息
　　 *此时若没有通过bind()绑定一个地址，那么就通过unix_autobind()自动生成
　　 *一个
　　 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>sock<span style="color: #339933;">-&gt;</span>passcred <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span>sk<span style="color: #339933;">-&gt;</span>protinfo.<span style="color: #202020;">af_unix</span>.<span style="color: #202020;">addr</span> <span style="color: #339933;">&amp;&amp;</span>
	    <span style="color: #009900;">(</span>err <span style="color: #339933;">=</span> unix_autobind<span style="color: #009900;">(</span>sock<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
&nbsp;
	err <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EMSGSIZE<span style="color: #339933;">;</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *插口的发送报文的缓冲区大小记录在sk-&gt;sndbuf中，但是需要保留32
　　 *字节用于控制目的
　　 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span><span style="color: #009900;">)</span>len <span style="color: #339933;">&gt;</span> sk<span style="color: #339933;">-&gt;</span>sndbuf <span style="color: #339933;">-</span> <span style="color: #0000dd;">32</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
&nbsp;
　　<span style="color: #808080; font-style: italic;">/*
　　 *为发送报文分配sk_buff数据结构，包括所需的缓冲区
　　 */</span>
	skb <span style="color: #339933;">=</span> sock_alloc_send_skb<span style="color: #009900;">(</span>sk<span style="color: #339933;">,</span> len<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> msg<span style="color: #339933;">-&gt;</span>msg_flags<span style="color: #339933;">&amp;</span>MSG_DONTWAIT<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>err<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>skb<span style="color: #339933;">==</span>NULL<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
&nbsp;
　　<span style="color: #808080; font-style: italic;">/*
　　 *	struct unix_skb_parms
　　 *	{
　　 *		struct ucred		creds;		//Skb credentials
　　 *		struct scm_fp_list	*fp;		//Passed files
　　 *	};
　　 *
　　 *
　　 *	#define UNIXCB(skb) 	(*(struct unix_skb_parms*)&amp;((skb)-&gt;cb))
　　 *	#define UNIXCREDS(skb)	(&amp;UNIXCB((skb)).creds)
　　 *sk_buff中的48字节的cb数组用来存放scm_cookie数据
　　 *这里直接拷贝进去
　　 */</span>
	memcpy<span style="color: #009900;">(</span>UNIXCREDS<span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>scm<span style="color: #339933;">-&gt;</span>creds<span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> ucred<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *函数unix_attach_fds()定义在af_unix.c中，定义如下：
　　 *	static void unix_attach_fds(struct scm_cookie *scm, struct sk_buff *skb)
　　 *	{
　　 *		int i;
　　 *		for (i=scm-&gt;fp-&gt;count-1; i&gt;=0; i--)
　　 *			unix_inflight(scm-&gt;fp-&gt;fp[i]);	//循环处理每个打开文件
　　 *		UNIXCB(skb).fp = scm-&gt;fp;
　　 *		skb-&gt;destructor = unix_destruct_fds;
　　 *		scm-&gt;fp = NULL;
　　 *	}
　　 *函数unix_inflight()定义在net/unix/garbage.c中：
　　 *	void unix_inflight(struct file *fp)
　　 *	{
　　 *		unix_socket *s=unix_get_socket(fp);
　　 *		if(s) {
　　 *			atomic_inc(&amp;s-&gt;protinfo.af_unix.inflight);
　　 *			atomic_inc(&amp;unix_tot_inflight);
　　 *		}
　　 *	}
　　 *可见，处理实际上就是递增“飞行模式”计数
　　 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>scm<span style="color: #339933;">-&gt;</span>fp<span style="color: #009900;">)</span>
		unix_attach_fds<span style="color: #009900;">(</span>scm<span style="color: #339933;">,</span> skb<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//处理对已打开文件的访问授权</span>
&nbsp;
	skb<span style="color: #339933;">-&gt;</span>h.<span style="color: #202020;">raw</span> <span style="color: #339933;">=</span> skb<span style="color: #339933;">-&gt;</span>data<span style="color: #339933;">;</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *将报文数据从用户空间拷贝到依附于sk_buff结构的缓冲区中
　　 */</span>
	err <span style="color: #339933;">=</span> memcpy_fromiovec<span style="color: #009900;">(</span>skb_put<span style="color: #009900;">(</span>skb<span style="color: #339933;">,</span>len<span style="color: #009900;">)</span><span style="color: #339933;">,</span> msg<span style="color: #339933;">-&gt;</span>msg_iov<span style="color: #339933;">,</span> len<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>err<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out_free<span style="color: #339933;">;</span>
&nbsp;
	timeo <span style="color: #339933;">=</span> sock_sndtimeo<span style="color: #009900;">(</span>sk<span style="color: #339933;">,</span> msg<span style="color: #339933;">-&gt;</span>msg_flags <span style="color: #339933;">&amp;</span> MSG_DONTWAIT<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//时间限制</span>
&nbsp;
restart<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>other<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *other为0有两种情况，一个是未通过connect()建立连接，
　　 *二是本次发送重新给了个地址
　　 */</span>
		err <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ECONNRESET<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>sunaddr <span style="color: #339933;">==</span> NULL<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> out_free<span style="color: #339933;">;</span>
&nbsp;
		other <span style="color: #339933;">=</span> unix_find_other<span style="color: #009900;">(</span>sunaddr<span style="color: #339933;">,</span> namelen<span style="color: #339933;">,</span> sk<span style="color: #339933;">-&gt;</span>type<span style="color: #339933;">,</span> hash<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>err<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>other<span style="color: #339933;">==</span>NULL<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> out_free<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	unix_state_rlock<span style="color: #009900;">(</span>other<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	err <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EPERM<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>unix_may_send<span style="color: #009900;">(</span>sk<span style="color: #339933;">,</span> other<span style="color: #009900;">)</span><span style="color: #009900;">)</span>	<span style="color: #666666; font-style: italic;">//测试是否允许发送</span>
		<span style="color: #b1b100;">goto</span> out_unlock<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>other<span style="color: #339933;">-&gt;</span>dead<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #808080; font-style: italic;">/*
		 *	Check with 1003.1g - what should
		 *	datagram error
		 */</span>
		unix_state_runlock<span style="color: #009900;">(</span>other<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		sock_put<span style="color: #009900;">(</span>other<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
		err <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		unix_state_wlock<span style="color: #009900;">(</span>sk<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>unix_peer<span style="color: #009900;">(</span>sk<span style="color: #009900;">)</span> <span style="color: #339933;">==</span> other<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			unix_peer<span style="color: #009900;">(</span>sk<span style="color: #009900;">)</span><span style="color: #339933;">=</span>NULL<span style="color: #339933;">;</span>
			unix_state_wunlock<span style="color: #009900;">(</span>sk<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
			unix_dgram_disconnected<span style="color: #009900;">(</span>sk<span style="color: #339933;">,</span> other<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			sock_put<span style="color: #009900;">(</span>other<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			err <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ECONNREFUSED<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
			unix_state_wunlock<span style="color: #009900;">(</span>sk<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
&nbsp;
		other <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>err<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> out_free<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> restart<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	err <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EPIPE<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>other<span style="color: #339933;">-&gt;</span>shutdown<span style="color: #339933;">&amp;</span>RCV_SHUTDOWN<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out_unlock<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>unix_peer<span style="color: #009900;">(</span>other<span style="color: #009900;">)</span> <span style="color: #339933;">!=</span> sk <span style="color: #339933;">&amp;&amp;</span>
	    skb_queue_len<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>other<span style="color: #339933;">-&gt;</span>receive_queue<span style="color: #009900;">)</span> <span style="color: #339933;">&gt;</span> other<span style="color: #339933;">-&gt;</span>max_ack_backlog<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>timeo<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			err <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EAGAIN<span style="color: #339933;">;</span>
			<span style="color: #b1b100;">goto</span> out_unlock<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
&nbsp;
		timeo <span style="color: #339933;">=</span> unix_wait_for_peer<span style="color: #009900;">(</span>other<span style="color: #339933;">,</span> timeo<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
		err <span style="color: #339933;">=</span> sock_intr_errno<span style="color: #009900;">(</span>timeo<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>signal_pending<span style="color: #009900;">(</span>current<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> out_free<span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">goto</span> restart<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	skb_queue_tail<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>other<span style="color: #339933;">-&gt;</span>receive_queue<span style="color: #339933;">,</span> skb<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//挂入队列</span>
	unix_state_runlock<span style="color: #009900;">(</span>other<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	other<span style="color: #339933;">-&gt;</span>data_ready<span style="color: #009900;">(</span>other<span style="color: #339933;">,</span> len<span style="color: #009900;">)</span><span style="color: #339933;">;</span>		<span style="color: #666666; font-style: italic;">//其他唤醒等处理</span>
	sock_put<span style="color: #009900;">(</span>other<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> len<span style="color: #339933;">;</span>
&nbsp;
out_unlock<span style="color: #339933;">:</span>
	unix_state_runlock<span style="color: #009900;">(</span>other<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
out_free<span style="color: #339933;">:</span>
	kfree_skb<span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
out<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>other<span style="color: #009900;">)</span>
		sock_put<span style="color: #009900;">(</span>other<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> err<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>对于有连接模式，函数最终要调用的是<span style="font-family: 'Times New Roman';">unix_stream_sendmsg()</span><span style="font-family: 宋体;">函数，定义在</span><span style="font-family: 'Times New Roman';">af_unix.c</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=730&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p73012"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
</pre></td> 
              <td class="code" id="p730code12"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">int</span> unix_stream_sendmsg<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> socket <span style="color: #339933;">*</span>sock<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> msghdr <span style="color: #339933;">*</span>msg<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> len<span style="color: #339933;">,</span>
			       <span style="color: #993333;">struct</span> scm_cookie <span style="color: #339933;">*</span>scm<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> sock <span style="color: #339933;">*</span>sk <span style="color: #339933;">=</span> sock<span style="color: #339933;">-&gt;</span>sk<span style="color: #339933;">;</span>
	unix_socket <span style="color: #339933;">*</span>other <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> sockaddr_un <span style="color: #339933;">*</span>sunaddr<span style="color: #339933;">=</span>msg<span style="color: #339933;">-&gt;</span>msg_name<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> err<span style="color: #339933;">,</span>size<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> sk_buff <span style="color: #339933;">*</span>skb<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> limit<span style="color: #339933;">=</span><span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> sent<span style="color: #339933;">=</span><span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
	err <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EOPNOTSUPP<span style="color: #339933;">;</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *UNIX域的有连接模式也不支持OOB报文
　　 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>msg<span style="color: #339933;">-&gt;</span>msg_flags<span style="color: #339933;">&amp;</span>MSG_OOB<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out_err<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>msg<span style="color: #339933;">-&gt;</span>msg_namelen<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		err <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>sk<span style="color: #339933;">-&gt;</span>state<span style="color: #339933;">==</span>TCP_ESTABLISHED <span style="color: #339933;">?</span> <span style="color: #339933;">-</span>EISCONN <span style="color: #339933;">:</span> <span style="color: #339933;">-</span>EOPNOTSUPP<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> out_err<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
		sunaddr <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
		err <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ENOTCONN<span style="color: #339933;">;</span>
		other <span style="color: #339933;">=</span> unix_peer_get<span style="color: #009900;">(</span>sk<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>other<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> out_err<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>sk<span style="color: #339933;">-&gt;</span>shutdown<span style="color: #339933;">&amp;</span>SEND_SHUTDOWN<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> pipe_err<span style="color: #339933;">;</span>
&nbsp;
　　<span style="color: #808080; font-style: italic;">/*
　　 *有连接模式和无连接模式不一样，无连接模式下发送报文需要保持边界
　　 *超过限制的报文发送不过去，而有连接模式下的报文是可以循环发送的
　　 *为了保证效率，发送的时候将报文分割，普通情况下分割为sk-&gt;sndbuf
　　 *的一半，还有16字节保留用于头部结构，这样的话可以保证发送方在
　　 *准备后一半的时候接收方就在接收前一半了，但是如果有时候一半还是
　　 *太大，还是分配不到缓冲区，那么就分配一块更小的缓冲区，大小为一个
　　 *页面，如果还不行的话就只能睡眠等待或者宣告失败了
　　 */</span>
	<span style="color: #b1b100;">while</span><span style="color: #009900;">(</span>sent <span style="color: #339933;">&lt;</span> len<span style="color: #009900;">)</span>
	<span style="color: #009900;">{</span>
		<span style="color: #808080; font-style: italic;">/*
		 *	Optimisation for the fact that under 0.01% of X messages typically
		 *	need breaking up.
		 */</span>
&nbsp;
		size<span style="color: #339933;">=</span>len<span style="color: #339933;">-</span>sent<span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/* Keep two messages in the pipe so it schedules better */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>size <span style="color: #339933;">&gt;</span> sk<span style="color: #339933;">-&gt;</span>sndbuf<span style="color: #339933;">/</span><span style="color: #0000dd;">2</span> <span style="color: #339933;">-</span> <span style="color: #0000dd;">16</span><span style="color: #009900;">)</span>
			size <span style="color: #339933;">=</span> sk<span style="color: #339933;">-&gt;</span>sndbuf<span style="color: #339933;">/</span><span style="color: #0000dd;">2</span> <span style="color: #339933;">-</span> <span style="color: #0000dd;">16</span><span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/*
		 *	Keep to page sized kmalloc()'s as various people
		 *	have suggested. Big mallocs stress the vm too
		 *	much.
		 */</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>size <span style="color: #339933;">&gt;</span> PAGE_SIZE<span style="color: #339933;">-</span><span style="color: #0000dd;">16</span><span style="color: #009900;">)</span>
			limit <span style="color: #339933;">=</span> PAGE_SIZE<span style="color: #339933;">-</span><span style="color: #0000dd;">16</span><span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* Fall back to a page if we can't grab a big buffer this instant */</span>
		<span style="color: #b1b100;">else</span>
			limit <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Otherwise just grab and wait */</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/*
		 *	Grab a buffer
		 */</span>
&nbsp;
		skb<span style="color: #339933;">=</span>sock_alloc_send_skb<span style="color: #009900;">(</span>sk<span style="color: #339933;">,</span>size<span style="color: #339933;">,</span>limit<span style="color: #339933;">,</span>msg<span style="color: #339933;">-&gt;</span>msg_flags<span style="color: #339933;">&amp;</span>MSG_DONTWAIT<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>err<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>skb<span style="color: #339933;">==</span>NULL<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> out_err<span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/*
		 *	If you pass two values to the sock_alloc_send_skb
		 *	it tries to grab the large buffer with GFP_BUFFER
		 *	(which can fail easily), and if it fails grab the
		 *	fallback size buffer which is under a page and will
		 *	succeed. [Alan]
		 */</span>
		size <span style="color: #339933;">=</span> min<span style="color: #009900;">(</span>size<span style="color: #339933;">,</span> skb_tailroom<span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
		memcpy<span style="color: #009900;">(</span>UNIXCREDS<span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>scm<span style="color: #339933;">-&gt;</span>creds<span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> ucred<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>scm<span style="color: #339933;">-&gt;</span>fp<span style="color: #009900;">)</span>
			unix_attach_fds<span style="color: #009900;">(</span>scm<span style="color: #339933;">,</span> skb<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>err <span style="color: #339933;">=</span> memcpy_fromiovec<span style="color: #009900;">(</span>skb_put<span style="color: #009900;">(</span>skb<span style="color: #339933;">,</span>size<span style="color: #009900;">)</span><span style="color: #339933;">,</span> msg<span style="color: #339933;">-&gt;</span>msg_iov<span style="color: #339933;">,</span> size<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			kfree_skb<span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">goto</span> out_err<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
&nbsp;
		unix_state_rlock<span style="color: #009900;">(</span>other<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>other<span style="color: #339933;">-&gt;</span>dead <span style="color: #339933;">||</span> <span style="color: #009900;">(</span>other<span style="color: #339933;">-&gt;</span>shutdown <span style="color: #339933;">&amp;</span> RCV_SHUTDOWN<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> pipe_err_free<span style="color: #339933;">;</span>
&nbsp;
		skb_queue_tail<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>other<span style="color: #339933;">-&gt;</span>receive_queue<span style="color: #339933;">,</span> skb<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		unix_state_runlock<span style="color: #009900;">(</span>other<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		other<span style="color: #339933;">-&gt;</span>data_ready<span style="color: #009900;">(</span>other<span style="color: #339933;">,</span> size<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		sent<span style="color: #339933;">+=</span>size<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	sock_put<span style="color: #009900;">(</span>other<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> sent<span style="color: #339933;">;</span>
&nbsp;
pipe_err_free<span style="color: #339933;">:</span>
	unix_state_runlock<span style="color: #009900;">(</span>other<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	kfree_skb<span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
pipe_err<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>sent<span style="color: #339933;">==</span><span style="color: #0000dd;">0</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span><span style="color: #009900;">(</span>msg<span style="color: #339933;">-&gt;</span>msg_flags<span style="color: #339933;">&amp;</span>MSG_NOSIGNAL<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		send_sig<span style="color: #009900;">(</span>SIGPIPE<span style="color: #339933;">,</span>current<span style="color: #339933;">,</span><span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	err <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EPIPE<span style="color: #339933;">;</span>
out_err<span style="color: #339933;">:</span>
        <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>other<span style="color: #009900;">)</span>
		sock_put<span style="color: #009900;">(</span>other<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> sent <span style="color: #339933;">?</span> <span style="color: #339933;">:</span> err<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>分配缓冲区空间函数<span style="font-family: 'Times New Roman';">sock_alloc_send_skb()</span><span style="font-family: 宋体;">在</span><span style="font-family: 'Times New Roman';">net/core/sock.c</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=730&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p73013"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre></td> 
              <td class="code" id="p730code13"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> sk_buff <span style="color: #339933;">*</span>sock_alloc_send_skb<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> sock <span style="color: #339933;">*</span>sk<span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> size<span style="color: #339933;">,</span> 
			<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> fallback<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> noblock<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> <span style="color: #339933;">*</span>errcode<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span> err<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> sk_buff <span style="color: #339933;">*</span>skb<span style="color: #339933;">;</span>
	<span style="color: #993333;">long</span> timeo<span style="color: #339933;">;</span>
&nbsp;
	timeo <span style="color: #339933;">=</span> sock_sndtimeo<span style="color: #009900;">(</span>sk<span style="color: #339933;">,</span> noblock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> try_size <span style="color: #339933;">=</span> size<span style="color: #339933;">;</span>
&nbsp;
		err <span style="color: #339933;">=</span> sock_error<span style="color: #009900;">(</span>sk<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>err <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> failure<span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/*
		 *	We should send SIGPIPE in these cases according to
		 *	1003.1g draft 6.4. If we (the user) did a shutdown()
		 *	call however we should not. 
		 *
		 *	Note: This routine isnt just used for datagrams and
		 *	anyway some datagram protocols have a notion of
		 *	close down.
		 */</span>
&nbsp;
		err <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EPIPE<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>sk<span style="color: #339933;">-&gt;</span>shutdown<span style="color: #339933;">&amp;</span>SEND_SHUTDOWN<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> failure<span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>atomic_read<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>sk<span style="color: #339933;">-&gt;</span>wmem_alloc<span style="color: #009900;">)</span> <span style="color: #339933;">&lt;</span> sk<span style="color: #339933;">-&gt;</span>sndbuf<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>fallback<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				<span style="color: #808080; font-style: italic;">/* The buffer get won't block, or use the atomic queue.
			 	* It does produce annoying no free page messages still.
			 	*/</span>
				skb <span style="color: #339933;">=</span> alloc_skb<span style="color: #009900;">(</span>size<span style="color: #339933;">,</span> GFP_BUFFER<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span>
					<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
				try_size <span style="color: #339933;">=</span> fallback<span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			skb <span style="color: #339933;">=</span> alloc_skb<span style="color: #009900;">(</span>try_size<span style="color: #339933;">,</span> sk<span style="color: #339933;">-&gt;</span>allocation<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			err <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ENOBUFS<span style="color: #339933;">;</span>
			<span style="color: #b1b100;">goto</span> failure<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/*
		 *	This means we have too many buffers for this socket already.
		 */</span>
&nbsp;
		set_bit<span style="color: #009900;">(</span>SOCK_ASYNC_NOSPACE<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>sk<span style="color: #339933;">-&gt;</span>socket<span style="color: #339933;">-&gt;</span>flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		set_bit<span style="color: #009900;">(</span>SOCK_NOSPACE<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>sk<span style="color: #339933;">-&gt;</span>socket<span style="color: #339933;">-&gt;</span>flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		err <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EAGAIN<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>timeo<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> failure<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>signal_pending<span style="color: #009900;">(</span>current<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> interrupted<span style="color: #339933;">;</span>
		timeo <span style="color: #339933;">=</span> sock_wait_for_wmem<span style="color: #009900;">(</span>sk<span style="color: #339933;">,</span> timeo<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	skb_set_owner_w<span style="color: #009900;">(</span>skb<span style="color: #339933;">,</span> sk<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> skb<span style="color: #339933;">;</span>
&nbsp;
interrupted<span style="color: #339933;">:</span>
	err <span style="color: #339933;">=</span> sock_intr_errno<span style="color: #009900;">(</span>timeo<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
failure<span style="color: #339933;">:</span>
	<span style="color: #339933;">*</span>errcode <span style="color: #339933;">=</span> err<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> NULL<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>函数先试着按<span style="font-family: 'Times New Roman';">size</span><span style="font-family: 宋体;">大小分配空间，优先级为</span><span style="font-family: 'Times New Roman';">GFP_BUFFER</span><span style="font-family: 宋体;">。如果行就</span><span style="font-family: 'Times New Roman';">OK</span><span style="font-family: 宋体;">了，否则就看参数</span><span style="font-family: 'Times New Roman';">fallback</span><span style="font-family: 宋体;">，要是</span><span style="font-family: 'Times New Roman';">fallback</span><span style="font-family: 宋体;">为</span><span style="font-family: 'Times New Roman';">0</span><span style="font-family: 宋体;">，那就或者通过</span><span style="font-family: 'Times New Roman';">sock_wait_for_wmem()</span><span style="font-family: 宋体;">睡眠，或者失败返回，要看</span><span style="font-family: 'Times New Roman';">noblock</span><span style="font-family: 宋体;">参数，要是</span><span style="font-family: 'Times New Roman';">fallback</span><span style="font-family: 宋体;">为非</span><span style="font-family: 'Times New Roman';">0</span><span style="font-family: 宋体;">的话那就按照</span><span style="font-family: 'Times New Roman';">fallback</span><span style="font-family: 宋体;">大小再分配一次，这次大小为</span><span style="font-family: 'Times New Roman';">sk-&gt;allocation</span><span style="font-family: 宋体;">，通常比</span><span style="font-family: 'Times New Roman';">GFP_BUFFER</span><span style="font-family: 宋体;">高，如果再失败那就只能睡眠等待或者失败返回了。</span></p> 
          <p>具体的缓冲区分配函数是由<span style="font-family: 'Times New Roman';">sock_wmalloc()</span><span style="font-family: 宋体;">函数分配的，定义在</span><span style="font-family: 'Times New Roman';">net/core/sock.c</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=730&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p73014"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td> 
              <td class="code" id="p730code14"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> sk_buff <span style="color: #339933;">*</span>sock_wmalloc<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> sock <span style="color: #339933;">*</span>sk<span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> size<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> force<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> priority<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>force <span style="color: #339933;">||</span> atomic_read<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>sk<span style="color: #339933;">-&gt;</span>wmem_alloc<span style="color: #009900;">)</span> <span style="color: #339933;">&lt;</span> sk<span style="color: #339933;">-&gt;</span>sndbuf<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">struct</span> sk_buff <span style="color: #339933;">*</span> skb <span style="color: #339933;">=</span> alloc_skb<span style="color: #009900;">(</span>size<span style="color: #339933;">,</span> priority<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			skb_set_owner_w<span style="color: #009900;">(</span>skb<span style="color: #339933;">,</span> sk<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">return</span> skb<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">return</span> NULL<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>函数<span style="font-family: 'Times New Roman';">skb_set_owner_w()</span><span style="font-family: 宋体;">定义在</span><span style="font-family: 'Times New Roman';">include/net/sock.h</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=730&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p73015"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
</pre></td> 
              <td class="code" id="p730code15"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #000000; font-weight: bold;">inline</span> <span style="color: #993333;">void</span> skb_set_owner_w<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> sk_buff <span style="color: #339933;">*</span>skb<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> sock <span style="color: #339933;">*</span>sk<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	sock_hold<span style="color: #009900;">(</span>sk<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	skb<span style="color: #339933;">-&gt;</span>sk <span style="color: #339933;">=</span> sk<span style="color: #339933;">;</span>
	skb<span style="color: #339933;">-&gt;</span>destructor <span style="color: #339933;">=</span> sock_wfree<span style="color: #339933;">;</span>
	atomic_add<span style="color: #009900;">(</span>skb<span style="color: #339933;">-&gt;</span>truesize<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>sk<span style="color: #339933;">-&gt;</span>wmem_alloc<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>主要就是设置了一些函数指针，不多说了。</p> 
          <h2>报文的接收：</h2> 
          <p>同发送一样，在用户接口上，报文的接收也是有如下几个函数：<span style="font-family: 'Times New Roman';">recv()</span><span style="font-family: 宋体;">、</span><span style="font-family: 'Times New Roman';">recvfrom()</span><span style="font-family: 宋体;">、</span><span style="font-family: 'Times New Roman';">recvmsg()</span><span style="font-family: 宋体;">，它们的主要入口函数都是</span><span style="font-family: 'Times New Roman';">sock_recvmsg()</span><span style="font-family: 宋体;">。</span></p> 
          <p>这里列出函数和部分注释，就不详说了，主要的接收函数在上篇中讲过了，对于无连接模式，主要调用函数是<span style="font-family: 'Times New Roman';">unix_dgram_recvmsg()</span><span style="font-family: 宋体;">，对于有连接模式来说，主要调用函数是</span><span style="font-family: 'Times New Roman';">unix_stream_recvmsg()</span><span style="font-family: 宋体;">。</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=730&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p73016"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
</pre></td> 
              <td class="code" id="p730code16"><pre class="c" style="font-family:monospace;">asmlinkage <span style="color: #993333;">long</span> sys_recvfrom<span style="color: #009900;">(</span><span style="color: #993333;">int</span> fd<span style="color: #339933;">,</span> <span style="color: #993333;">void</span> <span style="color: #339933;">*</span> ubuf<span style="color: #339933;">,</span> size_t size<span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> flags<span style="color: #339933;">,</span>
			     <span style="color: #993333;">struct</span> sockaddr <span style="color: #339933;">*</span>addr<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> <span style="color: #339933;">*</span>addr_len<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> socket <span style="color: #339933;">*</span>sock<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> iovec iov<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> msghdr msg<span style="color: #339933;">;</span>
	<span style="color: #993333;">char</span> address<span style="color: #009900;">[</span>MAX_SOCK_ADDR<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> err<span style="color: #339933;">,</span>err2<span style="color: #339933;">;</span>
&nbsp;
	sock <span style="color: #339933;">=</span> sockfd_lookup<span style="color: #009900;">(</span>fd<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>err<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>sock<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
&nbsp;
	msg.<span style="color: #202020;">msg_control</span><span style="color: #339933;">=</span>NULL<span style="color: #339933;">;</span>
	msg.<span style="color: #202020;">msg_controllen</span><span style="color: #339933;">=</span><span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	msg.<span style="color: #202020;">msg_iovlen</span><span style="color: #339933;">=</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	msg.<span style="color: #202020;">msg_iov</span><span style="color: #339933;">=&amp;</span>iov<span style="color: #339933;">;</span>
	iov.<span style="color: #202020;">iov_len</span><span style="color: #339933;">=</span>size<span style="color: #339933;">;</span>
	iov.<span style="color: #202020;">iov_base</span><span style="color: #339933;">=</span>ubuf<span style="color: #339933;">;</span>
	msg.<span style="color: #202020;">msg_name</span><span style="color: #339933;">=</span>address<span style="color: #339933;">;</span>
	msg.<span style="color: #202020;">msg_namelen</span><span style="color: #339933;">=</span>MAX_SOCK_ADDR<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>sock<span style="color: #339933;">-&gt;</span>file<span style="color: #339933;">-&gt;</span>f_flags <span style="color: #339933;">&amp;</span> O_NONBLOCK<span style="color: #009900;">)</span>
		flags <span style="color: #339933;">|=</span> MSG_DONTWAIT<span style="color: #339933;">;</span>
	err<span style="color: #339933;">=</span>sock_recvmsg<span style="color: #009900;">(</span>sock<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>msg<span style="color: #339933;">,</span> size<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span><span style="color: #009900;">(</span>err <span style="color: #339933;">&gt;=</span> <span style="color: #0000dd;">0</span> <span style="color: #339933;">&amp;&amp;</span> addr <span style="color: #339933;">!=</span> NULL <span style="color: #339933;">&amp;&amp;</span> msg.<span style="color: #202020;">msg_namelen</span><span style="color: #009900;">)</span>
	<span style="color: #009900;">{</span>
		err2<span style="color: #339933;">=</span>move_addr_to_user<span style="color: #009900;">(</span>address<span style="color: #339933;">,</span> msg.<span style="color: #202020;">msg_namelen</span><span style="color: #339933;">,</span> addr<span style="color: #339933;">,</span> addr_len<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span><span style="color: #009900;">(</span>err2<span style="color: #339933;">&lt;</span><span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
			err<span style="color: #339933;">=</span>err2<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	sockfd_put<span style="color: #009900;">(</span>sock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>			
out<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">return</span> err<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #993333;">int</span> sock_recvmsg<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> socket <span style="color: #339933;">*</span>sock<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> msghdr <span style="color: #339933;">*</span>msg<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> size<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> flags<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> scm_cookie scm<span style="color: #339933;">;</span>
&nbsp;
	memset<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>scm<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span>scm<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	size <span style="color: #339933;">=</span> sock<span style="color: #339933;">-&gt;</span>ops<span style="color: #339933;">-&gt;</span>recvmsg<span style="color: #009900;">(</span>sock<span style="color: #339933;">,</span> msg<span style="color: #339933;">,</span> size<span style="color: #339933;">,</span> flags<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>scm<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//接受</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>size <span style="color: #339933;">&gt;=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
		scm_recv<span style="color: #009900;">(</span>sock<span style="color: #339933;">,</span> msg<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>scm<span style="color: #339933;">,</span> flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//处理附加信息</span>
&nbsp;
	<span style="color: #b1b100;">return</span> size<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #993333;">static</span> <span style="color: #993333;">int</span> unix_dgram_recvmsg<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> socket <span style="color: #339933;">*</span>sock<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> msghdr <span style="color: #339933;">*</span>msg<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> size<span style="color: #339933;">,</span>
			      <span style="color: #993333;">int</span> flags<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> scm_cookie <span style="color: #339933;">*</span>scm<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> sock <span style="color: #339933;">*</span>sk <span style="color: #339933;">=</span> sock<span style="color: #339933;">-&gt;</span>sk<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> noblock <span style="color: #339933;">=</span> flags <span style="color: #339933;">&amp;</span> MSG_DONTWAIT<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> sk_buff <span style="color: #339933;">*</span>skb<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> err<span style="color: #339933;">;</span>
&nbsp;
	err <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EOPNOTSUPP<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>flags<span style="color: #339933;">&amp;</span>MSG_OOB<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
&nbsp;
	msg<span style="color: #339933;">-&gt;</span>msg_namelen <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
	skb <span style="color: #339933;">=</span> skb_recv_datagram<span style="color: #009900;">(</span>sk<span style="color: #339933;">,</span> flags<span style="color: #339933;">,</span> noblock<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>err<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//接收报文</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>skb<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
&nbsp;
	wake_up_interruptible<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>sk<span style="color: #339933;">-&gt;</span>protinfo.<span style="color: #202020;">af_unix</span>.<span style="color: #202020;">peer_wait</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>msg<span style="color: #339933;">-&gt;</span>msg_name<span style="color: #009900;">)</span>
		unix_copy_addr<span style="color: #009900;">(</span>msg<span style="color: #339933;">,</span> skb<span style="color: #339933;">-&gt;</span>sk<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//copy地址</span>
&nbsp;
　　<span style="color: #666666; font-style: italic;">//处理接收长度</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>size <span style="color: #339933;">&gt;</span> skb<span style="color: #339933;">-&gt;</span>len<span style="color: #009900;">)</span>
		size <span style="color: #339933;">=</span> skb<span style="color: #339933;">-&gt;</span>len<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>size <span style="color: #339933;">&lt;</span> skb<span style="color: #339933;">-&gt;</span>len<span style="color: #009900;">)</span>
		msg<span style="color: #339933;">-&gt;</span>msg_flags <span style="color: #339933;">|=</span> MSG_TRUNC<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//报文被截尾了</span>
&nbsp;
	err <span style="color: #339933;">=</span> skb_copy_datagram_iovec<span style="color: #009900;">(</span>skb<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> msg<span style="color: #339933;">-&gt;</span>msg_iov<span style="color: #339933;">,</span> size<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//copy数据</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>err<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out_free<span style="color: #339933;">;</span>
&nbsp;
	scm<span style="color: #339933;">-&gt;</span>creds <span style="color: #339933;">=</span> <span style="color: #339933;">*</span>UNIXCREDS<span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//copy附加信息</span>
&nbsp;
　　<span style="color: #808080; font-style: italic;">/*
　　 *如果sk_buff载送着对已打开文件的访问授权的话，一个进程把它的已打开
　　 *文件的访问权发送给另一个进程的时候，要把对这些文件的访问权的描绘
　　 *也接收下来，若已打开文件代表着UNIX域插口，发送者要为每个这样的
　　 *文件记下一笔帐，说明使用权正在传送中，而这里的接收进程要负责“销帐”
　　 *用户进程可以将MSG_PEEK标志置成1，表示“偷看”，并不实际接收，
　　 *所以如果MSG_PEEK为0的话表示正式接收，需要调用函数unix_detach_fds()
　　 *来进行“销帐”，否则就直接复制一份scm_fp_list结构
　　 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span><span style="color: #009900;">(</span>flags <span style="color: #339933;">&amp;</span> MSG_PEEK<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
	<span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>UNIXCB<span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span>.<span style="color: #202020;">fp</span><span style="color: #009900;">)</span>
			unix_detach_fds<span style="color: #009900;">(</span>scm<span style="color: #339933;">,</span> skb<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">else</span> 
	<span style="color: #009900;">{</span>
		<span style="color: #808080; font-style: italic;">/* It is questionable: on PEEK we could:
		   - do not return fds - good, but too simple 8)
		   - return fds, and do not return them on read (old strategy,
		     apparently wrong)
		   - clone fds (I choosed it for now, it is the most universal
		     solution)
&nbsp;
	           POSIX 1003.1g does not actually define this clearly
	           at all. POSIX 1003.1g doesn't define a lot of things
	           clearly however!		     
&nbsp;
		*/</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>UNIXCB<span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span>.<span style="color: #202020;">fp</span><span style="color: #009900;">)</span>
			scm<span style="color: #339933;">-&gt;</span>fp <span style="color: #339933;">=</span> scm_fp_dup<span style="color: #009900;">(</span>UNIXCB<span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span>.<span style="color: #202020;">fp</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	err <span style="color: #339933;">=</span> size<span style="color: #339933;">;</span>
&nbsp;
out_free<span style="color: #339933;">:</span>
	skb_free_datagram<span style="color: #009900;">(</span>sk<span style="color: #339933;">,</span>skb<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
out<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">return</span> err<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #993333;">static</span> <span style="color: #993333;">void</span> unix_detach_fds<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> scm_cookie <span style="color: #339933;">*</span>scm<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> sk_buff <span style="color: #339933;">*</span>skb<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span> i<span style="color: #339933;">;</span>
&nbsp;
	scm<span style="color: #339933;">-&gt;</span>fp <span style="color: #339933;">=</span> UNIXCB<span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span>.<span style="color: #202020;">fp</span><span style="color: #339933;">;</span>
	skb<span style="color: #339933;">-&gt;</span>destructor <span style="color: #339933;">=</span> sock_wfree<span style="color: #339933;">;</span>
	UNIXCB<span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span>.<span style="color: #202020;">fp</span> <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>i<span style="color: #339933;">=</span>scm<span style="color: #339933;">-&gt;</span>fp<span style="color: #339933;">-&gt;</span>count<span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span> i<span style="color: #339933;">&gt;=</span><span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> i<span style="color: #339933;">--</span><span style="color: #009900;">)</span>
		unix_notinflight<span style="color: #009900;">(</span>scm<span style="color: #339933;">-&gt;</span>fp<span style="color: #339933;">-&gt;</span>fp<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span>
<span style="color: #993333;">void</span> unix_notinflight<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span>fp<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	unix_socket <span style="color: #339933;">*</span>s<span style="color: #339933;">=</span>unix_get_socket<span style="color: #009900;">(</span>fp<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span><span style="color: #009900;">(</span>s<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		atomic_dec<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>s<span style="color: #339933;">-&gt;</span>protinfo.<span style="color: #202020;">af_unix</span>.<span style="color: #202020;">inflight</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		atomic_dec<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>unix_tot_inflight<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">extern</span> <span style="color: #000000; font-weight: bold;">inline</span> unix_socket <span style="color: #339933;">*</span>unix_get_socket<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span>filp<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	unix_socket <span style="color: #339933;">*</span> u_sock <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span>inode <span style="color: #339933;">=</span> filp<span style="color: #339933;">-&gt;</span>f_dentry<span style="color: #339933;">-&gt;</span>d_inode<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 *	Socket ?
	 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>inode<span style="color: #339933;">-&gt;</span>i_sock<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">struct</span> socket <span style="color: #339933;">*</span> sock <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>inode<span style="color: #339933;">-&gt;</span>u.<span style="color: #202020;">socket_i</span><span style="color: #339933;">;</span>
		<span style="color: #993333;">struct</span> sock <span style="color: #339933;">*</span> s <span style="color: #339933;">=</span> sock<span style="color: #339933;">-&gt;</span>sk<span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/*
		 *	PF_UNIX ?
		 */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>s <span style="color: #339933;">&amp;&amp;</span> sock<span style="color: #339933;">-&gt;</span>ops <span style="color: #339933;">&amp;&amp;</span> sock<span style="color: #339933;">-&gt;</span>ops<span style="color: #339933;">-&gt;</span>family <span style="color: #339933;">==</span> PF_UNIX<span style="color: #009900;">)</span>
			u_sock <span style="color: #339933;">=</span> s<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">return</span> u_sock<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #993333;">static</span> __inline__ <span style="color: #993333;">void</span> scm_recv<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> socket <span style="color: #339933;">*</span>sock<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> msghdr <span style="color: #339933;">*</span>msg<span style="color: #339933;">,</span>
				<span style="color: #993333;">struct</span> scm_cookie <span style="color: #339933;">*</span>scm<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> flags<span style="color: #009900;">)</span>
<span style="color: #666666; font-style: italic;">//此函数用于处理附加信息</span>
<span style="color: #009900;">{</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>msg<span style="color: #339933;">-&gt;</span>msg_control<span style="color: #009900;">)</span>
	<span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>sock<span style="color: #339933;">-&gt;</span>passcred <span style="color: #339933;">||</span> scm<span style="color: #339933;">-&gt;</span>fp<span style="color: #009900;">)</span>
			msg<span style="color: #339933;">-&gt;</span>msg_flags <span style="color: #339933;">|=</span> MSG_CTRUNC<span style="color: #339933;">;</span>
		scm_destroy<span style="color: #009900;">(</span>scm<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//无控制信息缓冲区，直接销毁</span>
		<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
　　<span style="color: #666666; font-style: italic;">//将对方身份信息递交到用户空间</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>sock<span style="color: #339933;">-&gt;</span>passcred<span style="color: #009900;">)</span>
		put_cmsg<span style="color: #009900;">(</span>msg<span style="color: #339933;">,</span> SOL_SOCKET<span style="color: #339933;">,</span> SCM_CREDENTIALS<span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span>scm<span style="color: #339933;">-&gt;</span>creds<span style="color: #009900;">)</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>scm<span style="color: #339933;">-&gt;</span>creds<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>scm<span style="color: #339933;">-&gt;</span>fp<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
	<span style="color: #808080; font-style: italic;">/*
 	 *对已打开的文件访问授权，要将已经打开的文件纳入自己的已打开文件表中
　　 */</span>
	scm_detach_fds<span style="color: #009900;">(</span>msg<span style="color: #339933;">,</span> scm<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #993333;">void</span> scm_detach_fds<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> msghdr <span style="color: #339933;">*</span>msg<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> scm_cookie <span style="color: #339933;">*</span>scm<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> cmsghdr <span style="color: #339933;">*</span>cm <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> cmsghdr<span style="color: #339933;">*</span><span style="color: #009900;">)</span>msg<span style="color: #339933;">-&gt;</span>msg_control<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #993333;">int</span> fdmax <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> fdnum <span style="color: #339933;">=</span> scm<span style="color: #339933;">-&gt;</span>fp<span style="color: #339933;">-&gt;</span>count<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> file <span style="color: #339933;">**</span>fp <span style="color: #339933;">=</span> scm<span style="color: #339933;">-&gt;</span>fp<span style="color: #339933;">-&gt;</span>fp<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> <span style="color: #339933;">*</span>cmfptr<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> err <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> i<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>msg<span style="color: #339933;">-&gt;</span>msg_controllen <span style="color: #339933;">&gt;</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> cmsghdr<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		fdmax <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>msg<span style="color: #339933;">-&gt;</span>msg_controllen <span style="color: #339933;">-</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> cmsghdr<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			 <span style="color: #339933;">/</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">int</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>fdnum <span style="color: #339933;">&lt;</span> fdmax<span style="color: #009900;">)</span>
		fdmax <span style="color: #339933;">=</span> fdnum<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>i<span style="color: #339933;">=</span><span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> cmfptr<span style="color: #339933;">=</span><span style="color: #009900;">(</span><span style="color: #993333;">int</span><span style="color: #339933;">*</span><span style="color: #009900;">)</span>CMSG_DATA<span style="color: #009900;">(</span>cm<span style="color: #009900;">)</span><span style="color: #339933;">;</span> i<span style="color: #339933;">&lt;</span>fdmax<span style="color: #339933;">;</span> i<span style="color: #339933;">++,</span> cmfptr<span style="color: #339933;">++</span><span style="color: #009900;">)</span>
	<span style="color: #009900;">{</span>
		<span style="color: #993333;">int</span> new_fd<span style="color: #339933;">;</span>
		err <span style="color: #339933;">=</span> get_unused_fd<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>err <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		new_fd <span style="color: #339933;">=</span> err<span style="color: #339933;">;</span>
		err <span style="color: #339933;">=</span> put_user<span style="color: #009900;">(</span>new_fd<span style="color: #339933;">,</span> cmfptr<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>err<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			put_unused_fd<span style="color: #009900;">(</span>new_fd<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		<span style="color: #808080; font-style: italic;">/* Bump the usage count and install the file. */</span>
		get_file<span style="color: #009900;">(</span>fp<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		fd_install<span style="color: #009900;">(</span>new_fd<span style="color: #339933;">,</span> fp<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>i <span style="color: #339933;">&gt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
	<span style="color: #009900;">{</span>
		<span style="color: #993333;">int</span> cmlen <span style="color: #339933;">=</span> CMSG_LEN<span style="color: #009900;">(</span>i<span style="color: #339933;">*</span><span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">int</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>err<span style="color: #009900;">)</span>
			err <span style="color: #339933;">=</span> put_user<span style="color: #009900;">(</span>SOL_SOCKET<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>cm<span style="color: #339933;">-&gt;</span>cmsg_level<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>err<span style="color: #009900;">)</span>
			err <span style="color: #339933;">=</span> put_user<span style="color: #009900;">(</span>SCM_RIGHTS<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>cm<span style="color: #339933;">-&gt;</span>cmsg_type<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>err<span style="color: #009900;">)</span>
			err <span style="color: #339933;">=</span> put_user<span style="color: #009900;">(</span>cmlen<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>cm<span style="color: #339933;">-&gt;</span>cmsg_len<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>err<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			cmlen <span style="color: #339933;">=</span> CMSG_SPACE<span style="color: #009900;">(</span>i<span style="color: #339933;">*</span><span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">int</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			msg<span style="color: #339933;">-&gt;</span>msg_control <span style="color: #339933;">+=</span> cmlen<span style="color: #339933;">;</span>
			msg<span style="color: #339933;">-&gt;</span>msg_controllen <span style="color: #339933;">-=</span> cmlen<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>i <span style="color: #339933;">&lt;</span> fdnum <span style="color: #339933;">||</span> <span style="color: #009900;">(</span>fdnum <span style="color: #339933;">&amp;&amp;</span> fdmax <span style="color: #339933;">&lt;=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		msg<span style="color: #339933;">-&gt;</span>msg_flags <span style="color: #339933;">|=</span> MSG_CTRUNC<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * All of the files that fit in the message have had their
	 * usage counts incremented, so we just free the list.
	 */</span>
	__scm_destroy<span style="color: #009900;">(</span>scm<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #993333;">static</span> <span style="color: #993333;">int</span> unix_stream_recvmsg<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> socket <span style="color: #339933;">*</span>sock<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> msghdr <span style="color: #339933;">*</span>msg<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> size<span style="color: #339933;">,</span>
			       <span style="color: #993333;">int</span> flags<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> scm_cookie <span style="color: #339933;">*</span>scm<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> sock <span style="color: #339933;">*</span>sk <span style="color: #339933;">=</span> sock<span style="color: #339933;">-&gt;</span>sk<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> sockaddr_un <span style="color: #339933;">*</span>sunaddr<span style="color: #339933;">=</span>msg<span style="color: #339933;">-&gt;</span>msg_name<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> copied <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> check_creds <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> target<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> err <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">long</span> timeo<span style="color: #339933;">;</span>
&nbsp;
	err <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EINVAL<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>sk<span style="color: #339933;">-&gt;</span>state <span style="color: #339933;">!=</span> TCP_ESTABLISHED<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
&nbsp;
	err <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EOPNOTSUPP<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>flags<span style="color: #339933;">&amp;</span>MSG_OOB<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
&nbsp;
	target <span style="color: #339933;">=</span> sock_rcvlowat<span style="color: #009900;">(</span>sk<span style="color: #339933;">,</span> flags<span style="color: #339933;">&amp;</span>MSG_WAITALL<span style="color: #339933;">,</span> size<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	timeo <span style="color: #339933;">=</span> sock_rcvtimeo<span style="color: #009900;">(</span>sk<span style="color: #339933;">,</span> flags<span style="color: #339933;">&amp;</span>MSG_DONTWAIT<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	msg<span style="color: #339933;">-&gt;</span>msg_namelen <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Lock the socket to prevent queue disordering
	 * while sleeps in memcpy_tomsg
	 */</span>
&nbsp;
	down<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>sk<span style="color: #339933;">-&gt;</span>protinfo.<span style="color: #202020;">af_unix</span>.<span style="color: #202020;">readsem</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">do</span>
	<span style="color: #009900;">{</span>
		<span style="color: #993333;">int</span> chunk<span style="color: #339933;">;</span>
		<span style="color: #993333;">struct</span> sk_buff <span style="color: #339933;">*</span>skb<span style="color: #339933;">;</span>
&nbsp;
		skb<span style="color: #339933;">=</span>skb_dequeue<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>sk<span style="color: #339933;">-&gt;</span>receive_queue<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>skb<span style="color: #339933;">==</span>NULL<span style="color: #009900;">)</span>
		<span style="color: #009900;">{</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>copied <span style="color: #339933;">&gt;=</span> target<span style="color: #009900;">)</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
&nbsp;
			<span style="color: #808080; font-style: italic;">/*
			 *	POSIX 1003.1g mandates this order.
			 */</span>
&nbsp;
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>err <span style="color: #339933;">=</span> sock_error<span style="color: #009900;">(</span>sk<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>sk<span style="color: #339933;">-&gt;</span>shutdown <span style="color: #339933;">&amp;</span> RCV_SHUTDOWN<span style="color: #009900;">)</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			err <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EAGAIN<span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>timeo<span style="color: #009900;">)</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			up<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>sk<span style="color: #339933;">-&gt;</span>protinfo.<span style="color: #202020;">af_unix</span>.<span style="color: #202020;">readsem</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
			timeo <span style="color: #339933;">=</span> unix_stream_data_wait<span style="color: #009900;">(</span>sk<span style="color: #339933;">,</span> timeo<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>signal_pending<span style="color: #009900;">(</span>current<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				err <span style="color: #339933;">=</span> sock_intr_errno<span style="color: #009900;">(</span>timeo<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			down<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>sk<span style="color: #339933;">-&gt;</span>protinfo.<span style="color: #202020;">af_unix</span>.<span style="color: #202020;">readsem</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>check_creds<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #808080; font-style: italic;">/* Never glue messages from different writers */</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>memcmp<span style="color: #009900;">(</span>UNIXCREDS<span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>scm<span style="color: #339933;">-&gt;</span>creds<span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span>scm<span style="color: #339933;">-&gt;</span>creds<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				skb_queue_head<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>sk<span style="color: #339933;">-&gt;</span>receive_queue<span style="color: #339933;">,</span> skb<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
		<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
			<span style="color: #808080; font-style: italic;">/* Copy credentials */</span>
			scm<span style="color: #339933;">-&gt;</span>creds <span style="color: #339933;">=</span> <span style="color: #339933;">*</span>UNIXCREDS<span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			check_creds <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/* Copy address just once */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>sunaddr<span style="color: #009900;">)</span>
		<span style="color: #009900;">{</span>
			unix_copy_addr<span style="color: #009900;">(</span>msg<span style="color: #339933;">,</span> skb<span style="color: #339933;">-&gt;</span>sk<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			sunaddr <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
&nbsp;
		chunk <span style="color: #339933;">=</span> min<span style="color: #009900;">(</span>skb<span style="color: #339933;">-&gt;</span>len<span style="color: #339933;">,</span> size<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>memcpy_toiovec<span style="color: #009900;">(</span>msg<span style="color: #339933;">-&gt;</span>msg_iov<span style="color: #339933;">,</span> skb<span style="color: #339933;">-&gt;</span>data<span style="color: #339933;">,</span> chunk<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			skb_queue_head<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>sk<span style="color: #339933;">-&gt;</span>receive_queue<span style="color: #339933;">,</span> skb<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>copied <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
				copied <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EFAULT<span style="color: #339933;">;</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		copied <span style="color: #339933;">+=</span> chunk<span style="color: #339933;">;</span>
		size <span style="color: #339933;">-=</span> chunk<span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/* Mark read part of skb as used */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span><span style="color: #009900;">(</span>flags <span style="color: #339933;">&amp;</span> MSG_PEEK<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #009900;">{</span>
			skb_pull<span style="color: #009900;">(</span>skb<span style="color: #339933;">,</span> chunk<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>UNIXCB<span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span>.<span style="color: #202020;">fp</span><span style="color: #009900;">)</span>
				unix_detach_fds<span style="color: #009900;">(</span>scm<span style="color: #339933;">,</span> skb<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
			<span style="color: #808080; font-style: italic;">/* put the skb back if we didn't use it up.. */</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>skb<span style="color: #339933;">-&gt;</span>len<span style="color: #009900;">)</span>
			<span style="color: #009900;">{</span>
				skb_queue_head<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>sk<span style="color: #339933;">-&gt;</span>receive_queue<span style="color: #339933;">,</span> skb<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
&nbsp;
			kfree_skb<span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>scm<span style="color: #339933;">-&gt;</span>fp<span style="color: #009900;">)</span>
				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		<span style="color: #b1b100;">else</span>
		<span style="color: #009900;">{</span>
			<span style="color: #808080; font-style: italic;">/* It is questionable, see note in unix_dgram_recvmsg.
			 */</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>UNIXCB<span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span>.<span style="color: #202020;">fp</span><span style="color: #009900;">)</span>
				scm<span style="color: #339933;">-&gt;</span>fp <span style="color: #339933;">=</span> scm_fp_dup<span style="color: #009900;">(</span>UNIXCB<span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span>.<span style="color: #202020;">fp</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
			<span style="color: #808080; font-style: italic;">/* put message back and return */</span>
			skb_queue_head<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>sk<span style="color: #339933;">-&gt;</span>receive_queue<span style="color: #339933;">,</span> skb<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span>size<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	up<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>sk<span style="color: #339933;">-&gt;</span>protinfo.<span style="color: #202020;">af_unix</span>.<span style="color: #202020;">readsem</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
out<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">return</span> copied <span style="color: #339933;">?</span> <span style="color: #339933;">:</span> err<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <h2>插口的关闭：</h2> 
          <p>插口的关闭是通过<span style="font-family: 'Times New Roman';">close()</span><span style="font-family: 宋体;">系统调用来实现的，最终调用</span><span style="font-family: 'Times New Roman';">sock_close()</span><span style="font-family: 宋体;">函数，定义在</span><span style="font-family: 'Times New Roman';">net/socket.c</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=730&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p73017"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td> 
              <td class="code" id="p730code17"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">int</span> sock_close<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span>inode<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span>filp<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #808080; font-style: italic;">/*
	 *	It was possible the inode is NULL we were 
	 *	closing an unfinished socket. 
	 */</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>inode<span style="color: #009900;">)</span>
	<span style="color: #009900;">{</span>
		printk<span style="color: #009900;">(</span>KERN_DEBUG <span style="color: #ff0000;">"sock_close: NULL inode<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	sock_fasync<span style="color: #009900;">(</span><span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> filp<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//释放fasync_list队列中的结构</span>
	sock_release<span style="color: #009900;">(</span>socki_lookup<span style="color: #009900;">(</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>函数<span style="font-family: 'Times New Roman';">sock_release()</span><span style="font-family: 宋体;">定义在</span><span style="font-family: 'Times New Roman';">socket.c</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=730&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p73018"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td> 
              <td class="code" id="p730code18"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">void</span> sock_release<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> socket <span style="color: #339933;">*</span>sock<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>sock<span style="color: #339933;">-&gt;</span>ops<span style="color: #009900;">)</span> 
		sock<span style="color: #339933;">-&gt;</span>ops<span style="color: #339933;">-&gt;</span>release<span style="color: #009900;">(</span>sock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>sock<span style="color: #339933;">-&gt;</span>fasync_list<span style="color: #009900;">)</span>
		printk<span style="color: #009900;">(</span>KERN_ERR <span style="color: #ff0000;">"sock_release: fasync list not empty!<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	sockets_in_use<span style="color: #009900;">[</span>smp_processor_id<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">]</span>.<span style="color: #202020;">counter</span><span style="color: #339933;">--;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>sock<span style="color: #339933;">-&gt;</span>file<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		iput<span style="color: #009900;">(</span>sock<span style="color: #339933;">-&gt;</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	sock<span style="color: #339933;">-&gt;</span>file<span style="color: #339933;">=</span>NULL<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>release<span style="font-family: 宋体;">指针都指向函数</span><span style="font-family: 'Times New Roman';">unix_release()</span><span style="font-family: 宋体;">，定义在</span><span style="font-family: 'Times New Roman';">af_unix.c</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=730&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p73019"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td> 
              <td class="code" id="p730code19"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">int</span> unix_release<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> socket <span style="color: #339933;">*</span>sock<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	unix_socket <span style="color: #339933;">*</span>sk <span style="color: #339933;">=</span> sock<span style="color: #339933;">-&gt;</span>sk<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>sk<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
	sock<span style="color: #339933;">-&gt;</span>sk <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">return</span> unix_release_sock <span style="color: #009900;">(</span>sk<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>函数<span style="font-family: 'Times New Roman';">unix_release_sock()</span><span style="font-family: 宋体;">定义在</span><span style="font-family: 'Times New Roman';">af_unix.c</span><span style="font-family: 宋体;">中：</span></p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=730&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p73020"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
</pre></td> 
              <td class="code" id="p730code20"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">int</span> unix_release_sock <span style="color: #009900;">(</span>unix_socket <span style="color: #339933;">*</span>sk<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> embrion<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> dentry <span style="color: #339933;">*</span>dentry<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> vfsmount <span style="color: #339933;">*</span>mnt<span style="color: #339933;">;</span>
	unix_socket <span style="color: #339933;">*</span>skpair<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> sk_buff <span style="color: #339933;">*</span>skb<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> state<span style="color: #339933;">;</span>
&nbsp;
	unix_remove_socket<span style="color: #009900;">(</span>sk<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//将sock结构从unix_socket_table哈希表中摘除</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Clear state */</span>
	unix_state_wlock<span style="color: #009900;">(</span>sk<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	sock_orphan<span style="color: #009900;">(</span>sk<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//改变一些指针及状态信息</span>
	sk<span style="color: #339933;">-&gt;</span>shutdown <span style="color: #339933;">=</span> SHUTDOWN_MASK<span style="color: #339933;">;</span>
	dentry <span style="color: #339933;">=</span> sk<span style="color: #339933;">-&gt;</span>protinfo.<span style="color: #202020;">af_unix</span>.<span style="color: #202020;">dentry</span><span style="color: #339933;">;</span>
	sk<span style="color: #339933;">-&gt;</span>protinfo.<span style="color: #202020;">af_unix</span>.<span style="color: #202020;">dentry</span><span style="color: #339933;">=</span>NULL<span style="color: #339933;">;</span>
	mnt <span style="color: #339933;">=</span> sk<span style="color: #339933;">-&gt;</span>protinfo.<span style="color: #202020;">af_unix</span>.<span style="color: #202020;">mnt</span><span style="color: #339933;">;</span>
	sk<span style="color: #339933;">-&gt;</span>protinfo.<span style="color: #202020;">af_unix</span>.<span style="color: #202020;">mnt</span><span style="color: #339933;">=</span>NULL<span style="color: #339933;">;</span>
	state <span style="color: #339933;">=</span> sk<span style="color: #339933;">-&gt;</span>state<span style="color: #339933;">;</span>
	sk<span style="color: #339933;">-&gt;</span>state <span style="color: #339933;">=</span> TCP_CLOSE<span style="color: #339933;">;</span>
	unix_state_wunlock<span style="color: #009900;">(</span>sk<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	wake_up_interruptible_all<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>sk<span style="color: #339933;">-&gt;</span>protinfo.<span style="color: #202020;">af_unix</span>.<span style="color: #202020;">peer_wait</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//唤醒进程</span>
&nbsp;
	skpair<span style="color: #339933;">=</span>unix_peer<span style="color: #009900;">(</span>sk<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>skpair<span style="color: #339933;">!=</span>NULL<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>sk<span style="color: #339933;">-&gt;</span>type<span style="color: #339933;">==</span>SOCK_STREAM<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			unix_state_wlock<span style="color: #009900;">(</span>skpair<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			skpair<span style="color: #339933;">-&gt;</span>shutdown<span style="color: #339933;">=</span>SHUTDOWN_MASK<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* No more writes*/</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>skb_queue_empty<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>sk<span style="color: #339933;">-&gt;</span>receive_queue<span style="color: #009900;">)</span> <span style="color: #339933;">||</span> embrion<span style="color: #009900;">)</span>
				skpair<span style="color: #339933;">-&gt;</span>err <span style="color: #339933;">=</span> ECONNRESET<span style="color: #339933;">;</span>
			unix_state_wunlock<span style="color: #009900;">(</span>skpair<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			skpair<span style="color: #339933;">-&gt;</span>state_change<span style="color: #009900;">(</span>skpair<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			read_lock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>skpair<span style="color: #339933;">-&gt;</span>callback_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			sk_wake_async<span style="color: #009900;">(</span>skpair<span style="color: #339933;">,</span><span style="color: #0000dd;">1</span><span style="color: #339933;">,</span>POLL_HUP<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			read_unlock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>skpair<span style="color: #339933;">-&gt;</span>callback_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		sock_put<span style="color: #009900;">(</span>skpair<span style="color: #009900;">)</span><span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* It may now die */</span>
		unix_peer<span style="color: #009900;">(</span>sk<span style="color: #009900;">)</span> <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Try to flush out this socket. Throw out buffers at least */</span>
&nbsp;
	<span style="color: #b1b100;">while</span><span style="color: #009900;">(</span><span style="color: #009900;">(</span>skb<span style="color: #339933;">=</span>skb_dequeue<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>sk<span style="color: #339933;">-&gt;</span>receive_queue<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">!=</span>NULL<span style="color: #009900;">)</span>
	<span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>state<span style="color: #339933;">==</span>TCP_LISTEN<span style="color: #009900;">)</span>
			unix_release_sock<span style="color: #009900;">(</span>skb<span style="color: #339933;">-&gt;</span>sk<span style="color: #339933;">,</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #808080; font-style: italic;">/* passed fds are erased in the kfree_skb hook	      */</span>
		kfree_skb<span style="color: #009900;">(</span>skb<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>dentry<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		dput<span style="color: #009900;">(</span>dentry<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		mntput<span style="color: #009900;">(</span>mnt<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	sock_put<span style="color: #009900;">(</span>sk<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* ---- Socket is dead now and most probably destroyed ---- */</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * Fixme: BSD difference: In BSD all sockets connected to use get
	 *	  ECONNRESET and we die on the spot. In Linux we behave
	 *	  like files and pipes do and wait for the last
	 *	  dereference.
	 *
	 * Can't we simply set sock-&gt;err?
	 *
	 *	  What the above comment does talk about? --ANK(980817)
	 */</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>atomic_read<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>unix_tot_inflight<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		unix_gc<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* Garbage collect fds */</span>	
&nbsp;
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>函数就不详解了，就是释放一切有关的东西，需要说明的是，数据结构的最后释放是在当最后一个进程调用的时候计数为<span style="font-family: 'Times New Roman';">0</span><span style="font-family: 宋体;">的时候进行数据结构的释放，但是有可能因为一些原因计数不会达到</span><span style="font-family: 'Times New Roman';">0</span><span style="font-family: 宋体;">但是已经没有插口在使用了。这时候就需要一个回收机制来进行特定回收，也就是通过</span><span style="font-family: 'Times New Roman';">unix_gc()</span><span style="font-family: 宋体;">函数来检测此种情况并且释放。</span></p> 
          <p>具体函数不详说了。</p> 
          <p>&nbsp;</p> 
          <p>这篇文章写了好几天，毛老先生的书上写的有点乱，要理清不容易啊！</p> 
          <p>&nbsp;</p> 
          <p>The&nbsp;end.</p> 
          <p>Socket<span style="font-family: 宋体;">机制完！</span></p> 
         </div> 
        </div>
       </div>
       <!-- .entry-content --> 
       <!-- .entry-meta --> 
      </article>
      <!-- #post-730 --> 
      <!-- #comments --> 
     </div>
     <!-- #content --> 
    </div>
    <!-- #primary --> 
    <!-- #secondary .widget-area --> 
   </div>
   <!-- #main --> 
   <!-- #colophon --> 
  </div>
  <!-- #page -->   
  <!-- JiaThis Button BEGIN -->  
  <!-- JiaThis Button END -->   
 </body>
</html>