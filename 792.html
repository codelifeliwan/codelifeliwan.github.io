<!doctype html>
<!--[if IE 6]>
<html id="ie6" lang="zh-CN">
<![endif]-->
<!--[if IE 7]>
<html id="ie7" lang="zh-CN">
<![endif]-->
<!--[if IE 8]>
<html id="ie8" lang="zh-CN">
<![endif]-->
<!--[if !(IE 6) | !(IE 7) | !(IE 8)  ]><!-->
<html lang="zh-CN">
 <!--<![endif]-->
 <head>      
  <link rel="stylesheet" type="text/css" media="all" href="stylesheets/style.css">     
  <link rel="stylesheet" id="codebox-css" href="stylesheets/codebox.css" type="text/css" media="screen">             
 </head> 
 <body class="single single-post postid-792 single-format-standard content-sidebar"> 
  <div id="page" class="hfeed"> 
   <header id="branding" role="banner"> 
    <hgroup> 
     <h1 id="site-title"><span><a href="http://codelifeliwan.github.io/" title="Code_Life_LiWan" rel="home">Code_Life_LiWan</a></span></h1> 
     <h2 id="site-description">My heart will go on and on…</h2> 
    </hgroup>  
    <!-- #access --> 
   </header>
   <!-- #branding --> 
   <div id="main" class="clearfix"> 
    <div id="primary"> 
     <div id="content" role="main"> 
      <!-- #nav-single --> 
      <article id="post-792" class="post-792 post type-post status-publish format-standard hentry category-linux_kernel_source_code_notes"> 
       <header class="entry-header"> 
        <h1 class="entry-title">Linux内核-设备驱动（八、字符设备驱动数据结构说明）</h1> 
        <div class="entry-meta"> 
         <span class="sep">Posted on </span>
         <a href="http://codelifeliwan.github.io/?p=792" title="上午 10:15" rel="bookmark"><time class="entry-date" datetime="2013-01-30T10:15:13+00:00" pubdate>30 一月, 2013</time></a>
         <span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codelifeliwan.github.io/?author=1" title="View all posts by wanli" rel="author">wanli</a></span></span> 
         <span class="sep"> — </span> 
         <span class="comments-link"> <a href="http://codelifeliwan.github.io/?p=792#respond" title="Comment on Linux内核-设备驱动（八、字符设备驱动数据结构说明）">No Comments ↓</a> </span> 
        </div>
        <!-- .entry-meta --> 
       </header>
       <!-- .entry-header --> 
       <div class="entry-content">
        <div class="entry-content"> 
         <p>说到字符设备驱动数据结构，主要说的就是终端设备的驱动，我们还是从进程的PCB结构task_struct开始说起，在task_struct结构中有个tty_struct结构类型的指针：</p> 
         <p>struct tty_struct *tty; /* NULL if no tty */</p> 
         <p>它指向本进程的终端设备的总数据结构入口tty_struct，这个数据结构的定义在include/linux/tty.h中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=792&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7921"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
</pre></td> 
             <td class="code" id="p792code1"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * Where all of the state associated with a tty is kept while the tty
 * is open.  Since the termios state should be kept even if the tty
 * has been closed --- for things like the baud rate, etc --- it is
 * not stored here, but rather a pointer to the real state is stored
 * here.  Possible the winsize structure should have the same
 * treatment, but (1) the default 80x24 is usually right and (2) it's
 * most often used by a windowing system, which will set the correct
 * size each time the window is created or resized anyway.
 * IMPORTANT: since this structure is dynamically allocated, it must
 * be no larger than 4096 bytes.  Changing TTY_FLIPBUF_SIZE will change
 * the size of this structure, and it needs to be done with care.
 * 						- TYT, 9/14/92
 */</span>
<span style="color: #993333;">struct</span> tty_struct <span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span>	magic<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//魔数</span>
	<span style="color: #993333;">struct</span> tty_driver driver<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//某种终端设备的驱动结构，确定了对某种终端类型的一套操作</span>
	<span style="color: #993333;">struct</span> tty_ldisc ldisc<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//链路规则</span>
<span style="color: #808080; font-style: italic;">/*
 *termios结构是在每一个具体的逻辑终端设备上都有，比如伪终端设备的两端
 *每端都有一个此数据结构，它可以说是数据结构tty_ldisc的补充，它规定了
 *对接口上输入和输出的每个字符所做的处理以及传输速度（即波特率）等
 */</span>
	<span style="color: #993333;">struct</span> termios <span style="color: #339933;">*</span>termios<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>termios_locked<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> pgrp<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> session<span style="color: #339933;">;</span>
	kdev_t	device<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//设备号</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> flags<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> count<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> winsize winsize<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> stopped<span style="color: #339933;">:</span><span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> hw_stopped<span style="color: #339933;">:</span><span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> flow_stopped<span style="color: #339933;">:</span><span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> packet<span style="color: #339933;">:</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> low_latency<span style="color: #339933;">:</span><span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> warned<span style="color: #339933;">:</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> ctrl_status<span style="color: #339933;">;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 *用于伪终端设备，伪终端设备的两头都有一个tty_struct数据结构
 *link字段互相指向对方数据结构
 */</span>
	<span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>link<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> fasync_struct <span style="color: #339933;">*</span>fasync<span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *终端设备输入缓冲区
 */</span>
	<span style="color: #993333;">struct</span> tty_flip_buffer flip<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> max_flip_cnt<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> alt_speed<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* For magic substitution of 38400 bps */</span>
<span style="color: #808080; font-style: italic;">/*
 *读写请求队列
 */</span>
	wait_queue_head_t write_wait<span style="color: #339933;">;</span>
	wait_queue_head_t read_wait<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> tq_struct tq_hangup<span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span> <span style="color: #339933;">*</span>disc_data<span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span> <span style="color: #339933;">*</span>driver_data<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> list_head tty_files<span style="color: #339933;">;</span>
&nbsp;
<span style="color: #339933;">#define N_TTY_BUF_SIZE 4096</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * The following is data for the N_TTY line discipline.  For
	 * historical reasons, this is included in the tty structure.
	 */</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> column<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> lnext<span style="color: #339933;">:</span><span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> erasing<span style="color: #339933;">:</span><span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> raw<span style="color: #339933;">:</span><span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> real_raw<span style="color: #339933;">:</span><span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> icanon<span style="color: #339933;">:</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> closing<span style="color: #339933;">:</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">short</span> minimum_to_wake<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> overrun_time<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> num_overrun<span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*
 *字符位图
 */</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> process_char_map<span style="color: #009900;">[</span><span style="color: #0000dd;">256</span><span style="color: #339933;">/</span><span style="color: #009900;">(</span><span style="color: #0000dd;">8</span><span style="color: #339933;">*</span><span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">char</span> <span style="color: #339933;">*</span>read_buf<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> read_head<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> read_tail<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> read_cnt<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> read_flags<span style="color: #009900;">[</span>N_TTY_BUF_SIZE<span style="color: #339933;">/</span><span style="color: #009900;">(</span><span style="color: #0000dd;">8</span><span style="color: #339933;">*</span><span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> canon_data<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> canon_head<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> canon_column<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> semaphore atomic_read<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> semaphore atomic_write<span style="color: #339933;">;</span>
	spinlock_t read_lock<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>终端设备的驱动结构tty_driver定义在include/linux/tty_driver.h中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=792&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7922"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
</pre></td> 
             <td class="code" id="p792code2"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> tty_driver <span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span>	magic<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* magic number for this structure */</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">char</span>	<span style="color: #339933;">*</span>driver_name<span style="color: #339933;">;</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">char</span>	<span style="color: #339933;">*</span>name<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span>	name_base<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* offset of printed name */</span>
<span style="color: #808080; font-style: italic;">/*
 *主设备号，因为一个tty_driver代表的是一组相同的终端设备，并不是
 *某个具体的逻辑终端设备，所以tty_driver中有一个唯一的主设备号，
 *但是次设备号是一个范围
 */</span>
	<span style="color: #993333;">short</span>	major<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* major device number */</span>
<span style="color: #808080; font-style: italic;">/*
 *开始次设备号
 */</span>
	<span style="color: #993333;">short</span>	minor_start<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* start of minor device number*/</span>
<span style="color: #808080; font-style: italic;">/*
 *次设备号数目
 */</span>
	<span style="color: #993333;">short</span>	num<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* number of devices */</span>
<span style="color: #808080; font-style: italic;">/*
 *终端设备类型
 */</span>
	<span style="color: #993333;">short</span>	type<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* type of tty driver */</span>
	<span style="color: #993333;">short</span>	subtype<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* subtype of tty driver */</span>
	<span style="color: #993333;">struct</span> termios init_termios<span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* Initial termios */</span>
	<span style="color: #993333;">int</span>	flags<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* tty driver flags */</span>
	<span style="color: #993333;">int</span>	<span style="color: #339933;">*</span>refcount<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* for loadable tty drivers */</span>
	<span style="color: #993333;">struct</span> proc_dir_entry <span style="color: #339933;">*</span>proc_entry<span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* /proc fs entry */</span>
	<span style="color: #993333;">struct</span> tty_driver <span style="color: #339933;">*</span>other<span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* only used for the PTY driver */</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * Pointer to the tty data structures
	 */</span>
<span style="color: #808080; font-style: italic;">/*
 *指向具体的一种终端的tty_struct结构数组，对于一种终端来说，只有
 *一个tty_driver结构，但是每一个逻辑终端都有一个tty_struct结构（？）
 *一种终端的tty_struct结构构成一个数组，这个数组以次设备号减开始次设备号
 *为下标
 */</span>
	<span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">**</span>table<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> termios <span style="color: #339933;">**</span>termios<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> termios <span style="color: #339933;">**</span>termios_locked<span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span> <span style="color: #339933;">*</span>driver_state<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* only used for the PTY driver */</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * Interface routines from the upper tty layer to the tty
	 * driver.
	 */</span>
	<span style="color: #993333;">int</span>  <span style="color: #009900;">(</span><span style="color: #339933;">*</span>open<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span> tty<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span> filp<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>close<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span> tty<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span> filp<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span>  <span style="color: #009900;">(</span><span style="color: #339933;">*</span>write<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span> tty<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> from_user<span style="color: #339933;">,</span>
		      <span style="color: #993333;">const</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>buf<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> count<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>put_char<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> ch<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>flush_chars<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span>  <span style="color: #009900;">(</span><span style="color: #339933;">*</span>write_room<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span>  <span style="color: #009900;">(</span><span style="color: #339933;">*</span>chars_in_buffer<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span>  <span style="color: #009900;">(</span><span style="color: #339933;">*</span>ioctl<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span> file<span style="color: #339933;">,</span>
		    <span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> cmd<span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> arg<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>set_termios<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> termios <span style="color: #339933;">*</span> old<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>throttle<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>unthrottle<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span> tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>stop<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>start<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>hangup<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>break_ctl<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> state<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>flush_buffer<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>set_ldisc<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>wait_until_sent<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> timeout<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>send_xchar<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #339933;">,</span> <span style="color: #993333;">char</span> ch<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>read_proc<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">char</span> <span style="color: #339933;">*</span>page<span style="color: #339933;">,</span> <span style="color: #993333;">char</span> <span style="color: #339933;">**</span>start<span style="color: #339933;">,</span> off_t off<span style="color: #339933;">,</span>
			  <span style="color: #993333;">int</span> count<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> <span style="color: #339933;">*</span>eof<span style="color: #339933;">,</span> <span style="color: #993333;">void</span> <span style="color: #339933;">*</span>data<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>write_proc<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span>file<span style="color: #339933;">,</span> <span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>buffer<span style="color: #339933;">,</span>
			  <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> count<span style="color: #339933;">,</span> <span style="color: #993333;">void</span> <span style="color: #339933;">*</span>data<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * linked list pointers
	 */</span>
	<span style="color: #993333;">struct</span> tty_driver <span style="color: #339933;">*</span>next<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> tty_driver <span style="color: #339933;">*</span>prev<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>在内核中有个链表tty_drivers，系统在初始化或者安装某种终端设备的驱动模块时，都会通过函数tty_register_driver()将各种终端设备的tty_driver结构登记到这个链表中，每当打开一个终端设备时就要根据其设备号通过函数get_tty_driver()在这个链表中找到相应的tty_driver结构并把它复制到具体的tty_struct结构中。</p> 
         <p>在tty_struct中还有链路规则数据结构tty_ldisc，所谓链路规则，就是具体的下层的读写等操作接口，我们在tty_driver中看到了有很多函数指针，这些指针是“终端设备层”的上层接口，而tty_ldisc中的函数接口则是其与下层，也就是物理设备层之间的界面。</p> 
         <p>结构tty_ldisc定义在include/linux/tty_ldisc.h中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=792&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7923"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td> 
             <td class="code" id="p792code3"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> tty_ldisc <span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span>	magic<span style="color: #339933;">;</span>
	<span style="color: #993333;">char</span>	<span style="color: #339933;">*</span>name<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span>	num<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span>	flags<span style="color: #339933;">;</span>
	<span style="color: #808080; font-style: italic;">/*
	 * The following routines are called from above.
	 */</span>
	<span style="color: #993333;">int</span>	<span style="color: #009900;">(</span><span style="color: #339933;">*</span>open<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span>	<span style="color: #009900;">(</span><span style="color: #339933;">*</span>close<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span>	<span style="color: #009900;">(</span><span style="color: #339933;">*</span>flush_buffer<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	ssize_t	<span style="color: #009900;">(</span><span style="color: #339933;">*</span>chars_in_buffer<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	ssize_t	<span style="color: #009900;">(</span><span style="color: #339933;">*</span>read<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span> tty<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span> file<span style="color: #339933;">,</span>
			<span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span> buf<span style="color: #339933;">,</span> size_t nr<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	ssize_t	<span style="color: #009900;">(</span><span style="color: #339933;">*</span>write<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span> tty<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span> file<span style="color: #339933;">,</span>
			 <span style="color: #993333;">const</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span> buf<span style="color: #339933;">,</span> size_t nr<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	
	<span style="color: #993333;">int</span>	<span style="color: #009900;">(</span><span style="color: #339933;">*</span>ioctl<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span> tty<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span> file<span style="color: #339933;">,</span>
			 <span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> cmd<span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> arg<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span>	<span style="color: #009900;">(</span><span style="color: #339933;">*</span>set_termios<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span>tty<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> termios <span style="color: #339933;">*</span> old<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>poll<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*,</span> <span style="color: #993333;">struct</span> file <span style="color: #339933;">*,</span>
			     <span style="color: #993333;">struct</span> poll_table_struct <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * The following routines are called from below.
	 */</span>
	<span style="color: #993333;">void</span>	<span style="color: #009900;">(</span><span style="color: #339933;">*</span>receive_buf<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*,</span> <span style="color: #993333;">const</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>cp<span style="color: #339933;">,</span>
			       <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>fp<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> count<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span>	<span style="color: #009900;">(</span><span style="color: #339933;">*</span>receive_room<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">void</span>	<span style="color: #009900;">(</span><span style="color: #339933;">*</span>write_wakeup<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> tty_struct <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>在内核中定义了一个tty_ldisc结构的数组ldiscs[]，定义在drivers/char/tty_io.c中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=792&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7924"> 
             <td class="line_numbers"><pre>1
2
</pre></td> 
             <td class="code" id="p792code4"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> tty_ldisc lsiscs<span style="color: #009900;">[</span>NR_LDISCS<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
NR_LDISCS定义为<span style="color: #0000dd;">16</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>另外还有一个termios结构，这个结构是对一个具体的逻辑终端设备而言的，它是对tty_ldisc结构的补充，每一种终端设备有一个tty_ldisc结构，但是tty_ldisc不能具体到某一个逻辑设备，而termois就是这个功能。这个数据结构定义于include/asm-i386/termbits.h中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=792&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7925"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td> 
             <td class="code" id="p792code5"><pre class="c" style="font-family:monospace;"><span style="color: #339933;">#define NCCS 19</span>
<span style="color: #993333;">struct</span> termios <span style="color: #009900;">{</span>
	tcflag_t c_iflag<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* input mode flags */</span>
	tcflag_t c_oflag<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* output mode flags */</span>
	tcflag_t c_cflag<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* control mode flags */</span>
	tcflag_t c_lflag<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* local mode flags */</span>
	cc_t c_line<span style="color: #339933;">;</span>			<span style="color: #808080; font-style: italic;">/* line discipline */</span>
	cc_t c_cc<span style="color: #009900;">[</span>NCCS<span style="color: #009900;">]</span><span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* control characters */</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>这个数据结构规定了特定接口上的输入输出和每个字符所做的处理以及波特率等，同一文件中定义了许多用于它的标志位，比较重要的概念是“加工模式”，就是对字符等进行处理再输出等，而“原始模式”就是不进行处理，其他的就不多说了。</p> 
         <p>在tty_struct中还有个重要的成分flip，是个tty_flip_buffer数据结构，它是终端设备的输入缓冲区，底层的中断服务程序将接收到的字符存储于这个缓冲区中，供其上层读取，这个数据结构定义于include/linux/tty.h中：</p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=792&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7926"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td> 
             <td class="code" id="p792code6"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * This is the flip buffer used for the tty driver.  The buffer is
 * located in the tty structure, and is used as a high speed interface
 * between the tty driver and the tty line discipline.
 */</span>
<span style="color: #339933;">#define TTY_FLIPBUF_SIZE 512</span>
&nbsp;
<span style="color: #993333;">struct</span> tty_flip_buffer <span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> tq_struct tqueue<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> semaphore pty_sem<span style="color: #339933;">;</span>
	<span style="color: #993333;">char</span>		<span style="color: #339933;">*</span>char_buf_ptr<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span>	<span style="color: #339933;">*</span>flag_buf_ptr<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span>		count<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span>		buf_num<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span>	char_buf<span style="color: #009900;">[</span><span style="color: #0000dd;">2</span><span style="color: #339933;">*</span>TTY_FLIPBUF_SIZE<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">char</span>		flag_buf<span style="color: #009900;">[</span><span style="color: #0000dd;">2</span><span style="color: #339933;">*</span>TTY_FLIPBUF_SIZE<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span>	slop<span style="color: #009900;">[</span><span style="color: #0000dd;">4</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* N.B. bug overwrites buffer by 1 */</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>与flip互相辅助的是process_char_map[]，若这个位图中的某一位为1且为加工模式就表示要对这个字符做一些特殊的处理或者反应。</p> 
         <p>对于以上的数据结构，我们给出关系图如下：</p> 
         <p><a href="uploads/2013/01/14.jpg"><img class="aligncenter size-full wp-image-793" alt="1" src="uploads/2013/01/14.jpg" width="647" height="451"></a></p> 
         <p>The End.</p> 
        </div>
       </div>
       <!-- .entry-content --> 
       <!-- .entry-meta --> 
      </article>
      <!-- #post-792 --> 
      <!-- #comments --> 
     </div>
     <!-- #content --> 
    </div>
    <!-- #primary --> 
    <!-- #secondary .widget-area --> 
   </div>
   <!-- #main --> 
   <!-- #colophon --> 
  </div>
  <!-- #page -->   
  <!-- JiaThis Button BEGIN -->  
  <!-- JiaThis Button END -->   
 </body>
</html>