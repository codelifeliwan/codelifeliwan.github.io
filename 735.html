<!doctype html>
<!--[if IE 6]>
<html id="ie6" lang="zh-CN">
<![endif]-->
<!--[if IE 7]>
<html id="ie7" lang="zh-CN">
<![endif]-->
<!--[if IE 8]>
<html id="ie8" lang="zh-CN">
<![endif]-->
<!--[if !(IE 6) | !(IE 7) | !(IE 8)  ]><!-->
<html lang="zh-CN">
 <!--<![endif]-->
 <head>      
  <link rel="stylesheet" type="text/css" media="all" href="stylesheets/style.css">     
  <link rel="stylesheet" id="codebox-css" href="stylesheets/codebox.css" type="text/css" media="screen">             
 </head> 
 <body class="single single-post postid-735 single-format-standard content-sidebar"> 
  <div id="page" class="hfeed"> 
   <header id="branding" role="banner"> 
    <hgroup> 
     <h1 id="site-title"><span><a href="http://codelifeliwan.github.io/" title="Code_Life_LiWan" rel="home">Code_Life_LiWan</a></span></h1> 
     <h2 id="site-description">My heart will go on and on…</h2> 
    </hgroup>  
    <!-- #access --> 
   </header>
   <!-- #branding --> 
   <div id="main" class="clearfix"> 
    <div id="primary"> 
     <div id="content" role="main"> 
      <!-- #nav-single --> 
      <article id="post-735" class="post-735 post type-post status-publish format-standard hentry category-linux_kernel_source_code_notes"> 
       <header class="entry-header"> 
        <h1 class="entry-title">Linux内核-设备驱动（一、设备驱动概述、设备节点创建与可安装模块）</h1> 
        <div class="entry-meta"> 
         <span class="sep">Posted on </span>
         <a href="http://codelifeliwan.github.io/?p=735" title="上午 9:45" rel="bookmark"><time class="entry-date" datetime="2012-12-14T09:45:42+00:00" pubdate>14 十二月, 2012</time></a>
         <span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codelifeliwan.github.io/?author=1" title="View all posts by wanli" rel="author">wanli</a></span></span> 
         <span class="sep"> — </span> 
         <span class="comments-link"> <a href="http://codelifeliwan.github.io/?p=735#comments" title="Comment on Linux内核-设备驱动（一、设备驱动概述、设备节点创建与可安装模块）">2 Comments ↓</a> </span> 
        </div>
        <!-- .entry-meta --> 
       </header>
       <!-- .entry-header --> 
       <div class="entry-content">
        <div class="entry-content"> 
         <p>终于进入设备驱动模块了<span style="font-family: 'Times New Roman';">~</span></p> 
         <h2>1、设备驱动概述</h2> 
         <p>在<span style="font-family: 'Times New Roman';">Linux</span><span style="font-family: 宋体;">中将所有东西，包括设备都看成文件，都纳入文件系统的范畴。通过文件系统界面来进行操作，这样的话就有如下几点：</span></p> 
         <p>1、每一项设备都至少由文件系统的一个文件代表，文件名是唯一的，每个这样的文件唯一的代表了一个设备。</p> 
         <p>2、应用程序可以像操作普通文件一样对设备进行操作，使用<span style="font-family: 'Times New Roman';">open()</span><span style="font-family: 宋体;">来打开设备文件，建立连接等。</span></p> 
         <p>3、打开文件后可以使用<span style="font-family: 'Times New Roman';">read()</span><span style="font-family: 宋体;">、</span><span style="font-family: 'Times New Roman';">write()</span><span style="font-family: 宋体;">对文件进行读写等，其上层使用文件系统实现，具体的下层使用设备驱动进行实现。</span></p> 
         <p>这样的话，文件系统与设备驱动就成为同一事物的不同层次，而不是互相独立或平行的两个概念，对于<span style="font-family: 'Times New Roman';">Linux</span><span style="font-family: 宋体;">来说，毛老先生给了如下图示：</span></p> 
         <p><a href="uploads/2012/12/11.jpg"><img class="aligncenter size-full wp-image-737" title="1" src="uploads/2012/12/11.jpg" alt="" width="653" height="578"></a></p> 
         <p>在<span style="font-family: 'Times New Roman';">Linux2.4.0</span><span style="font-family: 宋体;">中，将设备大概分为两大类，称为“块设备”和“字符设备”，当然后来还有网络设备。这里只讨论块设备和字符设备，这两个设备的划分不好划分，一般的划分方法如下：</span></p> 
         <p>块设备的介质必须是存储介质，并且支持“随机访问”，如我们的硬盘；而字符设备一般都是“传输介质”，只能顺序访问，如我们的键盘。</p> 
         <p>要使得一个设备在系统中可见，首先得在文件系统中有着一个代表这这个设备的文件节点，这个节点可以通过系统调用<span style="font-family: 'Times New Roman';">mknode()</span><span style="font-family: 宋体;">来实现，还有就是在设备驱动层得有设备驱动程序。在早期的操作系统中这些驱动程序都静态连接在内核中，而随着设备的增多，内核会变得非常大，那么对于现代的操作系统来说，把全部的设备驱动都静态连接在内核中是非常不现实的方法，所以</span><span style="font-family: 'Times New Roman';">Linux</span><span style="font-family: 宋体;">中提供了可安装模块来对模块进行动态的安装，用到时再安装不用时就拆卸下来。</span></p> 
         <p>可安装模块是经过编译但是没经过连接的<span style="font-family: 'Times New Roman';">.o</span><span style="font-family: 宋体;">文件，可以在系统运行的时候动态安装到内核中。在内核的源代码中可以规定允许“移出”内核的一些符号，如子程序入口，全局变量等。模块的运行可能需要依赖其他的符号链接等等，在安装模块的时候进行检查和动态连接。</span></p> 
         <p>符号的连接操作是由一个程序<span style="font-family: 'Times New Roman';">/sbin/insmod</span><span style="font-family: 宋体;">完成的，这个程序不但负责模块与内核的连接，也负责把模块的目标文件（</span><span style="font-family: 'Times New Roman';">.o</span><span style="font-family: 宋体;">）文件“装入”到内核空间，所以</span><span style="font-family: 'Times New Roman';">insmod</span><span style="font-family: 宋体;">与</span><span style="font-family: 'Times New Roman';">ld</span><span style="font-family: 宋体;">的功能相似，不同的是</span><span style="font-family: 'Times New Roman';">insmod</span><span style="font-family: 宋体;">是运行时的动态连接和装入，而</span><span style="font-family: 'Times New Roman';">ld</span><span style="font-family: 宋体;">所进行的是静态的连接与装入，有装入当然也有拆卸等程序，</span><span style="font-family: 'Times New Roman';">/sbin/rmmod</span><span style="font-family: 宋体;">负责模块的拆卸，将一个模块从内核中拆除。以上程序只有特权用户才能执行。</span></p> 
         <p>对于设备驱动程序一般有两种不同的驱动方式，即“中断驱动”和“<span style="font-family: 'Times New Roman';">DMA</span><span style="font-family: 宋体;">”方式。设备驱动程序要直接访问外部设备或者接口卡上的物理电路，这部分电路通常是以寄存器的形式出现的。根据访问这些寄存器的方式可以把</span><span style="font-family: 'Times New Roman';">CPU</span><span style="font-family: 宋体;">分为两大类，一类</span><span style="font-family: 'Times New Roman';">CPU</span><span style="font-family: 宋体;">把这些寄存器看作内存的一部分，直接操作内存来操作寄存器，这种</span><span style="font-family: 'Times New Roman';">CPU</span><span style="font-family: 宋体;">没有专门用于</span><span style="font-family: 'Times New Roman';">I/O</span><span style="font-family: 宋体;">的指令，比如</span><span style="font-family: 'Times New Roman';">PPC</span><span style="font-family: 宋体;">，另一类</span><span style="font-family: 'Times New Roman';">CPU</span><span style="font-family: 宋体;">将外部设备的寄存器看成一个独立的地址空间，使用</span><span style="font-family: 'Times New Roman';">in</span><span style="font-family: 宋体;">、</span><span style="font-family: 'Times New Roman';">out</span><span style="font-family: 宋体;">等指令来对设备寄存器进行读写，如</span><span style="font-family: 'Times New Roman';">i386.</span></p> 
         <p>对于<span style="font-family: 'Times New Roman';">i386</span><span style="font-family: 宋体;">来说只有</span><span style="font-family: 'Times New Roman';">in</span><span style="font-family: 宋体;">和</span><span style="font-family: 'Times New Roman';">out</span><span style="font-family: 宋体;">这两条指令来进行读写，但是在</span><span style="font-family: 'Times New Roman';">Linux</span><span style="font-family: 宋体;">内核中将其“派生”出来了多个函数，来进行不同方式的读写，如</span><span style="font-family: 'Times New Roman';">inb(),inw(),inl()</span><span style="font-family: 宋体;">等来表示操作的是字节、字和双字，而</span><span style="font-family: 'Times New Roman';">outb(),outw(),outl()</span><span style="font-family: 宋体;">也是如此，另外，照顾到一些寄存器的特殊，需要进行一些延迟来使得寄存器有时间恢复，所以有了</span><span style="font-family: 'Times New Roman';">outb_p()</span><span style="font-family: 宋体;">等函数，与</span><span style="font-family: 'Times New Roman';">outb()</span><span style="font-family: 宋体;">区别是里面使用了几个</span><span style="font-family: 'Times New Roman';">jmp</span><span style="font-family: 宋体;">指令来达到延迟时间目的。</span></p> 
         <h2>2<span style="font-family: 黑体;">、设备节点的创建</span></h2> 
         <p>前面说了，每一个设备都必须有一个设备文件才能使得设备可见，所以就需要创建一个设备节点，也就是创建“设备文件”。与普通文件相比，设备文件在磁盘上只占一个索引节点，而没有任何的用于存放数据的记录块与之相联系，那么索引结构中的记录块映像表也就是空的，也就是没啥用处了，那么这种情况下就用这个数组中的第一个元素即<span style="font-family: 'Times New Roman';">i_block[0]</span><span style="font-family: 宋体;">来记载目标设备的设备号（</span><span style="font-family: 'Times New Roman';">8</span><span style="font-family: 宋体;">位）。对于设备文件，必须在创建时就将其所代表的设备号写入数组的第一个元素中。</span></p> 
         <p>因为对于设备文件，创建的时候要为其分配一个设备号，那么也就不能使用<span style="font-family: 'Times New Roman';">sys_open()</span><span style="font-family: 宋体;">函数来创建，而是使用专用的函数</span><span style="font-family: 'Times New Roman';">mknod()</span><span style="font-family: 宋体;">函数来实现。</span></p> 
         <p>在内核中，<span style="font-family: 'Times New Roman';">mknod()</span><span style="font-family: 宋体;">是通过函数</span><span style="font-family: 'Times New Roman';">sys_mknod()</span><span style="font-family: 宋体;">来实现的，定义于</span><span style="font-family: 'Times New Roman';">fs/namei.c</span><span style="font-family: 宋体;">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=735&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7351"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td> 
             <td class="code" id="p735code1"><pre class="c" style="font-family:monospace;">asmlinkage <span style="color: #993333;">long</span> sys_mknod<span style="color: #009900;">(</span><span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span> filename<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> mode<span style="color: #339933;">,</span> dev_t dev<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span> error <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">char</span> <span style="color: #339933;">*</span> tmp<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> dentry <span style="color: #339933;">*</span> dentry<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> nameidata nd<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>S_ISDIR<span style="color: #009900;">(</span>mode<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EPERM<span style="color: #339933;">;</span>
	tmp <span style="color: #339933;">=</span> getname<span style="color: #009900;">(</span>filename<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>IS_ERR<span style="color: #009900;">(</span>tmp<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> PTR_ERR<span style="color: #009900;">(</span>tmp<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>path_init<span style="color: #009900;">(</span>tmp<span style="color: #339933;">,</span> LOOKUP_PARENT<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>nd<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		error <span style="color: #339933;">=</span> path_walk<span style="color: #009900;">(</span>tmp<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>nd<span style="color: #009900;">)</span><span style="color: #339933;">;</span>		<span style="color: #666666; font-style: italic;">//寻找路径</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>error<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
	dentry <span style="color: #339933;">=</span> lookup_create<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>nd<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	error <span style="color: #339933;">=</span> PTR_ERR<span style="color: #009900;">(</span>dentry<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>IS_ERR<span style="color: #009900;">(</span>dentry<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">switch</span> <span style="color: #009900;">(</span>mode <span style="color: #339933;">&amp;</span> S_IFMT<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">case</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">:</span> <span style="color: #b1b100;">case</span> S_IFREG<span style="color: #339933;">:</span>
			error <span style="color: #339933;">=</span> vfs_create<span style="color: #009900;">(</span>nd.<span style="color: #202020;">dentry</span><span style="color: #339933;">-&gt;</span>d_inode<span style="color: #339933;">,</span>dentry<span style="color: #339933;">,</span>mode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//创建普通文件</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">case</span> S_IFCHR<span style="color: #339933;">:</span> <span style="color: #b1b100;">case</span> S_IFBLK<span style="color: #339933;">:</span> <span style="color: #b1b100;">case</span> S_IFIFO<span style="color: #339933;">:</span> <span style="color: #b1b100;">case</span> S_IFSOCK<span style="color: #339933;">:</span>
			error <span style="color: #339933;">=</span> vfs_mknod<span style="color: #009900;">(</span>nd.<span style="color: #202020;">dentry</span><span style="color: #339933;">-&gt;</span>d_inode<span style="color: #339933;">,</span>dentry<span style="color: #339933;">,</span>mode<span style="color: #339933;">,</span>dev<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//创建特殊文件</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">case</span> S_IFDIR<span style="color: #339933;">:</span>
			error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EPERM<span style="color: #339933;">;</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">default</span><span style="color: #339933;">:</span>
			error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EINVAL<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		dput<span style="color: #009900;">(</span>dentry<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	up<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>nd.<span style="color: #202020;">dentry</span><span style="color: #339933;">-&gt;</span>d_inode<span style="color: #339933;">-&gt;</span>i_sem<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	path_release<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>nd<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
out<span style="color: #339933;">:</span>
	putname<span style="color: #009900;">(</span>tmp<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">return</span> error<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>函数<span style="font-family: 'Times New Roman';">vfs_mknod()</span><span style="font-family: 宋体;">是用来创建特殊问文件节点的函数，需要说明的是，类型</span><span style="font-family: 'Times New Roman';">dev_t</span><span style="font-family: 宋体;">实际上就是</span><span style="font-family: 'Times New Roman';">unsigned&nbsp;short</span><span style="font-family: 宋体;">类型，其高</span><span style="font-family: 'Times New Roman';">8</span><span style="font-family: 宋体;">位表示主设备号，而低</span><span style="font-family: 'Times New Roman';">8</span><span style="font-family: 宋体;">位表示同一类别内的设备号。定义如下：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=735&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7352"> 
             <td class="line_numbers"><pre>1
2
</pre></td> 
             <td class="code" id="p735code2"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">typedef</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">short</span> __kernel_dev_t<span style="color: #339933;">;</span>
<span style="color: #993333;">typedef</span> __kernel_dev_t dev_t<span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>目前还是<span style="font-family: 'Times New Roman';">16</span><span style="font-family: 宋体;">位的，但是后来改成</span><span style="font-family: 'Times New Roman';">32</span><span style="font-family: 宋体;">位的。</span></p> 
         <p>函数<span style="font-family: 'Times New Roman';">vfs_mknod()</span><span style="font-family: 宋体;">定义在</span><span style="font-family: 'Times New Roman';">fs/namei.c</span><span style="font-family: 宋体;">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=735&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7353"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td> 
             <td class="code" id="p735code3"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">int</span> vfs_mknod<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span>dir<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> dentry <span style="color: #339933;">*</span>dentry<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> mode<span style="color: #339933;">,</span> dev_t dev<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span> error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EPERM<span style="color: #339933;">;</span>
&nbsp;
	mode <span style="color: #339933;">&amp;=</span> ~current<span style="color: #339933;">-&gt;</span>fs<span style="color: #339933;">-&gt;</span>umask<span style="color: #339933;">;</span>
&nbsp;
	down<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>dir<span style="color: #339933;">-&gt;</span>i_zombie<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>S_ISCHR<span style="color: #009900;">(</span>mode<span style="color: #009900;">)</span> <span style="color: #339933;">||</span> S_ISBLK<span style="color: #009900;">(</span>mode<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span>capable<span style="color: #009900;">(</span>CAP_MKNOD<span style="color: #009900;">)</span><span style="color: #009900;">)</span>	<span style="color: #666666; font-style: italic;">//权限检查</span>
		<span style="color: #b1b100;">goto</span> exit_lock<span style="color: #339933;">;</span>
&nbsp;
	error <span style="color: #339933;">=</span> may_create<span style="color: #009900;">(</span>dir<span style="color: #339933;">,</span> dentry<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//权限检查</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>error<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> exit_lock<span style="color: #339933;">;</span>
&nbsp;
	error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EPERM<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>dir<span style="color: #339933;">-&gt;</span>i_op <span style="color: #339933;">||</span> <span style="color: #339933;">!</span>dir<span style="color: #339933;">-&gt;</span>i_op<span style="color: #339933;">-&gt;</span>mknod<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> exit_lock<span style="color: #339933;">;</span>
&nbsp;
	DQUOT_INIT<span style="color: #009900;">(</span>dir<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	lock_kernel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	error <span style="color: #339933;">=</span> dir<span style="color: #339933;">-&gt;</span>i_op<span style="color: #339933;">-&gt;</span>mknod<span style="color: #009900;">(</span>dir<span style="color: #339933;">,</span> dentry<span style="color: #339933;">,</span> mode<span style="color: #339933;">,</span> dev<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//创建节点</span>
	unlock_kernel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
exit_lock<span style="color: #339933;">:</span>
	up<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>dir<span style="color: #339933;">-&gt;</span>i_zombie<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>error<span style="color: #009900;">)</span>
		inode_dir_notify<span style="color: #009900;">(</span>dir<span style="color: #339933;">,</span> DN_CREATE<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> error<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>最后创建节点的函数指针指向<span style="font-family: 'Times New Roman';">ext2_mknod()</span><span style="font-family: 宋体;">函数，这个函数定义在</span><span style="font-family: 'Times New Roman';">fs/ext2/namei.c</span><span style="font-family: 宋体;">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=735&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7354"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td> 
             <td class="code" id="p735code4"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">int</span> ext2_mknod <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span> dir<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> dentry <span style="color: #339933;">*</span>dentry<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> mode<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> rdev<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span> inode <span style="color: #339933;">=</span> ext2_new_inode <span style="color: #009900;">(</span>dir<span style="color: #339933;">,</span> mode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//分配数据结构</span>
	<span style="color: #993333;">int</span> err <span style="color: #339933;">=</span> PTR_ERR<span style="color: #009900;">(</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>IS_ERR<span style="color: #009900;">(</span>inode<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> err<span style="color: #339933;">;</span>
&nbsp;
	inode<span style="color: #339933;">-&gt;</span>i_uid <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>fsuid<span style="color: #339933;">;</span>
	init_special_inode<span style="color: #009900;">(</span>inode<span style="color: #339933;">,</span> mode<span style="color: #339933;">,</span> rdev<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//初始化</span>
	err <span style="color: #339933;">=</span> ext2_add_entry <span style="color: #009900;">(</span>dir<span style="color: #339933;">,</span> dentry<span style="color: #339933;">-&gt;</span>d_name.<span style="color: #202020;">name</span><span style="color: #339933;">,</span> dentry<span style="color: #339933;">-&gt;</span>d_name.<span style="color: #202020;">len</span><span style="color: #339933;">,</span> 
			     inode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//将新创建节点加进所在目录在磁盘上的目录文件中</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>err<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> out_no_entry<span style="color: #339933;">;</span>
	mark_inode_dirty<span style="color: #009900;">(</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//将新创建的节点设置成“脏”</span>
	d_instantiate<span style="color: #009900;">(</span>dentry<span style="color: #339933;">,</span> inode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//使得内存中的inode与dentry挂钩</span>
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
out_no_entry<span style="color: #339933;">:</span>
	inode<span style="color: #339933;">-&gt;</span>i_nlink<span style="color: #339933;">--;</span>
	mark_inode_dirty<span style="color: #009900;">(</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	iput<span style="color: #009900;">(</span>inode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> err<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>设置并初始化<span style="font-family: 'Times New Roman';">inode</span><span style="font-family: 宋体;">的函数是</span><span style="font-family: 'Times New Roman';">init_special_inode()</span><span style="font-family: 宋体;">，这个函数是在</span><span style="font-family: 'Times New Roman';">fs/devices.c</span><span style="font-family: 宋体;">中定义的：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=735&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7355"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td> 
             <td class="code" id="p735code5"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">void</span> init_special_inode<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span>inode<span style="color: #339933;">,</span> umode_t mode<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> rdev<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	inode<span style="color: #339933;">-&gt;</span>i_mode <span style="color: #339933;">=</span> mode<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>S_ISCHR<span style="color: #009900;">(</span>mode<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		inode<span style="color: #339933;">-&gt;</span>i_fop <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>def_chr_fops<span style="color: #339933;">;</span>
		inode<span style="color: #339933;">-&gt;</span>i_rdev <span style="color: #339933;">=</span> to_kdev_t<span style="color: #009900;">(</span>rdev<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>S_ISBLK<span style="color: #009900;">(</span>mode<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		inode<span style="color: #339933;">-&gt;</span>i_fop <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>def_blk_fops<span style="color: #339933;">;</span>
		inode<span style="color: #339933;">-&gt;</span>i_rdev <span style="color: #339933;">=</span> to_kdev_t<span style="color: #009900;">(</span>rdev<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
　　<span style="color: #666666; font-style: italic;">//获得并且初始化块设备控制结构，且将其链入hash表bdev_hashtable[]中</span>
		inode<span style="color: #339933;">-&gt;</span>i_bdev <span style="color: #339933;">=</span> bdget<span style="color: #009900;">(</span>rdev<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>S_ISFIFO<span style="color: #009900;">(</span>mode<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		inode<span style="color: #339933;">-&gt;</span>i_fop <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>def_fifo_fops<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>S_ISSOCK<span style="color: #009900;">(</span>mode<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		inode<span style="color: #339933;">-&gt;</span>i_fop <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>bad_sock_fops<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">else</span>
		printk<span style="color: #009900;">(</span>KERN_DEBUG <span style="color: #ff0000;">"init_special_inode: bogus imode (%o)<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> mode<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>这里主要就是设置两个指针，一个是<span style="font-family: 'Times New Roman';">i_fop</span><span style="font-family: 宋体;">，使它指向</span><span style="font-family: 'Times New Roman';">def_chr_fops</span><span style="font-family: 宋体;">或者</span><span style="font-family: 'Times New Roman';">def_blk_fops</span><span style="font-family: 宋体;">等，另一个就是将设备号写入</span><span style="font-family: 'Times New Roman';">i_rdev</span><span style="font-family: 宋体;">，</span><span style="font-family: 'Times New Roman';">to_kdev_t</span><span style="font-family: 宋体;">是将设备号转化的函数。</span></p> 
         <p>需要说明的是，在<span style="font-family: 'Times New Roman';">inode</span><span style="font-family: 宋体;">中有两个类型为</span><span style="font-family: 'Times New Roman';">kdev_t</span><span style="font-family: 宋体;">的字段，一个是</span><span style="font-family: 'Times New Roman';">i_rdev</span><span style="font-family: 宋体;">，是该索引节点所代表的设备的设备号；另一个是</span><span style="font-family: 'Times New Roman';">i_dev</span><span style="font-family: 宋体;">，是该索引节点所在的设备号。</span></p> 
         <p>对于块设备，<span style="font-family: 'Times New Roman';">inode</span><span style="font-family: 宋体;">中还有一个代表着块设备控制结构</span><span style="font-family: 'Times New Roman';">block_device</span><span style="font-family: 宋体;">指针</span><span style="font-family: 'Times New Roman';">i_bdev</span><span style="font-family: 宋体;">，这个结构定义在</span><span style="font-family: 'Times New Roman';">include/linux/fs.h</span><span style="font-family: 宋体;">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=735&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7356"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td> 
             <td class="code" id="p735code6"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> block_device <span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> list_head	bd_hash<span style="color: #339933;">;</span>
	atomic_t		bd_count<span style="color: #339933;">;</span>
<span style="color: #808080; font-style: italic;">/*	struct address_space	bd_data; */</span>
	dev_t			bd_dev<span style="color: #339933;">;</span>  <span style="color: #808080; font-style: italic;">/* not a kdev_t - it's a search key */</span>
	atomic_t		bd_openers<span style="color: #339933;">;</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *指向设备函数跳转表，这里设置成NULL，留待第一次打开
　　 *设备文件时再设置
　　 */</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">struct</span> block_device_operations <span style="color: #339933;">*</span>bd_op<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> semaphore	bd_sem<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* open/close mutex */</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>在<span style="font-family: 'Times New Roman';">ext2_mknod()</span><span style="font-family: 宋体;">函数中，将</span><span style="font-family: 'Times New Roman';">inode</span><span style="font-family: 宋体;">结构设置成“脏”，那么内核在同步的时候就会将其写回磁盘，即写回</span><span style="font-family: 'Times New Roman';">ext2_inode</span><span style="font-family: 宋体;">结构，由于</span><span style="font-family: 'Times New Roman';">ext2_inode</span><span style="font-family: 宋体;">结构并不存在</span><span style="font-family: 'Times New Roman';">i_rdev</span><span style="font-family: 宋体;">字段，那么就使用</span><span style="font-family: 'Times New Roman';">i_block[]</span><span style="font-family: 宋体;">数组的第一个位置来存储设备号。当需要读出来的时候进行从</span><span style="font-family: 'Times New Roman';">i_block[0]</span><span style="font-family: 宋体;">中取出设备号。</span></p> 
         <h2>3、可安装模块</h2> 
         <p>可安装模块是在系统运行时动态地安装和拆卸的软件，在应用程序上，内核通过<span style="font-family: 'Times New Roman';">4</span><span style="font-family: 宋体;">个系统调用来支持模块的动态安装与拆卸，它们是</span><span style="font-family: 'Times New Roman';">create_module()</span><span style="font-family: 宋体;">、</span><span style="font-family: 'Times New Roman';">init_module()</span><span style="font-family: 宋体;">、</span><span style="font-family: 'Times New Roman';">query_module()</span><span style="font-family: 宋体;">和</span><span style="font-family: 'Times New Roman';">delete_module()</span><span style="font-family: 宋体;">。通常，用户使用</span><span style="font-family: 'Times New Roman';">/sbin/insmod</span><span style="font-family: 宋体;">和</span><span style="font-family: 'Times New Roman';">/sbin/rmmod</span><span style="font-family: 宋体;">来安装和拆卸这些模块，安装模块可分为以下几步：</span></p> 
         <p>1、打开可安装模块（<span style="font-family: 'Times New Roman';">.o</span><span style="font-family: 宋体;">文件）并将其读入用户空间。</span></p> 
         <p>2、通过<span style="font-family: 'Times New Roman';">query_module()</span><span style="font-family: 宋体;">询问一些内核或者其他模块的依赖关系，并取出内核允许“移出”的符号表。</span></p> 
         <p>3、通过<span style="font-family: 'Times New Roman';">create_module()</span><span style="font-family: 宋体;">在内核中创建一个</span><span style="font-family: 'Times New Roman';">module</span><span style="font-family: 宋体;">数据结构，并且“预定”所需的系统空间。</span></p> 
         <p>4、通过系统调用<span style="font-family: 'Times New Roman';">init_module()</span><span style="font-family: 宋体;">把用户空间中完成了单向连接的模块映像装入内核空间，再调用一个</span><span style="font-family: 'Times New Roman';">init_module()</span><span style="font-family: 宋体;">函数（不是系统调用</span><span style="font-family: 'Times New Roman';">init_module()</span><span style="font-family: 宋体;">）来向内核登记。</span></p> 
         <p>这样，安装模块就完成了。</p> 
         <p>为了更好理解，在讲函数之前，我们还是来先讲数据结构关系。</p> 
         <p>首先，就是代表这一个模块的数据结构<span style="font-family: 'Times New Roman';">module</span><span style="font-family: 宋体;">，这个就够定义在</span><span style="font-family: 'Times New Roman';">include/linux/module.h</span><span style="font-family: 宋体;">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=735&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7357"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td> 
             <td class="code" id="p735code7"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> module
<span style="color: #009900;">{</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> size_of_struct<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* == sizeof(module) */</span>
	<span style="color: #993333;">struct</span> module <span style="color: #339933;">*</span>next<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//模块链指针</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>name<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//模块名</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> size<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//模块大小</span>
&nbsp;
	<span style="color: #993333;">union</span>
	<span style="color: #009900;">{</span>
		atomic_t usecount<span style="color: #339933;">;</span>
		<span style="color: #993333;">long</span> pad<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> uc<span style="color: #339933;">;</span>				<span style="color: #808080; font-style: italic;">/* Needs to keep its size - so says rth */</span>
&nbsp;
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> flags<span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* AUTOCLEAN et al */</span>
&nbsp;
	<span style="color: #993333;">unsigned</span> nsyms<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//syms数组的大小</span>
	<span style="color: #993333;">unsigned</span> ndeps<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//deps数组的大小</span>
&nbsp;
	<span style="color: #993333;">struct</span> module_symbol <span style="color: #339933;">*</span>syms<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//指向module_symbol数组</span>
	<span style="color: #993333;">struct</span> module_ref <span style="color: #339933;">*</span>deps<span style="color: #339933;">;</span>			<span style="color: #666666; font-style: italic;">//指向module_ref数组</span>
	<span style="color: #993333;">struct</span> module_ref <span style="color: #339933;">*</span>refs<span style="color: #339933;">;</span>			<span style="color: #666666; font-style: italic;">//module_ref链</span>
	<span style="color: #993333;">int</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>init<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">void</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">// init_module()函数指针</span>
	<span style="color: #993333;">void</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>cleanup<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">void</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//cleanup_module()函数指针</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">struct</span> exception_table_entry <span style="color: #339933;">*</span>ex_table_start<span style="color: #339933;">;</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">struct</span> exception_table_entry <span style="color: #339933;">*</span>ex_table_end<span style="color: #339933;">;</span>
<span style="color: #339933;">#ifdef __alpha__</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> gp<span style="color: #339933;">;</span>
<span style="color: #339933;">#endif</span>
	<span style="color: #808080; font-style: italic;">/* Members past this point are extensions to the basic
	   module support and are optional.  Use mod_member_present()
	   to examine them.  */</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">struct</span> module_persist <span style="color: #339933;">*</span>persist_start<span style="color: #339933;">;</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">struct</span> module_persist <span style="color: #339933;">*</span>persist_end<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>can_unload<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">void</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> runsize<span style="color: #339933;">;</span>			<span style="color: #808080; font-style: italic;">/* In modutils, not currently used */</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>kallsyms_start<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* All symbols for kernel debugging */</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>kallsyms_end<span style="color: #339933;">;</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>archdata_start<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* arch specific data for module */</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>archdata_end<span style="color: #339933;">;</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>kernel_data<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Reserved for kernel internal use */</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>需要说明的是，模块之间的依赖关系指针，在这个数据结构里面又涉及到两个数据结构，一个事<span style="font-family: 'Times New Roman';">module_symbol</span><span style="font-family: 宋体;">，一个是</span><span style="font-family: 'Times New Roman';">module_ref</span><span style="font-family: 宋体;">结构，这两个结构都定义如下：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=735&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7358"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td> 
             <td class="code" id="p735code8"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> module_symbol
<span style="color: #009900;">{</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> value<span style="color: #339933;">;</span>
	<span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>name<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #993333;">struct</span> module_ref
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> module <span style="color: #339933;">*</span>dep<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* "parent" pointer */</span>
	<span style="color: #993333;">struct</span> module <span style="color: #339933;">*</span>ref<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* "child" pointer */</span>
	<span style="color: #993333;">struct</span> module_ref <span style="color: #339933;">*</span>next_ref<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>module<span style="font-family: 宋体;">结构中的</span><span style="font-family: 'Times New Roman';">syms</span><span style="font-family: 宋体;">指针指向一个</span><span style="font-family: 'Times New Roman';">module_symbol</span><span style="font-family: 宋体;">结构的数组，数组的大小用</span><span style="font-family: 'Times New Roman';">nsyms</span><span style="font-family: 宋体;">指定，这个数组就是本模块的符号表；</span><span style="font-family: 'Times New Roman';">deps</span><span style="font-family: 宋体;">指针指向一个</span><span style="font-family: 'Times New Roman';">module_ref</span><span style="font-family: 宋体;">数组，这个数组的大小用</span><span style="font-family: 'Times New Roman';">ndeps</span><span style="font-family: 宋体;">指定，数组中的每一项都指向一个本模块所依赖的模块，可以看到，在</span><span style="font-family: 'Times New Roman';">module_ref</span><span style="font-family: 宋体;">中有两个</span><span style="font-family: 'Times New Roman';">module</span><span style="font-family: 宋体;">指针，</span><span style="font-family: 'Times New Roman';">dep</span><span style="font-family: 宋体;">指向本模块所依赖的模块，而</span><span style="font-family: 'Times New Roman';">ref</span><span style="font-family: 宋体;">指向依赖本模块的模块，在</span><span style="font-family: 'Times New Roman';">module</span><span style="font-family: 宋体;">中的</span><span style="font-family: 'Times New Roman';">refs</span><span style="font-family: 宋体;">指针指向一个</span><span style="font-family: 'Times New Roman';">module_ref</span><span style="font-family: 宋体;">链，链接着所有依赖本模块的模块指针。</span></p> 
         <p>总的来说，这三个数据结构是如下关系：</p> 
         <p><a href="uploads/2012/12/2.jpg"><img class="aligncenter size-full wp-image-738" title="2" src="uploads/2012/12/2.jpg" alt="" width="626" height="248"></a></p> 
         <p>第一个<span style="font-family: 'Times New Roman';">module</span><span style="font-family: 宋体;">是手动定义的，代表着内核本身，其</span><span style="font-family: 'Times New Roman';">module</span><span style="font-family: 宋体;">结构即为</span><span style="font-family: 'Times New Roman';">kernel_module</span><span style="font-family: 宋体;">，定义于</span><span style="font-family: 'Times New Roman';">kernel/module.c</span><span style="font-family: 宋体;">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=735&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p7359"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td> 
             <td class="code" id="p735code9"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">struct</span> module kernel_module <span style="color: #339933;">=</span>
<span style="color: #009900;">{</span>
	size_of_struct<span style="color: #339933;">:</span>		<span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> module<span style="color: #009900;">)</span><span style="color: #339933;">,</span>
	name<span style="color: #339933;">:</span> 			<span style="color: #ff0000;">""</span><span style="color: #339933;">,</span>
	uc<span style="color: #339933;">:</span>	 		<span style="color: #009900;">{</span>ATOMIC_INIT<span style="color: #009900;">(</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #009900;">}</span><span style="color: #339933;">,</span>
	flags<span style="color: #339933;">:</span>			MOD_RUNNING<span style="color: #339933;">,</span>
	syms<span style="color: #339933;">:</span>			__start___ksymtab<span style="color: #339933;">,</span>
	ex_table_start<span style="color: #339933;">:</span>		__start___ex_table<span style="color: #339933;">,</span>
	ex_table_end<span style="color: #339933;">:</span>		__stop___ex_table<span style="color: #339933;">,</span>
	kallsyms_start<span style="color: #339933;">:</span>		__start___kallsyms<span style="color: #339933;">,</span>
	kallsyms_end<span style="color: #339933;">:</span>		__stop___kallsyms<span style="color: #339933;">,</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>好了，介绍完了数据结构，我们来看看具体操作：</p> 
         <h3>模块的手动安装：</h3> 
         <p>先来看看向内核询问链接地址的函数<span style="font-family: 'Times New Roman';">query_module()</span><span style="font-family: 宋体;">，这个函数在内核中的实现是</span><span style="font-family: 'Times New Roman';">sys_query_module()</span><span style="font-family: 宋体;">，定义在</span><span style="font-family: 'Times New Roman';">kernel/module.c</span><span style="font-family: 宋体;">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=735&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p73510"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre></td> 
             <td class="code" id="p735code10"><pre class="c" style="font-family:monospace;">asmlinkage <span style="color: #993333;">long</span>
sys_query_module<span style="color: #009900;">(</span><span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>name_user<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> which<span style="color: #339933;">,</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>buf<span style="color: #339933;">,</span> size_t bufsize<span style="color: #339933;">,</span>
		 size_t <span style="color: #339933;">*</span>ret<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> module <span style="color: #339933;">*</span>mod<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> err<span style="color: #339933;">;</span>
&nbsp;
	lock_kernel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>name_user <span style="color: #339933;">==</span> NULL<span style="color: #009900;">)</span>
		mod <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>kernel_module<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">long</span> namelen<span style="color: #339933;">;</span>
		<span style="color: #993333;">char</span> <span style="color: #339933;">*</span>name<span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>namelen <span style="color: #339933;">=</span> get_mod_name<span style="color: #009900;">(</span>name_user<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>name<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			err <span style="color: #339933;">=</span> namelen<span style="color: #339933;">;</span>
			<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		err <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ENOENT<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>namelen <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
			mod <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>kernel_module<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>mod <span style="color: #339933;">=</span> find_module<span style="color: #009900;">(</span>name<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">==</span> NULL<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			put_mod_name<span style="color: #009900;">(</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		put_mod_name<span style="color: #009900;">(</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #b1b100;">switch</span> <span style="color: #009900;">(</span>which<span style="color: #009900;">)</span>
	<span style="color: #009900;">{</span>
	<span style="color: #b1b100;">case</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">:</span>
		err <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">case</span> QM_MODULES<span style="color: #339933;">:</span>
		err <span style="color: #339933;">=</span> qm_modules<span style="color: #009900;">(</span>buf<span style="color: #339933;">,</span> bufsize<span style="color: #339933;">,</span> ret<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">case</span> QM_DEPS<span style="color: #339933;">:</span>
		err <span style="color: #339933;">=</span> qm_deps<span style="color: #009900;">(</span>mod<span style="color: #339933;">,</span> buf<span style="color: #339933;">,</span> bufsize<span style="color: #339933;">,</span> ret<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">case</span> QM_REFS<span style="color: #339933;">:</span>
		err <span style="color: #339933;">=</span> qm_refs<span style="color: #009900;">(</span>mod<span style="color: #339933;">,</span> buf<span style="color: #339933;">,</span> bufsize<span style="color: #339933;">,</span> ret<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">case</span> QM_SYMBOLS<span style="color: #339933;">:</span>
		err <span style="color: #339933;">=</span> qm_symbols<span style="color: #009900;">(</span>mod<span style="color: #339933;">,</span> buf<span style="color: #339933;">,</span> bufsize<span style="color: #339933;">,</span> ret<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">case</span> QM_INFO<span style="color: #339933;">:</span>
		err <span style="color: #339933;">=</span> qm_info<span style="color: #009900;">(</span>mod<span style="color: #339933;">,</span> buf<span style="color: #339933;">,</span> bufsize<span style="color: #339933;">,</span> ret<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">default</span><span style="color: #339933;">:</span>
		err <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EINVAL<span style="color: #339933;">;</span>
		<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
out<span style="color: #339933;">:</span>
	unlock_kernel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> err<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>参数<span style="font-family: 'Times New Roman';">name_user</span><span style="font-family: 宋体;">为查询对象所在的模块的模块名，为空的话就是内核本身，所以将</span><span style="font-family: 'Times New Roman';">mod</span><span style="font-family: 宋体;">设置成</span><span style="font-family: 'Times New Roman';">kernel_module</span><span style="font-family: 宋体;">。否则就通过</span><span style="font-family: 'Times New Roman';">get_mod_name()</span><span style="font-family: 宋体;">从用户空间复制模块名，然后通过</span><span style="font-family: 'Times New Roman';">find_module()</span><span style="font-family: 宋体;">在</span><span style="font-family: 'Times New Roman';">module_list</span><span style="font-family: 宋体;">中寻找相应的</span><span style="font-family: 'Times New Roman';">module</span><span style="font-family: 宋体;">结构。然后通过具体的查询服务来进行具体操作。</span></p> 
         <p>函数<span style="font-family: 'Times New Roman';">find_module()</span><span style="font-family: 宋体;">定义在</span><span style="font-family: 'Times New Roman';">kernel/module.c</span><span style="font-family: 宋体;">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=735&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p73511"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td> 
             <td class="code" id="p735code11"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * Look for a module by name, ignoring modules marked for deletion.
 */</span>
<span style="color: #993333;">struct</span> module <span style="color: #339933;">*</span>
find_module<span style="color: #009900;">(</span><span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>name<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> module <span style="color: #339933;">*</span>mod<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>mod <span style="color: #339933;">=</span> module_list<span style="color: #339933;">;</span> mod <span style="color: #339933;">;</span> mod <span style="color: #339933;">=</span> mod<span style="color: #339933;">-&gt;</span>next<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>mod<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">&amp;</span> MOD_DELETED<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>strcmp<span style="color: #009900;">(</span>mod<span style="color: #339933;">-&gt;</span>name<span style="color: #339933;">,</span> name<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #b1b100;">return</span> mod<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>具体的查询服务我们来说一个即可，函数<span style="font-family: 'Times New Roman';">qm_deps()</span><span style="font-family: 宋体;">定义在</span><span style="font-family: 'Times New Roman';">kernel/module.c</span><span style="font-family: 宋体;">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=735&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p73512"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td> 
             <td class="code" id="p735code12"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">int</span>
qm_deps<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> module <span style="color: #339933;">*</span>mod<span style="color: #339933;">,</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>buf<span style="color: #339933;">,</span> size_t bufsize<span style="color: #339933;">,</span> size_t <span style="color: #339933;">*</span>ret<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	size_t i<span style="color: #339933;">,</span> space<span style="color: #339933;">,</span> len<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>mod <span style="color: #339933;">==</span> <span style="color: #339933;">&amp;</span>kernel_module<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EINVAL<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>MOD_CAN_QUERY<span style="color: #009900;">(</span>mod<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>put_user<span style="color: #009900;">(</span><span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> ret<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EFAULT<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">else</span>
			<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
	space <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>i <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> i <span style="color: #339933;">&lt;</span> mod<span style="color: #339933;">-&gt;</span>ndeps<span style="color: #339933;">;</span> <span style="color: #339933;">++</span>i<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>dep_name <span style="color: #339933;">=</span> mod<span style="color: #339933;">-&gt;</span>deps<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span>.<span style="color: #202020;">dep</span><span style="color: #339933;">-&gt;</span>name<span style="color: #339933;">;</span>
&nbsp;
		len <span style="color: #339933;">=</span> strlen<span style="color: #009900;">(</span>dep_name<span style="color: #009900;">)</span><span style="color: #339933;">+</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>len <span style="color: #339933;">&gt;</span> bufsize<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> calc_space_needed<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>copy_to_user<span style="color: #009900;">(</span>buf<span style="color: #339933;">,</span> dep_name<span style="color: #339933;">,</span> len<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EFAULT<span style="color: #339933;">;</span>
		buf <span style="color: #339933;">+=</span> len<span style="color: #339933;">;</span>
		bufsize <span style="color: #339933;">-=</span> len<span style="color: #339933;">;</span>
		space <span style="color: #339933;">+=</span> len<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>put_user<span style="color: #009900;">(</span>i<span style="color: #339933;">,</span> ret<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EFAULT<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">else</span>
		<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
calc_space_needed<span style="color: #339933;">:</span>
	space <span style="color: #339933;">+=</span> len<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span><span style="color: #339933;">++</span>i <span style="color: #339933;">&lt;</span> mod<span style="color: #339933;">-&gt;</span>ndeps<span style="color: #009900;">)</span>
		space <span style="color: #339933;">+=</span> strlen<span style="color: #009900;">(</span>mod<span style="color: #339933;">-&gt;</span>deps<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span>.<span style="color: #202020;">dep</span><span style="color: #339933;">-&gt;</span>name<span style="color: #009900;">)</span><span style="color: #339933;">+</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>put_user<span style="color: #009900;">(</span>space<span style="color: #339933;">,</span> ret<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EFAULT<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">else</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>ENOSPC<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>代码比较简单，读者可以自己阅读。</p> 
         <p>再来看看模块的创建<span style="font-family: 'Times New Roman';">create_module()</span><span style="font-family: 宋体;">系统调用，这个系统调用在内核中是通过函数</span><span style="font-family: 'Times New Roman';">sys_create_module()</span><span style="font-family: 宋体;">实现的，代码也在</span><span style="font-family: 'Times New Roman';">kernel/module.c</span><span style="font-family: 宋体;">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=735&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p73513"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre></td> 
             <td class="code" id="p735code13"><pre class="c" style="font-family:monospace;">asmlinkage <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span>
sys_create_module<span style="color: #009900;">(</span><span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>name_user<span style="color: #339933;">,</span> size_t size<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">char</span> <span style="color: #339933;">*</span>name<span style="color: #339933;">;</span>
	<span style="color: #993333;">long</span> namelen<span style="color: #339933;">,</span> error<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> module <span style="color: #339933;">*</span>mod<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>capable<span style="color: #009900;">(</span>CAP_SYS_MODULE<span style="color: #009900;">)</span><span style="color: #009900;">)</span>	<span style="color: #666666; font-style: italic;">//权限检查</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EPERM<span style="color: #339933;">;</span>
	lock_kernel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>namelen <span style="color: #339933;">=</span> get_mod_name<span style="color: #009900;">(</span>name_user<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>name<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//复制模块名</span>
		error <span style="color: #339933;">=</span> namelen<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> err0<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>size <span style="color: #339933;">&lt;</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> module<span style="color: #009900;">)</span><span style="color: #339933;">+</span>namelen<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EINVAL<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> err1<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>find_module<span style="color: #009900;">(</span>name<span style="color: #009900;">)</span> <span style="color: #339933;">!=</span> NULL<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//寻找模块</span>
		error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EEXIST<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> err1<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *size表示模块的大小，包含模块的映像本身和一个module数据结构大小
　　 *module_map()定义为:
　　 *#define module_map(x) vmalloc(x)
　　 *这里就是分配模块空间
　　 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>mod <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #993333;">struct</span> module <span style="color: #339933;">*</span><span style="color: #009900;">)</span>module_map<span style="color: #009900;">(</span>size<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">==</span> NULL<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ENOMEM<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> err1<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	memset<span style="color: #009900;">(</span>mod<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #339933;">*</span>mod<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *分配空间的开头用作module结构本身
　　 */</span>
	mod<span style="color: #339933;">-&gt;</span>size_of_struct <span style="color: #339933;">=</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #339933;">*</span>mod<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	mod<span style="color: #339933;">-&gt;</span>next <span style="color: #339933;">=</span> module_list<span style="color: #339933;">;</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *然后的用作模块名字符串
　　 */</span>
	mod<span style="color: #339933;">-&gt;</span>name <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #993333;">char</span> <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #009900;">(</span>mod <span style="color: #339933;">+</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	mod<span style="color: #339933;">-&gt;</span>size <span style="color: #339933;">=</span> size<span style="color: #339933;">;</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *复制模块名，namelen+1而不是namelen的目的是字符串后面的'\0'？
　　 */</span>
	memcpy<span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #993333;">char</span><span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #009900;">(</span>mod<span style="color: #339933;">+</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span> name<span style="color: #339933;">,</span> namelen<span style="color: #339933;">+</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	put_mod_name<span style="color: #009900;">(</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
　　
　　<span style="color: #808080; font-style: italic;">/*
　　 *链入module_list前端
　　 */</span>	
	module_list <span style="color: #339933;">=</span> mod<span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* link it in */</span>
&nbsp;
	error <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #993333;">long</span><span style="color: #009900;">)</span> mod<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">goto</span> err0<span style="color: #339933;">;</span>
err1<span style="color: #339933;">:</span>
	put_mod_name<span style="color: #009900;">(</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
err0<span style="color: #339933;">:</span>
	unlock_kernel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> error<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>这样<span style="font-family: 'Times New Roman';">create_module()</span><span style="font-family: 宋体;">就完成了。</span></p> 
         <p>然后再来看看系统调用<span style="font-family: 'Times New Roman';">init_module()</span><span style="font-family: 宋体;">，这个系统调用在内核中的实现是</span><span style="font-family: 'Times New Roman';">sys_init_module()</span><span style="font-family: 宋体;">，定义在</span><span style="font-family: 'Times New Roman';">kernel/module.c</span><span style="font-family: 宋体;">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=735&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p73514"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
</pre></td> 
             <td class="code" id="p735code14"><pre class="c" style="font-family:monospace;">asmlinkage <span style="color: #993333;">long</span>
sys_init_module<span style="color: #009900;">(</span><span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>name_user<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> module <span style="color: #339933;">*</span>mod_user<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
　　<span style="color: #666666; font-style: italic;">//mod_user为已经创建好的module结构指针</span>
	<span style="color: #993333;">struct</span> module mod_tmp<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>mod<span style="color: #339933;">;</span>
	<span style="color: #993333;">char</span> <span style="color: #339933;">*</span>name<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>n_name<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>name_tmp <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	<span style="color: #993333;">long</span> namelen<span style="color: #339933;">,</span> n_namelen<span style="color: #339933;">,</span> i<span style="color: #339933;">,</span> error<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> mod_user_size<span style="color: #339933;">;</span>
	<span style="color: #993333;">struct</span> module_ref <span style="color: #339933;">*</span>dep<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>capable<span style="color: #009900;">(</span>CAP_SYS_MODULE<span style="color: #009900;">)</span><span style="color: #009900;">)</span>	<span style="color: #666666; font-style: italic;">//权限检查</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EPERM<span style="color: #339933;">;</span>
	lock_kernel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>namelen <span style="color: #339933;">=</span> get_mod_name<span style="color: #009900;">(</span>name_user<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>name<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//复制模块名</span>
		error <span style="color: #339933;">=</span> namelen<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> err0<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>mod <span style="color: #339933;">=</span> find_module<span style="color: #009900;">(</span>name<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">==</span> NULL<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//寻找模块</span>
		error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ENOENT<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> err1<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Check module header size.  We allow a bit of slop over the
	   size we are familiar with to cope with a version of insmod
　　	   for a newer kernel.  But don't over do it. */</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *简单点说就是用户空间的module和系统空间定义的module可能不同
　　 *用户空间的module可能不包含某些字段，所以先将用户空间module
　　 *中的size_of_struct字段复制过来加以检查
　　 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>error <span style="color: #339933;">=</span> get_user<span style="color: #009900;">(</span>mod_user_size<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>mod_user<span style="color: #339933;">-&gt;</span>size_of_struct<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> err1<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>mod_user_size <span style="color: #339933;">&lt;</span> <span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span><span style="color: #339933;">&amp;</span><span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> module <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #0000dd;">0L</span><span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>persist_start
	    <span style="color: #339933;">||</span> mod_user_size <span style="color: #339933;">&gt;</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> module<span style="color: #009900;">)</span> <span style="color: #339933;">+</span> <span style="color: #0000dd;">16</span><span style="color: #339933;">*</span><span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">void</span><span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		printk<span style="color: #009900;">(</span>KERN_ERR <span style="color: #ff0000;">"init_module: Invalid module header size.<span style="color: #000099; font-weight: bold;">\n</span>"</span>
		       KERN_ERR <span style="color: #ff0000;">"A new version of the modutils is likely "</span>
				<span style="color: #ff0000;">"needed.<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EINVAL<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> err1<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Hold the current contents while we play with the user's idea
	   of righteousness.  */</span>
	mod_tmp <span style="color: #339933;">=</span> <span style="color: #339933;">*</span>mod<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//将内核的module复制到堆栈中作为后备</span>
　　<span style="color: #666666; font-style: italic;">//然后从用户空间复制其module结构</span>
	name_tmp <span style="color: #339933;">=</span> kmalloc<span style="color: #009900;">(</span>strlen<span style="color: #009900;">(</span>mod<span style="color: #339933;">-&gt;</span>name<span style="color: #009900;">)</span> <span style="color: #339933;">+</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> GFP_KERNEL<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* Where's kstrdup()? */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>name_tmp <span style="color: #339933;">==</span> NULL<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ENOMEM<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> err1<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	strcpy<span style="color: #009900;">(</span>name_tmp<span style="color: #339933;">,</span> mod<span style="color: #339933;">-&gt;</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	error <span style="color: #339933;">=</span> copy_from_user<span style="color: #009900;">(</span>mod<span style="color: #339933;">,</span> mod_user<span style="color: #339933;">,</span> mod_user_size<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>error<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EFAULT<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> err2<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Sanity check the size of the module.  */</span>
	error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EINVAL<span style="color: #339933;">;</span>
　　<span style="color: #666666; font-style: italic;">//检查核对数据结构大小</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>mod<span style="color: #339933;">-&gt;</span>size <span style="color: #339933;">&gt;</span> mod_tmp.<span style="color: #202020;">size</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		printk<span style="color: #009900;">(</span>KERN_ERR <span style="color: #ff0000;">"init_module: Size of initialized module "</span>
				<span style="color: #ff0000;">"exceeds size of created module.<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> err2<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Make sure all interesting pointers are sane.  */</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *下面就是检查结构中内容的合理性，函数mod_bound()用来检查
　　 *用户提供的指针所指的对象是否落在模块的边界内，定义于
　　 *include/linux/module.h中：
　　 *#define mod_bound(p, n, m) ((unsigned long)(p) &gt;= ((unsigned long)(m) + ((m)-&gt;size_of_struct)) &amp;&amp; \
　　	         (unsigned long)((p)+(n)) &lt;= (unsigned long)(m) + (m)-&gt;size)
　　 /*
	if (!mod_bound(mod-&gt;name, namelen, mod)) {
		printk(KERN_ERR "init_module: mod-&gt;name out of bounds.\n");
		goto err2;
	}
	if (mod-&gt;nsyms &amp;&amp; !mod_bound(mod-&gt;syms, mod-&gt;nsyms, mod)) {
		printk(KERN_ERR "init_module: mod-&gt;syms out of bounds.\n");
		goto err2;
	}
	if (mod-&gt;ndeps &amp;&amp; !mod_bound(mod-&gt;deps, mod-&gt;ndeps, mod)) {
		printk(KERN_ERR "init_module: mod-&gt;deps out of bounds.\n");
		goto err2;
	}
	if (mod-&gt;init &amp;&amp; !mod_bound(mod-&gt;init, 0, mod)) {
		printk(KERN_ERR "init_module: mod-&gt;init out of bounds.\n");
		goto err2;
	}
	if (mod-&gt;cleanup &amp;&amp; !mod_bound(mod-&gt;cleanup, 0, mod)) {
		printk(KERN_ERR "init_module: mod-&gt;cleanup out of bounds.\n");
		goto err2;
	}
	if (mod-&gt;ex_table_start &gt; mod-&gt;ex_table_end
	    || (mod-&gt;ex_table_start &amp;&amp;
		!((unsigned long)mod-&gt;ex_table_start &gt;= ((unsigned long)mod + mod-&gt;size_of_struct)
		  &amp;&amp; ((unsigned long)mod-&gt;ex_table_end
		      &lt; (unsigned long)mod + mod-&gt;size)))
	    || (((unsigned long)mod-&gt;ex_table_start
		 - (unsigned long)mod-&gt;ex_table_end)
		% sizeof(struct exception_table_entry))) {
		printk(KERN_ERR "init_module: mod-&gt;ex_table_* invalid.\n");
		goto err2;
	}
	if (mod-&gt;flags &amp; ~MOD_AUTOCLEAN) {
		printk(KERN_ERR "init_module: mod-&gt;flags invalid.\n");
		goto err2;
	}
#ifdef __alpha__
	if (!mod_bound(mod-&gt;gp - 0x8000, 0, mod)) {
		printk(KERN_ERR "init_module: mod-&gt;gp out of bounds.\n");
		goto err2;
	}
#endif
	if (mod_member_present(mod, can_unload)
	    &amp;&amp; mod-&gt;can_unload &amp;&amp; !mod_bound(mod-&gt;can_unload, 0, mod)) {
		printk(KERN_ERR "init_module: mod-&gt;can_unload out of bounds.\n");
		goto err2;
	}
	if (mod_member_present(mod, kallsyms_end)) {
	    if (mod-&gt;kallsyms_end &amp;&amp;
		(!mod_bound(mod-&gt;kallsyms_start, 0, mod) ||
		 !mod_bound(mod-&gt;kallsyms_end, 0, mod))) {
		printk(KERN_ERR "init_module: mod-&gt;kallsyms out of bounds.\n");
		goto err2;
	    }
	    if (mod-&gt;kallsyms_start &gt; mod-&gt;kallsyms_end) {
		printk(KERN_ERR "init_module: mod-&gt;kallsyms invalid.\n");
		goto err2;
	    }
	}
	if (mod_member_present(mod, archdata_end)) {
	    if (mod-&gt;archdata_end &amp;&amp;
		(!mod_bound(mod-&gt;archdata_start, 0, mod) ||
		 !mod_bound(mod-&gt;archdata_end, 0, mod))) {
		printk(KERN_ERR "init_module: mod-&gt;archdata out of bounds.\n");
		goto err2;
	    }
	    if (mod-&gt;archdata_start &gt; mod-&gt;archdata_end) {
		printk(KERN_ERR "init_module: mod-&gt;archdata invalid.\n");
		goto err2;
	    }
	}
	if (mod_member_present(mod, kernel_data) &amp;&amp; mod-&gt;kernel_data) {
	    printk(KERN_ERR "init_module: mod-&gt;kernel_data must be zero.\n");
	    goto err2;
	}
&nbsp;
	/* Check that the user isn't doing something silly with the name.  */</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>n_namelen <span style="color: #339933;">=</span> get_mod_name<span style="color: #009900;">(</span>mod<span style="color: #339933;">-&gt;</span>name <span style="color: #339933;">-</span> <span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span>mod
				      <span style="color: #339933;">+</span> <span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span>mod_user<span style="color: #339933;">,</span>
				      <span style="color: #339933;">&amp;</span>n_name<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		printk<span style="color: #009900;">(</span>KERN_ERR <span style="color: #ff0000;">"init_module: get_mod_name failure.<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		error <span style="color: #339933;">=</span> n_namelen<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> err2<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>namelen <span style="color: #339933;">!=</span> n_namelen <span style="color: #339933;">||</span> strcmp<span style="color: #009900;">(</span>n_name<span style="color: #339933;">,</span> mod_tmp.<span style="color: #202020;">name</span><span style="color: #009900;">)</span> <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		printk<span style="color: #009900;">(</span>KERN_ERR <span style="color: #ff0000;">"init_module: changed module name to "</span>
				<span style="color: #ff0000;">"`%s' from `%s'<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span>
		       n_name<span style="color: #339933;">,</span> mod_tmp.<span style="color: #202020;">name</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> err3<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Ok, that's about all the sanity we can stomach; copy the rest.  */</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *检查通过后就从用户空间把模块的映像复制过来
　　 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>copy_from_user<span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #993333;">char</span> <span style="color: #339933;">*</span><span style="color: #009900;">)</span>mod<span style="color: #339933;">+</span>mod_user_size<span style="color: #339933;">,</span>
			   <span style="color: #009900;">(</span><span style="color: #993333;">char</span> <span style="color: #339933;">*</span><span style="color: #009900;">)</span>mod_user<span style="color: #339933;">+</span>mod_user_size<span style="color: #339933;">,</span>
			   mod<span style="color: #339933;">-&gt;</span>size<span style="color: #339933;">-</span>mod_user_size<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EFAULT<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> err3<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>module_arch_init<span style="color: #009900;">(</span>mod<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> err3<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* On some machines it is necessary to do something here
	   to make the I and D caches consistent.  */</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *对于部分处理器，需要将其缓存的内容刷新到内存
　　 */</span>
	flush_icache_range<span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span>mod<span style="color: #339933;">,</span> <span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span>mod <span style="color: #339933;">+</span> mod<span style="color: #339933;">-&gt;</span>size<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	mod<span style="color: #339933;">-&gt;</span>next <span style="color: #339933;">=</span> mod_tmp.<span style="color: #202020;">next</span><span style="color: #339933;">;</span>
	mod<span style="color: #339933;">-&gt;</span>refs <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//刚初始化，所以没有依赖它的模块</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Sanity check the module's dependents */</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *循环检查其所依赖的模块是否被拆除
　　 */</span>
	<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>i <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> dep <span style="color: #339933;">=</span> mod<span style="color: #339933;">-&gt;</span>deps<span style="color: #339933;">;</span> i <span style="color: #339933;">&lt;</span> mod<span style="color: #339933;">-&gt;</span>ndeps<span style="color: #339933;">;</span> <span style="color: #339933;">++</span>i<span style="color: #339933;">,</span> <span style="color: #339933;">++</span>dep<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">struct</span> module <span style="color: #339933;">*</span>o<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>d <span style="color: #339933;">=</span> dep<span style="color: #339933;">-&gt;</span>dep<span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/* Make sure the indicated dependencies are really modules.  */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>d <span style="color: #339933;">==</span> mod<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			printk<span style="color: #009900;">(</span>KERN_ERR <span style="color: #ff0000;">"init_module: self-referential "</span>
					<span style="color: #ff0000;">"dependency in mod-&gt;deps.<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">goto</span> err3<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/* Scan the current modules for this dependency */</span>
		<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>o <span style="color: #339933;">=</span> module_list<span style="color: #339933;">;</span> o <span style="color: #339933;">!=</span> <span style="color: #339933;">&amp;</span>kernel_module <span style="color: #339933;">&amp;&amp;</span> o <span style="color: #339933;">!=</span> d<span style="color: #339933;">;</span> o <span style="color: #339933;">=</span> o<span style="color: #339933;">-&gt;</span>next<span style="color: #009900;">)</span>
			<span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>o <span style="color: #339933;">!=</span> d<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			printk<span style="color: #009900;">(</span>KERN_ERR <span style="color: #ff0000;">"init_module: found dependency that is "</span>
				<span style="color: #ff0000;">"(no longer?) a module.<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">goto</span> err3<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Update module references.  */</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *循环将本模块的每个module_ref结构链入到所依赖模块的refs链中
　　 *并将其中的ref指针指向本模块
　　 */</span>
	<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>i <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> dep <span style="color: #339933;">=</span> mod<span style="color: #339933;">-&gt;</span>deps<span style="color: #339933;">;</span> i <span style="color: #339933;">&lt;</span> mod<span style="color: #339933;">-&gt;</span>ndeps<span style="color: #339933;">;</span> <span style="color: #339933;">++</span>i<span style="color: #339933;">,</span> <span style="color: #339933;">++</span>dep<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">struct</span> module <span style="color: #339933;">*</span>d <span style="color: #339933;">=</span> dep<span style="color: #339933;">-&gt;</span>dep<span style="color: #339933;">;</span>
&nbsp;
		dep<span style="color: #339933;">-&gt;</span>ref <span style="color: #339933;">=</span> mod<span style="color: #339933;">;</span>
		dep<span style="color: #339933;">-&gt;</span>next_ref <span style="color: #339933;">=</span> d<span style="color: #339933;">-&gt;</span>refs<span style="color: #339933;">;</span>
		d<span style="color: #339933;">-&gt;</span>refs <span style="color: #339933;">=</span> dep<span style="color: #339933;">;</span>
		<span style="color: #808080; font-style: italic;">/* Being referenced by a dependent module counts as a
		   use as far as kmod is concerned.  */</span>
		d<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">|=</span> MOD_USED_ONCE<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Free our temporary memory.  */</span>
	put_mod_name<span style="color: #009900;">(</span>n_name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	put_mod_name<span style="color: #009900;">(</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Initialize the module.  */</span>
	mod<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">|=</span> MOD_INITIALIZING<span style="color: #339933;">;</span>
	atomic_set<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>mod<span style="color: #339933;">-&gt;</span>uc.<span style="color: #202020;">usecount</span><span style="color: #339933;">,</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *执行启动执行模块的init_module()函数
　　 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>mod<span style="color: #339933;">-&gt;</span>init <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">(</span>error <span style="color: #339933;">=</span> mod<span style="color: #339933;">-&gt;</span>init<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		atomic_set<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>mod<span style="color: #339933;">-&gt;</span>uc.<span style="color: #202020;">usecount</span><span style="color: #339933;">,</span><span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		mod<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">&amp;=</span> ~MOD_INITIALIZING<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>error <span style="color: #339933;">&gt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>	<span style="color: #808080; font-style: italic;">/* Buggy module */</span>
			error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EBUSY<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> err0<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	atomic_dec<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>mod<span style="color: #339933;">-&gt;</span>uc.<span style="color: #202020;">usecount</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* And set it running.  */</span>
	mod<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>mod<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">|</span> MOD_RUNNING<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;</span> ~MOD_INITIALIZING<span style="color: #339933;">;</span>
	error <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">goto</span> err0<span style="color: #339933;">;</span>
&nbsp;
err3<span style="color: #339933;">:</span>
	put_mod_name<span style="color: #009900;">(</span>n_name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
err2<span style="color: #339933;">:</span>
	<span style="color: #339933;">*</span>mod <span style="color: #339933;">=</span> mod_tmp<span style="color: #339933;">;</span>
	strcpy<span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #993333;">char</span> <span style="color: #339933;">*</span><span style="color: #009900;">)</span>mod<span style="color: #339933;">-&gt;</span>name<span style="color: #339933;">,</span> name_tmp<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #808080; font-style: italic;">/* We know there is room for this */</span>
err1<span style="color: #339933;">:</span>
	put_mod_name<span style="color: #009900;">(</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
err0<span style="color: #339933;">:</span>
	unlock_kernel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	kfree<span style="color: #009900;">(</span>name_tmp<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> error<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>这个函数比较长，注释都在里面说的很清楚了。</p> 
         <p>最后来说说用来拆卸模块的系统调用<span style="font-family: 'Times New Roman';">delete_module()</span><span style="font-family: 宋体;">，这个函数在内核中是</span><span style="font-family: 'Times New Roman';">sys_delete_module()</span><span style="font-family: 宋体;">，代码在</span><span style="font-family: 'Times New Roman';">kernel/module.c</span><span style="font-family: 宋体;">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=735&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p73515"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
</pre></td> 
             <td class="code" id="p735code15"><pre class="c" style="font-family:monospace;">asmlinkage <span style="color: #993333;">long</span>
sys_delete_module<span style="color: #009900;">(</span><span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>name_user<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> module <span style="color: #339933;">*</span>mod<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>next<span style="color: #339933;">;</span>
	<span style="color: #993333;">char</span> <span style="color: #339933;">*</span>name<span style="color: #339933;">;</span>
	<span style="color: #993333;">long</span> error<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> something_changed<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>capable<span style="color: #009900;">(</span>CAP_SYS_MODULE<span style="color: #009900;">)</span><span style="color: #009900;">)</span>	<span style="color: #666666; font-style: italic;">//检查权限</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EPERM<span style="color: #339933;">;</span>
&nbsp;
	lock_kernel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *若name_user不为0则表示卸载特定模块，否则表示卸载所有可卸载的模块
　　 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>name_user<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>error <span style="color: #339933;">=</span> get_mod_name<span style="color: #009900;">(</span>name_user<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>name<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span>	<span style="color: #666666; font-style: italic;">//复制模块名</span>
			<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>error <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EINVAL<span style="color: #339933;">;</span>
			put_mod_name<span style="color: #009900;">(</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ENOENT<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>mod <span style="color: #339933;">=</span> find_module<span style="color: #009900;">(</span>name<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">==</span> NULL<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>	<span style="color: #666666; font-style: italic;">//搜索取得模块结构</span>
			put_mod_name<span style="color: #009900;">(</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		put_mod_name<span style="color: #009900;">(</span>name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EBUSY<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>mod<span style="color: #339933;">-&gt;</span>refs <span style="color: #339933;">!=</span> NULL<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
&nbsp;
		spin_lock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>unload_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *__MOD_IN_USE()用于检查模块是否正在使用中，
　　 *定义于include/linux/module.h中：
　　 *	#define __MOD_IN_USE(mod)						\
　　 *		(mod_member_present((mod), can_unload) &amp;&amp; (mod)-&gt;can_unload	\
　　 *	 	? (mod)-&gt;can_unload() : atomic_read(&amp;(mod)-&gt;uc.usecount))
　　 */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>__MOD_IN_USE<span style="color: #009900;">(</span>mod<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			mod<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">|=</span> MOD_DELETED<span style="color: #339933;">;</span>
			spin_unlock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>unload_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			free_module<span style="color: #009900;">(</span>mod<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//拆除</span>
			error <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
			spin_unlock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>unload_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Do automatic reaping */</span>
<span style="color: #808080; font-style: italic;">/*
 *这里是进行拆除全部可拆除模块的代码，所谓“可以拆除”，即满足：
 *	1、不再有任何模块依赖它
 *	2、安装时带有MOD_AUTOCLEAN标志，表示允许自动拆除
 *	3、已经安装完毕但是尚未拆除
 *	4、尚未开始拆除
 *	5、模块已经被引用
 *	6、模块已经不在使用
 */</span>
restart<span style="color: #339933;">:</span>
	something_changed <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>mod <span style="color: #339933;">=</span> module_list<span style="color: #339933;">;</span> mod <span style="color: #339933;">!=</span> <span style="color: #339933;">&amp;</span>kernel_module<span style="color: #339933;">;</span> mod <span style="color: #339933;">=</span> next<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		next <span style="color: #339933;">=</span> mod<span style="color: #339933;">-&gt;</span>next<span style="color: #339933;">;</span>
		spin_lock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>unload_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>mod<span style="color: #339933;">-&gt;</span>refs <span style="color: #339933;">==</span> NULL
		    <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">(</span>mod<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">&amp;</span> MOD_AUTOCLEAN<span style="color: #009900;">)</span>
		    <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">(</span>mod<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">&amp;</span> MOD_RUNNING<span style="color: #009900;">)</span>
		    <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span><span style="color: #009900;">(</span>mod<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">&amp;</span> MOD_DELETED<span style="color: #009900;">)</span>
		    <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">(</span>mod<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">&amp;</span> MOD_USED_ONCE<span style="color: #009900;">)</span>
		    <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span>__MOD_IN_USE<span style="color: #009900;">(</span>mod<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>mod<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">&amp;</span> MOD_VISITED<span style="color: #009900;">)</span>
			    <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span><span style="color: #009900;">(</span>mod<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">&amp;</span> MOD_JUST_FREED<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				spin_unlock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>unload_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				mod<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">&amp;=</span> ~MOD_VISITED<span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
				mod<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">|=</span> MOD_DELETED<span style="color: #339933;">;</span>
				spin_unlock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>unload_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				free_module<span style="color: #009900;">(</span>mod<span style="color: #339933;">,</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				something_changed <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
		<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
			spin_unlock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>unload_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>something_changed<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> restart<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>mod <span style="color: #339933;">=</span> module_list<span style="color: #339933;">;</span> mod <span style="color: #339933;">!=</span> <span style="color: #339933;">&amp;</span>kernel_module<span style="color: #339933;">;</span> mod <span style="color: #339933;">=</span> mod<span style="color: #339933;">-&gt;</span>next<span style="color: #009900;">)</span>
		mod<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">&amp;=</span> ~MOD_JUST_FREED<span style="color: #339933;">;</span>
	error <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
out<span style="color: #339933;">:</span>
	unlock_kernel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> error<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>拆除函数<span style="font-family: 'Times New Roman';">free_module()</span><span style="font-family: 宋体;">定义在</span><span style="font-family: 'Times New Roman';">kernel/module.c</span><span style="font-family: 宋体;">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=735&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p73516"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td> 
             <td class="code" id="p735code16"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">void</span>
free_module<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> module <span style="color: #339933;">*</span>mod<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> tag_freed<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> module_ref <span style="color: #339933;">*</span>dep<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> i<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Let the module clean up.  */</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>mod<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">&amp;</span> MOD_RUNNING<span style="color: #009900;">)</span>
	<span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span><span style="color: #009900;">(</span>mod<span style="color: #339933;">-&gt;</span>cleanup<span style="color: #009900;">)</span>
			mod<span style="color: #339933;">-&gt;</span>cleanup<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//调用cleanup_module()函数</span>
		mod<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">&amp;=</span> ~MOD_RUNNING<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Remove the module from the dependency lists.  */</span>
&nbsp;
　　<span style="color: #808080; font-style: italic;">/*
　　 *将deps、refs等脱链
　　 */</span>
	<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>i <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> dep <span style="color: #339933;">=</span> mod<span style="color: #339933;">-&gt;</span>deps<span style="color: #339933;">;</span> i <span style="color: #339933;">&lt;</span> mod<span style="color: #339933;">-&gt;</span>ndeps<span style="color: #339933;">;</span> <span style="color: #339933;">++</span>i<span style="color: #339933;">,</span> <span style="color: #339933;">++</span>dep<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">struct</span> module_ref <span style="color: #339933;">**</span>pp<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>pp <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>dep<span style="color: #339933;">-&gt;</span>dep<span style="color: #339933;">-&gt;</span>refs<span style="color: #339933;">;</span> <span style="color: #339933;">*</span>pp <span style="color: #339933;">!=</span> dep<span style="color: #339933;">;</span> pp <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span><span style="color: #009900;">(</span><span style="color: #339933;">*</span>pp<span style="color: #009900;">)</span><span style="color: #339933;">-&gt;</span>next_ref<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span>
		<span style="color: #339933;">*</span>pp <span style="color: #339933;">=</span> dep<span style="color: #339933;">-&gt;</span>next_ref<span style="color: #339933;">;</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *如果将一个module_ref从一个模块的refs队列中脱链以后使得这个队列
　　 *成了空队列，那么这个模块就没有其他的依赖了，也就是自由模块了，
　　 *这个时候如果参数tag_freed不为0，那么就设置这个模块的MOD_JUST_FREED
　　 *标志位，表示模块刚刚得到自由
　　 */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tag_freed <span style="color: #339933;">&amp;&amp;</span> dep<span style="color: #339933;">-&gt;</span>dep<span style="color: #339933;">-&gt;</span>refs <span style="color: #339933;">==</span> NULL<span style="color: #009900;">)</span>
			dep<span style="color: #339933;">-&gt;</span>dep<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">|=</span> MOD_JUST_FREED<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* And from the main module list.  */</span>
&nbsp;
　　<span style="color: #808080; font-style: italic;">/*
　　 *将module从module_list中除去
　　 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>mod <span style="color: #339933;">==</span> module_list<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		module_list <span style="color: #339933;">=</span> mod<span style="color: #339933;">-&gt;</span>next<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">struct</span> module <span style="color: #339933;">*</span>p<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>p <span style="color: #339933;">=</span> module_list<span style="color: #339933;">;</span> p<span style="color: #339933;">-&gt;</span>next <span style="color: #339933;">!=</span> mod<span style="color: #339933;">;</span> p <span style="color: #339933;">=</span> p<span style="color: #339933;">-&gt;</span>next<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span>
		p<span style="color: #339933;">-&gt;</span>next <span style="color: #339933;">=</span> mod<span style="color: #339933;">-&gt;</span>next<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* And free the memory.  */</span>
　　<span style="color: #666666; font-style: italic;">//释放内存</span>
	module_unmap<span style="color: #009900;">(</span>mod<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>模块的一系列操作结束。</p> 
         <h3>模块的自动安装：</h3> 
         <p>在大多数情况下模块是内核主动检测安装上去的，比如我们在<span style="font-family: 'Times New Roman';">Linux</span><span style="font-family: 宋体;">里面连接上一个</span><span style="font-family: 'Times New Roman';">NTFS</span><span style="font-family: 宋体;">格式的文件系统，</span><span style="font-family: 'Times New Roman';">Linux</span><span style="font-family: 宋体;">默认是不支持的，但是我们可以通过安装程序来使得</span><span style="font-family: 'Times New Roman';">Linux</span><span style="font-family: 宋体;">支持这种文件系统，当插上硬盘时</span><span style="font-family: 'Times New Roman';">Linux</span><span style="font-family: 宋体;">就制动检测这种模块然后安装上，使得可以对</span><span style="font-family: 'Times New Roman';">NTFS</span><span style="font-family: 宋体;">文件系统进行操作。</span></p> 
         <p>这样就是一个模块的自动安装过程，自动启动<span style="font-family: 'Times New Roman';">/sbin/insmod</span><span style="font-family: 宋体;">来安装。</span></p> 
         <p>内核通过函数<span style="font-family: 'Times New Roman';">request_module()</span><span style="font-family: 宋体;">来主动地启动模块的安装，这个函数定义在</span><span style="font-family: 'Times New Roman';">kernel/kmod.c</span><span style="font-family: 宋体;">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=735&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p73517"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
</pre></td> 
             <td class="code" id="p735code17"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/**
 *	request_module - try to load a kernel module
 *	@module_name: Name of module
 *
 * 	Load a module using the user mode module loader. The function returns
 *	zero on success or a negative errno code on failure. Note that a
 * 	successful module load does not mean the module did not then unload
 *	and exit on an error of its own. Callers must check that the service
 *	they requested is now available not blindly invoke it.
 *
 *	If module auto-loading support is disabled then this function
 *	becomes a no-operation.
 */</span>
&nbsp;
<span style="color: #993333;">int</span> request_module<span style="color: #009900;">(</span><span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span> module_name<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	pid_t pid<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> waitpid_result<span style="color: #339933;">;</span>
	sigset_t tmpsig<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> i<span style="color: #339933;">;</span>
	<span style="color: #993333;">static</span> atomic_t kmod_concurrent <span style="color: #339933;">=</span> ATOMIC_INIT<span style="color: #009900;">(</span><span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #339933;">#define MAX_KMOD_CONCURRENT 50	/* Completely arbitrary value - KAO */</span>
	<span style="color: #993333;">static</span> <span style="color: #993333;">int</span> kmod_loop_msg<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Don't allow request_module() before the root fs is mounted!  */</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *自动安装前必须先安装根文件系统
　　 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span> <span style="color: #339933;">!</span> current<span style="color: #339933;">-&gt;</span>fs<span style="color: #339933;">-&gt;</span>root <span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		printk<span style="color: #009900;">(</span>KERN_ERR <span style="color: #ff0000;">"request_module[%s]: Root fs not mounted<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span>
			module_name<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EPERM<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* If modprobe needs a service that is in a module, we get a recursive
	 * loop.  Limit the number of running kmod threads to max_threads/2 or
	 * MAX_KMOD_CONCURRENT, whichever is the smaller.  A cleaner method
	 * would be to run the parents of this process, counting how many times
	 * kmod was invoked.  That would mean accessing the internals of the
	 * process tables to get the command line, proc_pid_cmdline is static
	 * and it is not worth changing the proc code just to handle this case. 
	 * KAO.
	 */</span>
	i <span style="color: #339933;">=</span> max_threads<span style="color: #339933;">/</span><span style="color: #0000dd;">2</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>i <span style="color: #339933;">&gt;</span> MAX_KMOD_CONCURRENT<span style="color: #009900;">)</span>
		i <span style="color: #339933;">=</span> MAX_KMOD_CONCURRENT<span style="color: #339933;">;</span>
	atomic_inc<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>kmod_concurrent<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
　　<span style="color: #808080; font-style: italic;">/*
　　 *限制request_module()调用的嵌套层数
　　 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>atomic_read<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>kmod_concurrent<span style="color: #009900;">)</span> <span style="color: #339933;">&gt;</span> i<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>kmod_loop_msg<span style="color: #339933;">++</span> <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">5</span><span style="color: #009900;">)</span>
			printk<span style="color: #009900;">(</span>KERN_ERR
			       <span style="color: #ff0000;">"kmod: runaway modprobe loop assumed and stopped<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		atomic_dec<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>kmod_concurrent<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>ENOMEM<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
　　<span style="color: #666666; font-style: italic;">//创建内核线程exec_modprobe()</span>
	pid <span style="color: #339933;">=</span> kernel_thread<span style="color: #009900;">(</span>exec_modprobe<span style="color: #339933;">,</span> <span style="color: #009900;">(</span><span style="color: #993333;">void</span><span style="color: #339933;">*</span><span style="color: #009900;">)</span> module_name<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>	
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>pid <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		printk<span style="color: #009900;">(</span>KERN_ERR <span style="color: #ff0000;">"request_module[%s]: fork failed, errno %d<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> module_name<span style="color: #339933;">,</span> <span style="color: #339933;">-</span>pid<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		atomic_dec<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>kmod_concurrent<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span> pid<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Block everything but SIGKILL/SIGSTOP */</span>
	spin_lock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>current<span style="color: #339933;">-&gt;</span>sigmask_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	tmpsig <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>blocked<span style="color: #339933;">;</span>
　　<span style="color: #666666; font-style: italic;">//为了使安装不受干扰，需要屏蔽掉除了SIGKILL和SIGSTOP以外其他信号</span>
	siginitsetinv<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>current<span style="color: #339933;">-&gt;</span>blocked<span style="color: #339933;">,</span> sigmask<span style="color: #009900;">(</span>SIGKILL<span style="color: #009900;">)</span> <span style="color: #339933;">|</span> sigmask<span style="color: #009900;">(</span>SIGSTOP<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	recalc_sigpending<span style="color: #009900;">(</span>current<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	spin_unlock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>current<span style="color: #339933;">-&gt;</span>sigmask_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	waitpid_result <span style="color: #339933;">=</span> waitpid<span style="color: #009900;">(</span>pid<span style="color: #339933;">,</span> NULL<span style="color: #339933;">,</span> __WCLONE<span style="color: #009900;">)</span><span style="color: #339933;">;</span>	<span style="color: #666666; font-style: italic;">//进入睡眠，等待安装完成</span>
	atomic_dec<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>kmod_concurrent<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Allow signals again.. */</span>
	spin_lock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>current<span style="color: #339933;">-&gt;</span>sigmask_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	current<span style="color: #339933;">-&gt;</span>blocked <span style="color: #339933;">=</span> tmpsig<span style="color: #339933;">;</span>
	recalc_sigpending<span style="color: #009900;">(</span>current<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	spin_unlock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>current<span style="color: #339933;">-&gt;</span>sigmask_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>waitpid_result <span style="color: #339933;">!=</span> pid<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		printk<span style="color: #009900;">(</span>KERN_ERR <span style="color: #ff0000;">"request_module[%s]: waitpid(%d,...) failed, errno %d<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span>
		       module_name<span style="color: #339933;">,</span> pid<span style="color: #339933;">,</span> <span style="color: #339933;">-</span>waitpid_result<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>具体的内核线程执行的是<span style="font-family: 'Times New Roman';">exec_modprobe()</span><span style="font-family: 宋体;">函数，函数定义在</span><span style="font-family: 'Times New Roman';">kernel/kmod.c</span><span style="font-family: 宋体;">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=735&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p73518"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td> 
             <td class="code" id="p735code18"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
	modprobe_path is set via /proc/sys.
*/</span>
<span style="color: #993333;">char</span> modprobe_path<span style="color: #009900;">[</span><span style="color: #0000dd;">256</span><span style="color: #009900;">]</span> <span style="color: #339933;">=</span> <span style="color: #ff0000;">"/sbin/modprobe"</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #993333;">static</span> <span style="color: #993333;">int</span> exec_modprobe<span style="color: #009900;">(</span><span style="color: #993333;">void</span> <span style="color: #339933;">*</span> module_name<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">static</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span> envp<span style="color: #009900;">[</span><span style="color: #009900;">]</span> <span style="color: #339933;">=</span> <span style="color: #009900;">{</span> <span style="color: #ff0000;">"HOME=/"</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">"TERM=linux"</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">"PATH=/sbin:/usr/sbin:/bin:/usr/bin"</span><span style="color: #339933;">,</span> NULL <span style="color: #009900;">}</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">char</span> <span style="color: #339933;">*</span>argv<span style="color: #009900;">[</span><span style="color: #009900;">]</span> <span style="color: #339933;">=</span> <span style="color: #009900;">{</span> modprobe_path<span style="color: #339933;">,</span> <span style="color: #ff0000;">"-s"</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">"-k"</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">"--"</span><span style="color: #339933;">,</span> <span style="color: #009900;">(</span><span style="color: #993333;">char</span><span style="color: #339933;">*</span><span style="color: #009900;">)</span>module_name<span style="color: #339933;">,</span> NULL <span style="color: #009900;">}</span><span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> ret<span style="color: #339933;">;</span>
&nbsp;
	ret <span style="color: #339933;">=</span> exec_usermodehelper<span style="color: #009900;">(</span>modprobe_path<span style="color: #339933;">,</span> argv<span style="color: #339933;">,</span> envp<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>ret<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		printk<span style="color: #009900;">(</span>KERN_ERR
		       <span style="color: #ff0000;">"kmod: failed to exec %s -s -k %s, errno = %d<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span>
		       modprobe_path<span style="color: #339933;">,</span> <span style="color: #009900;">(</span><span style="color: #993333;">char</span><span style="color: #339933;">*</span><span style="color: #009900;">)</span> module_name<span style="color: #339933;">,</span> errno<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">return</span> ret<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>这个函数的作用就是执行一个命令，<span style="font-family: 'Times New Roman';">modprobe_path</span><span style="font-family: 宋体;">就是</span><span style="font-family: 'Times New Roman';">/sbin/modprobe</span><span style="font-family: 宋体;">，所以如果</span><span style="font-family: 'Times New Roman';">module_name</span><span style="font-family: 宋体;">为</span><span style="font-family: 'Times New Roman';">mymodule</span><span style="font-family: 宋体;">的话就是执行：</span></p> 
         <p>/sbin/modprobe&nbsp;-s&nbsp;-k&nbsp;mymodule</p> 
         <p>选项<span style="font-family: 'Times New Roman';">-s</span><span style="font-family: 宋体;">表示在安装过程中产生的信息应写入系统的运行日志，而不在终端显示，</span><span style="font-family: 'Times New Roman';">-k</span><span style="font-family: 宋体;">表示安装时将模块的</span><span style="font-family: 'Times New Roman';">MOD_AUTOCLEAN</span><span style="font-family: 宋体;">标志设置成</span><span style="font-family: 'Times New Roman';">1.</span></p> 
         <p>上述函数最后调用了函数<span style="font-family: 'Times New Roman';">exec_usermodehelper()</span><span style="font-family: 宋体;">，最终调用的是</span><span style="font-family: 'Times New Roman';">execve()</span><span style="font-family: 宋体;">来执行命令。</span></p> 
         <p>&nbsp;</p> 
         <p>关于内核的符号允许移出问题，内核中每一个符号都必须通过宏定义<span style="font-family: 'Times New Roman';">EXPORT_SYMBOL</span><span style="font-family: 宋体;">明确规定允许移出，才能由函数</span><span style="font-family: 'Times New Roman';">query_module()</span><span style="font-family: 宋体;">系统调用获得这些符号，否则就不允许移出，比如在</span><span style="font-family: 'Times New Roman';">kernel/ksyms.c</span><span style="font-family: 宋体;">中有很多：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=735&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p73519"> 
             <td class="line_numbers"><pre>1
2
3
4
5
</pre></td> 
             <td class="code" id="p735code19"><pre class="c" style="font-family:monospace;">EXPORT_SYMBOL<span style="color: #009900;">(</span>bh_task_vec<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
EXPORT_SYMBOL<span style="color: #009900;">(</span>init_bh<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
EXPORT_SYMBOL<span style="color: #009900;">(</span>remove_bh<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
EXPORT_SYMBOL<span style="color: #009900;">(</span>tasklet_init<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
EXPORT_SYMBOL<span style="color: #009900;">(</span>tasklet_kill<span style="color: #009900;">)</span><span style="color: #339933;">;</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>这些都是允许移出的符号，宏定义<span style="font-family: 'Times New Roman';">EXPORT_SYMBOL</span><span style="font-family: 宋体;">将给定的符号名和它的值，即该符号在连接后的内核映像中的地址，组装在一个</span><span style="font-family: 'Times New Roman';">module_symbol</span><span style="font-family: 宋体;">结构中，这个结构前面已经讲过了，并让</span><span style="font-family: 'Times New Roman';">ld</span><span style="font-family: 宋体;">链接程序在连接内核映像时将这个结构放在一个“</span><span style="font-family: 'Times New Roman';">__ksymtab</span><span style="font-family: 宋体;">”区段中，这个区段就成了内核对外的公开符号表。</span></p> 
         <p>module_symbol<span style="font-family: 宋体;">结构中的</span><span style="font-family: 'Times New Roman';">name</span><span style="font-family: 宋体;">只是一个字符指针，真正的字符则放在另一个区段</span><span style="font-family: 'Times New Roman';">“.kstrtab”</span><span style="font-family: 宋体;">中。</span></p> 
         <p>宏定义<span style="font-family: 'Times New Roman';">EXPORT_SYMBOL</span><span style="font-family: 宋体;">定义在</span><span style="font-family: 'Times New Roman';">include/linux/module.h</span><span style="font-family: 宋体;">中：</span></p> 
         <div class="wp_codebox_msgheader"> 
          <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
          <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=735&amp;download=download.c">download.c</a></span> 
          <div class="codebox_clear"></div> 
         </div> 
         <div class="wp_codebox"> 
          <table> 
           <tbody> 
            <tr id="p73520"> 
             <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td> 
             <td class="code" id="p735code20"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/* Indirect stringification.  */</span>
&nbsp;
<span style="color: #339933;">#define __MODULE_STRING_1(x)   #x</span>
<span style="color: #339933;">#define __MODULE_STRING(x)   __MODULE_STRING_1(x)</span>
&nbsp;
<span style="color: #339933;">#define __EXPORT_SYMBOL(sym, str)			\
const char __kstrtab_##sym[]				\
__attribute__((section(".kstrtab"))) = str;		\
const struct module_symbol __ksymtab_##sym 		\
__attribute__((section("__ksymtab"))) =			\
{ (unsigned long)&amp;sym, __kstrtab_##sym }</span>
&nbsp;
<span style="color: #339933;">#if defined(MODVERSIONS) || !defined(CONFIG_MODVERSIONS)</span>
<span style="color: #339933;">#define EXPORT_SYMBOL(var)  __EXPORT_SYMBOL(var, __MODULE_STRING(var))</span>
<span style="color: #339933;">#else</span>
<span style="color: #339933;">#define EXPORT_SYMBOL(var)  __EXPORT_SYMBOL(var, __MODULE_STRING(__VERSIONED_SYMBOL(var)))</span>
<span style="color: #339933;">#endif</span></pre></td> 
            </tr> 
           </tbody> 
          </table> 
         </div> 
         <p>上述宏定义的作用就是组装一个<span style="font-family: 'Times New Roman';">module_symbol</span><span style="font-family: 宋体;">数据结构并将其放入</span><span style="font-family: 'Times New Roman';">__ksymtab</span><span style="font-family: 宋体;">区段，还记得</span><span style="font-family: 'Times New Roman';">kernel_module</span><span style="font-family: 宋体;">吗？那个内核模块的</span><span style="font-family: 'Times New Roman';">syms</span><span style="font-family: 宋体;">就是</span><span style="font-family: 'Times New Roman';">__start___ksymtab</span><span style="font-family: 宋体;">，也就是这里的</span><span style="font-family: 'Times New Roman';">__ksymtab</span><span style="font-family: 宋体;">的起始地址。另外还将字符串放入</span><span style="font-family: 'Times New Roman';">.kstrtab</span><span style="font-family: 宋体;">区段。当然有版本号和无版本号的区别，这里也就不详说了。</span></p> 
         <p>&nbsp;</p> 
         <p>The&nbsp;End.</p> 
        </div>
       </div>
       <!-- .entry-content --> 
       <!-- .entry-meta --> 
      </article>
      <!-- #post-735 --> 
      <!-- #comments --> 
     </div>
     <!-- #content --> 
    </div>
    <!-- #primary --> 
    <!-- #secondary .widget-area --> 
   </div>
   <!-- #main --> 
   <!-- #colophon --> 
  </div>
  <!-- #page -->   
  <!-- JiaThis Button BEGIN -->  
  <!-- JiaThis Button END -->   
 </body>
</html>