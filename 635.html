<!doctype html>
<!--[if IE 6]>
<html id="ie6" lang="zh-CN">
<![endif]-->
<!--[if IE 7]>
<html id="ie7" lang="zh-CN">
<![endif]-->
<!--[if IE 8]>
<html id="ie8" lang="zh-CN">
<![endif]-->
<!--[if !(IE 6) | !(IE 7) | !(IE 8)  ]><!-->
<html lang="zh-CN">
 <!--<![endif]-->
 <head>      
  <link rel="stylesheet" type="text/css" media="all" href="stylesheets/style.css">     
  <link rel="stylesheet" id="codebox-css" href="stylesheets/codebox.css" type="text/css" media="screen">             
 </head> 
 <body class="single single-post postid-635 single-format-standard content-sidebar"> 
  <div id="page" class="hfeed"> 
   <header id="branding" role="banner"> 
    <hgroup> 
     <h1 id="site-title"><span><a href="http://codelifeliwan.github.io/" title="Code_Life_LiWan" rel="home">Code_Life_LiWan</a></span></h1> 
     <h2 id="site-description">My heart will go on and on…</h2> 
    </hgroup>  
    <!-- #access --> 
   </header>
   <!-- #branding --> 
   <div id="main" class="clearfix"> 
    <div id="primary"> 
     <div id="content" role="main"> 
      <!-- #nav-single --> 
      <article id="post-635" class="post-635 post type-post status-publish format-standard hentry category-linux_kernel_source_code_notes"> 
       <header class="entry-header"> 
        <h1 class="entry-title">Linux内核-进程管理（二、进程创建）</h1> 
        <div class="entry-meta"> 
         <span class="sep">Posted on </span>
         <a href="http://codelifeliwan.github.io/?p=635" title="下午 7:35" rel="bookmark"><time class="entry-date" datetime="2012-10-05T19:35:23+00:00" pubdate>5 十月, 2012</time></a>
         <span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codelifeliwan.github.io/?author=1" title="View all posts by wanli" rel="author">wanli</a></span></span> 
         <span class="sep"> — </span> 
         <span class="comments-link"> <a href="http://codelifeliwan.github.io/?p=635#respond" title="Comment on Linux内核-进程管理（二、进程创建）">No Comments ↓</a> </span> 
        </div>
        <!-- .entry-meta --> 
       </header>
       <!-- .entry-header --> 
       <div class="entry-content">
        <div class="entry-content"> 
         <div> 
          <p>关于进程创建的基本知识，请参照《Diers<span style="font-family: 宋体;">操作系统设计与实现</span>》。</p> 
          <p>先大体说下Linux<span style="font-family: 宋体;">的进程创建，在</span><span style="font-family: 'Times New Roman';">Linux</span><span style="font-family: 宋体;">中有个系统调用</span>fork()，用来创建进程，创建完成后返回的时候是有两个返回值的，因为创建完成后是两个进程了：父进程和子进程。创建进程实际上就是复制父进程的部分资料，包括指令执行指针<span style="font-family: 'Times New Roman';">EIP</span><span style="font-family: 宋体;">，所以，创建进程完成后父进程和子进程是从同样的程序返回的，只是在创建进程的时候对返回值也就是</span><span style="font-family: 'Times New Roman';">EAX</span><span style="font-family: 宋体;">寄存器设置了一定限制，从而返回的时候是不一样的，进程创建的时候是父进程创建子进程，在子进程复制完父进程信息以后父进程就把子进程信息部分的</span><span style="font-family: 'Times New Roman';">EAX</span><span style="font-family: 宋体;">寄存器设置为</span><span style="font-family: 'Times New Roman';">0</span><span style="font-family: 宋体;">，那么这个时候子进程返回的时候返回值就是</span><span style="font-family: 'Times New Roman';">0</span><span style="font-family: 宋体;">了，父进程返回的的设置好的子进程的</span><span style="font-family: 'Times New Roman';">PID</span><span style="font-family: 宋体;">。</span></p> 
          <p>进程创建出错的时候返回<span style="font-family: 'Times New Roman';">-1.</span></p> 
          <p>在<span style="font-family: 'Times New Roman';">Linux</span><span style="font-family: 宋体;">中，子进程创建完成后可以继续执行与父进程公用的代码，也可以执行自己的代码，与父进程“分道扬镳”。</span><span style="font-family: 'Times New Roman';">Linux</span>2.4也为父进程提供了两个系统调用wait3()和wait4()，其中，<span style="font-family: 'Times New Roman';">wait</span>3()是等待任何一个子进程结束，wait4()是等待特定的子进程结束。</p> 
          <p>Linux<span style="font-family: 宋体;">也提供</span>execve()系统调用来让进程执行特定程序，比如下面程序：</p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=635&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p6351"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td> 
              <td class="code" id="p635code1"><pre class="c" style="font-family:monospace;"><span style="color: #339933;">#include&lt;stdio.h&gt;</span>
<span style="color: #339933;">#include&lt;unistd.h&gt;</span>
&nbsp;
<span style="color: #993333;">int</span> main<span style="color: #009900;">(</span><span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	pid_t pid<span style="color: #339933;">;</span>
	<span style="color: #993333;">char</span> <span style="color: #339933;">*</span>args<span style="color: #009900;">[</span><span style="color: #009900;">]</span><span style="color: #339933;">=</span><span style="color: #009900;">{</span><span style="color: #ff0000;">"/bin/echo"</span><span style="color: #339933;">,</span><span style="color: #ff0000;">"Hello"</span><span style="color: #339933;">,</span><span style="color: #ff0000;">"World"</span><span style="color: #339933;">,</span>NULL<span style="color: #009900;">}</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">while</span><span style="color: #009900;">(</span><span style="color: #009900;">(</span>pid<span style="color: #339933;">=</span>fork<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">&lt;</span><span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span><span style="color: #009900;">(</span>pid<span style="color: #339933;">==</span><span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #009900;">{</span>
		<span style="color: #666666; font-style: italic;">//子进程返回值为0</span>
		<a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: #009900;">(</span><span style="color: #ff0000;">"pid is : %d and %d is my father!<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span>getpid<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>getppid<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		execve<span style="color: #009900;">(</span><span style="color: #ff0000;">"/bin/echo"</span><span style="color: #339933;">,</span>args<span style="color: #339933;">,</span>NULL<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: #009900;">(</span><span style="color: #ff0000;">"Program will not run here!<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span><span style="color: #666666; font-style: italic;">//程序不会执行到此处</span>
	<span style="color: #009900;">}</span><span style="color: #b1b100;">else</span><span style="color: #009900;">{</span>
		<span style="color: #666666; font-style: italic;">//父进程返回子进程pid</span>
		<a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: #009900;">(</span><span style="color: #ff0000;">"This is father process!<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>每一个子进程结束后都有一个<span style="font-family: 'Times New Roman';">exit</span>()系统调用来通知父进程子进程已经结束，在程序编译的过程中<span style="font-family: 'Times New Roman';">gcc</span><span style="font-family: 宋体;">会为程序自动加上</span><span style="font-family: 'Times New Roman';">exit</span>()系统调用，所以上面程序不会执行到L，因为在执行<span style="font-family: 'Times New Roman';">execve</span><span style="font-family: 宋体;">的时候子进程就已经与父进程“分道扬镳”了，之后会执行自己的</span>exit()系统调用，不会再返回到父进程代码。</p> 
          <p>进程的创建有三种方式，一个是fork()，一个是vfork()，一个是<span style="font-family: 'Times New Roman';">clone()</span><span style="font-family: 宋体;">。</span></p> 
          <p>fork()创建的进程是将父进程的所有资源全部复制。</p> 
          <p>clone()<span style="font-family: 宋体;">创建的进程是有选择的复制父进程资源。</span></p> 
          <p>vfork()<span style="font-family: 宋体;">只是将父进程的</span><span style="font-family: 'Times New Roman';">task_struct</span><span style="font-family: 宋体;">结构和系统堆栈复制，其他全部与父进程共用。</span></p> 
          <p>先撇开以上三种方法，这里介绍一种创建内核线程的方法kernel_thread()，这个方法定义在arch/i386/kernel/process.c中：</p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=635&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p6352"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td> 
              <td class="code" id="p635code2"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * Create a kernel thread
 */</span>
<span style="color: #993333;">int</span> kernel_thread<span style="color: #009900;">(</span><span style="color: #993333;">int</span> <span style="color: #009900;">(</span><span style="color: #339933;">*</span>fn<span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #993333;">void</span> <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span> <span style="color: #993333;">void</span> <span style="color: #339933;">*</span> arg<span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> flags<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">long</span> retval<span style="color: #339933;">,</span> d0<span style="color: #339933;">;</span>
&nbsp;
	__asm__ __volatile__<span style="color: #009900;">(</span>
		<span style="color: #ff0000;">"movl %%esp,%%esi<span style="color: #000099; font-weight: bold;">\n</span><span style="color: #000099; font-weight: bold;">\t</span>"</span>
		<span style="color: #ff0000;">"int $0x80<span style="color: #000099; font-weight: bold;">\n</span><span style="color: #000099; font-weight: bold;">\t</span>"</span>		<span style="color: #808080; font-style: italic;">/* Linux/i386 system call */</span>
		<span style="color: #ff0000;">"cmpl %%esp,%%esi<span style="color: #000099; font-weight: bold;">\n</span><span style="color: #000099; font-weight: bold;">\t</span>"</span>	<span style="color: #808080; font-style: italic;">/* child or parent? */</span>
		<span style="color: #ff0000;">"je 1f<span style="color: #000099; font-weight: bold;">\n</span><span style="color: #000099; font-weight: bold;">\t</span>"</span>		<span style="color: #808080; font-style: italic;">/* parent - jump */</span>
		<span style="color: #808080; font-style: italic;">/* Load the argument into eax, and push it.  That way, it does
		 * not matter whether the called function is compiled with
		 * -mregparm or not.  */</span>
		<span style="color: #ff0000;">"movl %4,%%eax<span style="color: #000099; font-weight: bold;">\n</span><span style="color: #000099; font-weight: bold;">\t</span>"</span>
		<span style="color: #ff0000;">"pushl %%eax<span style="color: #000099; font-weight: bold;">\n</span><span style="color: #000099; font-weight: bold;">\t</span>"</span>		
		<span style="color: #ff0000;">"call *%5<span style="color: #000099; font-weight: bold;">\n</span><span style="color: #000099; font-weight: bold;">\t</span>"</span>		<span style="color: #808080; font-style: italic;">/* call fn */</span>
		<span style="color: #ff0000;">"movl %3,%0<span style="color: #000099; font-weight: bold;">\n</span><span style="color: #000099; font-weight: bold;">\t</span>"</span>	<span style="color: #808080; font-style: italic;">/* exit */</span>
		<span style="color: #ff0000;">"int $0x80<span style="color: #000099; font-weight: bold;">\n</span>"</span>
		<span style="color: #ff0000;">"1:<span style="color: #000099; font-weight: bold;">\t</span>"</span>
		<span style="color: #339933;">:</span><span style="color: #ff0000;">"=&amp;a"</span> <span style="color: #009900;">(</span>retval<span style="color: #009900;">)</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">"=&amp;S"</span> <span style="color: #009900;">(</span>d0<span style="color: #009900;">)</span>
		<span style="color: #339933;">:</span><span style="color: #ff0000;">"0"</span> <span style="color: #009900;">(</span>__NR_clone<span style="color: #009900;">)</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">"i"</span> <span style="color: #009900;">(</span>__NR_exit<span style="color: #009900;">)</span><span style="color: #339933;">,</span>
		 <span style="color: #ff0000;">"r"</span> <span style="color: #009900;">(</span>arg<span style="color: #009900;">)</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">"r"</span> <span style="color: #009900;">(</span>fn<span style="color: #009900;">)</span><span style="color: #339933;">,</span>
		 <span style="color: #ff0000;">"b"</span> <span style="color: #009900;">(</span>flags <span style="color: #339933;">|</span> CLONE_VM<span style="color: #009900;">)</span>
		<span style="color: #339933;">:</span> <span style="color: #ff0000;">"memory"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> retval<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>这里使用内联汇编的方式来创建内核线程，先看输入部：<span style="font-family: 'Times New Roman';">“0”&nbsp;(__NR_clone)</span><span style="font-family: 宋体;">将</span>__NR_clone装入<span style="font-family: 'Times New Roman';">EAX</span><span style="font-family: 宋体;">寄存器，也就是说在第一个</span>int&nbsp;0x80使用系统调用之前设置了<span style="font-family: 'Times New Roman';">EAX</span><span style="font-family: 宋体;">为</span>__NR_clone，事实上就是调用了系统调用<span style="font-family: 'Times New Roman';">clone</span>()，接着比较<span style="font-family: 'Times New Roman';">esp</span><span style="font-family: 宋体;">与</span><span style="font-family: 'Times New Roman';">esi</span><span style="font-family: 宋体;">是否相等，可以看到，在</span><span style="font-family: 'Times New Roman';">0x80</span><span style="font-family: 宋体;">号系统调用之前使</span><span style="font-family: 'Times New Roman';">esp</span><span style="font-family: 宋体;">也就是父进程堆栈指针与</span><span style="font-family: 'Times New Roman';">esi</span><span style="font-family: 宋体;">相等了，而在</span><span style="font-family: 'Times New Roman';">clone</span>()后子进程采用自己的系统堆栈，所以堆栈指针肯定变化了，为什么不比较<span style="font-family: 'Times New Roman';">pid</span><span style="font-family: 宋体;">呢？因为使用</span><span style="font-family: 'Times New Roman';">clone</span>()的时候父子进程的<span style="font-family: 'Times New Roman';">pid</span><span style="font-family: 宋体;">可以相等，所以不能比较。然后如果</span><span style="font-family: 'Times New Roman';">esp</span><span style="font-family: 宋体;">与</span><span style="font-family: 'Times New Roman';">esi</span><span style="font-family: 宋体;">相等则是父进程跳转到</span><span style="font-family: 'Times New Roman';">1</span><span style="font-family: 宋体;">处开始执行，否则就执行传入的函数指针</span><span style="font-family: 'Times New Roman';">fn</span><span style="font-family: 宋体;">，因为是内核线程，没有自动的</span>exit()，所以执行完<span style="font-family: 'Times New Roman';">fn</span><span style="font-family: 宋体;">之后还会返回到此处，然后手动调用</span><span style="font-family: 'Times New Roman';">exit</span>()系统调用来结束，下面的int&nbsp;0x80就是为此设置的exit()系统调用。</p> 
          <p>好了，现在来介绍正式的进程创建：</p> 
          <p>还是在arch/i386/kernel/process.c中：</p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=635&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p6353"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td> 
              <td class="code" id="p635code3"><pre class="c" style="font-family:monospace;">asmlinkage <span style="color: #993333;">int</span> sys_fork<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> pt_regs regs<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #b1b100;">return</span> do_fork<span style="color: #009900;">(</span>SIGCHLD<span style="color: #339933;">,</span> regs.<span style="color: #202020;">esp</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>regs<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span>
&nbsp;
asmlinkage <span style="color: #993333;">int</span> sys_clone<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> pt_regs regs<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> clone_flags<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> newsp<span style="color: #339933;">;</span>
&nbsp;
	clone_flags <span style="color: #339933;">=</span> regs.<span style="color: #202020;">ebx</span><span style="color: #339933;">;</span>
	newsp <span style="color: #339933;">=</span> regs.<span style="color: #202020;">ecx</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>newsp<span style="color: #009900;">)</span>
		newsp <span style="color: #339933;">=</span> regs.<span style="color: #202020;">esp</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> do_fork<span style="color: #009900;">(</span>clone_flags<span style="color: #339933;">,</span> newsp<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>regs<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/*
 * This is trivial, and on the face of it looks like it
 * could equally well be done in user mode.
 *
 * Not so, for quite unobvious reasons - register pressure.
 * In user mode vfork() cannot have a stack frame, and if
 * done by calling the "clone()" system call directly, you
 * do not have enough call-clobbered registers to hold all
 * the information you need.
 */</span>
asmlinkage <span style="color: #993333;">int</span> sys_vfork<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> pt_regs regs<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #b1b100;">return</span> do_fork<span style="color: #009900;">(</span>CLONE_VFORK <span style="color: #339933;">|</span> CLONE_VM <span style="color: #339933;">|</span> SIGCHLD<span style="color: #339933;">,</span> regs.<span style="color: #202020;">esp</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>regs<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>可见，这三个创建进程的方法都是使用do_fork()来创建的，只是创建的时候传的参数不一样罢了。</p> 
          <p>其中传入的标志位如下所示(include/linux/sched.h)：</p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=635&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p6354"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td> 
              <td class="code" id="p635code4"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
&nbsp;
*&nbsp;cloning&nbsp;flags:
&nbsp;
*/</span>
&nbsp;
<span style="color: #339933;">#define&nbsp;CSIGNAL 0x000000ff /*&nbsp;signal&nbsp;mask&nbsp;to&nbsp;be&nbsp;sent&nbsp;at&nbsp;exit&nbsp;*/</span>
&nbsp;
<span style="color: #339933;">#define&nbsp;CLONE_VM 0x00000100 /*&nbsp;set&nbsp;if&nbsp;VM&nbsp;shared&nbsp;between&nbsp;processes&nbsp;*/</span>
&nbsp;
<span style="color: #339933;">#define&nbsp;CLONE_FS 0x00000200 /*&nbsp;set&nbsp;if&nbsp;fs&nbsp;info&nbsp;shared&nbsp;between&nbsp;processes&nbsp;*/</span>
&nbsp;
<span style="color: #339933;">#define&nbsp;CLONE_FILES 0x00000400 /*&nbsp;set&nbsp;if&nbsp;open&nbsp;files&nbsp;shared&nbsp;between&nbsp;processes&nbsp;*/</span>
&nbsp;
<span style="color: #339933;">#define&nbsp;CLONE_SIGHAND 0x00000800 /*&nbsp;set&nbsp;if&nbsp;signal&nbsp;handlers&nbsp;and&nbsp;blocked&nbsp;signals&nbsp;shared&nbsp;*/</span>
&nbsp;
<span style="color: #339933;">#define&nbsp;CLONE_PID 0x00001000 /*&nbsp;set&nbsp;if&nbsp;pid&nbsp;shared&nbsp;*/</span>
&nbsp;
<span style="color: #339933;">#define&nbsp;CLONE_PTRACE 0x00002000 /*&nbsp;set&nbsp;if&nbsp;we&nbsp;want&nbsp;to&nbsp;let&nbsp;tracing&nbsp;continue&nbsp;on&nbsp;the&nbsp;child&nbsp;too&nbsp;*/</span>
&nbsp;
<span style="color: #339933;">#define&nbsp;CLONE_VFORK 0x00004000 /*&nbsp;set&nbsp;if&nbsp;the&nbsp;parent&nbsp;wants&nbsp;the&nbsp;child&nbsp;to&nbsp;wake&nbsp;it&nbsp;up&nbsp;on&nbsp;mm_release&nbsp;*/</span>
&nbsp;
<span style="color: #339933;">#define&nbsp;CLONE_PARENT 0x00008000 /*&nbsp;set&nbsp;if&nbsp;we&nbsp;want&nbsp;to&nbsp;have&nbsp;the&nbsp;same&nbsp;parent&nbsp;as&nbsp;the&nbsp;cloner&nbsp;*/</span>
&nbsp;
<span style="color: #339933;">#define&nbsp;CLONE_THREAD 0x00010000 /*&nbsp;Same&nbsp;thread&nbsp;group?&nbsp;*/</span>
&nbsp;
&nbsp;
&nbsp;
<span style="color: #339933;">#define&nbsp;CLONE_SIGNAL (CLONE_SIGHAND&nbsp;|&nbsp;CLONE_THREAD)</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>对于fork()来说，这些全部为<span style="font-family: 'Times New Roman';">0</span><span style="font-family: 宋体;">，而对于</span>vfork()来说为<span style="font-family: 'Times New Roman';">CLONE_VFORK|CLONE_VM</span><span style="font-family: 宋体;">表示父子进程共用用户虚存区间，并且当子进程释放其虚存区间时要唤醒父进程，下面可以看到，使用</span><span style="font-family: 'Times New Roman';">vfork()</span><span style="font-family: 宋体;">创建进程的时候是子进程先运行，父进程不得不睡眠，因为只有一份资源，两个进程不可同时使用。对于</span><span style="font-family: 'Times New Roman';">clone()</span><span style="font-family: 宋体;">来说，这些标志位可以由调用者自己设定。</span></p> 
          <p>在将do_fork()函数的时候，由于函数比较长，所以我尽量加上注释，由于函数几乎都是顺序执行的，所以就不给出流程图了，读者可以自己根据注释画出流程图：</p> 
          <p>do_fork()是在kernel/fork.c中定义的：</p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=635&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p6355"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
</pre></td> 
              <td class="code" id="p635code5"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 *  Ok, this is the main fork-routine. It copies the system process
 * information (task[nr]) and sets up the necessary registers. It also
 * copies the data segment in its entirety.  The "stack_start" and
 * "stack_top" arguments are simply passed along to the platform
 * specific copy_thread() routine.  Most platforms ignore stack_top.
 * For an example that's using stack_top, see
 * arch/ia64/kernel/process.c.
 */</span>
<span style="color: #993333;">int</span> do_fork<span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> clone_flags<span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> stack_start<span style="color: #339933;">,</span>
	    <span style="color: #993333;">struct</span> pt_regs <span style="color: #339933;">*</span>regs<span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> stack_size<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">int</span> retval <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ENOMEM<span style="color: #339933;">;</span>       	<span style="color: #666666; font-style: italic;">//返回值</span>
	<span style="color: #993333;">struct</span> task_struct <span style="color: #339933;">*</span>p<span style="color: #339933;">;</span>          <span style="color: #666666; font-style: italic;">//task_struct结构</span>
	DECLARE_MUTEX_LOCKED<span style="color: #009900;">(</span>sem<span style="color: #009900;">)</span><span style="color: #339933;">;</span>      <span style="color: #666666; font-style: italic;">//创建进程同步/互斥信号量</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>clone_flags <span style="color: #339933;">&amp;</span> CLONE_PID<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>  <span style="color: #666666; font-style: italic;">//判断是否需要共用pid</span>
		<span style="color: #808080; font-style: italic;">/* This is only allowed from the boot up thread */</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>pid<span style="color: #009900;">)</span>           <span style="color: #666666; font-style: italic;">//只有0号进程才可以共用pid</span>
			<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>EPERM<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	current<span style="color: #339933;">-&gt;</span>vfork_sem <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>sem<span style="color: #339933;">;</span>
&nbsp;
	p <span style="color: #339933;">=</span> alloc_task_struct<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>        <span style="color: #666666; font-style: italic;">//为进程task_struct和系统堆栈分配两个页面空间</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>p<span style="color: #009900;">)</span>                         <span style="color: #666666; font-style: italic;">//分配失败</span>
		<span style="color: #b1b100;">goto</span> fork_out<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #339933;">*</span>p <span style="color: #339933;">=</span> <span style="color: #339933;">*</span>current<span style="color: #339933;">;</span>                  <span style="color: #666666; font-style: italic;">//整体赋值，将当前进程的task_struct赋值给子进程，用memcpy实现</span>
&nbsp;
	retval <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EAGAIN<span style="color: #339933;">;</span>
	<span style="color: #808080; font-style: italic;">/**
	 *在每个task_struct结构中都有一个user_struct结构，
	 *定义于include/linux/sched.h中：
     *  struct user_struct {
	 *      atomic_t __count;//计数
	 *      atomic_t processes;//当前用户进程数
	 *      atomic_t files;     //当前用户打开文件数
	 *      struct user_struct *next, **pprev;
	 *      uid_t uid;
     *  };
     *用来表明当前进程的用户信息，注意，内核线程不属于
     *任何用户，其task_struct中的user指针为空。
	 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>atomic_read<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>p<span style="color: #339933;">-&gt;</span>user<span style="color: #339933;">-&gt;</span>processes<span style="color: #009900;">)</span> <span style="color: #339933;">&gt;=</span> p<span style="color: #339933;">-&gt;</span>rlim<span style="color: #009900;">[</span>RLIMIT_NPROC<span style="color: #009900;">]</span>.<span style="color: #202020;">rlim_cur</span><span style="color: #009900;">)</span> <span style="color: #666666; font-style: italic;">//判断当前用户进程数是否已经达到上限</span>
		<span style="color: #b1b100;">goto</span> bad_fork_free<span style="color: #339933;">;</span>
	atomic_inc<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>p<span style="color: #339933;">-&gt;</span>user<span style="color: #339933;">-&gt;</span>__count<span style="color: #009900;">)</span><span style="color: #339933;">;</span>  <span style="color: #666666; font-style: italic;">//自增操作</span>
	atomic_inc<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>p<span style="color: #339933;">-&gt;</span>user<span style="color: #339933;">-&gt;</span>processes<span style="color: #009900;">)</span><span style="color: #339933;">;</span>    <span style="color: #666666; font-style: italic;">//自增操作</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * Counter increases are protected by
	 * the kernel lock so nr_threads can't
	 * increase under us (but it may decrease).
	 */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>nr_threads <span style="color: #339933;">&gt;=</span> max_threads<span style="color: #009900;">)</span>  <span style="color: #666666; font-style: italic;">//判断总进程数是否已达上限</span>
		<span style="color: #b1b100;">goto</span> bad_fork_cleanup_count<span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;">/**
     *在每个task_struct结构中都有一个exec_domain指针
     *定义在include/linux/personality.h中：
     *  struct exec_domain {
	 *      const char *name;
     *      lcall7_func handler;
	 *      unsigned char pers_low, pers_high;
	 *      unsigned long * signal_map;
	 *      unsigned long * signal_invmap;
	 *      struct module * module;
	 *      struct exec_domain *next;
     *  };
     *这个结构用来说明进程的“执行域”，一个进程除了
     *属于一个“用户”以外，还属于某个执行域，根据Unix
     *的变种不同形成了不同的“执行域”，其中，handler
     *用于通过调用门实现系统调用，pers_low为域代码。
     *module为动态安装模块。
     *get_exec_domain定义如下：
     *#define get_exec_domain(it) \
     *  if(it&amp;&amp;it-&gt;module) __MOD_INC_USE_COUNT(it-&gt;module);
     */</span>
	get_exec_domain<span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>exec_domain<span style="color: #009900;">)</span><span style="color: #339933;">;</span>    <span style="color: #666666; font-style: italic;">//递增“执行域”操作</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>binfmt <span style="color: #339933;">&amp;&amp;</span> p<span style="color: #339933;">-&gt;</span>binfmt<span style="color: #339933;">-&gt;</span>module<span style="color: #009900;">)</span>
		__MOD_INC_USE_COUNT<span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>binfmt<span style="color: #339933;">-&gt;</span>module<span style="color: #009900;">)</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">//递增可执行文件映像格式</span>
&nbsp;
	p<span style="color: #339933;">-&gt;</span>did_exec <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>        <span style="color: #666666; font-style: italic;">//子进程执行exec为0，未执行过</span>
	p<span style="color: #339933;">-&gt;</span>swappable <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>       <span style="color: #666666; font-style: italic;">//子进程未发生过页面交换</span>
	p<span style="color: #339933;">-&gt;</span>state <span style="color: #339933;">=</span> TASK_UNINTERRUPTIBLE<span style="color: #339933;">;</span><span style="color: #666666; font-style: italic;">//为了防止新建进程被调度执行，所以将状态设置成TASK_UNINTERRUPTIBLE</span>
&nbsp;
	copy_flags<span style="color: #009900;">(</span>clone_flags<span style="color: #339933;">,</span> p<span style="color: #009900;">)</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">//将clone_flags略加修改，写入p-&gt;flags</span>
	p<span style="color: #339933;">-&gt;</span>pid <span style="color: #339933;">=</span> get_pid<span style="color: #009900;">(</span>clone_flags<span style="color: #009900;">)</span><span style="color: #339933;">;</span>  <span style="color: #666666; font-style: italic;">//随机取得pid，在下面将会讲到</span>
&nbsp;
	p<span style="color: #339933;">-&gt;</span>run_list.<span style="color: #202020;">next</span> <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>        <span style="color: #666666; font-style: italic;">//暂时不链入可执行队列</span>
	p<span style="color: #339933;">-&gt;</span>run_list.<span style="color: #202020;">prev</span> <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>        <span style="color: #666666; font-style: italic;">//暂时不链入可执行队列</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>clone_flags <span style="color: #339933;">&amp;</span> CLONE_VFORK<span style="color: #009900;">)</span> <span style="color: #339933;">||</span> <span style="color: #339933;">!</span><span style="color: #009900;">(</span>clone_flags <span style="color: #339933;">&amp;</span> CLONE_PARENT<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		p<span style="color: #339933;">-&gt;</span>p_opptr <span style="color: #339933;">=</span> current<span style="color: #339933;">;</span>       <span style="color: #666666; font-style: italic;">//p_opptr指向进程的原始父进程</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span><span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>ptrace <span style="color: #339933;">&amp;</span> PT_PTRACED<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			p<span style="color: #339933;">-&gt;</span>p_pptr <span style="color: #339933;">=</span> current<span style="color: #339933;">;</span>    <span style="color: #666666; font-style: italic;">//p_pptr指向进程的当前父进程</span>
	<span style="color: #009900;">}</span>
	p<span style="color: #339933;">-&gt;</span>p_cptr <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>           <span style="color: #666666; font-style: italic;">//子进程现在还没有子进程，所以最年轻子进程为空</span>
	init_waitqueue_head<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>p<span style="color: #339933;">-&gt;</span>wait_chldexit<span style="color: #009900;">)</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">//初始化等待进程p的子进程队列</span>
	<span style="color: #808080; font-style: italic;">/**
	 *下面是信号量、计时等初始化
	 */</span>
	p<span style="color: #339933;">-&gt;</span>vfork_sem <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	spin_lock_init<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>p<span style="color: #339933;">-&gt;</span>alloc_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	p<span style="color: #339933;">-&gt;</span>sigpending <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	init_sigpending<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>p<span style="color: #339933;">-&gt;</span>pending<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	p<span style="color: #339933;">-&gt;</span>it_real_value <span style="color: #339933;">=</span> p<span style="color: #339933;">-&gt;</span>it_virt_value <span style="color: #339933;">=</span> p<span style="color: #339933;">-&gt;</span>it_prof_value <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	p<span style="color: #339933;">-&gt;</span>it_real_incr <span style="color: #339933;">=</span> p<span style="color: #339933;">-&gt;</span>it_virt_incr <span style="color: #339933;">=</span> p<span style="color: #339933;">-&gt;</span>it_prof_incr <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	init_timer<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>p<span style="color: #339933;">-&gt;</span>real_timer<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	p<span style="color: #339933;">-&gt;</span>real_timer.<span style="color: #202020;">data</span> <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span> p<span style="color: #339933;">;</span>
&nbsp;
	p<span style="color: #339933;">-&gt;</span>leader <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* session leadership doesn't inherit */</span>
	p<span style="color: #339933;">-&gt;</span>tty_old_pgrp <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	p<span style="color: #339933;">-&gt;</span>times.<span style="color: #202020;">tms_utime</span> <span style="color: #339933;">=</span> p<span style="color: #339933;">-&gt;</span>times.<span style="color: #202020;">tms_stime</span> <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	p<span style="color: #339933;">-&gt;</span>times.<span style="color: #202020;">tms_cutime</span> <span style="color: #339933;">=</span> p<span style="color: #339933;">-&gt;</span>times.<span style="color: #202020;">tms_cstime</span> <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #808080; font-style: italic;">/*多处理器相关*/</span>
<span style="color: #339933;">#ifdef CONFIG_SMP</span>
	<span style="color: #009900;">{</span>
		<span style="color: #993333;">int</span> i<span style="color: #339933;">;</span>
		p<span style="color: #339933;">-&gt;</span>has_cpu <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		p<span style="color: #339933;">-&gt;</span>processor <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>processor<span style="color: #339933;">;</span>
		<span style="color: #808080; font-style: italic;">/* ?? should we just memset this ?? */</span>
		<span style="color: #b1b100;">for</span><span style="color: #009900;">(</span>i <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> i <span style="color: #339933;">&lt;</span> smp_num_cpus<span style="color: #339933;">;</span> i<span style="color: #339933;">++</span><span style="color: #009900;">)</span>
			p<span style="color: #339933;">-&gt;</span>per_cpu_utime<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span> <span style="color: #339933;">=</span> p<span style="color: #339933;">-&gt;</span>per_cpu_stime<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span> <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		spin_lock_init<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>p<span style="color: #339933;">-&gt;</span>sigmask_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
<span style="color: #339933;">#endif</span>
	p<span style="color: #339933;">-&gt;</span>lock_depth <span style="color: #339933;">=</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>		<span style="color: #808080; font-style: italic;">/* -1 = no lock */</span>
	p<span style="color: #339933;">-&gt;</span>start_time <span style="color: #339933;">=</span> jiffies<span style="color: #339933;">;</span>    <span style="color: #666666; font-style: italic;">//初始时间为当前系统时间片</span>
&nbsp;
	retval <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ENOMEM<span style="color: #339933;">;</span>
	<span style="color: #808080; font-style: italic;">/* copy all the process information */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>copy_files<span style="color: #009900;">(</span>clone_flags<span style="color: #339933;">,</span> p<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #666666; font-style: italic;">//有条件地复制已打开文件的控制结构</span>
		<span style="color: #b1b100;">goto</span> bad_fork_cleanup<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>copy_fs<span style="color: #009900;">(</span>clone_flags<span style="color: #339933;">,</span> p<span style="color: #009900;">)</span><span style="color: #009900;">)</span>    <span style="color: #666666; font-style: italic;">//有条件地复制文件系统相关控制结构</span>
		<span style="color: #b1b100;">goto</span> bad_fork_cleanup_files<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>copy_sighand<span style="color: #009900;">(</span>clone_flags<span style="color: #339933;">,</span> p<span style="color: #009900;">)</span><span style="color: #009900;">)</span>   <span style="color: #666666; font-style: italic;">//有条件地复制信号量相关控制结构</span>
		<span style="color: #b1b100;">goto</span> bad_fork_cleanup_fs<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>copy_mm<span style="color: #009900;">(</span>clone_flags<span style="color: #339933;">,</span> p<span style="color: #009900;">)</span><span style="color: #009900;">)</span>        <span style="color: #666666; font-style: italic;">//有条件的复制内存结构</span>
		<span style="color: #b1b100;">goto</span> bad_fork_cleanup_sighand<span style="color: #339933;">;</span>
	retval <span style="color: #339933;">=</span> copy_thread<span style="color: #009900;">(</span><span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> clone_flags<span style="color: #339933;">,</span> stack_start<span style="color: #339933;">,</span> stack_size<span style="color: #339933;">,</span> p<span style="color: #339933;">,</span> regs<span style="color: #009900;">)</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">//有条件的复制系统堆栈</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>retval<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> bad_fork_cleanup_sighand<span style="color: #339933;">;</span>
	p<span style="color: #339933;">-&gt;</span>semundo <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Our parent execution domain becomes current domain
	   These must match for thread signalling to apply */</span>
&nbsp;
	p<span style="color: #339933;">-&gt;</span>parent_exec_id <span style="color: #339933;">=</span> p<span style="color: #339933;">-&gt;</span>self_exec_id<span style="color: #339933;">;</span>    <span style="color: #666666; font-style: italic;">//这个执行域标志难道是用来进程间的父子识别？</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* ok, now we should be set up.. */</span>
	p<span style="color: #339933;">-&gt;</span>swappable <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>       <span style="color: #666666; font-style: italic;">//本进程存储页面可以被换出</span>
	p<span style="color: #339933;">-&gt;</span>exit_signal <span style="color: #339933;">=</span> clone_flags <span style="color: #339933;">&amp;</span> CSIGNAL<span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">//进程执行exit()时父进程发送信号？</span>
	p<span style="color: #339933;">-&gt;</span>pdeath_signal <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>   <span style="color: #666666; font-style: italic;">//要求父进程在执行exit()时不向本进程发送信号</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * "share" dynamic priority between parent and child, thus the
	 * total amount of dynamic priorities in the system doesnt change,
	 * more scheduling fairness. This is only important in the first
	 * timeslice, on the long run the scheduling behaviour is unchanged.
	 */</span>
	p<span style="color: #339933;">-&gt;</span>counter <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>counter <span style="color: #339933;">+</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span> <span style="color: #339933;">&gt;&gt;</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>   <span style="color: #666666; font-style: italic;">//进程运行时间配额</span>
	current<span style="color: #339933;">-&gt;</span>counter <span style="color: #339933;">&gt;&gt;=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>     <span style="color: #666666; font-style: italic;">//父进程时间配额分成两半，父子各一半</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>current<span style="color: #339933;">-&gt;</span>counter<span style="color: #009900;">)</span>      <span style="color: #666666; font-style: italic;">//配额太少</span>
		current<span style="color: #339933;">-&gt;</span>need_resched <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * Ok, add it to the run-queues and make it
	 * visible to the rest of the system.
	 *
	 * Let it rip!
	 */</span>
	retval <span style="color: #339933;">=</span> p<span style="color: #339933;">-&gt;</span>pid<span style="color: #339933;">;</span>        <span style="color: #666666; font-style: italic;">//父进程返回值为子进程pid</span>
	p<span style="color: #339933;">-&gt;</span>tgid <span style="color: #339933;">=</span> retval<span style="color: #339933;">;</span>
	INIT_LIST_HEAD<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>p<span style="color: #339933;">-&gt;</span>thread_group<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	write_lock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tasklist_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>clone_flags <span style="color: #339933;">&amp;</span> CLONE_THREAD<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>   <span style="color: #666666; font-style: italic;">//判断是否创建的是线程</span>
		p<span style="color: #339933;">-&gt;</span>tgid <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>tgid<span style="color: #339933;">;</span>        <span style="color: #666666; font-style: italic;">//是的话就通过thread_group来与父进程连接起来，形成“进程组”</span>
		list_add<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>p<span style="color: #339933;">-&gt;</span>thread_group<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>current<span style="color: #339933;">-&gt;</span>thread_group<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	SET_LINKS<span style="color: #009900;">(</span>p<span style="color: #009900;">)</span><span style="color: #339933;">;</span>       <span style="color: #666666; font-style: italic;">//将子进程链入内核进程队列，但是由于状态为TASK_UNINTERRUPTIBLE</span>
                        <span style="color: #666666; font-style: italic;">//所以不可调度</span>
	hash_pid<span style="color: #009900;">(</span>p<span style="color: #009900;">)</span><span style="color: #339933;">;</span>        <span style="color: #666666; font-style: italic;">//链入哈希杂凑队列</span>
	nr_threads<span style="color: #339933;">++;</span>       <span style="color: #666666; font-style: italic;">//总进程数加1</span>
	write_unlock_irq<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>tasklist_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>ptrace <span style="color: #339933;">&amp;</span> PT_PTRACED<span style="color: #009900;">)</span> <span style="color: #666666; font-style: italic;">//如果需要调试此子进程</span>
		send_sig<span style="color: #009900;">(</span>SIGSTOP<span style="color: #339933;">,</span> p<span style="color: #339933;">,</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>    <span style="color: #666666; font-style: italic;">//子进程状态设置为TASK_STOPPED</span>
&nbsp;
	wake_up_process<span style="color: #009900;">(</span>p<span style="color: #009900;">)</span><span style="color: #339933;">;</span><span style="color: #666666; font-style: italic;">//进程创建和初始化结束，唤醒进程，使之可以被调度运行</span>
	<span style="color: #339933;">++</span>total_forks<span style="color: #339933;">;</span>      <span style="color: #666666; font-style: italic;">//总创建进程次数加1</span>
&nbsp;
fork_out<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span>clone_flags <span style="color: #339933;">&amp;</span> CLONE_VFORK<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">(</span>retval <span style="color: #339933;">&gt;</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #666666; font-style: italic;">//若为VFORK</span>
		down<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>sem<span style="color: #009900;">)</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">//父进程信号量阻塞，等待子进程完成</span>
	<span style="color: #b1b100;">return</span> retval<span style="color: #339933;">;</span>
&nbsp;
bad_fork_cleanup_sighand<span style="color: #339933;">:</span>
	exit_sighand<span style="color: #009900;">(</span>p<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
bad_fork_cleanup_fs<span style="color: #339933;">:</span>
	exit_fs<span style="color: #009900;">(</span>p<span style="color: #009900;">)</span><span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* blocking */</span>
bad_fork_cleanup_files<span style="color: #339933;">:</span>
	exit_files<span style="color: #009900;">(</span>p<span style="color: #009900;">)</span><span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* blocking */</span>
bad_fork_cleanup<span style="color: #339933;">:</span>
	put_exec_domain<span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>exec_domain<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>binfmt <span style="color: #339933;">&amp;&amp;</span> p<span style="color: #339933;">-&gt;</span>binfmt<span style="color: #339933;">-&gt;</span>module<span style="color: #009900;">)</span>
		__MOD_DEC_USE_COUNT<span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>binfmt<span style="color: #339933;">-&gt;</span>module<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
bad_fork_cleanup_count<span style="color: #339933;">:</span>
	atomic_dec<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>p<span style="color: #339933;">-&gt;</span>user<span style="color: #339933;">-&gt;</span>processes<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	free_uid<span style="color: #009900;">(</span>p<span style="color: #339933;">-&gt;</span>user<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
bad_fork_free<span style="color: #339933;">:</span>
	free_task_struct<span style="color: #009900;">(</span>p<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">goto</span> fork_out<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>而关于上面有条件复制的一些函数需要说明下：</p> 
          <p>第一个就是copy_files()，定义在fork.c中：</p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=635&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p6356"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
</pre></td> 
              <td class="code" id="p635code6"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">int</span> copy_files<span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> clone_flags<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> task_struct <span style="color: #339933;">*</span> tsk<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> files_struct <span style="color: #339933;">*</span>oldf<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>newf<span style="color: #339933;">;</span><span style="color: #666666; font-style: italic;">//oldf为父进程打开的文件，newf为子进程打开的文件</span>
	<span style="color: #993333;">struct</span> file <span style="color: #339933;">**</span>old_fds<span style="color: #339933;">,</span> <span style="color: #339933;">**</span>new_fds<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> open_files<span style="color: #339933;">,</span> nfds<span style="color: #339933;">,</span> size<span style="color: #339933;">,</span> i<span style="color: #339933;">,</span> error <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/**
	 * A background process may not have any files ...
	 *每个父进程都有一个files_struct指针files，存放打开的
	 *文件。
	 */</span>
	oldf <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>files<span style="color: #339933;">;</span>  <span style="color: #666666; font-style: italic;">//父进程打开的文件</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>oldf<span style="color: #009900;">)</span>              <span style="color: #666666; font-style: italic;">//未打开文件</span>
		<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>clone_flags <span style="color: #339933;">&amp;</span> CLONE_FILES<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>    <span style="color: #666666; font-style: italic;">//不复制，只共享</span>
		atomic_inc<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>oldf<span style="color: #339933;">-&gt;</span>count<span style="color: #009900;">)</span><span style="color: #339933;">;</span>       <span style="color: #666666; font-style: italic;">//共享次数增1</span>
		<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	tsk<span style="color: #339933;">-&gt;</span>files <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ENOMEM<span style="color: #339933;">;</span>
	newf <span style="color: #339933;">=</span> kmem_cache_alloc<span style="color: #009900;">(</span>files_cachep<span style="color: #339933;">,</span> SLAB_KERNEL<span style="color: #009900;">)</span><span style="color: #339933;">;</span><span style="color: #666666; font-style: italic;">//分配数据结构</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>newf<span style="color: #009900;">)</span>      <span style="color: #666666; font-style: italic;">//分配失败</span>
		<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
&nbsp;
	atomic_set<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>newf<span style="color: #339933;">-&gt;</span>count<span style="color: #339933;">,</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>    <span style="color: #666666; font-style: italic;">//共享次数为1</span>
&nbsp;
	newf<span style="color: #339933;">-&gt;</span>file_lock	    <span style="color: #339933;">=</span> RW_LOCK_UNLOCKED<span style="color: #339933;">;</span>
	newf<span style="color: #339933;">-&gt;</span>next_fd	    <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	newf<span style="color: #339933;">-&gt;</span>max_fds	    <span style="color: #339933;">=</span> NR_OPEN_DEFAULT<span style="color: #339933;">;</span>
	newf<span style="color: #339933;">-&gt;</span>max_fdset	    <span style="color: #339933;">=</span> __FD_SETSIZE<span style="color: #339933;">;</span>
	newf<span style="color: #339933;">-&gt;</span>close_on_exec <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>newf<span style="color: #339933;">-&gt;</span>close_on_exec_init<span style="color: #339933;">;</span>
	newf<span style="color: #339933;">-&gt;</span>open_fds	    <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>newf<span style="color: #339933;">-&gt;</span>open_fds_init<span style="color: #339933;">;</span>
	newf<span style="color: #339933;">-&gt;</span>fd	    <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>newf<span style="color: #339933;">-&gt;</span>fd_array<span style="color: #009900;">[</span><span style="color: #0000dd;">0</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* We don't yet have the oldf readlock, but even if the old
           fdset gets grown now, we'll only copy up to "size" fds */</span>
	size <span style="color: #339933;">=</span> oldf<span style="color: #339933;">-&gt;</span>max_fdset<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>size <span style="color: #339933;">&gt;</span> __FD_SETSIZE<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		newf<span style="color: #339933;">-&gt;</span>max_fdset <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		write_lock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>newf<span style="color: #339933;">-&gt;</span>file_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		error <span style="color: #339933;">=</span> expand_fdset<span style="color: #009900;">(</span>newf<span style="color: #339933;">,</span> size<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		write_unlock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>newf<span style="color: #339933;">-&gt;</span>file_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>error<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> out_release<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	read_lock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>oldf<span style="color: #339933;">-&gt;</span>file_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	open_files <span style="color: #339933;">=</span> count_open_files<span style="color: #009900;">(</span>oldf<span style="color: #339933;">,</span> size<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * Check whether we need to allocate a larger fd array.
	 * Note: we're not a clone task, so the open count won't
	 * change.
	 */</span>
	nfds <span style="color: #339933;">=</span> NR_OPEN_DEFAULT<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>open_files <span style="color: #339933;">&gt;</span> nfds<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		read_unlock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>oldf<span style="color: #339933;">-&gt;</span>file_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		newf<span style="color: #339933;">-&gt;</span>max_fds <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
		write_lock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>newf<span style="color: #339933;">-&gt;</span>file_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		error <span style="color: #339933;">=</span> expand_fd_array<span style="color: #009900;">(</span>newf<span style="color: #339933;">,</span> open_files<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		write_unlock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>newf<span style="color: #339933;">-&gt;</span>file_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>error<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> out_release<span style="color: #339933;">;</span>
		nfds <span style="color: #339933;">=</span> newf<span style="color: #339933;">-&gt;</span>max_fds<span style="color: #339933;">;</span>
		read_lock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>oldf<span style="color: #339933;">-&gt;</span>file_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	old_fds <span style="color: #339933;">=</span> oldf<span style="color: #339933;">-&gt;</span>fd<span style="color: #339933;">;</span>
	new_fds <span style="color: #339933;">=</span> newf<span style="color: #339933;">-&gt;</span>fd<span style="color: #339933;">;</span>
&nbsp;
	memcpy<span style="color: #009900;">(</span>newf<span style="color: #339933;">-&gt;</span>open_fds<span style="color: #339933;">-&gt;</span>fds_bits<span style="color: #339933;">,</span> oldf<span style="color: #339933;">-&gt;</span>open_fds<span style="color: #339933;">-&gt;</span>fds_bits<span style="color: #339933;">,</span> open_files<span style="color: #339933;">/</span><span style="color: #0000dd;">8</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	memcpy<span style="color: #009900;">(</span>newf<span style="color: #339933;">-&gt;</span>close_on_exec<span style="color: #339933;">-&gt;</span>fds_bits<span style="color: #339933;">,</span> oldf<span style="color: #339933;">-&gt;</span>close_on_exec<span style="color: #339933;">-&gt;</span>fds_bits<span style="color: #339933;">,</span> open_files<span style="color: #339933;">/</span><span style="color: #0000dd;">8</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>i <span style="color: #339933;">=</span> open_files<span style="color: #339933;">;</span> i <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> i<span style="color: #339933;">--</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span>f <span style="color: #339933;">=</span> <span style="color: #339933;">*</span>old_fds<span style="color: #339933;">++;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>f<span style="color: #009900;">)</span>
			get_file<span style="color: #009900;">(</span>f<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #339933;">*</span>new_fds<span style="color: #339933;">++</span> <span style="color: #339933;">=</span> f<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	read_unlock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>oldf<span style="color: #339933;">-&gt;</span>file_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* compute the remainder to be cleared */</span>
	size <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>newf<span style="color: #339933;">-&gt;</span>max_fds <span style="color: #339933;">-</span> open_files<span style="color: #009900;">)</span> <span style="color: #339933;">*</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* This is long word aligned thus could use a optimized version */</span>
	memset<span style="color: #009900;">(</span>new_fds<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> size<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>newf<span style="color: #339933;">-&gt;</span>max_fdset <span style="color: #339933;">&gt;</span> open_files<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		<span style="color: #993333;">int</span> left <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>newf<span style="color: #339933;">-&gt;</span>max_fdset<span style="color: #339933;">-</span>open_files<span style="color: #009900;">)</span><span style="color: #339933;">/</span><span style="color: #0000dd;">8</span><span style="color: #339933;">;</span>
		<span style="color: #993333;">int</span> start <span style="color: #339933;">=</span> open_files <span style="color: #339933;">/</span> <span style="color: #009900;">(</span><span style="color: #0000dd;">8</span> <span style="color: #339933;">*</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
		memset<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>newf<span style="color: #339933;">-&gt;</span>open_fds<span style="color: #339933;">-&gt;</span>fds_bits<span style="color: #009900;">[</span>start<span style="color: #009900;">]</span><span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> left<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		memset<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>newf<span style="color: #339933;">-&gt;</span>close_on_exec<span style="color: #339933;">-&gt;</span>fds_bits<span style="color: #009900;">[</span>start<span style="color: #009900;">]</span><span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> left<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	tsk<span style="color: #339933;">-&gt;</span>files <span style="color: #339933;">=</span> newf<span style="color: #339933;">;</span>
	error <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
out<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">return</span> error<span style="color: #339933;">;</span>
&nbsp;
out_release<span style="color: #339933;">:</span>
	free_fdset <span style="color: #009900;">(</span>newf<span style="color: #339933;">-&gt;</span>close_on_exec<span style="color: #339933;">,</span> newf<span style="color: #339933;">-&gt;</span>max_fdset<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	free_fdset <span style="color: #009900;">(</span>newf<span style="color: #339933;">-&gt;</span>open_fds<span style="color: #339933;">,</span> newf<span style="color: #339933;">-&gt;</span>max_fdset<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	kmem_cache_free<span style="color: #009900;">(</span>files_cachep<span style="color: #339933;">,</span> newf<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>关于此函数的详细内容留到文件系统再说，这里要说的是，在这个函数里面有两种方式来实现，一个是共享不复制，另一种是复制。都是根据标志位来判别的。</p> 
          <p>其他几个函数也是一样，都有共享不复制和复制两种方式，copy_fs()函数定义在fork.c中：</p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=635&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p6357"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td> 
              <td class="code" id="p635code7"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #000000; font-weight: bold;">inline</span> <span style="color: #993333;">int</span> copy_fs<span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> clone_flags<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> task_struct <span style="color: #339933;">*</span> tsk<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>clone_flags <span style="color: #339933;">&amp;</span> CLONE_FS<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		atomic_inc<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>current<span style="color: #339933;">-&gt;</span>fs<span style="color: #339933;">-&gt;</span>count<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	tsk<span style="color: #339933;">-&gt;</span>fs <span style="color: #339933;">=</span> __copy_fs_struct<span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>fs<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>tsk<span style="color: #339933;">-&gt;</span>fs<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #993333;">struct</span> fs_struct <span style="color: #339933;">*</span>copy_fs_struct<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> fs_struct <span style="color: #339933;">*</span>old<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #b1b100;">return</span> __copy_fs_struct<span style="color: #009900;">(</span>old<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span>
&nbsp;
<span style="color: #993333;">static</span> <span style="color: #000000; font-weight: bold;">inline</span> <span style="color: #993333;">struct</span> fs_struct <span style="color: #339933;">*</span>__copy_fs_struct<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> fs_struct <span style="color: #339933;">*</span>old<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> fs_struct <span style="color: #339933;">*</span>fs <span style="color: #339933;">=</span> kmem_cache_alloc<span style="color: #009900;">(</span>fs_cachep<span style="color: #339933;">,</span> GFP_KERNEL<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #808080; font-style: italic;">/* We don't need to lock fs - think why ;-) */</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>fs<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		atomic_set<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>fs<span style="color: #339933;">-&gt;</span>count<span style="color: #339933;">,</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		fs<span style="color: #339933;">-&gt;</span>lock <span style="color: #339933;">=</span> RW_LOCK_UNLOCKED<span style="color: #339933;">;</span>
		fs<span style="color: #339933;">-&gt;</span>umask <span style="color: #339933;">=</span> old<span style="color: #339933;">-&gt;</span>umask<span style="color: #339933;">;</span>
		read_lock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>old<span style="color: #339933;">-&gt;</span>lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		fs<span style="color: #339933;">-&gt;</span>rootmnt <span style="color: #339933;">=</span> mntget<span style="color: #009900;">(</span>old<span style="color: #339933;">-&gt;</span>rootmnt<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		fs<span style="color: #339933;">-&gt;</span>root <span style="color: #339933;">=</span> dget<span style="color: #009900;">(</span>old<span style="color: #339933;">-&gt;</span>root<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		fs<span style="color: #339933;">-&gt;</span>pwdmnt <span style="color: #339933;">=</span> mntget<span style="color: #009900;">(</span>old<span style="color: #339933;">-&gt;</span>pwdmnt<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		fs<span style="color: #339933;">-&gt;</span>pwd <span style="color: #339933;">=</span> dget<span style="color: #009900;">(</span>old<span style="color: #339933;">-&gt;</span>pwd<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>old<span style="color: #339933;">-&gt;</span>altroot<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			fs<span style="color: #339933;">-&gt;</span>altrootmnt <span style="color: #339933;">=</span> mntget<span style="color: #009900;">(</span>old<span style="color: #339933;">-&gt;</span>altrootmnt<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			fs<span style="color: #339933;">-&gt;</span>altroot <span style="color: #339933;">=</span> dget<span style="color: #009900;">(</span>old<span style="color: #339933;">-&gt;</span>altroot<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">{</span>
			fs<span style="color: #339933;">-&gt;</span>altrootmnt <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
			fs<span style="color: #339933;">-&gt;</span>altroot <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		read_unlock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>old<span style="color: #339933;">-&gt;</span>lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	<span style="color: #b1b100;">return</span> fs<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>copy_sighand()也是一样：</p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=635&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p6358"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td> 
              <td class="code" id="p635code8"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #000000; font-weight: bold;">inline</span> <span style="color: #993333;">int</span> copy_sighand<span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> clone_flags<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> task_struct <span style="color: #339933;">*</span> tsk<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> signal_struct <span style="color: #339933;">*</span>sig<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>clone_flags <span style="color: #339933;">&amp;</span> CLONE_SIGHAND<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		atomic_inc<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>current<span style="color: #339933;">-&gt;</span>sig<span style="color: #339933;">-&gt;</span>count<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	sig <span style="color: #339933;">=</span> kmem_cache_alloc<span style="color: #009900;">(</span>sigact_cachep<span style="color: #339933;">,</span> GFP_KERNEL<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	tsk<span style="color: #339933;">-&gt;</span>sig <span style="color: #339933;">=</span> sig<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>sig<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	spin_lock_init<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>sig<span style="color: #339933;">-&gt;</span>siglock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	atomic_set<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>sig<span style="color: #339933;">-&gt;</span>count<span style="color: #339933;">,</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	memcpy<span style="color: #009900;">(</span>tsk<span style="color: #339933;">-&gt;</span>sig<span style="color: #339933;">-&gt;</span>action<span style="color: #339933;">,</span> current<span style="color: #339933;">-&gt;</span>sig<span style="color: #339933;">-&gt;</span>action<span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span>tsk<span style="color: #339933;">-&gt;</span>sig<span style="color: #339933;">-&gt;</span>action<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>copy_mm()一样：</p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=635&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p6359"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
</pre></td> 
              <td class="code" id="p635code9"><pre class="c" style="font-family:monospace;"><span style="color: #993333;">static</span> <span style="color: #993333;">int</span> copy_mm<span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> clone_flags<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> task_struct <span style="color: #339933;">*</span> tsk<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> mm_struct <span style="color: #339933;">*</span> mm<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>oldmm<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> retval<span style="color: #339933;">;</span>
&nbsp;
	tsk<span style="color: #339933;">-&gt;</span>min_flt <span style="color: #339933;">=</span> tsk<span style="color: #339933;">-&gt;</span>maj_flt <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	tsk<span style="color: #339933;">-&gt;</span>cmin_flt <span style="color: #339933;">=</span> tsk<span style="color: #339933;">-&gt;</span>cmaj_flt <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	tsk<span style="color: #339933;">-&gt;</span>nswap <span style="color: #339933;">=</span> tsk<span style="color: #339933;">-&gt;</span>cnswap <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
	tsk<span style="color: #339933;">-&gt;</span>mm <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	tsk<span style="color: #339933;">-&gt;</span>active_mm <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * Are we cloning a kernel thread?
	 *
	 * We need to steal a active VM for that..
	 */</span>
	oldmm <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>mm<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>oldmm<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>clone_flags <span style="color: #339933;">&amp;</span> CLONE_VM<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>       <span style="color: #666666; font-style: italic;">//共享</span>
		atomic_inc<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>oldmm<span style="color: #339933;">-&gt;</span>mm_users<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		mm <span style="color: #339933;">=</span> oldmm<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">goto</span> good_mm<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
&nbsp;
	retval <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ENOMEM<span style="color: #339933;">;</span>
	mm <span style="color: #339933;">=</span> allocate_mm<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>     <span style="color: #666666; font-style: italic;">//分配mm空间</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>mm<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> fail_nomem<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/* Copy the current MM stuff.. */</span>
	memcpy<span style="color: #009900;">(</span>mm<span style="color: #339933;">,</span> oldmm<span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">(</span><span style="color: #339933;">*</span>mm<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">//复制父进程mm结构</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>mm_init<span style="color: #009900;">(</span>mm<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> fail_nomem<span style="color: #339933;">;</span>
&nbsp;
	down<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>oldmm<span style="color: #339933;">-&gt;</span>mmap_sem<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	retval <span style="color: #339933;">=</span> dup_mmap<span style="color: #009900;">(</span>mm<span style="color: #009900;">)</span><span style="color: #339933;">;</span>  <span style="color: #666666; font-style: italic;">//重要函数，复制vm_area_struct数据结构和页面映射表</span>
	up<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>oldmm<span style="color: #339933;">-&gt;</span>mmap_sem<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * Add it to the mmlist after the parent.
	 *
	 * Doing it this way means that we can order
	 * the list, and fork() won't mess up the
	 * ordering significantly.
	 */</span>
	spin_lock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>mmlist_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	list_add<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>mm<span style="color: #339933;">-&gt;</span>mmlist<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>oldmm<span style="color: #339933;">-&gt;</span>mmlist<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	spin_unlock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>mmlist_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>retval<span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> free_pt<span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/*
	 * child gets a private LDT (if there was an LDT in the parent)
	 */</span>
	copy_segments<span style="color: #009900;">(</span>tsk<span style="color: #339933;">,</span> mm<span style="color: #009900;">)</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">//用于VM86模式，不详解</span>
&nbsp;
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>init_new_context<span style="color: #009900;">(</span>tsk<span style="color: #339933;">,</span>mm<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
		<span style="color: #b1b100;">goto</span> free_pt<span style="color: #339933;">;</span>
&nbsp;
good_mm<span style="color: #339933;">:</span>
	tsk<span style="color: #339933;">-&gt;</span>mm <span style="color: #339933;">=</span> mm<span style="color: #339933;">;</span>
	tsk<span style="color: #339933;">-&gt;</span>active_mm <span style="color: #339933;">=</span> mm<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
free_pt<span style="color: #339933;">:</span>
	mmput<span style="color: #009900;">(</span>mm<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
fail_nomem<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">return</span> retval<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span>
&nbsp;
&nbsp;
<span style="color: #993333;">static</span> <span style="color: #000000; font-weight: bold;">inline</span> <span style="color: #993333;">int</span> dup_mmap<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> mm_struct <span style="color: #339933;">*</span> mm<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> vm_area_struct <span style="color: #339933;">*</span> mpnt<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>tmp<span style="color: #339933;">,</span> <span style="color: #339933;">**</span>pprev<span style="color: #339933;">;</span>
	<span style="color: #993333;">int</span> retval<span style="color: #339933;">;</span>
&nbsp;
	flush_cache_mm<span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>mm<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	mm<span style="color: #339933;">-&gt;</span>locked_vm <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	mm<span style="color: #339933;">-&gt;</span>mmap <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	mm<span style="color: #339933;">-&gt;</span>mmap_avl <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	mm<span style="color: #339933;">-&gt;</span>mmap_cache <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
	mm<span style="color: #339933;">-&gt;</span>map_count <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	mm<span style="color: #339933;">-&gt;</span>cpu_vm_mask <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	mm<span style="color: #339933;">-&gt;</span>swap_cnt <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	mm<span style="color: #339933;">-&gt;</span>swap_address <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	pprev <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>mm<span style="color: #339933;">-&gt;</span>mmap<span style="color: #339933;">;</span>
	<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span>mpnt <span style="color: #339933;">=</span> current<span style="color: #339933;">-&gt;</span>mm<span style="color: #339933;">-&gt;</span>mmap <span style="color: #339933;">;</span> mpnt <span style="color: #339933;">;</span> mpnt <span style="color: #339933;">=</span> mpnt<span style="color: #339933;">-&gt;</span>vm_next<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><span style="color: #666666; font-style: italic;">//循环复制区间</span>
		<span style="color: #993333;">struct</span> file <span style="color: #339933;">*</span>file<span style="color: #339933;">;</span>
&nbsp;
		retval <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>ENOMEM<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span><span style="color: #009900;">(</span>mpnt<span style="color: #339933;">-&gt;</span>vm_flags <span style="color: #339933;">&amp;</span> VM_DONTCOPY<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span>
		tmp <span style="color: #339933;">=</span> kmem_cache_alloc<span style="color: #009900;">(</span>vm_area_cachep<span style="color: #339933;">,</span> SLAB_KERNEL<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>tmp<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> fail_nomem<span style="color: #339933;">;</span>
		<span style="color: #339933;">*</span>tmp <span style="color: #339933;">=</span> <span style="color: #339933;">*</span>mpnt<span style="color: #339933;">;</span>
		tmp<span style="color: #339933;">-&gt;</span>vm_flags <span style="color: #339933;">&amp;=</span> ~VM_LOCKED<span style="color: #339933;">;</span>
		tmp<span style="color: #339933;">-&gt;</span>vm_mm <span style="color: #339933;">=</span> mm<span style="color: #339933;">;</span>
		mm<span style="color: #339933;">-&gt;</span>map_count<span style="color: #339933;">++;</span>
		tmp<span style="color: #339933;">-&gt;</span>vm_next <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
		file <span style="color: #339933;">=</span> tmp<span style="color: #339933;">-&gt;</span>vm_file<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>file<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #993333;">struct</span> inode <span style="color: #339933;">*</span>inode <span style="color: #339933;">=</span> file<span style="color: #339933;">-&gt;</span>f_dentry<span style="color: #339933;">-&gt;</span>d_inode<span style="color: #339933;">;</span>
			get_file<span style="color: #009900;">(</span>file<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>tmp<span style="color: #339933;">-&gt;</span>vm_flags <span style="color: #339933;">&amp;</span> VM_DENYWRITE<span style="color: #009900;">)</span>
				atomic_dec<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>inode<span style="color: #339933;">-&gt;</span>i_writecount<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
			<span style="color: #808080; font-style: italic;">/* insert tmp into the share list, just after mpnt */</span>
			spin_lock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>inode<span style="color: #339933;">-&gt;</span>i_mapping<span style="color: #339933;">-&gt;</span>i_shared_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span><span style="color: #009900;">(</span><span style="color: #009900;">(</span>tmp<span style="color: #339933;">-&gt;</span>vm_next_share <span style="color: #339933;">=</span> mpnt<span style="color: #339933;">-&gt;</span>vm_next_share<span style="color: #009900;">)</span> <span style="color: #339933;">!=</span> NULL<span style="color: #009900;">)</span>
				mpnt<span style="color: #339933;">-&gt;</span>vm_next_share<span style="color: #339933;">-&gt;</span>vm_pprev_share <span style="color: #339933;">=</span>
					<span style="color: #339933;">&amp;</span>tmp<span style="color: #339933;">-&gt;</span>vm_next_share<span style="color: #339933;">;</span>
			mpnt<span style="color: #339933;">-&gt;</span>vm_next_share <span style="color: #339933;">=</span> tmp<span style="color: #339933;">;</span>
			tmp<span style="color: #339933;">-&gt;</span>vm_pprev_share <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>mpnt<span style="color: #339933;">-&gt;</span>vm_next_share<span style="color: #339933;">;</span>
			spin_unlock<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>inode<span style="color: #339933;">-&gt;</span>i_mapping<span style="color: #339933;">-&gt;</span>i_shared_lock<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/* Copy the pages, but defer checking for errors */</span>
		retval <span style="color: #339933;">=</span> copy_page_range<span style="color: #009900;">(</span>mm<span style="color: #339933;">,</span> current<span style="color: #339933;">-&gt;</span>mm<span style="color: #339933;">,</span> tmp<span style="color: #009900;">)</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">//逐层处理页面目录和页面表项</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>retval <span style="color: #339933;">&amp;&amp;</span> tmp<span style="color: #339933;">-&gt;</span>vm_ops <span style="color: #339933;">&amp;&amp;</span> tmp<span style="color: #339933;">-&gt;</span>vm_ops<span style="color: #339933;">-&gt;</span>open<span style="color: #009900;">)</span>
			tmp<span style="color: #339933;">-&gt;</span>vm_ops<span style="color: #339933;">-&gt;</span>open<span style="color: #009900;">(</span>tmp<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/*
		 * Link in the new vma even if an error occurred,
		 * so that exit_mmap() can clean up the mess.
		 */</span>
		<span style="color: #339933;">*</span>pprev <span style="color: #339933;">=</span> tmp<span style="color: #339933;">;</span>
		pprev <span style="color: #339933;">=</span> <span style="color: #339933;">&amp;</span>tmp<span style="color: #339933;">-&gt;</span>vm_next<span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>retval<span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> fail_nomem<span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
	retval <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>mm<span style="color: #339933;">-&gt;</span>map_count <span style="color: #339933;">&gt;=</span> AVL_MIN_MAP_COUNT<span style="color: #009900;">)</span>
		build_mmap_avl<span style="color: #009900;">(</span>mm<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
fail_nomem<span style="color: #339933;">:</span>
	flush_tlb_mm<span style="color: #009900;">(</span>current<span style="color: #339933;">-&gt;</span>mm<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">return</span> retval<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span>
&nbsp;
&nbsp;
<span style="color: #666666; font-style: italic;">//copy_page_range:mm/memory.c</span>
<span style="color: #993333;">int</span> copy_page_range<span style="color: #009900;">(</span><span style="color: #993333;">struct</span> mm_struct <span style="color: #339933;">*</span>dst<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> mm_struct <span style="color: #339933;">*</span>src<span style="color: #339933;">,</span>
			<span style="color: #993333;">struct</span> vm_area_struct <span style="color: #339933;">*</span>vma<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	pgd_t <span style="color: #339933;">*</span> src_pgd<span style="color: #339933;">,</span> <span style="color: #339933;">*</span> dst_pgd<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> address <span style="color: #339933;">=</span> vma<span style="color: #339933;">-&gt;</span>vm_start<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> end <span style="color: #339933;">=</span> vma<span style="color: #339933;">-&gt;</span>vm_end<span style="color: #339933;">;</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> cow <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>vma<span style="color: #339933;">-&gt;</span>vm_flags <span style="color: #339933;">&amp;</span> <span style="color: #009900;">(</span>VM_SHARED <span style="color: #339933;">|</span> VM_MAYWRITE<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">==</span> VM_MAYWRITE<span style="color: #339933;">;</span>
&nbsp;
	src_pgd <span style="color: #339933;">=</span> pgd_offset<span style="color: #009900;">(</span>src<span style="color: #339933;">,</span> address<span style="color: #009900;">)</span><span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
	dst_pgd <span style="color: #339933;">=</span> pgd_offset<span style="color: #009900;">(</span>dst<span style="color: #339933;">,</span> address<span style="color: #009900;">)</span><span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span><span style="color: #339933;">;;</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
		pmd_t <span style="color: #339933;">*</span> src_pmd<span style="color: #339933;">,</span> <span style="color: #339933;">*</span> dst_pmd<span style="color: #339933;">;</span>
&nbsp;
		src_pgd<span style="color: #339933;">++;</span> dst_pgd<span style="color: #339933;">++;</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/* copy_pmd_range */</span>
&nbsp;
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>pgd_none<span style="color: #009900;">(</span><span style="color: #339933;">*</span>src_pgd<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
			<span style="color: #b1b100;">goto</span> skip_copy_pmd_range<span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>pgd_bad<span style="color: #009900;">(</span><span style="color: #339933;">*</span>src_pgd<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			pgd_ERROR<span style="color: #009900;">(</span><span style="color: #339933;">*</span>src_pgd<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			pgd_clear<span style="color: #009900;">(</span>src_pgd<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
skip_copy_pmd_range<span style="color: #339933;">:</span>	address <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>address <span style="color: #339933;">+</span> PGDIR_SIZE<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;</span> PGDIR_MASK<span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>address <span style="color: #339933;">||</span> <span style="color: #009900;">(</span>address <span style="color: #339933;">&gt;=</span> end<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
			<span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
		<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>pgd_none<span style="color: #009900;">(</span><span style="color: #339933;">*</span>dst_pgd<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>pmd_alloc<span style="color: #009900;">(</span>dst_pgd<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				<span style="color: #b1b100;">goto</span> nomem<span style="color: #339933;">;</span>
		<span style="color: #009900;">}</span>
&nbsp;
		src_pmd <span style="color: #339933;">=</span> pmd_offset<span style="color: #009900;">(</span>src_pgd<span style="color: #339933;">,</span> address<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
		dst_pmd <span style="color: #339933;">=</span> pmd_offset<span style="color: #009900;">(</span>dst_pgd<span style="color: #339933;">,</span> address<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
		<span style="color: #b1b100;">do</span> <span style="color: #009900;">{</span>
			pte_t <span style="color: #339933;">*</span> src_pte<span style="color: #339933;">,</span> <span style="color: #339933;">*</span> dst_pte<span style="color: #339933;">;</span>
&nbsp;
			<span style="color: #808080; font-style: italic;">/* copy_pte_range */</span>
&nbsp;
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>pmd_none<span style="color: #009900;">(</span><span style="color: #339933;">*</span>src_pmd<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
				<span style="color: #b1b100;">goto</span> skip_copy_pte_range<span style="color: #339933;">;</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>pmd_bad<span style="color: #009900;">(</span><span style="color: #339933;">*</span>src_pmd<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				pmd_ERROR<span style="color: #009900;">(</span><span style="color: #339933;">*</span>src_pmd<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				pmd_clear<span style="color: #009900;">(</span>src_pmd<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
skip_copy_pte_range<span style="color: #339933;">:</span>		address <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>address <span style="color: #339933;">+</span> PMD_SIZE<span style="color: #009900;">)</span> <span style="color: #339933;">&amp;</span> PMD_MASK<span style="color: #339933;">;</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>address <span style="color: #339933;">&gt;=</span> end<span style="color: #009900;">)</span>
					<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
				<span style="color: #b1b100;">goto</span> cont_copy_pmd_range<span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
			<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>pmd_none<span style="color: #009900;">(</span><span style="color: #339933;">*</span>dst_pmd<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>pte_alloc<span style="color: #009900;">(</span>dst_pmd<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>
					<span style="color: #b1b100;">goto</span> nomem<span style="color: #339933;">;</span>
			<span style="color: #009900;">}</span>
&nbsp;
			src_pte <span style="color: #339933;">=</span> pte_offset<span style="color: #009900;">(</span>src_pmd<span style="color: #339933;">,</span> address<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
			dst_pte <span style="color: #339933;">=</span> pte_offset<span style="color: #009900;">(</span>dst_pmd<span style="color: #339933;">,</span> address<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
			<span style="color: #b1b100;">do</span> <span style="color: #009900;">{</span>
				pte_t pte <span style="color: #339933;">=</span> <span style="color: #339933;">*</span>src_pte<span style="color: #339933;">;</span>
				<span style="color: #993333;">struct</span> page <span style="color: #339933;">*</span>ptepage<span style="color: #339933;">;</span>
&nbsp;
				<span style="color: #808080; font-style: italic;">/* copy_one_pte */</span>
&nbsp;
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>pte_none<span style="color: #009900;">(</span>pte<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
					<span style="color: #b1b100;">goto</span> cont_copy_pte_range_noset<span style="color: #339933;">;</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #339933;">!</span>pte_present<span style="color: #009900;">(</span>pte<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
					swap_duplicate<span style="color: #009900;">(</span>pte_to_swp_entry<span style="color: #009900;">(</span>pte<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
					<span style="color: #b1b100;">goto</span> cont_copy_pte_range<span style="color: #339933;">;</span>
				<span style="color: #009900;">}</span>
				ptepage <span style="color: #339933;">=</span> pte_page<span style="color: #009900;">(</span>pte<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #339933;">!</span>VALID_PAGE<span style="color: #009900;">(</span>ptepage<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">||</span>
				    PageReserved<span style="color: #009900;">(</span>ptepage<span style="color: #009900;">)</span><span style="color: #009900;">)</span>
					<span style="color: #b1b100;">goto</span> cont_copy_pte_range<span style="color: #339933;">;</span>
&nbsp;
				<span style="color: #808080; font-style: italic;">/* If it's a COW mapping, write protect it both in the parent and the child */</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>cow<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
					ptep_set_wrprotect<span style="color: #009900;">(</span>src_pte<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
					pte <span style="color: #339933;">=</span> <span style="color: #339933;">*</span>src_pte<span style="color: #339933;">;</span>
				<span style="color: #009900;">}</span>
&nbsp;
				<span style="color: #808080; font-style: italic;">/* If it's a shared mapping, mark it clean in the child */</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>vma<span style="color: #339933;">-&gt;</span>vm_flags <span style="color: #339933;">&amp;</span> VM_SHARED<span style="color: #009900;">)</span>
					pte <span style="color: #339933;">=</span> pte_mkclean<span style="color: #009900;">(</span>pte<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				pte <span style="color: #339933;">=</span> pte_mkold<span style="color: #009900;">(</span>pte<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
				get_page<span style="color: #009900;">(</span>ptepage<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
cont_copy_pte_range<span style="color: #339933;">:</span>		set_pte<span style="color: #009900;">(</span>dst_pte<span style="color: #339933;">,</span> pte<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
cont_copy_pte_range_noset<span style="color: #339933;">:</span>	address <span style="color: #339933;">+=</span> PAGE_SIZE<span style="color: #339933;">;</span>
				<span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span>address <span style="color: #339933;">&gt;=</span> end<span style="color: #009900;">)</span>
					<span style="color: #b1b100;">goto</span> out<span style="color: #339933;">;</span>
				src_pte<span style="color: #339933;">++;</span>
				dst_pte<span style="color: #339933;">++;</span>
			<span style="color: #009900;">}</span> <span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span>src_pte <span style="color: #339933;">&amp;</span> PTE_TABLE_MASK<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
cont_copy_pmd_range<span style="color: #339933;">:</span>	src_pmd<span style="color: #339933;">++;</span>
			dst_pmd<span style="color: #339933;">++;</span>
		<span style="color: #009900;">}</span> <span style="color: #b1b100;">while</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span>src_pmd <span style="color: #339933;">&amp;</span> PMD_TABLE_MASK<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">}</span>
out<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
&nbsp;
nomem<span style="color: #339933;">:</span>
	<span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span>ENOMEM<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>这里，值得注意的是，复制页面表项的时候有如下几种方式：</p> 
          <p>1、表项内容为<span style="font-family: 'Times New Roman';">0</span><span style="font-family: 宋体;">，表示父进程映射尚未建立，不需要做任何事。</span></p> 
          <p>2、表项最低位即存在位为<span style="font-family: 'Times New Roman';">0</span><span style="font-family: 宋体;">，表示页面映射已经建立，但是页面不在内存，在交换设备上，所以要将该交换设备的那个页面的共享计数增</span><span style="font-family: 'Times New Roman';">1</span><span style="font-family: 宋体;">，然后复制页面表项。</span></p> 
          <p>3、映射已经建立，但是不是有效物理页面，这种页面的地址为“总线地址”，不属于换入换出内容，也不消耗动态分配的内存页面，所以只需要简单复制页面表项即可。</p> 
          <p>4、需要从父进程复制的“可写”页面，这种页面在子进程复制表项的时候要将子进程的权限改为“只读”，共享物理页面，等到子进程想写的时候再发生页面异常来进行内存页面申请和复制，也就是传说中的“<span style="font-family: 'Times New Roman';">copy</span>&nbsp;on&nbsp;write”：写时复制策略。</p> 
          <p>5、父进程的只读页面，简单复制表项即可。</p> 
          <p>可见，copy_page_range并没有真正复制哪怕半个物理页面，只是通过一系列的复制页面表项页面共享等来实现快速复制，快速创建进程。</p> 
          <p>copy_thread()<span style="font-family: 宋体;">定义在</span>arch/i386/kernel/process.c中，如下所示：</p> 
          <div class="wp_codebox_msgheader"> 
           <span class="right"><sup><a href="http://www.ericbess.com/ericblog/2008/03/03/wp-codebox/#examples" target="_blank" title="WP-CodeBox HowTo?"><span style="color: #99cc00">?</span></a></sup></span> 
           <span class="left2">Download <a href="http://codelifeliwan.github.io/wp-content/plugins/wp-codebox/wp-codebox.php?p=635&amp;download=download.c">download.c</a></span> 
           <div class="codebox_clear"></div> 
          </div> 
          <div class="wp_codebox"> 
           <table> 
            <tbody> 
             <tr id="p63510"> 
              <td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td> 
              <td class="code" id="p635code10"><pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * Save a segment.
 */</span>
<span style="color: #339933;">#define savesegment(seg,value) \
	asm volatile("movl %%" #seg ",%0":"=m" (*(int *)&amp;(value)))</span>
&nbsp;
<span style="color: #993333;">int</span> copy_thread<span style="color: #009900;">(</span><span style="color: #993333;">int</span> nr<span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> clone_flags<span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> esp<span style="color: #339933;">,</span>
	<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> unused<span style="color: #339933;">,</span>
	<span style="color: #993333;">struct</span> task_struct <span style="color: #339933;">*</span> p<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> pt_regs <span style="color: #339933;">*</span> regs<span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
	<span style="color: #993333;">struct</span> pt_regs <span style="color: #339933;">*</span> childregs<span style="color: #339933;">;</span>
&nbsp;
	childregs <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #993333;">struct</span> pt_regs <span style="color: #339933;">*</span><span style="color: #009900;">)</span> <span style="color: #009900;">(</span>THREAD_SIZE <span style="color: #339933;">+</span> <span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span> p<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">-</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">//堆栈地址，在8KB的最高处</span>
	struct_cpy<span style="color: #009900;">(</span>childregs<span style="color: #339933;">,</span> regs<span style="color: #009900;">)</span><span style="color: #339933;">;</span>    <span style="color: #666666; font-style: italic;">//复制堆栈内的regs</span>
	childregs<span style="color: #339933;">-&gt;</span>eax <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>             <span style="color: #666666; font-style: italic;">//将堆栈内的regs的eax设置为0，也就是子进程的返回值</span>
	childregs<span style="color: #339933;">-&gt;</span>esp <span style="color: #339933;">=</span> esp<span style="color: #339933;">;</span>       <span style="color: #666666; font-style: italic;">//指向指定的或者父进程的用户空间堆栈</span>
&nbsp;
	p<span style="color: #339933;">-&gt;</span>thread.<span style="color: #202020;">esp</span> <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span> childregs<span style="color: #339933;">;</span>
	p<span style="color: #339933;">-&gt;</span>thread.<span style="color: #202020;">esp0</span> <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span> <span style="color: #009900;">(</span>childregs<span style="color: #339933;">+</span><span style="color: #0000dd;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	p<span style="color: #339933;">-&gt;</span>thread.<span style="color: #202020;">eip</span> <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #009900;">)</span> ret_from_fork<span style="color: #339933;">;</span>
&nbsp;
	savesegment<span style="color: #009900;">(</span>fs<span style="color: #339933;">,</span>p<span style="color: #339933;">-&gt;</span>thread.<span style="color: #202020;">fs</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	savesegment<span style="color: #009900;">(</span>gs<span style="color: #339933;">,</span>p<span style="color: #339933;">-&gt;</span>thread.<span style="color: #202020;">gs</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	unlazy_fpu<span style="color: #009900;">(</span>current<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
	struct_cpy<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span>p<span style="color: #339933;">-&gt;</span>thread.<span style="color: #202020;">i387</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>current<span style="color: #339933;">-&gt;</span>thread.<span style="color: #202020;">i387</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <p>这里需要说明的是，将堆栈区间的<span style="font-family: 'Times New Roman';">EAX</span><span style="font-family: 宋体;">设置成</span><span style="font-family: 'Times New Roman';">0</span><span style="font-family: 宋体;">，从子进程返回的时候返回值即为</span><span style="font-family: 'Times New Roman';">0</span><span style="font-family: 宋体;">，两个返回值就是这么实现的。</span></p> 
          <p>&nbsp;</p> 
          <p>进程创建就这么多。</p> 
          <p>The&nbsp;End.</p> 
         </div> 
        </div>
       </div>
       <!-- .entry-content --> 
       <!-- .entry-meta --> 
      </article>
      <!-- #post-635 --> 
      <!-- #comments --> 
     </div>
     <!-- #content --> 
    </div>
    <!-- #primary --> 
    <!-- #secondary .widget-area --> 
   </div>
   <!-- #main --> 
   <!-- #colophon --> 
  </div>
  <!-- #page -->   
  <!-- JiaThis Button BEGIN -->  
  <!-- JiaThis Button END -->   
 </body>
</html>